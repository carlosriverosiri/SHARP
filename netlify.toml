[build]
  command = "npm ci && npm run build"
  publish = "dist"

[build.environment]
  NODE_VERSION = "20"

# Netlify Functions configuration
[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"
  # Extend timeout for AI API calls (max 26s on free plan, up to 15min on paid)
  # Note: Astro SSR routes use Netlify Functions internally

# Longer timeout for AI Council API
# Pro plan allows up to 15 minutes, we use 60 seconds
[functions."*"]
  timeout = 60

# Security headers (production)
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"

# Block indexing ONLY on Netlify preview/deploy-preview domains
[context.deploy-preview.headers]
  for = "/*"
    [context.deploy-preview.headers.values]
      X-Robots-Tag = "noindex, nofollow"

[context.branch-deploy.headers]
  for = "/*"
    [context.branch-deploy.headers.values]
      X-Robots-Tag = "noindex, nofollow"

# Cache statiska assets (JS, CSS) - 1 år
[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Cache Astro-genererade filer - 1 år
[[headers]]
  for = "/_astro/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Cache bilder - 1 år
[[headers]]
  for = "/images/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Cache favicons - 1 år
[[headers]]
  for = "/favicons/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Cache video - 1 år
[[headers]]
  for = "/video/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Cache fonter - 1 år
[[headers]]
  for = "/*.woff2"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.woff"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Cache SVG-filer - 1 år
[[headers]]
  for = "/*.svg"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Cache WebP-bilder - 1 år (preserve WebP format)
[[headers]]
  for = "/*.webp"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"
    Content-Type = "image/webp"

# HTML pages - korttidscache med revalidering
[[headers]]
  for = "/*.html"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"

# Enable Netlify's asset optimization (except images - handled by Astro)
[build.processing]
  skip_processing = false
[build.processing.css]
  bundle = true
  minify = true
[build.processing.js]
  bundle = true
  minify = true
[build.processing.html]
  pretty_urls = true

# NOTE: Trailing slash handling is done by Astro (trailingSlash: 'never' in astro.config.mjs)
# DO NOT add redirect rules for trailing slashes here - it breaks SSR pages!

# DISABLE Netlify's image optimization - Astro handles this better!
# Netlify's on-the-fly Image CDN converts WebP to JPEG, which is worse.
# Astro's <Image> component generates optimized WebP at build time.
[build.processing.images]
  compress = false

# Disable Netlify Image CDN completely
[images]
  remote_images = []
