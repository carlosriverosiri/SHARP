---
// src/layouts/BaseLayout.astro
import "../styles/global.css";
import Footer from "../components/footer.astro";
import Header from "../components/Header.astro";
import FooterMap from "../components/FooterMap.astro";

// Props med default-värden
interface Props {
  title: string;
  description?: string;
  image?: string;
  type?: 'website' | 'article';
  noindex?: boolean;
  alternateUrl?: string;
}

const { 
  title,
  description = "Specialistklinik i Stockholm för knä, axel och armbåge. Vi tar emot patienter från hela Sverige via Fritt Vårdval och försäkringsbolag.",
  image = "https://sodermalmsortopedi.se/images/branding/logo.svg",
  type = "website",
  noindex = false,
  alternateUrl
} = Astro.props;

// Generera full URL för canonical och OG
const siteUrl = "https://sodermalmsortopedi.se";
const canonicalUrl = new URL(Astro.url.pathname, siteUrl).href;
const ogImage = image.startsWith('http') ? image : `${siteUrl}${image}`;
---

<!doctype html>
<html lang={Astro.url.pathname.startsWith('/en') ? 'en' : 'sv'}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    
    <!-- DNS Prefetch för lazy-loadade resurser (kartan) -->
    <link rel="dns-prefetch" href="https://unpkg.com" />
    <link rel="dns-prefetch" href="https://tile.openstreetmap.org" />
    
    <!-- SEO Meta -->
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalUrl} />
    {noindex && <meta name="robots" content="noindex, nofollow" />}
    <meta name="author" content="Södermalms Ortopedi" />
    <meta name="geo.region" content="SE-AB" />
    <meta name="geo.placename" content="Stockholm" />
    
    <!-- Hreflang for multilingual SEO -->
    {Astro.url.pathname.startsWith('/en') ? (
      <>
        <link rel="alternate" hreflang="en" href={canonicalUrl} />
        <link rel="alternate" hreflang="sv" href={alternateUrl ? `${siteUrl}${alternateUrl}` : siteUrl} />
        <link rel="alternate" hreflang="x-default" href={alternateUrl ? `${siteUrl}${alternateUrl}` : siteUrl} />
      </>
    ) : (
      <>
        <link rel="alternate" hreflang="sv" href={canonicalUrl} />
        <link rel="alternate" hreflang="en" href={alternateUrl ? `${siteUrl}${alternateUrl}` : `${siteUrl}/en/`} />
        <link rel="alternate" hreflang="x-default" href={canonicalUrl} />
      </>
    )}
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={type} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content={title} />
    <meta property="og:locale" content={Astro.url.pathname.startsWith('/en') ? 'en_US' : 'sv_SE'} />
    <meta property="og:locale:alternate" content={Astro.url.pathname.startsWith('/en') ? 'sv_SE' : 'en_US'} />
    <meta property="og:site_name" content="Södermalms Ortopedi" />
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@sodermalmsortopedi" />
    <meta name="twitter:creator" content="@sodermalmsortopedi" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />
    <meta name="twitter:image:alt" content={title} />
    
    <!-- Fonts - Non-blocking load -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
      media="print"
      onload="this.media='all'"
    />
    <noscript>
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    </noscript>

    <!-- Preload critical resources -->
    <link rel="preload" href="/images/branding/logo.svg" as="image" type="image/svg+xml" />
    
    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="/favicons/favicon.svg" />
    <link rel="apple-touch-icon" href="/favicons/apple-touch-icon.png" />
    <link rel="manifest" href="/favicons/site.webmanifest" />
    <link rel="icon" type="image/x-icon" href="/favicons/favicon.ico" />
    
    <!-- Netlify Identity Widget - Lazy loaded -->
    <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    
    <!-- Named slot for page-specific head content (schemas, extra meta, etc.) -->
    <slot name="head" />
  </head>
  <!-- ÄNDRING: Tog bort 'pt-20' eftersom headern är sticky och tar upp plats själv -->
  <body class="bg-gray-50 text-gray-800 font-sans min-h-screen flex flex-col">
    
    <Header alternateUrl={alternateUrl} />
        
    <slot /> 
    
    <Footer />

    <FooterMap />

    <!-- Netlify Identity: Redirect till admin efter inloggning -->
    <script is:inline>
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on("init", user => {
          if (!user) {
            window.netlifyIdentity.on("login", () => {
              document.location.href = "/admin/";
            });
          }
        });
      }
    </script>
  </body>
</html>