---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getConditionInfo } from '../../data/conditions';

export async function getStaticPaths() {
  const questions = await getCollection('fraga-doktorn');
  return questions.map((question) => ({
    params: { slug: question.slug },
    props: { question },
  }));
}

const { question } = Astro.props;
const { Content } = await question.render();

// Hämta information om relaterad diagnos
const conditionInfo = question.data.relatedCondition 
  ? getConditionInfo(question.data.relatedCondition) 
  : null;

// Hämta relaterade frågor (samma kategori)
const allQuestions = await getCollection('fraga-doktorn', ({ data }) => data.published);
const relatedQuestions = allQuestions
  .filter(q => q.data.category === question.data.category && q.slug !== question.slug)
  .slice(0, 3);

// Formatera datum
function formatDate(date: Date) {
  return new Intl.DateTimeFormat('sv-SE', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  }).format(date);
}

// Kategori-namn (vi specialiserar oss på axel, knä och armbåge)
const categoryNames: Record<string, string> = {
  axel: 'Axel',
  kna: 'Knä',
  armbage: 'Armbåge',
};

// SEO-data
const pageTitle = `${question.data.title} - Fråga Doktorn | Södermalms Ortopedi`;
const pageDescription = question.data.description || `${question.data.title}. Dr. Carlos Rivero Siri svarar på patientfrågor om ${categoryNames[question.data.category].toLowerCase()}.`;

// Kategori-specifik OG-bild för sociala medier
const ogImages: Record<string, string> = {
  axel: '/images/og/fraga-doktorn-axel.svg',
  kna: '/images/og/fraga-doktorn-kna.svg',
  armbage: '/images/og/fraga-doktorn-armbage.svg',
};
const pageImage = ogImages[question.data.category] || '/images/og/fraga-doktorn-axel.svg';

// Schema.org FAQPage - optimerad för Google rich snippets
const schemaData = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [{
    "@type": "Question",
    "name": question.data.title,
    "text": question.data.question.substring(0, 500), // Frågan
    "dateCreated": question.data.date.toISOString(),
    "author": {
      "@type": "Person",
      "name": question.data.patientName || "Patient"
    },
    "acceptedAnswer": {
      "@type": "Answer",
      "text": pageDescription,
      "dateCreated": question.data.date.toISOString(),
      "author": {
        "@type": "Person",
        "name": question.data.author,
        "url": "https://sodermalmsortopedi.se/om-oss/vart-team/dr-carlos-rivero-siri",
        "jobTitle": "Specialist i Ortopedi",
        "worksFor": {
          "@type": "MedicalClinic",
          "name": "Södermalms Ortopedi",
          "url": "https://sodermalmsortopedi.se"
        }
      }
    }
  }]
};

// Schema.org MedicalWebPage
const medicalSchema = {
  "@context": "https://schema.org",
  "@type": "MedicalWebPage",
  "name": question.data.title,
  "description": pageDescription,
  "datePublished": question.data.date.toISOString(),
  "author": {
    "@type": "Person",
    "name": question.data.author
  },
  "reviewedBy": {
    "@type": "Person",
    "name": question.data.author,
    "jobTitle": "Specialist i Ortopedi"
  },
  "mainContentOfPage": {
    "@type": "WebPageElement",
    "cssSelector": "article"
  }
};
---

<BaseLayout 
  title={pageTitle}
  description={pageDescription}
  image={pageImage}
  type="article"
>
  
  <!-- Structured Data för SEO -->
  <script type="application/ld+json" slot="head" set:html={JSON.stringify(schemaData)} />
  <script type="application/ld+json" slot="head" set:html={JSON.stringify(medicalSchema)} />
  
  <!-- Article meta för Facebook -->
  <meta slot="head" property="article:author" content={question.data.author} />
  <meta slot="head" property="article:published_time" content={question.data.date.toISOString()} />
  <meta slot="head" property="article:section" content={`Frågor om ${categoryNames[question.data.category]}`} />
  {question.data.tags?.map((tag) => (
    <meta slot="head" property="article:tag" content={tag} />
  ))}

  <!-- Hero -->
  <section class="bg-gradient-to-br from-slate-900 via-slate-800 to-sky-900 text-white pt-8 pb-12">
    <div class="max-w-4xl mx-auto px-4 sm:px-6">
      <!-- Breadcrumbs -->
      <div class="flex flex-wrap items-center gap-2 text-sm mb-6">
        <a href="/" class="text-slate-400 hover:text-white">Hem</a>
        <span class="text-slate-500">/</span>
        <a href="/fraga-doktorn" class="text-slate-400 hover:text-white">Fråga Doktorn</a>
        <span class="text-slate-500">/</span>
        <span class="text-sky-400">{categoryNames[question.data.category]}</span>
      </div>
      
      <span class="inline-block py-1 px-3 rounded bg-sky-600/30 text-sky-300 text-xs font-bold mb-3 tracking-wider uppercase">
        {categoryNames[question.data.category]}
      </span>
      <h1 class="text-2xl md:text-3xl lg:text-4xl font-black mb-4 leading-tight tracking-tight">
        {question.data.title}
      </h1>
      
      <div class="flex flex-wrap items-center gap-4 text-sm text-slate-400">
        <span class="flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          {formatDate(question.data.date)}
        </span>
        <span class="flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
          {question.data.author}
        </span>
      </div>
    </div>
  </section>

  <!-- Innehåll -->
  <section class="bg-white py-10">
    <div class="max-w-4xl mx-auto px-4 sm:px-6">
      <div class="grid lg:grid-cols-3 gap-8">
        
        <!-- Huvudinnehåll -->
        <div class="lg:col-span-2 space-y-6">
          
          <!-- FRÅGA-BOX -->
          <div class="bg-slate-50 rounded-2xl border border-slate-200 overflow-hidden">
            <div class="bg-slate-700 px-5 py-3 flex items-center gap-3">
              <div class="w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center">
                <svg class="w-4 h-4 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
              </div>
              <div>
                <span class="text-white font-bold text-sm">
                  {question.data.patientName || 'Patient'}
                  {question.data.patientAge && <span class="text-slate-400 font-normal">, {question.data.patientAge} år</span>}
                </span>
                <span class="text-slate-400 text-xs block">frågar</span>
              </div>
            </div>
            <div class="p-5">
              <p class="text-slate-700 leading-relaxed whitespace-pre-line">{question.data.question}</p>
            </div>
          </div>

          <!-- SVAR-BOX -->
          <div class="bg-white rounded-2xl border-2 border-sky-200 overflow-hidden shadow-sm">
            <a href="/om-oss/vart-team/dr-carlos-rivero-siri" class="bg-sky-700 px-5 py-3 flex items-center gap-3 hover:bg-sky-600 transition-colors">
              <div class="w-8 h-8 rounded-full overflow-hidden border-2 border-sky-400">
                <img src="/images/carlos-rivero-siri.webp" alt={question.data.author} class="w-full h-full object-cover" />
              </div>
              <div>
                <span class="text-white font-bold text-sm">{question.data.author}</span>
                <span class="text-sky-200 text-xs block">svarar</span>
              </div>
            </a>
            <article class="p-5 prose prose-slate max-w-none
              prose-headings:font-bold prose-headings:text-slate-900
              prose-h2:text-lg prose-h2:mt-6 prose-h2:mb-3 prose-h2:text-sky-800
              prose-h3:text-base prose-h3:mt-4 prose-h3:mb-2
              prose-p:leading-relaxed prose-p:text-slate-700 prose-p:my-3
              prose-li:text-slate-700
              prose-strong:text-slate-900
              prose-a:text-sky-700 prose-a:no-underline hover:prose-a:underline
              prose-ul:my-3 prose-ol:my-3
            ">
              <Content />
            </article>
          </div>

          <!-- Informationsruta om relaterad diagnos -->
          {conditionInfo && (
            <a 
              href={conditionInfo.url}
              class="block bg-gradient-to-br from-slate-50 to-sky-50 rounded-2xl border border-sky-200 overflow-hidden hover:border-sky-400 hover:shadow-lg transition-all group"
            >
              <div class="flex flex-col sm:flex-row">
                {conditionInfo.image && (
                  <div class="sm:w-1/3 bg-white flex items-center justify-center p-4 border-b sm:border-b-0 sm:border-r border-sky-200">
                    <img 
                      src={conditionInfo.image} 
                      alt={conditionInfo.imageAlt || conditionInfo.title}
                      class="w-32 h-auto object-contain"
                    />
                  </div>
                )}
                <div class="flex-1 p-5">
                  <div class="flex items-center gap-2 mb-2">
                    <span class="text-xs font-bold uppercase tracking-wider text-sky-600">Fördjupning</span>
                  </div>
                  <h3 class="font-bold text-slate-800 text-lg mb-2 group-hover:text-sky-700 transition-colors">
                    {conditionInfo.title}
                  </h3>
                  <p class="text-slate-600 text-sm leading-relaxed mb-3">
                    {conditionInfo.shortDescription}
                  </p>
                  <span class="inline-flex items-center gap-2 text-sky-600 font-medium text-sm group-hover:text-sky-700">
                    Läs hela artikeln
                    <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                    </svg>
                  </span>
                </div>
              </div>
            </a>
          )}

        </div>

        <!-- Sidebar -->
        <aside class="lg:col-span-1 space-y-6">

          <!-- Tags -->
          {question.data.tags && question.data.tags.length > 0 && (
            <div class="bg-slate-50 rounded-xl p-5 border border-slate-200">
              <h3 class="font-bold text-slate-700 text-sm mb-3">Relaterade ämnen</h3>
              <div class="flex flex-wrap gap-2">
                {question.data.tags.map((tag) => (
                  <a 
                    href={`/fraga-doktorn/amne/${tag}`}
                    class="bg-white border border-slate-200 text-slate-600 px-3 py-1 rounded-full text-xs hover:bg-sky-50 hover:border-sky-300 hover:text-sky-700 transition-colors"
                  >
                    {tag}
                  </a>
                ))}
              </div>
            </div>
          )}

          <!-- CTA -->
          <div class="bg-gradient-to-br from-sky-600 to-sky-700 rounded-xl p-5 text-white">
            <h3 class="font-bold mb-2">Har du en egen fråga?</h3>
            <p class="text-sky-100 text-sm mb-4">Ställ din fråga till Dr. Carlos.</p>
            <a 
              href="/fraga-doktorn#stall-fraga"
              class="block text-center bg-white text-sky-700 font-bold py-2 px-4 rounded-lg text-sm hover:bg-sky-50 transition"
            >
              Ställ en fråga
            </a>
          </div>
        </aside>
      </div>
    </div>
  </section>

  <!-- Relaterade frågor -->
  {relatedQuestions.length > 0 && (
    <section class="bg-slate-50 py-10 border-t border-slate-200">
      <div class="max-w-4xl mx-auto px-4 sm:px-6">
        <h2 class="text-xl font-bold text-slate-900 mb-6">Fler frågor om {categoryNames[question.data.category].toLowerCase()}</h2>
        <div class="grid gap-3">
          {relatedQuestions.map((q) => (
            <a 
              href={`/fraga-doktorn/${q.slug}`}
              class="block bg-white hover:bg-sky-50 border border-slate-200 hover:border-sky-300 rounded-xl p-4 transition-colors"
            >
              <h3 class="font-bold text-slate-800 hover:text-sky-700">{q.data.title}</h3>
              {q.data.description && (
                <p class="text-sm text-slate-600 mt-1 line-clamp-2">{q.data.description}</p>
              )}
            </a>
          ))}
        </div>
        <div class="mt-6 text-center">
          <a 
            href="/fraga-doktorn"
            class="text-sky-700 hover:text-sky-900 font-medium text-sm"
          >
            ← Tillbaka till alla frågor
          </a>
        </div>
      </div>
    </section>
  )}

</BaseLayout>

