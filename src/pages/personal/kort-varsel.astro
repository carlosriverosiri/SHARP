---
/**
 * Dashboard f√∂r Kort varsel SMS
 * URL: /personal/kort-varsel
 */

export const prerender = false;

import BaseLayout from '../../layouts/BaseLayout.astro';
import { hamtaAnvandare, arInloggad } from '../../lib/auth';
import { supabaseAdmin, supabaseKonfigurerad } from '../../lib/supabase';

// Kontrollera inloggning
if (!await arInloggad(Astro.cookies)) {
  return Astro.redirect('/personal/');
}

const anvandare = await hamtaAnvandare(Astro.cookies);

// Om anv√§ndare √§r null trots inloggning, omdirigera
if (!anvandare) {
  return Astro.redirect('/personal/');
}

// H√§mta l√§kare
let lakare: any[] = [];
let lakareError: string | null = null;

if (supabaseKonfigurerad) {
  try {
    const { data, error } = await supabaseAdmin
      .from('lakare')
      .select('id, namn, kortnamn')
      .eq('aktiv', true)
      .order('namn');
    
    if (error) {
      lakareError = `L√§kare: ${error.message || 'Ok√§nt fel'}`;
    } else {
      lakare = data || [];
    }
  } catch (error: any) {
    lakareError = `L√§kare: ${error?.message || 'Exception'}`;
  }
} else {
  lakareError = 'Supabase √§r inte konfigurerat';
}

// H√§mta personal f√∂r notifieringslistan
let personal: any[] = [];
let personalError: string | null = null;

if (supabaseKonfigurerad) {
  try {
    const { data, error } = await supabaseAdmin
      .from('profiles')
      .select('id, email, mobilnummer, vill_ha_notifikationer')
      .order('email');
    
    if (error) {
      personalError = `Personal: ${error.message || 'Ok√§nt fel'}`;
    } else {
      personal = data || [];
    }
  } catch (error: any) {
    personalError = `Personal: ${error?.message || 'Exception'}`;
  }
}

// H√§mta kampanjer
let kampanjer: any[] = [];
let kampanjerError: string | null = null;

if (supabaseKonfigurerad) {
  try {
    const { data, error } = await supabaseAdmin
      .from('sms_kampanjer')
      .select('*')
      .order('skapad_vid', { ascending: false })
      .limit(20);
    
    if (error) {
      kampanjerError = `Kampanjer: ${error.message || 'Ok√§nt fel'}`;
    } else {
      kampanjer = data || [];
    }
  } catch (error: any) {
    kampanjerError = `Kampanjer: ${error?.message || 'Exception'}`;
  }
}

// URL-parameter f√∂r att visa specifik kampanj (?id=...)
const kampanjIdFromUrl = Astro.url.searchParams.get('id');

// H√§mta statistik
let statistik: any = null;
let statistikError: string | null = null;

if (supabaseKonfigurerad) {
  try {
    const { data, error } = await supabaseAdmin
      .from('kort_varsel_statistik')
      .select('*')
      .single();
    
    if (error) {
      statistikError = `Statistik: ${error.message || 'Ok√§nt fel'}`;
    } else {
      statistik = data;
    }
  } catch (error: any) {
    statistikError = `Statistik: ${error?.message || 'Exception'}`;
  }
}
---

<BaseLayout title="Kort varsel SMS | Personalportal" description="Hantera kort varsel SMS-utskick">
  <div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
      <div class="max-w-7xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            <a href="/personal/oversikt" class="text-gray-500 hover:text-gray-700">
              ‚Üê Tillbaka
            </a>
            <h1 class="text-2xl font-bold text-gray-900">üì± Kort varsel SMS</h1>
          </div>
          <div class="text-sm text-gray-500">
            Inloggad som {anvandare.email}
          </div>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8" data-kampanj-id={kampanjIdFromUrl || ''}>
      <!-- Debug: Visa om Supabase inte √§r konfigurerat -->
      {!supabaseKonfigurerad && (
        <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
          <h3 class="text-sm font-semibold text-red-800 mb-2">‚ùå Supabase inte konfigurerat</h3>
          <p class="text-xs text-red-700">
            Milj√∂variablerna <code>PUBLIC_SUPABASE_URL</code> eller <code>SUPABASE_SERVICE_ROLE_KEY</code> saknas.
            Kontrollera Netlify-inst√§llningar ‚Üí Environment variables.
          </p>
        </div>
      )}
      
      <!-- Debug: Visa felmeddelanden om n√•got gick fel -->
      {(lakareError || personalError || kampanjerError || statistikError) && (
        <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
          <h3 class="text-sm font-semibold text-yellow-800 mb-2">‚ö†Ô∏è Varningar vid databasanslutning:</h3>
          <ul class="text-xs text-yellow-700 space-y-1">
            {lakareError && <li>‚Ä¢ {lakareError}</li>}
            {personalError && <li>‚Ä¢ {personalError}</li>}
            {kampanjerError && <li>‚Ä¢ {kampanjerError}</li>}
            {statistikError && <li>‚Ä¢ {statistikError}</li>}
          </ul>
          <p class="text-xs text-yellow-600 mt-2">
            Sidan fungerar fortfarande, men vissa data kan saknas. Kontrollera Netlify-funktionsloggar f√∂r mer information.
          </p>
        </div>
      )}
      
      <!-- Flikar -->
      <div class="mb-6 border-b border-gray-200">
        <nav class="flex gap-4 md:gap-6 overflow-x-auto" role="tablist">
          <button 
            id="tab-pool"
            class="tab-button pb-3 px-1 text-sm font-medium border-b-2 border-sky-500 text-sky-600 whitespace-nowrap"
            data-tab="pool"
          >
            üë• Patientpool
          </button>
          <button 
            id="tab-kampanj"
            class="tab-button pb-3 px-1 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap"
            data-tab="kampanj"
          >
            üì§ Skapa SMS-utskick
          </button>
          <button 
            id="tab-aktiva"
            class="tab-button pb-3 px-1 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap"
            data-tab="aktiva"
          >
            <span class="inline-flex items-center gap-1">
              <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
              Aktiva
            </span>
          </button>
          <button 
            id="tab-historik"
            class="tab-button pb-3 px-1 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap"
            data-tab="historik"
          >
            üìã Historik
          </button>
        </nav>
      </div>

      <!-- ========== PATIENTPOOL-VY ========== -->
      <div id="panel-pool" class="tab-panel">
        <div class="max-w-5xl mx-auto space-y-6">
          
          <!-- L√§gg till patienter -->
          <div class="bg-white rounded-xl shadow-sm border p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">‚ûï L√§gg till patient i kortvarsel-poolen</h3>
            
            <!-- Rad 1: Planerat operationsdatum -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">Planerat operationsdatum *</label>
              <input 
                type="date" 
                id="patient-op-datum"
                class="w-full max-w-xs px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500"
              />
              <p class="text-xs text-gray-500 mt-1">Patientens nuvarande bokade operationsdatum (inte kort varsel-datum)</p>
            </div>
            
            <!-- Rad 2: L√§kare (checkboxar - v√§lj en eller flera) -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Vilka l√§kare kan operera patienten? *</label>
              <div class="flex flex-wrap gap-2" id="lakare-checkboxes">
                {lakare?.map(l => (
                  <label class="flex items-center gap-2 cursor-pointer px-3 py-2 border border-gray-200 rounded-lg hover:border-sky-300 has-[:checked]:border-sky-500 has-[:checked]:bg-sky-50 transition-colors">
                    <input type="checkbox" name="patient-lakare" value={l.namn} class="rounded w-4 h-4 text-sky-600" />
                    <span class="text-sm text-gray-700">{l.namn}</span>
                  </label>
                ))}
              </div>
              <p class="text-xs text-gray-500 mt-1">üí° T.ex. alla kn√§kirurger f√∂r en kn√§operation, eller alla armb√•gskirurger f√∂r en armb√•gsoperation</p>
            </div>
            
            <!-- Rad 2: Operationsstorlek -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Operationsstorlek *</label>
              <div class="flex flex-wrap gap-3">
                <label class="flex items-center gap-2 cursor-pointer px-4 py-2 border-2 border-gray-200 rounded-lg hover:border-sky-300 has-[:checked]:border-sky-500 has-[:checked]:bg-sky-50 transition-colors">
                  <input type="radio" name="patient-op-storlek" value="liten" class="w-4 h-4 text-sky-600" />
                  <div>
                    <span class="text-sm font-medium text-gray-900">üîπ Liten</span>
                    <span class="text-xs text-gray-500 block">5-15 min</span>
                  </div>
                </label>
                <label class="flex items-center gap-2 cursor-pointer px-4 py-2 border-2 border-gray-200 rounded-lg hover:border-sky-300 has-[:checked]:border-sky-500 has-[:checked]:bg-sky-50 transition-colors">
                  <input type="radio" name="patient-op-storlek" value="stor" class="w-4 h-4 text-sky-600" />
                  <div>
                    <span class="text-sm font-medium text-gray-900">üî∑ Stor</span>
                    <span class="text-xs text-gray-500 block">15-60 min</span>
                  </div>
                </label>
              </div>
              <p class="text-xs text-gray-500 mt-1">
                Operationens faktiska storlek (fast v√§rde)
              </p>
            </div>
            
            <!-- Rad 3: Sida (H√ñ/V√Ñ) -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Sida *</label>
              <div class="flex gap-3">
                <label class="flex items-center gap-2 cursor-pointer px-4 py-2 border-2 border-gray-200 rounded-lg hover:border-sky-300 has-[:checked]:border-sky-500 has-[:checked]:bg-sky-50 transition-colors">
                  <input type="radio" name="patient-sida" value="h√∂ger" class="w-4 h-4 text-sky-600" />
                  <span class="text-sm font-medium text-gray-900">H√ñ</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer px-4 py-2 border-2 border-gray-200 rounded-lg hover:border-sky-300 has-[:checked]:border-sky-500 has-[:checked]:bg-sky-50 transition-colors">
                  <input type="radio" name="patient-sida" value="v√§nster" class="w-4 h-4 text-sky-600" />
                  <span class="text-sm font-medium text-gray-900">V√Ñ</span>
                </label>
              </div>
              <p class="text-xs text-gray-500 mt-1">Vilken sida ska opereras?</p>
            </div>
            
            <!-- Rad 4: Prioritet -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Prioritet (valfritt)</label>
              <div class="flex flex-wrap gap-3">
                <label class="flex items-center gap-2 cursor-pointer px-3 py-2 bg-red-100 border-2 border-red-300 rounded-lg hover:bg-red-200 has-[:checked]:border-red-500 transition-colors">
                  <input type="checkbox" id="patient-akut" class="rounded w-4 h-4 text-red-600 focus:ring-red-500" />
                  <span class="text-sm text-red-700 font-bold">üö® AKUT <span class="font-normal">(1)</span></span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer px-3 py-2 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 has-[:checked]:border-blue-400 transition-colors">
                  <input type="checkbox" id="patient-sjukskriven" class="rounded w-4 h-4 text-blue-600 focus:ring-blue-500" />
                  <span class="text-sm text-blue-700 font-medium">üìã Sjukskriven <span class="font-normal">(2)</span></span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer px-3 py-2 bg-orange-50 border border-orange-200 rounded-lg hover:bg-orange-100 has-[:checked]:border-orange-400 transition-colors">
                  <input type="checkbox" id="patient-ont" class="rounded w-4 h-4 text-orange-600 focus:ring-orange-500" />
                  <span class="text-sm text-orange-700 font-medium">üî• Mycket ont <span class="font-normal">(3)</span></span>
                </label>
              </div>
              <p class="text-xs text-gray-500 mt-1">Prioritet 4 = normal (ingen markering)</p>
            </div>
            
            <!-- Rad 4: Patientdata -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">Patientdata *</label>
              <div class="flex gap-3">
                <textarea 
                  id="nya-patienter"
                  rows="3"
                  placeholder="Klistra in fr√•n journalsystemet:&#10;Namn Personnummer&#10;Mobilnummer: 07X-XXX XX XX"
                  class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 font-mono text-sm"
                ></textarea>
                <button 
                  id="btn-lagg-till"
                  class="px-6 py-2 bg-sky-600 text-white font-medium rounded-lg hover:bg-sky-700 transition-colors self-start"
                >
                  L√§gg till
                </button>
              </div>
            </div>
            
            <!-- Felmeddelande f√∂r dubbletter -->
            <div id="dubblett-varning" class="hidden mt-3 p-4 bg-red-50 border-2 border-red-300 rounded-lg">
              <div class="flex items-start gap-3">
                <span class="text-2xl">‚õî</span>
                <div class="flex-1">
                  <h4 class="font-bold text-red-800">DUBBLETT - REDAN I POOLEN</h4>
                  <div id="dubblett-lista" class="mt-2 space-y-1"></div>
                  <p class="text-red-600 text-sm mt-2">Ta bort patienten f√∂rst f√∂r att l√§gga till p√• nytt.</p>
                </div>
                <button id="stang-dubblett-varning" class="text-red-400 hover:text-red-600 text-xl font-bold" title="St√§ng">√ó</button>
              </div>
            </div>
            
            <!-- Succ√©meddelande -->
            <div id="tillagd-success" class="hidden mt-3 p-3 bg-green-50 border border-green-300 rounded-lg">
              <div class="flex items-center gap-2 text-green-700">
                <span class="text-xl">‚úÖ</span>
                <span id="tillagd-success-text" class="font-medium"></span>
              </div>
            </div>
          </div>
          
          <!-- Patienter i poolen (visar de som redan finns) -->
          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-gray-900">
                üìã Patienter i poolen
                <span id="stat-tillgangliga" class="text-sky-600 font-normal ml-2">-</span>
              </h3>
              <div class="flex items-center gap-3">
                <select 
                  id="filter-lakare"
                  class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500"
                >
                  <option value="">Alla l√§kare</option>
                  {lakare?.map(l => (
                    <option value={l.namn}>{l.namn}</option>
                  ))}
                </select>
                <button 
                  onclick="document.getElementById('tab-kampanj')?.click()"
                  class="px-4 py-2 bg-sky-600 text-white text-sm font-medium rounded-lg hover:bg-sky-700 transition-colors flex items-center gap-2"
                >
                  üì§ Skapa SMS-utskick
                </button>
              </div>
            </div>
            
            <!-- Tabell f√∂r patienter -->
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead>
                  <tr class="bg-gray-50 border-b text-xs font-medium text-gray-600">
                    <th class="px-2 py-2 text-center w-16">
                      <button id="sort-prioritet" class="hover:text-red-600 cursor-pointer" title="Sortera p√• prioritet">Prio ‚Üï</button>
                    </th>
                    <th class="px-2 py-2 text-left min-w-[180px]">
                      <button id="sort-namn" class="hover:text-sky-600 cursor-pointer">Namn ‚Üï</button>
                    </th>
                    <th class="px-2 py-2 text-center w-14">
                      <button id="sort-sida" class="hover:text-sky-600 cursor-pointer" title="H√∂ger/V√§nster">Sida ‚Üï</button>
                    </th>
                    <th class="px-2 py-2 text-center w-20">
                      <button id="sort-storlek" class="hover:text-sky-600 cursor-pointer" title="Liten/Stor op">Storlek ‚Üï</button>
                    </th>
                    <th class="px-2 py-2 text-center w-14">
                      <button id="sort-alder" class="hover:text-sky-600 cursor-pointer" title="Pension√§rer (67+) kommer l√§ttare">√Ölder ‚Üï</button>
                    </th>
                    <th class="px-2 py-2 text-left min-w-[140px]">
                      <button id="sort-lakare" class="hover:text-sky-600 cursor-pointer">L√§kare ‚Üï</button>
                    </th>
                    <th class="px-2 py-2 text-center w-16">
                      <button id="sort-dagar" class="hover:text-sky-600 cursor-pointer" title="Dagar kvar till planerad op">Kvar ‚Üï</button>
                    </th>
                    <th class="px-2 py-2 w-20 text-center">√Ötg√§rd</th>
                  </tr>
                </thead>
                <tbody id="lista-tillgangliga" class="divide-y divide-gray-100">
                  <tr><td colspan="8" class="text-gray-400 italic text-sm py-8 text-center">Laddar...</td></tr>
                </tbody>
              </table>
            </div>
            
            <p class="text-xs text-gray-400 mt-3 text-center">
              üí° Klicka p√• kolumnrubriker f√∂r att sortera. Hovra √∂ver en patient f√∂r att se redigera/ta bort.
            </p>
          </div>
          
          <!-- Dolt: statistik-element f√∂r JS-kompatibilitet -->
          <div class="hidden">
            <span id="stat-reserv">0</span>
            <span id="stat-nej">0</span>
            <span id="stat-bokade">0</span>
            <span id="stat-totalt">0</span>
            <div id="lista-reserv"></div>
            <div id="lista-nej"></div>
            <div id="lista-bokade"></div>
          </div>

        </div>
      </div>

      <!-- ========== SKAPA SMS-UTSKICK-VY ========== -->
      <div id="panel-kampanj" class="tab-panel hidden">
        <div class="max-w-3xl mx-auto">
          <div class="bg-white rounded-xl shadow-sm border p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center gap-2">
              <span class="text-2xl">üì§</span>
              Skapa nytt SMS-utskick
            </h2>

            <form id="kampanj-form" class="space-y-6">
              <!-- Datum och antal platser -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Ledig operationstid *
                  </label>
                  <input 
                    type="date" 
                    name="datum" 
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                  >
                  <p class="text-xs text-gray-500 mt-1">Datumet f√∂r den lediga tiden (kort varsel)</p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Antal lediga platser *
                  </label>
                  <div class="flex gap-2">
                    <label class="flex-1">
                      <input type="radio" name="antalPlatser" value="1" checked class="sr-only peer">
                      <div class="text-center py-2 px-4 border-2 border-gray-300 rounded-lg cursor-pointer peer-checked:border-sky-500 peer-checked:bg-sky-50 peer-checked:text-sky-700 font-medium transition-colors">
                        1
                      </div>
                    </label>
                    <label class="flex-1">
                      <input type="radio" name="antalPlatser" value="2" class="sr-only peer">
                      <div class="text-center py-2 px-4 border-2 border-gray-300 rounded-lg cursor-pointer peer-checked:border-sky-500 peer-checked:bg-sky-50 peer-checked:text-sky-700 font-medium transition-colors">
                        2
                      </div>
                    </label>
                    <label class="flex-1">
                      <input type="radio" name="antalPlatser" value="3" class="sr-only peer">
                      <div class="text-center py-2 px-4 border-2 border-gray-300 rounded-lg cursor-pointer peer-checked:border-sky-500 peer-checked:bg-sky-50 peer-checked:text-sky-700 font-medium transition-colors">
                        3
                      </div>
                    </label>
                  </div>
                  <p class="text-xs text-gray-500 mt-1">
                    Hur m√•nga patienter s√∂ker ni?
                  </p>
                </div>
              </div>

              <!-- L√§kare som har den lediga tiden -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  L√§kare med ledig tid *
                </label>
                <select 
                  name="lakare"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                >
                  <option value="">-- V√§lj l√§kare --</option>
                  {lakare?.map(l => (
                    <option value={l.namn}>{l.namn}</option>
                  ))}
                </select>
                <p class="text-xs text-gray-500 mt-1">
                  L√§karen som har luckan i sitt schema
                </p>
              </div>

              <!-- Sida (H√ñ/V√Ñ) och Operationsstorlek -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    √ñnskad sida *
                  </label>
                  <div class="flex gap-2">
                    <label class="flex-1">
                      <input type="radio" name="kampanjSida" value="h√∂ger" required class="sr-only peer">
                      <div class="text-center py-2 px-4 border-2 border-gray-300 rounded-lg cursor-pointer peer-checked:border-sky-500 peer-checked:bg-sky-50 peer-checked:text-sky-700 font-medium transition-colors">
                        H√ñ
                      </div>
                    </label>
                    <label class="flex-1">
                      <input type="radio" name="kampanjSida" value="v√§nster" class="sr-only peer">
                      <div class="text-center py-2 px-4 border-2 border-gray-300 rounded-lg cursor-pointer peer-checked:border-sky-500 peer-checked:bg-sky-50 peer-checked:text-sky-700 font-medium transition-colors">
                        V√Ñ
                      </div>
                    </label>
                  </div>
                  <p class="text-xs text-gray-500 mt-1">
                    Patienter med r√§tt sida prioriteras
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Operationsstorlek *
                  </label>
                  <div class="flex gap-2">
                    <label class="flex items-center gap-2 cursor-pointer px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-sky-300 has-[:checked]:border-sky-500 has-[:checked]:bg-sky-50 transition-colors">
                      <input type="checkbox" name="kampanjOpLiten" class="rounded w-4 h-4 text-sky-600" checked />
                      <span class="text-sm font-medium">üîπ Liten</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-sky-300 has-[:checked]:border-sky-500 has-[:checked]:bg-sky-50 transition-colors">
                      <input type="checkbox" name="kampanjOpStor" class="rounded w-4 h-4 text-sky-600" checked />
                      <span class="text-sm font-medium">üî∑ Stor</span>
                    </label>
                  </div>
                  <p class="text-xs text-gray-500 mt-1">
                    Vilken storlek har den lediga tiden?
                  </p>
                </div>
              </div>

              <!-- Tidsblock och operationstyp -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Tidsblock (valfritt)
                  </label>
                  <div class="flex gap-2">
                    <label class="flex-1">
                      <input type="radio" name="tidsblock" value="" checked class="sr-only peer">
                      <div class="text-center py-2 px-3 border border-gray-300 rounded-lg cursor-pointer peer-checked:border-sky-500 peer-checked:bg-sky-50 text-sm transition-colors">
                        Ingen info
                      </div>
                    </label>
                    <label class="flex-1">
                      <input type="radio" name="tidsblock" value="formiddag" class="sr-only peer">
                      <div class="text-center py-2 px-3 border border-gray-300 rounded-lg cursor-pointer peer-checked:border-sky-500 peer-checked:bg-sky-50 text-sm transition-colors">
                        F√∂rmiddag
                      </div>
                    </label>
                    <label class="flex-1">
                      <input type="radio" name="tidsblock" value="eftermiddag" class="sr-only peer">
                      <div class="text-center py-2 px-3 border border-gray-300 rounded-lg cursor-pointer peer-checked:border-sky-500 peer-checked:bg-sky-50 text-sm transition-colors">
                        Eftermiddag
                      </div>
                    </label>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Operationstyp (valfritt)
                  </label>
                  <input 
                    type="text" 
                    name="operationTyp" 
                    placeholder="T.ex. Kn√§artroskopi"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                  >
                  <p class="text-xs text-gray-500 mt-1">
                    Visas endast f√∂r patienter med samtycke
                  </p>
                </div>
              </div>

              <!-- Info: Mottagare h√§mtas fr√•n patientpoolen -->
              <div class="bg-sky-50 border border-sky-200 rounded-lg p-4">
                <div class="flex items-start gap-3">
                  <span class="text-xl">üìã</span>
                  <div>
                    <div class="font-medium text-sky-900">Mottagare h√§mtas automatiskt fr√•n patientpoolen</div>
                    <div class="text-sm text-sky-700 mt-1">
                      Patienter med matchande l√§kare, sida och operationsstorlek kontaktas i prioritetsordning.
                    </div>
                    <div id="matchande-patienter" class="text-sm text-sky-600 mt-2 font-medium"></div>
                  </div>
                </div>
              </div>

              <!-- Intervall mellan SMS -->
              <div class="bg-gray-50 rounded-lg p-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Tid mellan varje SMS-utskick
                </label>
                <div class="flex items-center gap-2">
                  <select 
                    id="intervall-select"
                    name="intervall" 
                    class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 bg-white"
                  >
                    <option value="5">5 minuter</option>
                    <option value="10">10 minuter</option>
                    <option value="15">15 minuter</option>
                    <option value="20">20 minuter</option>
                    <option value="30">30 minuter</option>
                    <option value="45">45 minuter</option>
                    <option value="60">60 minuter (1 timme)</option>
                  </select>
                  <span id="intervall-auto-badge" class="hidden px-2 py-0.5 text-xs font-medium bg-sky-100 text-sky-700 rounded-full">
                    Auto
                  </span>
                </div>
                
                <!-- Rekommendation/varning -->
                <div id="intervall-info" class="mt-3 hidden">
                  <div id="intervall-rekommendation" class="hidden p-3 bg-sky-50 border border-sky-200 rounded-lg">
                    <div class="flex items-start gap-2">
                      <span class="text-sky-600">üí°</span>
                      <div class="text-sm">
                        <span class="font-medium text-sky-800">Rekommenderat intervall:</span>
                        <span id="rekommenderat-intervall" class="text-sky-700"></span>
                        <p id="rekommendation-anledning" class="text-xs text-sky-600 mt-1"></p>
                      </div>
                    </div>
                  </div>
                  <div id="intervall-varning" class="hidden p-3 bg-amber-50 border border-amber-200 rounded-lg">
                    <div class="flex items-start gap-2">
                      <span class="text-amber-600">‚ö†Ô∏è</span>
                      <div class="text-sm">
                        <p id="varning-text" class="text-amber-800"></p>
                        <button 
                          type="button"
                          id="btn-anvand-rekommenderat"
                          class="mt-2 px-3 py-1 text-xs font-medium bg-amber-600 text-white rounded hover:bg-amber-700 transition-colors"
                        >
                          Anv√§nd rekommenderat intervall
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                
                <p class="text-xs text-gray-500 mt-2">
                  SMS skickas gradvis till en patient i taget. Stoppar automatiskt n√§r alla platser √§r fyllda.
                </p>
              </div>

              <!-- Tidsgr√§ns -->
              <div>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" name="harTidsGrans" class="rounded">
                  <span class="text-sm font-medium text-gray-700">
                    S√§tt sista svarstid
                  </span>
                </label>
                <div id="tidsgrans-section" class="mt-3 hidden">
                  <div class="grid grid-cols-2 gap-4">
                    <input 
                      type="date" 
                      name="tidsgransDatum"
                      class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500"
                    >
                    <input 
                      type="time" 
                      name="tidsgransTid"
                      value="18:00"
                      class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500"
                    >
                  </div>
                  <p class="text-xs text-gray-500 mt-1">
                    Efter denna tid kan patienter inte l√§ngre svara
                  </p>
                </div>
              </div>

              <!-- Notifiera personal -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Notifiera vid JA-svar
                </label>
                <div class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                  {personal?.filter(p => p.mobilnummer && p.vill_ha_notifikationer).map(p => (
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input 
                        type="checkbox" 
                        name="notifiera" 
                        value={p.id}
                        checked={p.id === anvandare?.id}
                        class="rounded"
                      >
                      <span class="text-sm text-gray-700">{p.email}</span>
                    </label>
                  ))}
                  {!personal?.some(p => p.mobilnummer && p.vill_ha_notifikationer) && (
                    <p class="text-sm text-gray-500 italic">
                      Ingen personal har registrerat mobilnummer. 
                      <a href="/personal/profil" class="text-sky-600 hover:underline">L√§gg till i din profil</a>
                    </p>
                  )}
                </div>
              </div>

              <!-- Submit -->
              <div class="flex items-center justify-between pt-4 border-t">
                <div id="mottagare-count" class="text-sm text-gray-500">
                  0 mottagare
                </div>
                <button 
                  type="submit"
                  class="px-6 py-3 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition-colors flex items-center gap-2"
                >
                  <span>üöÄ</span>
                  Skapa SMS-utskick
                </button>
              </div>
            </form>

            <!-- Resultat -->
            <div id="result" class="hidden mt-6 p-4 rounded-lg"></div>
          </div>
        </div>
      </div> <!-- St√§ng panel-kampanj -->

      <!-- ========== AKTIVA UTSKICK-VY ========== -->
      <div id="panel-aktiva" class="tab-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          
          <!-- V√§nster: Kampanjdetaljer (visas n√§r ?id= finns) -->
          <div class="lg:col-span-2">
            <div id="kampanj-detalj-wrap" class="hidden">
              <div class="bg-sky-50 rounded-xl shadow-sm border-2 border-sky-200 p-5">
                <div class="flex items-center justify-between mb-3">
                  <h2 id="kampanj-detalj-rubrik" class="text-lg font-semibold text-gray-900">üìã Vem svarade?</h2>
                  <span id="kampanj-detalj-datum" class="text-gray-500 text-sm"></span>
                </div>
                <div class="grid grid-cols-4 gap-2 mb-4">
                  <div class="bg-green-50 rounded-lg p-2 text-center">
                    <span id="kampanj-detalj-ja" class="text-xl font-bold text-green-700">0</span>
                    <div class="text-xs text-green-600">‚úÖ JA</div>
                  </div>
                  <div class="bg-yellow-50 rounded-lg p-2 text-center">
                    <span id="kampanj-detalj-reserv" class="text-xl font-bold text-yellow-700">0</span>
                    <div class="text-xs text-yellow-600">‚è∞ Reserv</div>
                  </div>
                  <div class="bg-red-50 rounded-lg p-2 text-center">
                    <span id="kampanj-detalj-nej" class="text-xl font-bold text-red-700">0</span>
                    <div class="text-xs text-red-600">‚ùå NEJ</div>
                  </div>
                  <div class="bg-gray-100 rounded-lg p-2 text-center">
                    <span id="kampanj-detalj-vantar" class="text-xl font-bold text-gray-700">0</span>
                    <div class="text-xs text-gray-600">‚è≥ V√§ntar</div>
                  </div>
                </div>
                <h3 class="font-medium text-gray-900 mb-2 text-sm">Mottagare</h3>
                <div id="kampanj-detalj-lista" class="space-y-1.5 max-h-64 overflow-y-auto"></div>
                
                <!-- Ut√∂ka utskick -->
                <div id="kampanj-utoka-section" class="mt-4 pt-4 border-t border-sky-200">
                  <button 
                    id="btn-utoka-kampanj"
                    class="w-full px-3 py-2 bg-sky-100 text-sky-700 text-sm font-medium rounded-lg hover:bg-sky-200 transition-colors flex items-center justify-center gap-2"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    L√§gg till fler patienter
                  </button>
                  <p class="text-xs text-gray-500 mt-1 text-center">
                    Ut√∂ka utskicket med fler mottagare
                  </p>
                </div>
                
                <!-- √Ötg√§rder f√∂r aktiv kampanj -->
                <div id="kampanj-detalj-actions" class="mt-4 pt-4 border-t border-sky-200">
                  <p class="text-sm font-medium text-gray-700 mb-2">Avsluta utskick:</p>
                  <div class="flex flex-wrap gap-2">
                    <button 
                      id="btn-fylld-manuellt"
                      class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition-colors"
                    >
                      ‚úÖ Avsluta utskick - Tiden fylld
                    </button>
                  </div>
                  <p class="text-xs text-gray-500 mt-2">
                    Avslutar utskicket och skickar SMS till de som f√•tt f√∂rfr√•gan men √§nnu inte svarat
                  </p>
                </div>
                
                <!-- √Ötg√§rder f√∂r fylld kampanj (ut√∂ka med fler platser) -->
                <div id="kampanj-detalj-utoka" class="mt-4 pt-4 border-t border-sky-200 hidden">
                  <p class="text-sm font-medium text-gray-700 mb-2">Ny avbokning? Ut√∂ka utskicket:</p>
                  
                  <!-- Alternativ f√∂r att rensa NEJ-svar -->
                  <label class="flex items-center gap-2 mb-2 cursor-pointer">
                    <input 
                      type="checkbox" 
                      id="checkbox-rensa-nej"
                      class="rounded border-gray-300 text-sky-500 focus:ring-sky-500"
                      checked
                    >
                    <span class="text-sm text-gray-700">Ta bort NEJ-svar (b√∂rja om med nya patienter)</span>
                  </label>
                  
                  <!-- Info-ruta om patientpoolen -->
                  <div class="mb-3 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                    <div class="flex items-start gap-2">
                      <span class="text-amber-500 text-lg leading-none">‚ÑπÔ∏è</span>
                      <div class="text-xs text-amber-800">
                        <p class="font-medium">Patienterna finns kvar i poolen</p>
                        <p class="mt-0.5 text-amber-700">NEJ betyder bara "inte just denna tid". De kan kontaktas f√∂r andra tider.</p>
                      </div>
                    </div>
                  </div>
                  
                  <div class="flex flex-wrap gap-2 items-center">
                    <button 
                      id="btn-utoka-en-plats"
                      class="px-4 py-2 bg-sky-600 text-white text-sm font-medium rounded-lg hover:bg-sky-700 transition-colors"
                    >
                      ‚ûï L√§gg till 1 plats
                    </button>
                    <button 
                      id="btn-utoka-tva-platser"
                      class="px-4 py-2 bg-sky-600 text-white text-sm font-medium rounded-lg hover:bg-sky-700 transition-colors"
                    >
                      ‚ûï L√§gg till 2 platser
                    </button>
                  </div>
                  <p class="text-xs text-gray-500 mt-2">
                    √Öter√∂ppnar utskicket och forts√§tter skicka SMS. JA-svar beh√•lls, NEJ-svar kan tas bort.
                  </p>
                  <div id="kampanj-platser-info" class="mt-2 text-sm text-sky-700 font-medium"></div>
                  <div id="kampanj-nej-info" class="text-sm text-orange-600"></div>
                </div>
              </div>
            </div>
            
            <!-- Tomt l√§ge n√§r ingen kampanj √§r vald -->
            <div id="kampanj-ingen-vald" class="bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 p-8 text-center">
              <div class="text-3xl mb-3">üëà</div>
              <h3 class="text-lg font-medium text-gray-900 mb-2">V√§lj en kampanj</h3>
              <p class="text-gray-500 text-sm">Klicka p√• en kampanj i listan till h√∂ger f√∂r att se detaljer</p>
            </div>
          </div>

          <!-- H√∂ger: Lista √∂ver aktiva och avslutade utskick -->
          <div class="lg:col-span-1 space-y-4">
            <!-- Aktiva utskick -->
            <div class="bg-white rounded-xl shadow-sm border p-4">
              <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <span class="w-2.5 h-2.5 bg-green-500 rounded-full animate-pulse"></span>
                Aktiva utskick
              </h3>
              
              <div class="space-y-2">
                {(() => {
                  // Filtrera aktiva/fyllda som INTE har passerat datum
                  const aktivaCount = kampanjer?.filter(k => {
                    if (k.status !== 'aktiv' && k.status !== 'fylld') return false;
                    if (!k.datum) return true;
                    const opDatum = new Date(k.datum);
                    const idag = new Date();
                    idag.setHours(0,0,0,0);
                    return opDatum >= idag;
                  }).length || 0;
                  
                  if (aktivaCount === 0) {
                    return (
                      <div class="text-center py-6">
                        <p class="text-gray-500 text-sm italic mb-3">Inga aktiva utskick</p>
                        <button 
                          onclick="document.getElementById('tab-kampanj')?.click()"
                          class="px-3 py-1.5 bg-sky-600 text-white text-sm font-medium rounded-lg hover:bg-sky-700 transition-colors"
                        >
                          üì§ Skapa SMS-utskick
                        </button>
                      </div>
                    );
                  }
                  return null;
                })()}
                {(() => {
                  // Filtrera aktiva/fyllda som INTE har passerat datum
                  const aktiva = kampanjer?.filter(k => {
                    if (k.status !== 'aktiv' && k.status !== 'fylld') return false;
                    if (!k.datum) return true;
                    const opDatum = new Date(k.datum);
                    const idag = new Date();
                    idag.setHours(0,0,0,0);
                    return opDatum >= idag;
                  }) || [];
                  
                  return aktiva.map(k => {
                    const antalPlatser = k.antal_platser || 1;
                    const antalFyllda = k.antal_fyllda || 0;
                    const visaProgress = antalPlatser > 1;
                    return (
                      <a 
                        href={`/personal/kort-varsel?id=${k.id}`}
                        class="block p-3 border border-gray-200 rounded-lg hover:border-sky-400 hover:bg-sky-50 transition-colors"
                      >
                        <div class="flex items-center justify-between mb-1">
                          <div class="flex items-center gap-2">
                            <span class={`px-2 py-0.5 text-xs font-medium rounded-full ${
                              k.status === 'fylld' 
                                ? 'bg-green-100 text-green-800' 
                                : 'bg-yellow-100 text-yellow-800'
                            }`}>
                              {k.status === 'fylld' ? 'üéâ Fylld' : '‚è≥ V√§ntar'}
                            </span>
                            {visaProgress && (
                              <span class="text-xs text-gray-500">
                                {antalFyllda}/{antalPlatser}
                              </span>
                            )}
                          </div>
                          <span class="text-gray-400 text-xs">
                            {k.skapad_vid ? new Date(k.skapad_vid).toLocaleDateString('sv-SE', { day: 'numeric', month: 'short' }) : '-'}
                          </span>
                        </div>
                        <div class="font-medium text-gray-900 text-sm">
                          {k.datum ? new Date(k.datum).toLocaleDateString('sv-SE', { weekday: 'short', day: 'numeric', month: 'short' }) : 'Inget datum'}
                        </div>
                        {k.lakare && (
                          <div class="text-xs text-gray-500 mt-1">{k.lakare}</div>
                        )}
                      </a>
                    );
                  });
                })()}
              </div>
            </div>

            <!-- Nyligen avslutade utskick (senaste 7 dagarna) -->
            <div class="bg-white rounded-xl shadow-sm border p-4">
              <h3 class="text-base font-semibold text-gray-900 mb-3 flex items-center gap-2">
                <span class="text-green-600">‚úì</span>
                Nyligen avslutade
                <span class="text-xs font-normal text-gray-500">(7 dagar)</span>
              </h3>
              
              <div class="space-y-2">
                {(() => {
                  const sjuDagarSen = new Date();
                  sjuDagarSen.setDate(sjuDagarSen.getDate() - 7);
                  const avslutade = kampanjer?.filter(k => 
                    k.status === 'avslutad' && 
                    k.avslutad_vid && 
                    new Date(k.avslutad_vid) >= sjuDagarSen
                  ) || [];
                  
                  if (avslutade.length === 0) {
                    return <p class="text-gray-400 text-sm italic text-center py-3">Inga avslutade utskick senaste veckan</p>;
                  }
                  
                  return avslutade.map(k => (
                    <a 
                      href={`/personal/kort-varsel?id=${k.id}`}
                      class="block p-3 border border-gray-200 rounded-lg hover:border-green-400 hover:bg-green-50 transition-colors"
                    >
                      <div class="flex items-center justify-between mb-1">
                        <span class={`px-2 py-0.5 text-xs font-medium rounded-full ${
                          k.utfall === 'fylld_via_sms' ? 'bg-green-100 text-green-800' :
                          k.utfall === 'fylld_manuellt' ? 'bg-blue-100 text-blue-800' :
                          k.utfall === 'misslyckad' ? 'bg-red-100 text-red-800' :
                          'bg-gray-100 text-gray-800'
                        }`}>
                          {k.utfall === 'fylld_via_sms' ? '‚úÖ Via SMS' :
                           k.utfall === 'fylld_manuellt' ? '‚úÖ Manuellt' :
                           k.utfall === 'misslyckad' ? '‚ùå Misslyckad' : '‚úì Avslutad'}
                        </span>
                        <span class="text-gray-400 text-xs">
                          {k.avslutad_vid ? new Date(k.avslutad_vid).toLocaleDateString('sv-SE', { day: 'numeric', month: 'short' }) : '-'}
                        </span>
                      </div>
                      <div class="font-medium text-gray-900 text-sm">
                        {k.datum ? new Date(k.datum).toLocaleDateString('sv-SE', { weekday: 'short', day: 'numeric', month: 'short' }) : 'Inget datum'}
                      </div>
                      {k.lakare && (
                        <div class="text-xs text-gray-500 mt-1">{k.lakare}</div>
                      )}
                    </a>
                  ));
                })()}
              </div>
              
              <div class="mt-3 pt-3 border-t">
                <button 
                  onclick="document.getElementById('tab-historik')?.click()"
                  class="w-full text-center text-sm text-sky-600 hover:text-sky-800 hover:underline"
                >
                  Visa alla i historik ‚Üí
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ========== HISTORIK-VY ========== -->
      <div id="panel-historik" class="tab-panel hidden">
        
        <!-- ========== √ñVERSIKT / DASHBOARD ========== -->
        <div class="mb-6">
          <!-- Periodv√§ljare f√∂r hela dashboard -->
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-gray-900">üìä Statistik</h2>
            <select 
              id="dashboard-period"
              class="text-sm border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500"
            >
              <option value="30" selected>30 dagar</option>
              <option value="90">90 dagar</option>
              <option value="all">All tid</option>
            </select>
          </div>
          
          <!-- Nyckeltalskort -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <!-- SMS-utskick -->
            <div class="bg-white rounded-xl shadow-sm border p-4">
              <div class="flex items-center justify-between">
                <p class="text-sm text-gray-600">SMS-utskick</p>
                <span id="nyckeltal-kampanjer-trend" class="text-xs font-medium hidden"></span>
              </div>
              <p id="nyckeltal-kampanjer" class="text-2xl font-bold text-gray-900 mt-1">-</p>
            </div>
            
            <!-- Fyllda tider -->
            <div class="bg-white rounded-xl shadow-sm border p-4">
              <p class="text-sm text-gray-600">Fyllda tider</p>
              <p class="mt-1">
                <span id="nyckeltal-fyllda-sms" class="text-2xl font-bold text-green-600">-</span>
                <span class="text-sm text-gray-500"> via SMS</span>
              </p>
              <p class="text-xs text-gray-500 mt-1">
                + <span id="nyckeltal-fyllda-manuellt">-</span> manuellt
              </p>
            </div>
            
            <!-- SMS skickade -->
            <div class="bg-white rounded-xl shadow-sm border p-4">
              <p class="text-sm text-gray-600">SMS skickade</p>
              <p id="nyckeltal-sms-skickade" class="text-2xl font-bold text-gray-900 mt-1">-</p>
              <p class="text-xs text-gray-500 mt-1">
                <span id="nyckeltal-sms-per-fylld">-</span> per fylld tid
              </p>
            </div>
            
            <!-- JA-rate -->
            <div class="bg-white rounded-xl shadow-sm border p-4">
              <div class="flex items-center justify-between">
                <p class="text-sm text-gray-600">JA-rate</p>
                <span id="nyckeltal-jarate-trend" class="text-xs font-medium hidden"></span>
              </div>
              <p id="nyckeltal-jarate" class="text-2xl font-bold text-sky-600 mt-1">-</p>
              <p class="text-xs text-gray-500 mt-1">
                Svarsfrekvens: <span id="nyckeltal-svarsrate">-</span>
              </p>
            </div>
          </div>
          
          <!-- Svarsf√∂rdelning per kategori -->
          <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
              üìà Svarsf√∂rdelning per kategori
            </h3>
            <div class="h-64">
              <canvas id="svarsfordelning-chart"></canvas>
            </div>
          </div>
          
          <!-- Statistik per dimension -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Per operationsstorlek -->
            <div class="bg-white rounded-xl shadow-sm border p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">
                üìê Per operationsstorlek
              </h3>
              <div id="dimension-opstorlek" class="space-y-3">
                <p class="text-gray-500 text-sm italic">Laddar...</p>
              </div>
            </div>
            
            <!-- Per sida -->
            <div class="bg-white rounded-xl shadow-sm border p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">
                ‚ÜîÔ∏è Per sida (H√ñ/V√Ñ)
              </h3>
              <div id="dimension-sida" class="space-y-3">
                <p class="text-gray-500 text-sm italic">Laddar...</p>
              </div>
            </div>
          </div>
          
          <!-- Trendanalys -->
          <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
              üìà Trendanalys √∂ver tid
            </h3>
            <div id="trend-laddar" class="text-center py-8 text-gray-500">
              <div class="animate-spin inline-block w-6 h-6 border-2 border-sky-500 border-t-transparent rounded-full"></div>
              <p class="mt-2">Laddar trenddata...</p>
            </div>
            <div id="trend-innehall" class="hidden">
              <div class="h-72">
                <canvas id="trend-chart"></canvas>
              </div>
              <div class="mt-4 flex flex-wrap gap-4 text-sm text-gray-600">
                <span class="flex items-center gap-1">
                  <span class="w-3 h-3 bg-green-500 rounded-full"></span> JA-rate (%)
                </span>
                <span class="flex items-center gap-1">
                  <span class="w-3 h-3 bg-sky-500 rounded-full"></span> Svarstid (min)
                </span>
                <span class="flex items-center gap-1">
                  <span class="w-3 h-3 bg-purple-500 rounded-full"></span> SMS/vecka
                </span>
              </div>
            </div>
            <div id="trend-ingen-data" class="hidden text-center py-8 text-gray-500">
              <p>Ingen trenddata √§nnu.</p>
              <p class="text-sm mt-1">Trends visas efter n√•gra veckors anv√§ndning.</p>
            </div>
          </div>
        </div>
        
        <!-- ========== SVARSTIDSSTATISTIK ========== -->
        <div class="mb-6">
          <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-gray-900">
                ‚è±Ô∏è Svarstid per kategori
              </h3>
              <select 
                id="svarstid-period"
                class="text-sm border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500"
              >
                <option value="30">30 dagar</option>
                <option value="90" selected>90 dagar</option>
                <option value="all">All tid</option>
              </select>
            </div>
            
            <div id="svarstid-laddar" class="text-center py-8 text-gray-500">
              <div class="animate-spin inline-block w-6 h-6 border-2 border-sky-500 border-t-transparent rounded-full"></div>
              <p class="mt-2">Laddar statistik...</p>
            </div>
            
            <div id="svarstid-innehall" class="hidden">
              <!-- Totalt-kort -->
              <div class="bg-gradient-to-r from-sky-50 to-sky-100 rounded-lg p-4 mb-6">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm text-sky-700">Totalt antal svar</p>
                    <p id="svarstid-totalt-antal" class="text-2xl font-bold text-sky-900">-</p>
                  </div>
                  <div>
                    <p class="text-sm text-sky-700">Medel svarstid</p>
                    <p id="svarstid-totalt-medel" class="text-2xl font-bold text-sky-900">- min</p>
                  </div>
                </div>
              </div>
              
              <!-- Chart.js Stapeldiagram f√∂r svarstid per kategori -->
              <div class="mb-6">
                <h4 class="text-sm font-medium text-gray-700 mb-3">Medel svarstid per kategori (minuter)</h4>
                <div class="h-64">
                  <canvas id="svarstid-kategori-chart"></canvas>
                </div>
              </div>
              
              <!-- Tabell (kompakt) -->
              <div class="overflow-x-auto mb-6">
                <table class="w-full text-sm">
                  <thead>
                    <tr class="border-b text-left text-gray-600">
                      <th class="pb-2 font-medium">Kategori</th>
                      <th class="pb-2 font-medium text-right">Antal</th>
                      <th class="pb-2 font-medium text-right">Medel</th>
                      <th class="pb-2 font-medium text-right">Median</th>
                      <th class="pb-2 font-medium text-right">JA-rate</th>
                    </tr>
                  </thead>
                  <tbody id="svarstid-tabell">
                    <!-- Fylls i via JavaScript -->
                  </tbody>
                </table>
              </div>
              
              <!-- Chart.js diagram f√∂r tid p√• dagen -->
              <div class="pt-6 border-t">
                <h4 class="text-sm font-medium text-gray-700 mb-3">Svarstid per tid p√• dagen (minuter)</h4>
                <div class="h-48">
                  <canvas id="svarstid-tid-chart"></canvas>
                </div>
              </div>
            </div>
            
            <div id="svarstid-ingen-data" class="hidden text-center py-8 text-gray-500">
              <p>Ingen svarstidsdata √§nnu.</p>
              <p class="text-sm mt-1">Statistik visas n√§r patienter b√∂rjar svara p√• SMS.</p>
            </div>
          </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
          
          <!-- V√§nster: Statistik -->
          <div class="lg:col-span-1 space-y-6">
            <!-- Statistik -->
            <div class="bg-white rounded-xl shadow-sm border p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">
                üìä Kampanjstatistik (30 d)
              </h3>
              
              <div class="space-y-4">
                <div class="flex justify-between items-center">
                  <span class="text-gray-600">SMS-utskick</span>
                  <span class="font-semibold">{statistik?.kampanjer_30_dagar || 0}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-600">Fyllda via SMS</span>
                  <span class="font-semibold text-green-600">{statistik?.fyllda_via_sms || 0}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-600">SMS skickade</span>
                  <span class="font-semibold">{statistik?.totalt_sms_skickade || 0}</span>
                </div>
                {statistik?.fyllda_via_sms > 0 && statistik?.totalt_sms_skickade > 0 && (
                  <div class="pt-3 border-t">
                    <div class="flex justify-between items-center">
                      <span class="text-gray-600">SMS per fylld tid</span>
                      <span class="font-semibold text-sky-600">
                        {(statistik.totalt_sms_skickade / statistik.fyllda_via_sms).toFixed(1)}
                      </span>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>

          <!-- H√∂ger: Kampanjlista -->
          <div class="lg:col-span-3">
            <div class="bg-white rounded-xl shadow-sm border p-6">
              <h2 class="text-xl font-semibold text-gray-900 mb-6">üìã Alla kampanjer</h2>
              
              <div class="space-y-4">
                {kampanjer?.map(k => (
                  <div class="border border-gray-200 rounded-lg p-4 hover:border-sky-300 transition-colors">
                    <div class="flex items-center justify-between">
                      <div>
                        <div class="font-medium text-gray-900">
                          {k.datum ? new Date(k.datum).toLocaleDateString('sv-SE', { weekday: 'long', day: 'numeric', month: 'long' }) : 'Inget datum'}
                          {k.tidsblock && ` (${k.tidsblock === 'formiddag' ? 'f√∂rmiddag' : 'eftermiddag'})`}
                        </div>
                        <div class="text-sm text-gray-500">
                          Skapad {k.skapad_vid ? new Date(k.skapad_vid).toLocaleDateString('sv-SE') : '-'}
                          {k.operation_typ && ` ‚Ä¢ ${k.operation_typ}`}
                          {k.lakare && ` ‚Ä¢ ${k.lakare}`}
                        </div>
                      </div>
                      <div class="flex items-center gap-3">
                        <span class={`px-3 py-1 text-sm font-medium rounded-full ${
                          k.utfall === 'fylld_via_sms' ? 'bg-green-100 text-green-700' :
                          k.utfall === 'fylld_manuellt' ? 'bg-blue-100 text-blue-700' :
                          k.utfall === 'misslyckad' ? 'bg-red-100 text-red-700' :
                          k.status === 'aktiv' ? 'bg-yellow-100 text-yellow-700' :
                          k.status === 'fylld' ? 'bg-green-100 text-green-700' :
                          'bg-gray-100 text-gray-600'
                        }`}>
                          {k.utfall === 'fylld_via_sms' ? '‚úÖ Fylld via SMS' :
                           k.utfall === 'fylld_manuellt' ? '‚úÖ Fylld manuellt' :
                           k.utfall === 'misslyckad' ? '‚ùå Misslyckad' :
                           k.status === 'aktiv' ? '‚è≥ Aktiv' :
                           k.status === 'fylld' ? '‚úÖ Fylld' : 'Avslutad'}
                        </span>
                        <a 
                          href={`/personal/kort-varsel?id=${k.id}`}
                          class="text-sky-600 hover:underline text-sm"
                        >
                          Visa ‚Üí
                        </a>
                      </div>
                    </div>
                  </div>
                ))}
                
                {!kampanjer?.length && (
                  <p class="text-gray-500 italic text-center py-8">Inga kampanjer √§nnu</p>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>

    </main>

    <!-- Modal f√∂r att redigera patient -->
    <div id="redigera-patient-modal" class="fixed inset-0 z-50 hidden">
      <!-- Bakgrund -->
      <div class="absolute inset-0 bg-black/50" onclick="stangRedigeraModal()"></div>
      
      <!-- Modal-inneh√•ll -->
      <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-lg bg-white rounded-xl shadow-xl overflow-hidden flex flex-col max-h-[90vh]">
        <div class="px-6 py-4 border-b bg-gray-50 flex items-center justify-between">
          <h3 class="text-lg font-semibold text-gray-900">Redigera patient</h3>
          <button onclick="stangRedigeraModal()" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
        </div>
        
        <div class="p-6 overflow-y-auto flex-1 space-y-4">
          <input type="hidden" id="redigera-patient-id">
          
          <!-- Namn -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Namn</label>
            <input 
              type="text" 
              id="redigera-namn" 
              class="w-full rounded-lg border-gray-300 focus:ring-sky-500 focus:border-sky-500"
            >
          </div>
          
          <!-- Prioritet -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Prioritet</label>
            <div class="flex flex-wrap gap-3">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="redigera-akut" class="rounded border-gray-300 text-red-500 focus:ring-red-500">
                <span class="text-sm">üö® AKUT</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="redigera-sjukskriven" class="rounded border-gray-300 text-blue-500 focus:ring-blue-500">
                <span class="text-sm">üìã Sjukskriven</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="redigera-ont" class="rounded border-gray-300 text-orange-500 focus:ring-orange-500">
                <span class="text-sm">üî• Mycket ont</span>
              </label>
            </div>
          </div>
          
          <!-- Sida -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Sida</label>
            <div class="flex gap-4">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="redigera-sida" value="h√∂ger" class="border-gray-300 text-sky-500 focus:ring-sky-500">
                <span class="text-sm">H√∂ger (H√ñ)</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="redigera-sida" value="v√§nster" class="border-gray-300 text-sky-500 focus:ring-sky-500">
                <span class="text-sm">V√§nster (V√Ñ)</span>
              </label>
            </div>
          </div>
          
          <!-- Operationsstorlek -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Operationsstorlek</label>
            <div class="flex gap-4">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="redigera-storlek" value="liten" class="border-gray-300 text-sky-500 focus:ring-sky-500">
                <span class="text-sm">üîπ Liten (5-15 min)</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="redigera-storlek" value="stor" class="border-gray-300 text-sky-500 focus:ring-sky-500">
                <span class="text-sm">üî∑ Stor (15-60 min)</span>
              </label>
            </div>
          </div>
          
          <!-- √Ölder -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">√Ölder</label>
            <input 
              type="number" 
              id="redigera-alder" 
              min="0" 
              max="120"
              class="w-24 rounded-lg border-gray-300 focus:ring-sky-500 focus:border-sky-500"
            >
            <span class="text-sm text-gray-500 ml-2">√•r</span>
          </div>
          
          <!-- L√§kare -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">L√§kare</label>
            <div id="redigera-lakare-checkboxes" class="flex flex-wrap gap-3">
              <!-- Fylls i dynamiskt -->
            </div>
          </div>
          
          <!-- Planerat operationsdatum -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Planerat operationsdatum</label>
            <input 
              type="date" 
              id="redigera-utgar-vid"
              class="w-full rounded-lg border-gray-300 focus:ring-sky-500 focus:border-sky-500"
            >
          </div>
        </div>
        
        <div class="px-6 py-4 border-t bg-gray-50 flex items-center justify-between">
          <button 
            onclick="taBortPatientFranModal()"
            class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg text-sm font-medium"
          >
            üóëÔ∏è Ta bort patient
          </button>
          <div class="flex gap-2">
            <button 
              onclick="stangRedigeraModal()"
              class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm font-medium"
            >
              Avbryt
            </button>
            <button 
              onclick="sparaPatientandringar()"
              class="px-4 py-2 bg-sky-600 text-white hover:bg-sky-700 rounded-lg text-sm font-medium"
            >
              Spara √§ndringar
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Bekr√§ftelsedialog (centrerad) -->
    <div id="bekrafta-modal" class="fixed inset-0 z-50 hidden">
      <!-- Bakgrund -->
      <div class="absolute inset-0 bg-black/50" onclick="stangBekraftaModal()"></div>
      
      <!-- Modal-inneh√•ll (centrerad) -->
      <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-sm bg-white rounded-xl shadow-xl overflow-hidden">
        <div class="p-6 text-center">
          <div class="text-4xl mb-4" id="bekrafta-ikon">‚ö†Ô∏è</div>
          <h3 class="text-lg font-semibold text-gray-900 mb-2" id="bekrafta-titel">Bekr√§fta</h3>
          <p class="text-gray-600 text-sm" id="bekrafta-text">√Ñr du s√§ker?</p>
        </div>
        <div class="px-6 py-4 bg-gray-50 flex gap-3 justify-center">
          <button 
            onclick="stangBekraftaModal()"
            class="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg text-sm font-medium"
          >
            Avbryt
          </button>
          <button 
            id="bekrafta-ja-btn"
            class="px-4 py-2 bg-red-600 text-white hover:bg-red-700 rounded-lg text-sm font-medium"
          >
            Ta bort
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== FLIKHANTERING ==========
    const tabs = document.querySelectorAll('.tab-button');
    const panels = document.querySelectorAll('.tab-panel');

    function visaPanel(panelKey: string) {
      const targetPanel = panelKey;
      tabs.forEach(t => {
        const key = t.getAttribute('data-tab');
        const isActive = key === targetPanel;
        t.classList.toggle('border-sky-500', isActive);
        t.classList.toggle('text-sky-600', isActive);
        t.classList.toggle('border-transparent', !isActive);
        t.classList.toggle('text-gray-500', !isActive);
      });
      panels.forEach(p => p.classList.add('hidden'));
      document.getElementById(`panel-${targetPanel}`)?.classList.remove('hidden');
    }

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const targetPanel = tab.getAttribute('data-tab');
        if (targetPanel) visaPanel(targetPanel);
      });
    });

    // ========== KAMPANJDETALJ (?id=) ==========
    async function laddaKampanjDetalj(kampanjId: string) {
      console.log('üì¶ laddaKampanjDetalj anropad med ID:', kampanjId);
      
      // Spara f√∂r avsluta-knappar (variabel definieras l√§ngre ner)
      (window as any).aktivKampanjId = kampanjId;
      
      const wrap = document.getElementById('kampanj-detalj-wrap');
      const ingenVald = document.getElementById('kampanj-ingen-vald');
      const actionsEl = document.getElementById('kampanj-detalj-actions');
      const utokaEl = document.getElementById('kampanj-utoka-section');
      const utokaPlatserEl = document.getElementById('kampanj-detalj-utoka');
      const platserInfoEl = document.getElementById('kampanj-platser-info');
      const rubrik = document.getElementById('kampanj-detalj-rubrik');
      const datumEl = document.getElementById('kampanj-detalj-datum');
      const jaEl = document.getElementById('kampanj-detalj-ja');
      const reservEl = document.getElementById('kampanj-detalj-reserv');
      const nejEl = document.getElementById('kampanj-detalj-nej');
      const vantarEl = document.getElementById('kampanj-detalj-vantar');
      const listaEl = document.getElementById('kampanj-detalj-lista');
      
      console.log('üì¶ Element hittade:', { wrap: !!wrap, rubrik: !!rubrik, datumEl: !!datumEl, listaEl: !!listaEl });
      
      if (!wrap || !rubrik || !datumEl || !jaEl || !reservEl || !nejEl || !vantarEl || !listaEl) {
        console.error('‚ùå Kunde inte hitta alla element f√∂r kampanjdetalj');
        return;
      }

      // Visa detalj-wrap och d√∂lj "ingen vald"-meddelandet
      console.log('üëÅÔ∏è Visar kampanjdetalj-wrap och s√§tter Laddar...');
      wrap.classList.remove('hidden');
      ingenVald?.classList.add('hidden');
      rubrik.textContent = 'üìã Vem svarade?';
      datumEl.textContent = 'Laddar...';
      listaEl.innerHTML = '<p class="text-gray-400 italic text-sm">Laddar mottagare...</p>';

      try {
        console.log('üåê Fetchar kampanjstatus fr√•n API...');
        const response = await fetch(`/api/kampanj/status?id=${encodeURIComponent(kampanjId)}`, { credentials: 'include' });
        console.log('üì• API svarade med status:', response.status);
        
        const data = await response.json();
        console.log('üìä API-data:', data);
        
        if (!response.ok || data.error) {
          console.error('‚ùå API-fel:', data.error, 'Details:', data.details);
          rubrik.textContent = 'Kunde inte ladda kampanj';
          datumEl.textContent = `${data.error || 'Ok√§nt fel'}${data.details ? ' ‚Äì ' + data.details : ''}`;
          listaEl.innerHTML = `<p class="text-red-600 text-sm">API-fel: ${data.error}</p><p class="text-gray-500 text-xs mt-2">Kampanj-ID: ${kampanjId}</p>`;
          return;
        }

        const k = data.kampanj;
        const mottagare = data.mottagare || [];
        const stats = data.statistik || {};
        
        console.log('‚úÖ Renderar kampanjdetaljer:', { antalMottagare: mottagare.length, stats });

        // Kortare rubrik f√∂r smalare layout
        const datumStr = k.datum ? new Date(k.datum).toLocaleDateString('sv-SE', { day: 'numeric', month: 'short' }) : '';
        rubrik.textContent = `üìã ${datumStr}${k.operationTyp ? ' ‚Äì ' + k.operationTyp : ''}`;
        
        // Status med platsinformation
        const platserText = (k.antalPlatser || 1) > 1 ? ` (${k.antalFyllda || 0}/${k.antalPlatser})` : '';
        if (k.status === 'fylld') {
          datumEl.textContent = `‚úÖ Fylld${platserText}`;
        } else if (k.status === 'aktiv') {
          datumEl.textContent = `‚è≥ V√§ntar${platserText}`;
        } else {
          datumEl.textContent = 'Avslutad';
        }

        // Visa/d√∂lj knappar beroende p√• status
        const antalPlatser = k.antalPlatser || 1;
        const antalFyllda = k.antalFyllda || 0;
        
        if (actionsEl) {
          // Avsluta-knappar: visa f√∂r aktiva utskick
          if (k.status === 'aktiv') {
            actionsEl.classList.remove('hidden');
          } else {
            actionsEl.classList.add('hidden');
          }
        }
        if (utokaEl) {
          // Ut√∂ka med fler patienter (den gamla knappen)
          if (k.status === 'aktiv') {
            utokaEl.classList.remove('hidden');
          } else {
            utokaEl.classList.add('hidden');
          }
        }
        if (utokaPlatserEl) {
          // Ut√∂ka med fler platser: visa f√∂r fyllda utskick
          if (k.status === 'fylld') {
            utokaPlatserEl.classList.remove('hidden');
            if (platserInfoEl) {
              platserInfoEl.textContent = `Nuvarande: ${antalFyllda}/${antalPlatser} platser fyllda`;
            }
            // Visa antal NEJ-svar
            const nejInfoEl = document.getElementById('kampanj-nej-info');
            if (nejInfoEl) {
              const antalNej = stats.nejSvar ?? 0;
              if (antalNej > 0) {
                nejInfoEl.textContent = `${antalNej} patient${antalNej > 1 ? 'er' : ''} har svarat NEJ`;
              } else {
                nejInfoEl.textContent = '';
              }
            }
          } else {
            utokaPlatserEl.classList.add('hidden');
          }
        }

        jaEl.textContent = String(stats.jaSvar ?? 0);
        reservEl.textContent = String(stats.reservSvar ?? 0);
        nejEl.textContent = String(stats.nejSvar ?? 0);
        vantarEl.textContent = String(stats.vantar ?? 0);

        // Sortera: Avregistrerade (beh√∂ver √•tg√§rd) f√∂rst, sen ja, reserv, nej, v√§ntar
        const sortOrder: Record<string, number> = { 'avregistrerad': 0, 'ja': 1, 'reserv': 2, 'nej': 3 };
        const sorterade = [...mottagare].sort((a: any, b: any) => {
          const aOrder = sortOrder[a.svar] ?? 4;
          const bOrder = sortOrder[b.svar] ?? 4;
          return aOrder - bOrder;
        });

        listaEl.innerHTML = sorterade.map((m: any) => {
          let badge = '';
          let extraClass = '';
          let actionTag = '';
          
          if (m.svar === 'ja') {
            badge = '‚úÖ';
          } else if (m.svar === 'reserv') {
            badge = '‚è∞';
          } else if (m.svar === 'nej') {
            badge = '‚ùå';
          } else if (m.svar === 'avregistrerad') {
            badge = 'üö´';
            extraClass = 'bg-amber-50 border-amber-200';
            actionTag = '<span class="text-xs bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded font-medium">‚Üí √Ñndra i kalender</span>';
          } else {
            badge = '‚è≥';
          }
          const namn = (m.namn || '').toString();
          return `<div class="flex items-center gap-2 p-2 rounded border text-sm ${extraClass || 'bg-white border-gray-100'}">
            <span class="flex-shrink-0">${badge}</span>
            <div class="flex-1 min-w-0">
              <span class="text-gray-900">${escapeHtml(namn)}</span>
              ${actionTag ? `<div class="mt-1">${actionTag}</div>` : ''}
            </div>
            <button 
              type="button"
              class="copy-namn-btn flex-shrink-0 p-1 text-gray-400 hover:text-sky-600 hover:bg-sky-50 rounded transition-colors cursor-pointer"
              data-namn="${escapeHtml(namn)}"
              title="Kopiera namn"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
            </button>
          </div>`;
        }).join('') || '<p class="text-gray-400 italic text-sm">Inga mottagare</p>';
        
        // L√§gg till klick-hanterare f√∂r kopiera namn
        listaEl.querySelectorAll('.copy-namn-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const button = e.currentTarget as HTMLButtonElement;
            const namn = button.getAttribute('data-namn') || '';
            
            try {
              await navigator.clipboard.writeText(namn);
              
              // Visuell feedback - byt till bock-ikon
              const originalHTML = button.innerHTML;
              button.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>`;
              button.classList.add('text-green-600', 'bg-green-50');
              button.classList.remove('text-gray-400');
              
              setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('text-green-600', 'bg-green-50');
                button.classList.add('text-gray-400');
              }, 1500);
            } catch (err) {
              console.error('Kunde inte kopiera:', err);
            }
          });
        });

      } catch (e) {
        rubrik.textContent = 'Kunde inte ladda kampanj';
        datumEl.textContent = 'N√§tverksfel';
        listaEl.innerHTML = '';
      }
    }

    function escapeHtml(s: string) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    // ========== AVSLUTA UTSKICK ==========
    async function avslutaKampanj(utfall: 'fylld_manuellt') {
      const kampanjId = (window as any).aktivKampanjId;
      if (!kampanjId) {
        alert('Ingen kampanj vald');
        return;
      }
      
      const bekrafta = confirm('Avsluta utskicket och markera tiden som fylld?\n\nSMS skickas till de som f√•tt f√∂rfr√•gan men √§nnu inte svarat, och meddelar att tiden nu √§r bokad.');
      
      if (!bekrafta) return;
      
      try {
        const response = await fetch('/api/kampanj/avsluta', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            kampanjId: kampanjId,
            utfall: utfall,
            skickaAvslutSms: true, // Skicka SMS till de som v√§ntar
          }),
        });
        
        const data = await response.json();
        
        if (data.success) {
          const smsInfo = data.antalNotifierade > 0 
            ? `\n\n${data.antalNotifierade} SMS skickades till patienter som √§nnu inte svarat.` 
            : '';
          alert(`‚úÖ Kampanjen avslutades - tiden markerad som fylld!${smsInfo}`);
          window.location.href = '/personal/kort-varsel';
        } else {
          alert('N√•got gick fel: ' + (data.error || 'Ok√§nt fel'));
        }
      } catch (err) {
        console.error('Fel vid avslutning:', err);
        alert('N√§tverksfel ‚Äì kunde inte avsluta utskicket');
      }
    }
    
    // Event listener f√∂r avsluta-knapp
    document.getElementById('btn-fylld-manuellt')?.addEventListener('click', () => {
      avslutaKampanj('fylld_manuellt');
    });

    // ========== UT√ñKA UTSKICK MED FLER PLATSER ==========
    async function utokaMedPlatser(antalNyaPlatser: number) {
      const kampanjId = (window as any).aktivKampanjId;
      if (!kampanjId) {
        alert('Ingen kampanj vald');
        return;
      }
      
      const rensaNejSvar = (document.getElementById('checkbox-rensa-nej') as HTMLInputElement)?.checked ?? true;
      
      let bekraftaText = `L√§gga till ${antalNyaPlatser} plats${antalNyaPlatser > 1 ? 'er' : ''} till utskicket?`;
      if (rensaNejSvar) {
        bekraftaText += '\n\n‚úì NEJ-svar tas bort (nya patienter kontaktas)';
        bekraftaText += '\n‚úì JA-svar beh√•lls';
      } else {
        bekraftaText += '\n\nKampanjen forts√§tter med kvarvarande patienter.';
      }
      
      const bekrafta = confirm(bekraftaText);
      
      if (!bekrafta) return;
      
      try {
        const response = await fetch('/api/kampanj/utoka-platser', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            kampanjId,
            antalNyaPlatser,
            rensaNejSvar
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert(`‚úÖ ${data.message}`);
          // Ladda om kampanjdetaljen
          laddaKampanjDetalj(kampanjId);
        } else {
          alert('N√•got gick fel: ' + (data.error || 'Ok√§nt fel'));
        }
      } catch (err) {
        console.error('Fel vid ut√∂kning:', err);
        alert('N√§tverksfel ‚Äì kunde inte ut√∂ka utskicket');
      }
    }
    
    document.getElementById('btn-utoka-en-plats')?.addEventListener('click', () => {
      utokaMedPlatser(1);
    });
    
    document.getElementById('btn-utoka-tva-platser')?.addEventListener('click', () => {
      utokaMedPlatser(2);
    });

    // ========== UT√ñKA UTSKICK MED FLER PATIENTER ==========
    document.getElementById('btn-utoka-kampanj')?.addEventListener('click', async () => {
      const kampanjId = (window as any).aktivKampanjId;
      if (!kampanjId) {
        alert('Ingen kampanj vald');
        return;
      }
      
      // H√§mta tillg√§ngliga patienter fr√•n poolen
      const response = await fetch('/api/pool/lista');
      const data = await response.json();
      
      if (!data.success || !data.patienter?.length) {
        alert('Inga tillg√§ngliga patienter i poolen.\n\nG√• till fliken "Patientpool" f√∂r att l√§gga till patienter.');
        return;
      }
      
      // Filtrera bort de som redan √§r med i denna kampanj
      const nuvarandeMottagare = await fetch(`/api/kampanj/status?id=${kampanjId}`)
        .then(r => r.json())
        .then(d => d.mottagare?.map((m: any) => m.telefon_hash) || []);
      
      const tillgangliga = data.patienter.filter((p: any) => 
        p.status === 'tillganglig' && !nuvarandeMottagare.includes(p.telefon_hash)
      );
      
      if (!tillgangliga.length) {
        alert('Alla patienter i poolen √§r redan med i denna kampanj eller upptagna.');
        return;
      }
      
      // Fr√•ga hur m√•nga som ska l√§ggas till
      const antal = prompt(
        `${tillgangliga.length} patienter tillg√§ngliga i poolen.\n\nHur m√•nga vill du l√§gga till i kampanjen?`,
        Math.min(5, tillgangliga.length).toString()
      );
      
      if (!antal || isNaN(parseInt(antal)) || parseInt(antal) < 1) return;
      
      const antalAttLagga = Math.min(parseInt(antal), tillgangliga.length);
      const patienterAttLagga = tillgangliga.slice(0, antalAttLagga);
      
      // Visa vilka som kommer l√§ggas till
      const namnLista = patienterAttLagga.map((p: any) => `‚Ä¢ ${p.namn}`).join('\n');
      const bekrafta = confirm(
        `F√∂ljande ${antalAttLagga} patient${antalAttLagga > 1 ? 'er' : ''} l√§ggs till och f√•r SMS direkt:\n\n${namnLista}\n\nForts√§tt?`
      );
      
      if (!bekrafta) return;
      
      // Anropa API f√∂r att ut√∂ka utskicket
      try {
        const utResponse = await fetch('/api/kampanj/utoka', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            kampanjId: kampanjId,
            patientIds: patienterAttLagga.map((p: any) => p.id),
          }),
        });
        
        const utData = await utResponse.json();
        
        if (utData.success) {
          alert(`‚úÖ ${utData.antalTillagda} patient${utData.antalTillagda > 1 ? 'er' : ''} tillagda!\n\n${utData.antalSkickade} SMS skickades.`);
          // Ladda om kampanjdetaljen
          laddaKampanjDetalj(kampanjId);
        } else {
          alert('N√•got gick fel: ' + (utData.error || 'Ok√§nt fel'));
        }
      } catch (err) {
        console.error('Fel vid ut√∂kning:', err);
        alert('N√§tverksfel ‚Äì kunde inte ut√∂ka utskicket');
      }
    });

    // ========== PATIENTPOOL ==========
    let cachedTillgangliga: any[] = []; // Cache f√∂r sortering
    let currentSort: { field: string; asc: boolean } = { field: 'prioritet', asc: false }; // Prioriterade f√∂rst som default

    async function laddaPatientpool() {
      try {
        const response = await fetch('/api/pool/lista');
        const data = await response.json();
        
        if (data.success) {
          // Uppdatera statistik
          const tillgangligaCount = data.statistik?.tillgangliga ?? data.patienter?.tillgangliga?.length ?? 0;
          document.getElementById('stat-tillgangliga')!.textContent = `(${tillgangligaCount} st)`;
          
          // Uppdatera dolda element f√∂r kompatibilitet
          const statReserv = document.getElementById('stat-reserv');
          const statNej = document.getElementById('stat-nej');
          const statBokade = document.getElementById('stat-bokade');
          const statTotalt = document.getElementById('stat-totalt');
          if (statReserv) statReserv.textContent = data.statistik?.reserv ?? '0';
          if (statNej) statNej.textContent = data.statistik?.nej ?? '0';
          if (statBokade) statBokade.textContent = data.statistik?.bokade ?? '0';
          if (statTotalt) statTotalt.textContent = data.statistik?.totalt ?? '0';
          
          // Spara och sortera tillg√§ngliga
          cachedTillgangliga = data.patienter?.tillgangliga || [];
          renderaSorteradLista();
          
          // Uppdatera matchande patienter i kampanjformul√§ret
          if (typeof updateMatchandePatienter === 'function') {
            updateMatchandePatienter();
          }
        }
      } catch (error) {
        console.error('Kunde inte ladda patientpool:', error);
      }
    }
    
    // Hj√§lpfunktion f√∂r att ber√§kna prioritetsnummer
    function getPrioritetNummer(p: any): number {
      if (p.akut) return 1;
      if (p.sjukskriven) return 2;
      if (p.har_ont) return 3;
      return 4;
    }
    
    function renderaSorteradLista() {
      const sorterade = [...cachedTillgangliga].sort((a, b) => {
        // AKUT alltid f√∂rst, oavsett annan sortering
        if (a.akut && !b.akut) return -1;
        if (!a.akut && b.akut) return 1;
        
        let comparison = 0;
        
        if (currentSort.field === 'prioritet') {
          // Prioritet: 1=akut, 2=sjukskriven, 3=ont, 4=normal (l√§gre nummer = h√∂gre prioritet)
          const prioA = getPrioritetNummer(a);
          const prioB = getPrioritetNummer(b);
          comparison = prioA - prioB; // L√§gre nummer f√∂rst
        } else if (currentSort.field === 'namn') {
          comparison = (a.namn || '').localeCompare(b.namn || '', 'sv');
        } else if (currentSort.field === 'storlek') {
          // Storlek: b√•da=3, stor=2, liten=1, ingen=0
          const storlekA = (a.op_liten ? 1 : 0) + (a.op_stor ? 2 : 0);
          const storlekB = (b.op_liten ? 1 : 0) + (b.op_stor ? 2 : 0);
          comparison = storlekB - storlekA;
        } else if (currentSort.field === 'alder') {
          // √Ñldre f√∂rst (pension√§rer kommer l√§ttare)
          const alderA = a.alder ?? 0;
          const alderB = b.alder ?? 0;
          comparison = alderB - alderA;
        } else if (currentSort.field === 'sida') {
          // H√∂ger f√∂rst (h < v alfabetiskt)
          const sidaA = a.sida || 'zzz'; // S√§tt tomma sist
          const sidaB = b.sida || 'zzz';
          comparison = sidaA.localeCompare(sidaB, 'sv');
        } else if (currentSort.field === 'lakare') {
          // Hantera l√§kare som array
          const lakareA = Array.isArray(a.lakare) ? a.lakare.join(', ') : (a.lakare || '');
          const lakareB = Array.isArray(b.lakare) ? b.lakare.join(', ') : (b.lakare || '');
          comparison = lakareA.localeCompare(lakareB, 'sv');
        } else if (currentSort.field === 'dagar') {
          const dagarA = Math.ceil((new Date(a.utgar_vid).getTime() - Date.now()) / (1000*60*60*24));
          const dagarB = Math.ceil((new Date(b.utgar_vid).getTime() - Date.now()) / (1000*60*60*24));
          comparison = dagarA - dagarB;
        }
        
        return currentSort.asc ? comparison : -comparison;
      });
      
      renderaPatientlista('lista-tillgangliga', sorterade);
    }
    
    // Sorteringsknappar
    function setupSortering(btnId: string, field: string) {
      document.getElementById(btnId)?.addEventListener('click', () => {
        if (currentSort.field === field) {
          currentSort.asc = !currentSort.asc;
        } else {
          currentSort.field = field;
          currentSort.asc = field === 'dagar'; // Dagar: l√§gst f√∂rst, annars: fallande
        }
        renderaSorteradLista();
      });
    }
    
    setupSortering('sort-prioritet', 'prioritet');
    setupSortering('sort-namn', 'namn');
    setupSortering('sort-sida', 'sida');
    setupSortering('sort-storlek', 'storlek');
    setupSortering('sort-alder', 'alder');
    setupSortering('sort-lakare', 'lakare');
    setupSortering('sort-dagar', 'dagar');

    function renderaPatientlista(containerId: string, patienter: any[], type?: string) {
      const container = document.getElementById(containerId);
      if (!container) return;
      
      if (!patienter || patienter.length === 0) {
        container.innerHTML = `<tr><td colspan="8" class="text-gray-400 italic text-sm py-8 text-center">Inga patienter i poolen √§nnu. L√§gg till ovan!</td></tr>`;
        return;
      }
      
      container.innerHTML = patienter.map(p => {
        const dagarKvar = Math.ceil((new Date(p.utgar_vid).getTime() - Date.now()) / (1000*60*60*24));
        
        if (type === 'nej') {
          return `
            <tr class="bg-red-50 hover:bg-red-100">
              <td colspan="6" class="px-2 py-2 font-medium text-gray-800">${p.namn}</td>
              <td class="px-2 py-2 text-center">
                ${!p.hanterad_i_journal ? `
                  <button onclick="markeraHanterad('${p.id}')" class="px-2 py-1 bg-gray-100 rounded hover:bg-gray-200 text-xs">‚úì Hanterad</button>
                ` : '<span class="text-green-600 text-xs">‚úì Hanterad</span>'}
              </td>
              <td class="px-2 py-2 text-center">
                <button onclick="taBortPatient('${p.id}')" class="p-1 text-red-500 hover:bg-red-100 rounded" title="Ta bort">üóëÔ∏è</button>
              </td>
            </tr>
          `;
        }
        
        if (type === 'bokad') {
          return `
            <tr class="bg-green-50 hover:bg-green-100">
              <td colspan="7" class="px-2 py-2">
                <span class="font-medium text-gray-800">${p.namn}</span>
                <span class="text-xs text-gray-500 ml-2">${p.bokad_datum ? new Date(p.bokad_datum).toLocaleDateString('sv-SE') : ''}</span>
              </td>
              <td class="px-2 py-2"></td>
            </tr>
          `;
        }
        
        // Tillg√§ngliga patienter
        const lakareArray = Array.isArray(p.lakare) ? p.lakare : (p.lakare ? [p.lakare] : []);
        const lakareInfo = lakareArray.length > 0 ? lakareArray.join(', ') : '-';
        const lakareTitle = lakareArray.length > 1 ? `Kan opereras av: ${lakareArray.join(', ')}` : '';
        
        const arAkut = p.akut === true;
        const harOnt = p.har_ont === true;
        const arSjukskriven = p.sjukskriven === true;
        const opLiten = p.op_liten === true;
        const opStor = p.op_stor === true;
        
        // Bakgrundsf√§rg baserat p√• prioritet
        let rowClass = 'hover:bg-gray-50';
        if (arAkut) {
          rowClass = 'bg-red-50 hover:bg-red-100 border-l-4 border-l-red-500';
        } else if (harOnt) {
          rowClass = 'bg-orange-50 hover:bg-orange-100 border-l-4 border-l-orange-400';
        } else if (arSjukskriven) {
          rowClass = 'bg-blue-50 hover:bg-blue-100 border-l-4 border-l-blue-400';
        }
        
        // Prioritetsnummer: 1=Akut, 2=Sjukskriven, 3=Mycket ont, 4=Normal
        let prioNum = 4;
        let prioTitle = 'Normal prioritet';
        let prioClass = 'text-gray-400';
        if (arAkut) {
          prioNum = 1;
          prioTitle = 'AKUT - m√•ste opereras snarast';
          prioClass = 'text-red-600 font-bold text-lg';
        } else if (arSjukskriven) {
          prioNum = 2;
          prioTitle = 'Sjukskriven';
          prioClass = 'text-blue-600 font-bold';
        } else if (harOnt) {
          prioNum = 3;
          prioTitle = 'Mycket ont';
          prioClass = 'text-orange-600 font-bold';
        }
        
        // Operationsstorlek
        let storlekBadge = '<span class="text-gray-300">-</span>';
        if (opLiten && opStor) {
          storlekBadge = '<span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded font-medium" title="Liten eller stor">L+S</span>';
        } else if (opLiten) {
          storlekBadge = '<span class="text-xs bg-sky-100 text-sky-700 px-2 py-0.5 rounded font-medium" title="Liten operation (5-15 min)">Liten</span>';
        } else if (opStor) {
          storlekBadge = '<span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded font-medium" title="Stor operation (15-60 min)">Stor</span>';
        }
        
        // √Ölder - pension√§r vid 67+
        const alderText = p.alder ? `${p.alder}` : '-';
        const isPension = p.alder && p.alder >= 67;
        const alderClass = isPension ? 'text-green-600 font-bold' : 'text-gray-500';
        const pensionBadge = isPension ? ' ‚úì' : '';
        
        // Sida (H√ñ/V√Ñ)
        const sidaText = p.sida === 'h√∂ger' ? 'H√ñ' : (p.sida === 'v√§nster' ? 'V√Ñ' : '-');
        const sidaClass = p.sida ? 'text-gray-700 font-medium' : 'text-gray-400';
        
        // Dagar kvar styling
        const dagarClass = dagarKvar <= 3 ? 'text-red-600 font-bold' : (dagarKvar <= 7 ? 'text-orange-600 font-medium' : 'text-gray-500');
        
        return `
          <tr class="${rowClass} group transition-colors">
            <td class="px-2 py-2.5 text-center">
              <span class="${prioClass}" title="${prioTitle}">${prioNum}</span>
            </td>
            <td class="px-2 py-2.5">
              <span class="font-medium text-gray-900">${p.namn}</span>
            </td>
            <td class="px-2 py-2.5 text-center">
              <span class="${sidaClass}" title="${p.sida === 'h√∂ger' ? 'H√∂ger sida' : (p.sida === 'v√§nster' ? 'V√§nster sida' : 'Ej angiven')}">${sidaText}</span>
            </td>
            <td class="px-2 py-2.5 text-center">
              ${storlekBadge}
            </td>
            <td class="px-2 py-2.5 text-center">
              <span class="${alderClass}" title="${isPension ? 'Pension√§r (67+) - kommer l√§ttare p√• kort varsel' : '√Ölder'}">${alderText}${pensionBadge}</span>
            </td>
            <td class="px-2 py-2.5 text-sky-700 font-medium" title="${lakareTitle}">
              ${lakareInfo}
            </td>
            <td class="px-2 py-2.5 text-center">
              <span class="${dagarClass}" title="Dagar till planerad operation">${dagarKvar}d</span>
            </td>
            <td class="px-2 py-2.5 text-center">
              <div class="flex items-center justify-center gap-1 opacity-30 group-hover:opacity-100 transition-opacity">
                <button 
                  onclick="redigeraPatient('${p.id}')"
                  class="p-1.5 text-gray-500 hover:text-sky-600 hover:bg-sky-50 rounded"
                  title="Redigera patient"
                >‚úèÔ∏è</button>
                <button 
                  onclick="taBortPatient('${p.id}')"
                  class="p-1.5 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded"
                  title="Ta bort patient"
                >üóëÔ∏è</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Hj√§lpfunktion: Ber√§kna √•lder fr√•n personnummer
    function beraknaAlderFranPnr(pnr: string): number | null {
      if (!pnr) return null;
      
      // Ta bort bindestreck och mellanslag
      const clean = pnr.replace(/[-\s]/g, '');
      
      // Format: √Ö√Ö√Ö√ÖMMDDXXXX (12 siffror) eller √Ö√ÖMMDDXXXX (10 siffror)
      let year: number;
      let month: number;
      let day: number;
      
      if (clean.length === 12) {
        year = parseInt(clean.substring(0, 4));
        month = parseInt(clean.substring(4, 6));
        day = parseInt(clean.substring(6, 8));
      } else if (clean.length === 10) {
        const shortYear = parseInt(clean.substring(0, 2));
        // Anta 1900-tal om > 30, annars 2000-tal
        year = shortYear > 30 ? 1900 + shortYear : 2000 + shortYear;
        month = parseInt(clean.substring(2, 4));
        day = parseInt(clean.substring(4, 6));
      } else {
        return null;
      }
      
      // Validera
      if (isNaN(year) || isNaN(month) || isNaN(day)) return null;
      if (month < 1 || month > 12 || day < 1 || day > 31) return null;
      
      // Ber√§kna √•lder
      const today = new Date();
      let age = today.getFullYear() - year;
      const monthDiff = today.getMonth() + 1 - month;
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < day)) {
        age--;
      }
      
      return age > 0 && age < 120 ? age : null;
    }

    // L√§gg till patienter
    document.getElementById('btn-lagg-till')?.addEventListener('click', async () => {
      const textarea = document.getElementById('nya-patienter') as HTMLTextAreaElement;
      const opDatumInput = document.getElementById('patient-op-datum') as HTMLInputElement;
      const akutCheckbox = document.getElementById('patient-akut') as HTMLInputElement;
      const ontCheckbox = document.getElementById('patient-ont') as HTMLInputElement;
      const sjukskrivenCheckbox = document.getElementById('patient-sjukskriven') as HTMLInputElement;
      
      // H√§mta valda l√§kare (checkboxar)
      const lakareCheckboxes = document.querySelectorAll('input[name="patient-lakare"]:checked') as NodeListOf<HTMLInputElement>;
      const valdaLakare = Array.from(lakareCheckboxes).map(cb => cb.value);
      
      // H√§mta vald sida (H√ñ/V√Ñ)
      const sidaRadio = document.querySelector('input[name="patient-sida"]:checked') as HTMLInputElement;
      const sida = sidaRadio?.value || null;
      
      // H√§mta vald operationsstorlek (radio - liten ELLER stor)
      const opStorlekRadio = document.querySelector('input[name="patient-op-storlek"]:checked') as HTMLInputElement;
      const opStorlek = opStorlekRadio?.value || null;
      
      const text = textarea.value.trim();
      const opDatum = opDatumInput.value;
      const arAkut = akutCheckbox.checked;
      const harOnt = ontCheckbox.checked;
      const arSjukskriven = sjukskrivenCheckbox.checked;
      const opLiten = opStorlek === 'liten';
      const opStor = opStorlek === 'stor';
      
      if (!text) return;
      
      if (valdaLakare.length === 0) {
        alert('V√§lj minst en l√§kare som kan utf√∂ra operationen');
        return;
      }
      
      if (!opDatum) {
        alert('Ange patientens ordinarie operationsdatum');
        return;
      }
      
      if (!sida) {
        alert('V√§lj vilken sida som ska opereras (H√ñ eller V√Ñ)');
        return;
      }
      
      if (!opStorlek) {
        alert('V√§lj operationsstorlek (liten eller stor)');
        return;
      }
      
      // Validera att op-datumet √§r i framtiden
      const opDate = new Date(opDatum);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      if (opDate < today) {
        alert('Operationsdatumet m√•ste vara i framtiden');
        return;
      }
      
      // Parsera patientdata - st√∂djer journalsystemformat
      const patienter: any[] = [];
      const lines = text.split('\n').map(l => l.trim()).filter(l => l);
      
      // Journalsystemformat: "Namn Personnummer" f√∂ljt av "Mobilnummer: 07X-XXX XX XX"
      if (text.toLowerCase().includes('mobilnummer')) {
        let currentNamn = '';
        let currentAlder: number | null = null;
        
        for (const line of lines) {
          // Kontrollera om raden inneh√•ller personnummer (√Ö√Ö√Ö√ÖMMDD-XXXX eller √Ö√ÖMMDD-XXXX)
          const personnummerMatch = line.match(/^(.+?)\s+(\d{6,8}[-\s]?\d{4})\s*$/);
          if (personnummerMatch) {
            currentNamn = personnummerMatch[1].trim();
            const pnr = personnummerMatch[2];
            currentAlder = beraknaAlderFranPnr(pnr);
          }
          // Kontrollera om raden inneh√•ller mobilnummer
          else if (line.toLowerCase().startsWith('mobilnummer')) {
            let telefon = line.replace(/mobilnummer[:\s]*/i, '').replace(/[-\s]/g, '');
            if (telefon.startsWith('0')) {
              telefon = '+46' + telefon.slice(1);
            }
            if (currentNamn && telefon) {
              patienter.push({
                namn: currentNamn,
                telefon: telefon,
                harSamtycke: true, // Default till ja vid journalimport
                lakare: valdaLakare, // Array av l√§kare
                opDatum: opDatum,
                akut: arAkut,
                harOnt: harOnt,
                sjukskriven: arSjukskriven,
                alder: currentAlder,
                opLiten: opLiten,
                opStor: opStor,
                sida: sida
              });
              currentNamn = '';
              currentAlder = null;
            }
          }
        }
      } 
      // Gammalt CSV-format: "Namn, Telefon, Samtycke"
      else {
        for (const line of lines) {
          const parts = line.split(',').map(p => p.trim());
          let telefon = parts[1]?.replace(/\s/g, '') || '';
          if (telefon.startsWith('0')) {
            telefon = '+46' + telefon.slice(1);
          }
          if (parts[0] && telefon) {
            patienter.push({
              namn: parts[0],
              telefon: telefon,
              harSamtycke: (parts[2] || '').toLowerCase() === 'ja',
              lakare: valdaLakare, // Array av l√§kare
              opDatum: opDatum,
              akut: arAkut,
              harOnt: harOnt,
              sjukskriven: arSjukskriven,
              alder: null, // Ingen √•lder vid CSV-import
              opLiten: opLiten,
              opStor: opStor,
              sida: sida
            });
          }
        }
      }
      
      if (patienter.length === 0) {
        alert('Inga giltiga patienter hittades. Kontrollera formatet.');
        return;
      }
      
      try {
        const response = await fetch('/api/pool/lagg-till', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ patienter })
        });
        
        const data = await response.json();
        
        // D√∂lj eventuella tidigare meddelanden
        const dublettVarning = document.getElementById('dubblett-varning')!;
        const successMsg = document.getElementById('tillagd-success')!;
        dublettVarning.classList.add('hidden');
        successMsg.classList.add('hidden');
        
        if (data.success) {
          textarea.value = '';
          opDatumInput.value = '';
          akutCheckbox.checked = false;
          ontCheckbox.checked = false;
          sjukskrivenCheckbox.checked = false;
          // √Öterst√§ll l√§kare-checkboxar
          document.querySelectorAll('input[name="patient-lakare"]').forEach((cb: any) => cb.checked = false);
          // √Öterst√§ll sida-radioknappar
          document.querySelectorAll('input[name="patient-sida"]').forEach((rb: any) => rb.checked = false);
          // √Öterst√§ll operationsstorlek-radioknappar
          document.querySelectorAll('input[name="patient-op-storlek"]').forEach((rb: any) => rb.checked = false);
          laddaPatientpool();
          
          // Visa succ√©meddelande
          const successText = document.getElementById('tillagd-success-text')!;
          successText.textContent = `${data.antalTillagda} patient(er) tillagda i poolen!`;
          successMsg.classList.remove('hidden');
          
          // D√∂lj efter 4 sekunder
          setTimeout(() => successMsg.classList.add('hidden'), 4000);
          
        } else if (data.dubletter) {
          // Visa tydlig dubblettvarning
          const dublettLista = document.getElementById('dubblett-lista')!;
          dublettLista.innerHTML = data.existerande.map((namn: string) => `
            <div class="flex items-center gap-2 p-2 bg-red-100 rounded border border-red-200">
              <span class="text-red-500 font-bold">‚úó</span>
              <span class="line-through text-red-800 font-medium">${namn}</span>
              <span class="text-red-600 text-xs ml-auto">redan i poolen</span>
            </div>
          `).join('');
          dublettVarning.classList.remove('hidden');
          
          // Scrolla till varningen
          dublettVarning.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
        } else {
          alert(data.error || 'Kunde inte l√§gga till patienter');
        }
      } catch (error) {
        alert('N√•got gick fel');
      }
    });

    // St√§ng dubblettvarning
    document.getElementById('stang-dubblett-varning')?.addEventListener('click', () => {
      document.getElementById('dubblett-varning')?.classList.add('hidden');
    });

    // Markera hanterad
    async function markeraHanterad(patientId: string) {
      await fetch('/api/pool/uppdatera', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ patientId, action: 'markera_hanterad' })
      });
      laddaPatientpool();
    }

    // Bekr√§ftelsedialog-funktioner
    let bekraftaCallback: (() => void) | null = null;
    
    function visaBekraftaModal(titel: string, text: string, btnText: string, callback: () => void, ikon: string = '‚ö†Ô∏è') {
      document.getElementById('bekrafta-titel')!.textContent = titel;
      document.getElementById('bekrafta-text')!.textContent = text;
      document.getElementById('bekrafta-ikon')!.textContent = ikon;
      document.getElementById('bekrafta-ja-btn')!.textContent = btnText;
      bekraftaCallback = callback;
      document.getElementById('bekrafta-modal')!.classList.remove('hidden');
    }
    
    function stangBekraftaModal() {
      document.getElementById('bekrafta-modal')!.classList.add('hidden');
      bekraftaCallback = null;
    }
    
    function bekraftaJa() {
      if (bekraftaCallback) {
        bekraftaCallback();
      }
      stangBekraftaModal();
    }
    
    // Koppla bekr√§fta-knappen
    document.getElementById('bekrafta-ja-btn')?.addEventListener('click', bekraftaJa);

    // Ta bort patient
    async function taBortPatient(patientId: string) {
      visaBekraftaModal(
        'Ta bort patient?',
        'Patienten tas bort fr√•n listan. Detta kan inte √•ngras.',
        'Ta bort',
        async () => {
          await fetch('/api/pool/ta-bort', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ patientId })
          });
          laddaPatientpool();
        },
        'üóëÔ∏è'
      );
    }

    // Redigera patient
    async function redigeraPatient(patientId: string) {
      // Hitta patienten i cachen
      const patient = cachedTillgangliga.find(p => p.id === patientId);
      if (!patient) {
        alert('Kunde inte hitta patienten');
        return;
      }
      
      // Fyll i modal med patientdata
      (document.getElementById('redigera-patient-id') as HTMLInputElement).value = patientId;
      (document.getElementById('redigera-namn') as HTMLInputElement).value = patient.namn || '';
      (document.getElementById('redigera-akut') as HTMLInputElement).checked = patient.akut === true;
      (document.getElementById('redigera-sjukskriven') as HTMLInputElement).checked = patient.sjukskriven === true;
      (document.getElementById('redigera-ont') as HTMLInputElement).checked = patient.har_ont === true;
      (document.getElementById('redigera-alder') as HTMLInputElement).value = patient.alder?.toString() || '';
      
      // Sida
      const sidaRadios = document.querySelectorAll('input[name="redigera-sida"]') as NodeListOf<HTMLInputElement>;
      sidaRadios.forEach(r => r.checked = r.value === patient.sida);
      
      // Storlek
      const storlekRadios = document.querySelectorAll('input[name="redigera-storlek"]') as NodeListOf<HTMLInputElement>;
      storlekRadios.forEach(r => {
        if (r.value === 'liten') r.checked = patient.op_liten === true;
        else if (r.value === 'stor') r.checked = patient.op_stor === true;
      });
      
      // L√§kare - h√§mta tillg√§ngliga l√§kare fr√•n DOM
      const lakareContainer = document.getElementById('redigera-lakare-checkboxes')!;
      const allLakare = Array.from(document.querySelectorAll('input[name="patient-lakare"]')) as HTMLInputElement[];
      const patientLakare = Array.isArray(patient.lakare) ? patient.lakare : (patient.lakare ? [patient.lakare] : []);
      
      lakareContainer.innerHTML = allLakare.map(cb => `
        <label class="flex items-center gap-2 cursor-pointer">
          <input 
            type="checkbox" 
            name="redigera-lakare" 
            value="${cb.value}"
            ${patientLakare.includes(cb.value) ? 'checked' : ''}
            class="rounded border-gray-300 text-sky-500 focus:ring-sky-500"
          >
          <span class="text-sm">${cb.value}</span>
        </label>
      `).join('');
      
      // Datum
      const utgarVid = patient.utgar_vid ? patient.utgar_vid.split('T')[0] : '';
      (document.getElementById('redigera-utgar-vid') as HTMLInputElement).value = utgarVid;
      
      // Visa modal
      document.getElementById('redigera-patient-modal')!.classList.remove('hidden');
    }
    
    function stangRedigeraModal() {
      document.getElementById('redigera-patient-modal')!.classList.add('hidden');
    }
    
    async function sparaPatientandringar() {
      const patientId = (document.getElementById('redigera-patient-id') as HTMLInputElement).value;
      
      const namn = (document.getElementById('redigera-namn') as HTMLInputElement).value.trim();
      const akut = (document.getElementById('redigera-akut') as HTMLInputElement).checked;
      const sjukskriven = (document.getElementById('redigera-sjukskriven') as HTMLInputElement).checked;
      const harOnt = (document.getElementById('redigera-ont') as HTMLInputElement).checked;
      const alder = parseInt((document.getElementById('redigera-alder') as HTMLInputElement).value) || null;
      
      const sidaRadio = document.querySelector('input[name="redigera-sida"]:checked') as HTMLInputElement;
      const sida = sidaRadio?.value || null;
      
      const storlekRadio = document.querySelector('input[name="redigera-storlek"]:checked') as HTMLInputElement;
      const opLiten = storlekRadio?.value === 'liten';
      const opStor = storlekRadio?.value === 'stor';
      
      const lakareCheckboxes = document.querySelectorAll('input[name="redigera-lakare"]:checked') as NodeListOf<HTMLInputElement>;
      const lakare = Array.from(lakareCheckboxes).map(cb => cb.value);
      
      const utgarVid = (document.getElementById('redigera-utgar-vid') as HTMLInputElement).value;
      
      // Validering
      if (!namn) {
        alert('Namn kr√§vs');
        return;
      }
      if (lakare.length === 0) {
        alert('V√§lj minst en l√§kare');
        return;
      }
      if (!sida) {
        alert('V√§lj sida (H√ñ/V√Ñ)');
        return;
      }
      if (!opLiten && !opStor) {
        alert('V√§lj operationsstorlek');
        return;
      }
      
      try {
        const response = await fetch('/api/pool/uppdatera', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            patientId,
            action: 'redigera',
            namn,
            lakare,
            sida,
            opLiten,
            opStor,
            akut,
            harOnt,
            sjukskriven,
            alder,
            utgarVid: utgarVid ? new Date(utgarVid).toISOString() : undefined
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          stangRedigeraModal();
          laddaPatientpool();
        } else {
          alert('Kunde inte spara: ' + (data.error || 'Ok√§nt fel'));
        }
      } catch (error) {
        console.error('Fel vid sparande:', error);
        alert('N√§tverksfel - kunde inte spara √§ndringar');
      }
    }
    
    function taBortPatientFranModal() {
      const patientId = (document.getElementById('redigera-patient-id') as HTMLInputElement).value;
      stangRedigeraModal();
      taBortPatient(patientId);
    }

    // G√∂r funktioner globala f√∂r onclick
    (window as any).markeraHanterad = markeraHanterad;
    (window as any).taBortPatient = taBortPatient;
    (window as any).redigeraPatient = redigeraPatient;
    (window as any).stangRedigeraModal = stangRedigeraModal;
    (window as any).sparaPatientandringar = sparaPatientandringar;
    (window as any).taBortPatientFranModal = taBortPatientFranModal;
    (window as any).stangBekraftaModal = stangBekraftaModal;

    // Ladda patientpool vid start
    laddaPatientpool();

    // Vid ?id=: visa Aktiva-flik och ladda kampanjdetaljer (JA/NEJ/reserv)
    // Anv√§nd URLSearchParams f√∂r att vara s√§ker p√• att vi f√•ngar ID:t √§ven om data-attributet strular
    const urlParams = new URLSearchParams(window.location.search);
    const kampanjIdFromUrl = urlParams.get('id') || document.querySelector('main')?.getAttribute('data-kampanj-id')?.trim();
    
    console.log('üîç Kampanj-ID fr√•n URL:', kampanjIdFromUrl);
    
    if (kampanjIdFromUrl) {
      console.log('‚úÖ Visar Aktiva-flik och laddar detaljer f√∂r ID:', kampanjIdFromUrl);
      // Se till att Aktiva-fliken √§r vald
      visaPanel('aktiva');
      
      // Scrolla upp s√• anv√§ndaren ser detaljerna
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      // Ladda detaljer
      laddaKampanjDetalj(kampanjIdFromUrl);
    } else {
      console.log('‚ö†Ô∏è Ingen kampanj-ID i URL, visar standard-vy');
    }

    // ========== KAMPANJFORMUL√ÑR ==========
    
    // Visa/d√∂lj tidsgr√§ns
    document.querySelector('input[name="harTidsGrans"]')?.addEventListener('change', (e) => {
      const section = document.getElementById('tidsgrans-section');
      if ((e.target as HTMLInputElement).checked) {
        section?.classList.remove('hidden');
        // S√§tt default till idag
        const idag = new Date();
        (document.querySelector('input[name="tidsgransDatum"]') as HTMLInputElement).value = 
          idag.toISOString().split('T')[0];
      } else {
        section?.classList.add('hidden');
      }
    });

    // Uppdatera matchande patienter n√§r filter √§ndras
    function updateMatchandePatienter() {
      const lakare = (document.querySelector('select[name="lakare"]') as HTMLSelectElement)?.value;
      const sida = (document.querySelector('input[name="kampanjSida"]:checked') as HTMLInputElement)?.value;
      const opLiten = (document.querySelector('input[name="kampanjOpLiten"]') as HTMLInputElement)?.checked;
      const opStor = (document.querySelector('input[name="kampanjOpStor"]') as HTMLInputElement)?.checked;
      
      // Filtrera cachedTillgangliga baserat p√• filter
      const matchande = cachedTillgangliga.filter(p => {
        // L√§kare: patienten m√•ste ha vald l√§kare i sin array
        if (lakare) {
          const patientLakare = Array.isArray(p.lakare) ? p.lakare : [p.lakare];
          if (!patientLakare.includes(lakare)) return false;
        }
        // Sida: matchar eller ej angiven
        if (sida && p.sida && p.sida !== sida) return false;
        // Operationsstorlek
        if (opLiten && !opStor && !p.op_liten) return false;
        if (opStor && !opLiten && !p.op_stor) return false;
        if (opLiten && opStor && !p.op_liten && !p.op_stor) return false;
        return true;
      });
      
      const matchandeEl = document.getElementById('matchande-patienter');
      if (matchandeEl) {
        if (matchande.length > 0) {
          matchandeEl.innerHTML = `<span id="matchande-antal">${matchande.length}</span> patient(er) matchar filtret`;
        } else if (lakare) {
          matchandeEl.innerHTML = '<span id="matchande-antal">0</span> ‚ö†Ô∏è Inga patienter matchar filtret';
        } else {
          matchandeEl.textContent = '';
        }
      }
    }
    
    // Lyssna p√• filter√§ndringar
    document.querySelector('select[name="lakare"]')?.addEventListener('change', updateMatchandePatienter);
    document.querySelectorAll('input[name="kampanjSida"]').forEach(r => 
      r.addEventListener('change', updateMatchandePatienter)
    );
    document.querySelector('input[name="kampanjOpLiten"]')?.addEventListener('change', updateMatchandePatienter);
    document.querySelector('input[name="kampanjOpStor"]')?.addEventListener('change', updateMatchandePatienter);

    // ========== SMART INTERVALL-LOGIK ==========
    
    // Intervall-tabell baserat p√• dagar och prioritet (i minuter)
    const INTERVALL_TABELL = {
      // [dagar]: { akut, sjukskriven, ont, normal }
      0: { akut: 5, sjukskriven: 5, ont: 5, normal: 5 },      // Samma dag
      1: { akut: 15, sjukskriven: 10, ont: 10, normal: 5 },   // Dagen innan
      2: { akut: 30, sjukskriven: 20, ont: 15, normal: 10 },  // 2 dagar
      3: { akut: 60, sjukskriven: 45, ont: 30, normal: 20 },  // 3+ dagar
    };
    
    // Tidspress-multiplikator (dagen innan, baserat p√• klockan)
    function getTidspressMultiplikator(): number {
      const nu = new Date();
      const timme = nu.getHours();
      if (timme >= 16) return 0.25;  // Efter 16: desperat
      if (timme >= 14) return 0.5;   // 14-16: stress
      if (timme >= 12) return 0.75;  // 12-14: lite press
      return 1.0;                     // F√∂re 12: lugnt
    }
    
    // Ber√§kna rekommenderat intervall
    function beraknaRekommenderatIntervall(opDatum: string, antalPatienter: number): { 
      intervall: number; 
      anledning: string;
      varning: string | null;
    } {
      if (!opDatum) return { intervall: 10, anledning: 'Inget datum valt', varning: null };
      
      const idag = new Date();
      idag.setHours(0, 0, 0, 0);
      const opDate = new Date(opDatum);
      opDate.setHours(0, 0, 0, 0);
      
      const diffMs = opDate.getTime() - idag.getTime();
      const diffDagar = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      
      // V√§lj intervall-niv√•
      let dagarKey = Math.min(Math.max(diffDagar, 0), 3);
      if (diffDagar >= 3) dagarKey = 3;
      
      const intervaller = INTERVALL_TABELL[dagarKey as keyof typeof INTERVALL_TABELL];
      
      // Anv√§nd "normal" som default (kan f√∂rb√§ttras med patientdata senare)
      let basIntervall = intervaller.normal;
      let anledning = '';
      
      if (diffDagar <= 0) {
        basIntervall = 5;
        anledning = 'Samma dag - maximal hastighet';
      } else if (diffDagar === 1) {
        basIntervall = intervaller.normal;
        // Applicera tidspress
        const multiplikator = getTidspressMultiplikator();
        basIntervall = Math.max(5, Math.round(basIntervall * multiplikator));
        
        const nu = new Date();
        if (nu.getHours() >= 14) {
          anledning = `Dagen innan, kl ${nu.getHours()}:${nu.getMinutes().toString().padStart(2, '0')} - √∂kat tempo`;
        } else {
          anledning = 'Dagen innan operation';
        }
      } else if (diffDagar === 2) {
        basIntervall = intervaller.normal;
        anledning = '2 dagar kvar - normalt tempo';
      } else {
        basIntervall = intervaller.normal;
        anledning = `${diffDagar} dagar kvar - lugnt tempo`;
      }
      
      // Kontrollera om tiden r√§cker
      let varning: string | null = null;
      if (antalPatienter > 0 && diffDagar <= 1) {
        const nu = new Date();
        const slutTid = new Date();
        slutTid.setHours(16, 0, 0, 0);
        
        if (diffDagar === 0 || nu.toDateString() === opDate.toDateString()) {
          // Samma dag - kolla tid kvar idag
        } else if (diffDagar === 1) {
          // Dagen innan - kolla tid kvar idag
          const minuterKvar = Math.max(0, (slutTid.getTime() - nu.getTime()) / (1000 * 60));
          const totalTidBeh√∂vs = antalPatienter * basIntervall;
          
          if (totalTidBeh√∂vs > minuterKvar && minuterKvar > 0) {
            const rekommenderatIntervall = Math.max(5, Math.floor(minuterKvar / antalPatienter));
            varning = `Med ${basIntervall} min intervall och ${antalPatienter} patienter tar det ${Math.round(totalTidBeh√∂vs)} min. Du har ca ${Math.round(minuterKvar)} min kvar till 16:00. Rekommenderat: ${rekommenderatIntervall} min.`;
            basIntervall = rekommenderatIntervall;
          }
        }
      }
      
      // Runda till n√§rmaste valbara v√§rde
      const valbara = [5, 10, 15, 20, 30, 45, 60];
      const n√§rmaste = valbara.reduce((prev, curr) => 
        Math.abs(curr - basIntervall) < Math.abs(prev - basIntervall) ? curr : prev
      );
      
      return { intervall: n√§rmaste, anledning, varning };
    }
    
    // Uppdatera intervall-rekommendation i UI
    let rekommenderatIntervallVarde = 10;
    
    function updateIntervallRekommendation() {
      const datumInput = document.querySelector('input[name="datum"]') as HTMLInputElement;
      const intervallSelect = document.getElementById('intervall-select') as HTMLSelectElement;
      const infoDiv = document.getElementById('intervall-info');
      const rekommendationDiv = document.getElementById('intervall-rekommendation');
      const varningDiv = document.getElementById('intervall-varning');
      const autoBadge = document.getElementById('intervall-auto-badge');
      
      if (!datumInput?.value || !intervallSelect || !infoDiv) return;
      
      // R√§kna matchande patienter
      const matchandeText = document.getElementById('matchande-antal')?.textContent || '0';
      const antalPatienter = parseInt(matchandeText) || 0;
      
      const { intervall, anledning, varning } = beraknaRekommenderatIntervall(datumInput.value, antalPatienter);
      rekommenderatIntervallVarde = intervall;
      
      // Visa info
      infoDiv.classList.remove('hidden');
      
      if (varning) {
        // Visa varning
        rekommendationDiv?.classList.add('hidden');
        varningDiv?.classList.remove('hidden');
        const varningText = document.getElementById('varning-text');
        if (varningText) varningText.textContent = varning;
      } else {
        // Visa rekommendation
        varningDiv?.classList.add('hidden');
        rekommendationDiv?.classList.remove('hidden');
        const rekText = document.getElementById('rekommenderat-intervall');
        const rekAnledning = document.getElementById('rekommendation-anledning');
        if (rekText) rekText.textContent = `${intervall} minuter`;
        if (rekAnledning) rekAnledning.textContent = anledning;
      }
      
      // Auto-v√§lj intervall om anv√§ndaren inte √§ndrat manuellt
      if (intervallSelect.dataset.autoSet !== 'false') {
        intervallSelect.value = String(intervall);
        autoBadge?.classList.remove('hidden');
      }
    }
    
    // Event listeners f√∂r intervall-logik
    document.querySelector('input[name="datum"]')?.addEventListener('change', () => {
      const intervallSelect = document.getElementById('intervall-select') as HTMLSelectElement;
      if (intervallSelect) intervallSelect.dataset.autoSet = 'true'; // √Öterst√§ll auto vid nytt datum
      updateIntervallRekommendation();
    });
    
    document.getElementById('intervall-select')?.addEventListener('change', () => {
      const intervallSelect = document.getElementById('intervall-select') as HTMLSelectElement;
      const autoBadge = document.getElementById('intervall-auto-badge');
      intervallSelect.dataset.autoSet = 'false'; // Markera som manuellt √§ndrat
      autoBadge?.classList.add('hidden');
    });
    
    document.getElementById('btn-anvand-rekommenderat')?.addEventListener('click', () => {
      const intervallSelect = document.getElementById('intervall-select') as HTMLSelectElement;
      const autoBadge = document.getElementById('intervall-auto-badge');
      if (intervallSelect) {
        intervallSelect.value = String(rekommenderatIntervallVarde);
        intervallSelect.dataset.autoSet = 'true';
        autoBadge?.classList.remove('hidden');
      }
      updateIntervallRekommendation();
    });
    
    // Uppdatera n√§r matchande patienter √§ndras
    const originalUpdateMatchande = updateMatchandePatienter;
    (window as any).updateMatchandePatienter = function() {
      originalUpdateMatchande();
      setTimeout(updateIntervallRekommendation, 100); // V√§nta p√• DOM-uppdatering
    };

    // Formul√§rsubmit
    document.getElementById('kampanj-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const form = e.target as HTMLFormElement;
      const formData = new FormData(form);
      const result = document.getElementById('result');
      
      // H√§mta filter-v√§rden
      const lakare = formData.get('lakare') as string;
      const sida = formData.get('kampanjSida') as string;
      const opLiten = (form.querySelector('input[name="kampanjOpLiten"]') as HTMLInputElement)?.checked;
      const opStor = (form.querySelector('input[name="kampanjOpStor"]') as HTMLInputElement)?.checked;
      
      // Validera
      if (!lakare) {
        if (result) {
          result.className = 'mt-6 p-4 rounded-lg bg-red-50 border border-red-200 text-red-800';
          result.textContent = 'V√§lj vilken l√§kare som har den lediga tiden';
          result.classList.remove('hidden');
        }
        return;
      }
      
      if (!sida) {
        if (result) {
          result.className = 'mt-6 p-4 rounded-lg bg-red-50 border border-red-200 text-red-800';
          result.textContent = 'V√§lj vilken sida (H√ñ/V√Ñ) som g√§ller';
          result.classList.remove('hidden');
        }
        return;
      }
      
      if (!opLiten && !opStor) {
        if (result) {
          result.className = 'mt-6 p-4 rounded-lg bg-red-50 border border-red-200 text-red-800';
          result.textContent = 'V√§lj operationsstorlek (Liten, Stor eller b√•da)';
          result.classList.remove('hidden');
        }
        return;
      }
      
      // Filtrera matchande patienter fr√•n poolen
      const matchande = cachedTillgangliga.filter(p => {
        // L√§kare: patienten m√•ste ha vald l√§kare i sin array
        const patientLakare = Array.isArray(p.lakare) ? p.lakare : [p.lakare];
        if (!patientLakare.includes(lakare)) return false;
        // Sida: matchar eller ej angiven p√• patienten
        if (p.sida && p.sida !== sida) return false;
        // Operationsstorlek
        if (opLiten && !opStor && !p.op_liten) return false;
        if (opStor && !opLiten && !p.op_stor) return false;
        if (opLiten && opStor && !p.op_liten && !p.op_stor) return false;
        return true;
      });
      
      if (matchande.length === 0) {
        if (result) {
          result.className = 'mt-6 p-4 rounded-lg bg-red-50 border border-red-200 text-red-800';
          result.textContent = 'Inga patienter i poolen matchar dina filter. L√§gg till patienter f√∂rst.';
          result.classList.remove('hidden');
        }
        return;
      }

      // H√§mta intervall (alltid gradvis nu)
      const intervall = parseInt(formData.get('intervall') as string) || 10;

      // Tidsgr√§ns
      let sistaVarstid = null;
      if (formData.get('harTidsGrans')) {
        const datum = formData.get('tidsgransDatum');
        const tid = formData.get('tidsgransTid') || '18:00';
        if (datum) {
          sistaVarstid = `${datum}T${tid}:00`;
        }
      }

      // Notifiera personal
      const notifiera = Array.from(form.querySelectorAll('input[name="notifiera"]:checked'))
        .map((el: any) => el.value);

      // H√§mta antal platser och tidsblock
      const antalPlatserValue = formData.get('antalPlatser');
      const antalPlatser = antalPlatserValue ? parseInt(antalPlatserValue as string) : 1;
      const tidsblock = formData.get('tidsblock') || null;

      const body = {
        datum: formData.get('datum'),
        antalPlatser,
        tidsblock,
        operationTyp: formData.get('operationTyp') || null,
        lakare: lakare,
        filterSida: sida,
        filterOpLiten: opLiten,
        filterOpStor: opStor,
        batchIntervallMinuter: intervall,
        sistaVarstid,
        notifieraPersonal: notifiera,
        // Skicka patient-ID:n f√∂r de matchande patienterna
        patientIds: matchande.map(p => p.id),
      };

      try {
        const response = await fetch('/api/kampanj/skapa', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        const data = await response.json();

        if (result) {
          if (data.success) {
            result.className = 'mt-6 p-4 rounded-lg bg-green-50 border border-green-200 text-green-800';
            result.innerHTML = `
              <div class="font-semibold">‚úÖ Kampanj skapad!</div>
              <div class="text-sm mt-1">
                ${data.antalSkickade} av ${data.antalMottagare} SMS skickade
                ${data.gradvisUtskick ? ' (gradvis utskick aktiverat)' : ''}
              </div>
              <a href="/personal/kort-varsel?id=${data.kampanjId}" class="text-green-700 underline text-sm mt-2 inline-block">
                Visa kampanj ‚Üí
              </a>
            `;
            form.reset();
            updateMatchandePatienter();
            laddaPatientpool(); // Uppdatera poolen
          } else {
            result.className = 'mt-6 p-4 rounded-lg bg-red-50 border border-red-200 text-red-800';
            result.textContent = data.error || 'N√•got gick fel';
          }
          result.classList.remove('hidden');
        }
      } catch (error) {
        if (result) {
          result.className = 'mt-6 p-4 rounded-lg bg-red-50 border border-red-200 text-red-800';
          result.textContent = 'Kunde inte skapa SMS-utskick. F√∂rs√∂k igen.';
          result.classList.remove('hidden');
        }
      }
    });

    // Initial uppdatering av matchande patienter
    // (g√∂rs n√§r laddaPatientpool() har k√∂rt klart)

    // ========== DASHBOARD / √ñVERSIKT ==========
    let svarsfordelningChart: any = null;

    async function laddaDashboard(period: string = '30') {
      try {
        const response = await fetch(`/api/statistik/oversikt?period=${period}`);
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Kunde inte h√§mta statistik');
        }
        
        // Uppdatera nyckeltal
        uppdateraNyckeltal(data.nyckeltal, data.trend);
        
        // Rendera svarsf√∂rdelning
        renderaSvarsfordelningChart(data.svarsfordelning);
        
        // Rendera dimensioner
        renderaDimensioner(data.dimensioner);
        
      } catch (error) {
        console.error('Fel vid laddning av dashboard:', error);
      }
    }

    function renderaDimensioner(dimensioner: any) {
      // Operationsstorlek
      const opStorlekEl = document.getElementById('dimension-opstorlek');
      if (opStorlekEl) {
        if (dimensioner.opStorlek.length === 0) {
          opStorlekEl.innerHTML = '<p class="text-gray-500 text-sm italic">Ingen data √§nnu</p>';
        } else {
          opStorlekEl.innerHTML = dimensioner.opStorlek.map((d: any) => renderaDimensionRad(d)).join('');
        }
      }
      
      // Sida
      const sidaEl = document.getElementById('dimension-sida');
      if (sidaEl) {
        if (dimensioner.sida.length === 0) {
          sidaEl.innerHTML = '<p class="text-gray-500 text-sm italic">Ingen data √§nnu</p>';
        } else {
          sidaEl.innerHTML = dimensioner.sida.map((d: any) => renderaDimensionRad(d)).join('');
        }
      }
    }

    function renderaDimensionRad(d: any) {
      const jaProc = d.totalt > 0 ? Math.round(100 * d.ja / d.totalt) : 0;
      const nejProc = d.totalt > 0 ? Math.round(100 * d.nej / d.totalt) : 0;
      const ingenProc = 100 - jaProc - nejProc;
      
      return `
        <div class="border-b border-gray-100 pb-3 last:border-0 last:pb-0">
          <div class="flex justify-between items-center mb-1">
            <span class="font-medium text-gray-800">${d.namn}</span>
            <span class="text-sm text-gray-500">${d.totalt} SMS</span>
          </div>
          <div class="flex h-4 rounded-full overflow-hidden bg-gray-100">
            <div class="bg-green-500 transition-all" style="width: ${jaProc}%" title="JA: ${d.ja}"></div>
            <div class="bg-red-500 transition-all" style="width: ${nejProc}%" title="NEJ: ${d.nej}"></div>
            <div class="bg-gray-300 transition-all" style="width: ${ingenProc}%" title="Inget svar: ${d.ingenSvar}"></div>
          </div>
          <div class="flex justify-between text-xs text-gray-500 mt-1">
            <span class="text-green-600">JA ${d.jaRate}%</span>
            <span>Inget svar: ${d.ingenSvar}</span>
          </div>
        </div>
      `;
    }

    // ========== TRENDANALYS ==========
    let trendChart: any = null;

    async function laddaTrend(period: string = '90') {
      const laddarEl = document.getElementById('trend-laddar');
      const innehallEl = document.getElementById('trend-innehall');
      const ingenDataEl = document.getElementById('trend-ingen-data');
      
      if (!laddarEl || !innehallEl || !ingenDataEl) return;
      
      laddarEl.classList.remove('hidden');
      innehallEl.classList.add('hidden');
      ingenDataEl.classList.add('hidden');
      
      try {
        await laddaChartJs();
        
        const response = await fetch(`/api/statistik/trend?period=${period}`);
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Kunde inte h√§mta trenddata');
        }
        
        laddarEl.classList.add('hidden');
        
        // Kolla om det finns data
        const harData = data.veckodata.some((v: any) => v.smsSkickade > 0);
        if (!harData) {
          ingenDataEl.classList.remove('hidden');
          return;
        }
        
        innehallEl.classList.remove('hidden');
        renderaTrendChart(data.veckodata);
        
      } catch (error) {
        console.error('Fel vid laddning av trenddata:', error);
        laddarEl.classList.add('hidden');
        ingenDataEl.classList.remove('hidden');
      }
    }

    async function renderaTrendChart(veckodata: any[]) {
      const canvas = document.getElementById('trend-chart') as HTMLCanvasElement;
      if (!canvas || !Chart) return;
      
      if (trendChart) {
        trendChart.destroy();
      }
      
      const ctx = canvas.getContext('2d');
      if (!ctx) return;
      
      // Registrera LineController om det inte redan √§r gjort
      const chartModule = await import('chart.js');
      Chart.register(
        chartModule.LineController,
        chartModule.LineElement,
        chartModule.PointElement
      );
      
      trendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: veckodata.map(v => v.vecka),
          datasets: [
            {
              label: 'JA-rate (%)',
              data: veckodata.map(v => v.jaRate),
              borderColor: '#22c55e',
              backgroundColor: 'rgba(34, 197, 94, 0.1)',
              fill: true,
              tension: 0.3,
              yAxisID: 'y',
            },
            {
              label: 'Svarstid (min)',
              data: veckodata.map(v => v.medelSvarstidMin),
              borderColor: '#0ea5e9',
              backgroundColor: 'transparent',
              tension: 0.3,
              yAxisID: 'y1',
            },
            {
              label: 'SMS/vecka',
              data: veckodata.map(v => v.smsSkickade),
              borderColor: '#a855f7',
              backgroundColor: 'transparent',
              tension: 0.3,
              yAxisID: 'y2',
            },
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: {
              display: false,
            },
            tooltip: {
              callbacks: {
                afterBody: function(context: any) {
                  const idx = context[0].dataIndex;
                  const v = veckodata[idx];
                  return [
                    `Kampanjer: ${v.kampanjer}`,
                    `JA: ${v.jaSvar}, NEJ: ${v.nejSvar}`,
                    `Svarsfrekvens: ${v.svarsRate}%`
                  ];
                }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              min: 0,
              max: 100,
              title: {
                display: true,
                text: 'JA-rate (%)'
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              min: 0,
              title: {
                display: true,
                text: 'Svarstid (min)'
              },
              grid: {
                drawOnChartArea: false,
              },
            },
            y2: {
              type: 'linear',
              display: false,
              min: 0,
            },
          },
          animation: {
            duration: 800,
            easing: 'easeOutQuart'
          }
        }
      });
    }

    function uppdateraNyckeltal(nyckeltal: any, trend: any) {
      // Kampanjer
      const kampanjerEl = document.getElementById('nyckeltal-kampanjer');
      const kampanjerTrendEl = document.getElementById('nyckeltal-kampanjer-trend');
      if (kampanjerEl) kampanjerEl.textContent = nyckeltal.kampanjer.toString();
      if (kampanjerTrendEl && trend.kampanjerTrend !== 0) {
        kampanjerTrendEl.classList.remove('hidden');
        kampanjerTrendEl.textContent = trend.kampanjerTrend > 0 
          ? `‚Üë ${trend.kampanjerTrend}` 
          : `‚Üì ${Math.abs(trend.kampanjerTrend)}`;
        kampanjerTrendEl.className = `text-xs font-medium ${trend.kampanjerTrend > 0 ? 'text-green-600' : 'text-red-600'}`;
      }
      
      // Fyllda tider
      const fylldaSmsEl = document.getElementById('nyckeltal-fyllda-sms');
      const fylldaManueltEl = document.getElementById('nyckeltal-fyllda-manuellt');
      if (fylldaSmsEl) fylldaSmsEl.textContent = nyckeltal.fylldaViaSms.toString();
      if (fylldaManueltEl) fylldaManueltEl.textContent = nyckeltal.fylldaManuellt.toString();
      
      // SMS skickade
      const smsSkickadeEl = document.getElementById('nyckeltal-sms-skickade');
      const smsPerFylldEl = document.getElementById('nyckeltal-sms-per-fylld');
      if (smsSkickadeEl) smsSkickadeEl.textContent = nyckeltal.smsSkickade.toString();
      if (smsPerFylldEl) smsPerFylldEl.textContent = nyckeltal.smsPerFylldTid.toString();
      
      // JA-rate
      const jarateEl = document.getElementById('nyckeltal-jarate');
      const jarateTrendEl = document.getElementById('nyckeltal-jarate-trend');
      const svarsrateEl = document.getElementById('nyckeltal-svarsrate');
      if (jarateEl) jarateEl.textContent = `${nyckeltal.jaRate}%`;
      if (svarsrateEl) svarsrateEl.textContent = `${nyckeltal.svarsRate}%`;
      if (jarateTrendEl && trend.jaRateTrend !== 0) {
        jarateTrendEl.classList.remove('hidden');
        jarateTrendEl.textContent = trend.jaRateTrend > 0 
          ? `‚Üë ${trend.jaRateTrend}%` 
          : `‚Üì ${Math.abs(trend.jaRateTrend)}%`;
        jarateTrendEl.className = `text-xs font-medium ${trend.jaRateTrend > 0 ? 'text-green-600' : 'text-red-600'}`;
      }
    }

    async function renderaSvarsfordelningChart(svarsfordelning: any[]) {
      await laddaChartJs();
      
      const canvas = document.getElementById('svarsfordelning-chart') as HTMLCanvasElement;
      if (!canvas || !Chart) return;
      
      if (svarsfordelningChart) {
        svarsfordelningChart.destroy();
      }
      
      const ctx = canvas.getContext('2d');
      if (!ctx) return;
      
      svarsfordelningChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: svarsfordelning.map(s => `${KATEGORI_IKONER[s.kategori] || ''} ${s.kategori}`),
          datasets: [
            {
              label: 'JA',
              data: svarsfordelning.map(s => s.ja),
              backgroundColor: '#22c55e', // green-500
              borderRadius: 4,
            },
            {
              label: 'NEJ',
              data: svarsfordelning.map(s => s.nej),
              backgroundColor: '#ef4444', // red-500
              borderRadius: 4,
            },
            {
              label: 'Inget svar',
              data: svarsfordelning.map(s => s.ingenSvar),
              backgroundColor: '#d1d5db', // gray-300
              borderRadius: 4,
            },
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                afterBody: function(context: any) {
                  const idx = context[0].dataIndex;
                  const s = svarsfordelning[idx];
                  return [`JA-rate: ${s.jaRate}%`, `Totalt: ${s.totalt} SMS`];
                }
              }
            }
          },
          scales: {
            x: {
              stacked: true,
              grid: { display: false }
            },
            y: {
              stacked: true,
              beginAtZero: true,
              title: {
                display: true,
                text: 'Antal'
              }
            }
          },
          animation: {
            duration: 800,
            easing: 'easeOutQuart'
          }
        }
      });
    }

    // Hantera dashboard-periodv√§ljare
    const dashboardPeriodSelect = document.getElementById('dashboard-period') as HTMLSelectElement;
    if (dashboardPeriodSelect) {
      dashboardPeriodSelect.addEventListener('change', () => {
        const period = dashboardPeriodSelect.value;
        laddaDashboard(period);
        laddaTrend(period);
        // Synka svarstid-perioden
        const svarstidPeriod = document.getElementById('svarstid-period') as HTMLSelectElement;
        if (svarstidPeriod) {
          svarstidPeriod.value = period;
          laddaSvarstidsstatistik(period);
        }
      });
    }

    // ========== SVARSTIDSSTATISTIK (Chart.js) ==========
    // Importera Chart.js dynamiskt
    let Chart: any = null;
    let kategoriChart: any = null;
    let tidChart: any = null;

    const KATEGORI_FARGER_HEX: Record<string, string> = {
      'AKUT': '#ef4444',        // red-500
      'Sjukskriven': '#f97316', // orange-500
      'Mycket ont': '#f59e0b',  // amber-500
      'Normal': '#0ea5e9',      // sky-500
    };

    const KATEGORI_IKONER: Record<string, string> = {
      'AKUT': 'üö®',
      'Sjukskriven': 'üìã',
      'Mycket ont': 'üî•',
      'Normal': '‚è∞',
    };

    async function laddaChartJs() {
      if (Chart) return;
      // Dynamisk import av Chart.js
      const chartModule = await import('chart.js');
      Chart = chartModule.Chart;
      // Registrera alla komponenter
      Chart.register(
        chartModule.CategoryScale,
        chartModule.LinearScale,
        chartModule.BarController,
        chartModule.BarElement,
        chartModule.Title,
        chartModule.Tooltip,
        chartModule.Legend
      );
    }

    async function laddaSvarstidsstatistik(period: string = '90') {
      const laddarEl = document.getElementById('svarstid-laddar');
      const innehallEl = document.getElementById('svarstid-innehall');
      const ingenDataEl = document.getElementById('svarstid-ingen-data');
      
      if (!laddarEl || !innehallEl || !ingenDataEl) return;
      
      // Visa laddningsindikator
      laddarEl.classList.remove('hidden');
      innehallEl.classList.add('hidden');
      ingenDataEl.classList.add('hidden');
      
      try {
        // Ladda Chart.js parallellt med API-anropet
        const [response] = await Promise.all([
          fetch(`/api/statistik/svarstid?period=${period}`),
          laddaChartJs()
        ]);
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Kunde inte h√§mta statistik');
        }
        
        // D√∂lj laddningsindikator
        laddarEl.classList.add('hidden');
        
        // Kolla om det finns data
        if (data.totalt.antalSvar === 0) {
          ingenDataEl.classList.remove('hidden');
          return;
        }
        
        innehallEl.classList.remove('hidden');
        
        // Uppdatera totalt
        const totaltAntalEl = document.getElementById('svarstid-totalt-antal');
        const totaltMedelEl = document.getElementById('svarstid-totalt-medel');
        if (totaltAntalEl) totaltAntalEl.textContent = data.totalt.antalSvar.toString();
        if (totaltMedelEl) totaltMedelEl.textContent = `${data.totalt.medelSvarstidMin} min`;
        
        // Rendera Chart.js-grafer
        renderaKategoriChart(data.kategorier);
        renderaTidChart(data.tidPaDagen);
        
        // Rendera tabell
        renderaSvarstidTabell(data.kategorier);
        
      } catch (error) {
        console.error('Fel vid laddning av svarstidsstatistik:', error);
        laddarEl.classList.add('hidden');
        ingenDataEl.classList.remove('hidden');
      }
    }

    function renderaKategoriChart(kategorier: any[]) {
      const canvas = document.getElementById('svarstid-kategori-chart') as HTMLCanvasElement;
      if (!canvas || !Chart) return;
      
      // F√∂rst√∂r befintlig graf
      if (kategoriChart) {
        kategoriChart.destroy();
      }
      
      const ctx = canvas.getContext('2d');
      if (!ctx) return;
      
      kategoriChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: kategorier.map(k => `${KATEGORI_IKONER[k.kategori] || ''} ${k.kategori}`),
          datasets: [{
            label: 'Medel svarstid (min)',
            data: kategorier.map(k => k.medelSvarstidMin),
            backgroundColor: kategorier.map(k => KATEGORI_FARGER_HEX[k.kategori] || '#6b7280'),
            borderRadius: 6,
            borderSkipped: false,
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context: any) {
                  const idx = context.dataIndex;
                  const kat = kategorier[idx];
                  return [
                    `Medel: ${kat.medelSvarstidMin} min`,
                    `Median: ${Math.round(kat.medianSvarstidSek / 60)} min`,
                    `Antal svar: ${kat.antalSvar}`,
                    `JA-rate: ${kat.jaRate}%`
                  ];
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Minuter'
              },
              grid: {
                color: 'rgba(0,0,0,0.05)'
              }
            },
            y: {
              grid: {
                display: false
              }
            }
          },
          animation: {
            duration: 800,
            easing: 'easeOutQuart'
          }
        }
      });
    }

    function renderaTidChart(tidPaDagen: any[]) {
      const canvas = document.getElementById('svarstid-tid-chart') as HTMLCanvasElement;
      if (!canvas || !Chart) return;
      
      // F√∂rst√∂r befintlig graf
      if (tidChart) {
        tidChart.destroy();
      }
      
      const ctx = canvas.getContext('2d');
      if (!ctx) return;
      
      tidChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: tidPaDagen.map(t => t.tidsblock),
          datasets: [{
            label: 'Medel svarstid (min)',
            data: tidPaDagen.map(t => t.medelSvarstidMin),
            backgroundColor: tidPaDagen.map(t => {
              // F√§rgl√§gg baserat p√• svarstid (gr√∂n = snabb, gul = medel, r√∂d = l√•ngsam)
              if (t.medelSvarstidMin <= 15) return '#22c55e'; // green-500
              if (t.medelSvarstidMin <= 25) return '#eab308'; // yellow-500
              return '#ef4444'; // red-500
            }),
            borderRadius: 4,
            borderSkipped: false,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context: any) {
                  const idx = context.dataIndex;
                  const tid = tidPaDagen[idx];
                  return [
                    `Svarstid: ${tid.medelSvarstidMin} min`,
                    `Antal svar: ${tid.antalSvar}`,
                    `JA-rate: ${tid.jaRate}%`
                  ];
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Tid p√• dagen'
              },
              grid: {
                display: false
              }
            },
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Minuter'
              },
              grid: {
                color: 'rgba(0,0,0,0.05)'
              }
            }
          },
          animation: {
            duration: 800,
            easing: 'easeOutQuart'
          }
        }
      });
    }

    function renderaSvarstidTabell(kategorier: any[]) {
      const tabellEl = document.getElementById('svarstid-tabell');
      if (!tabellEl) return;
      
      tabellEl.innerHTML = kategorier.map(k => {
        const ikon = KATEGORI_IKONER[k.kategori] || '';
        
        return `
          <tr class="border-b border-gray-100">
            <td class="py-2">
              <span class="inline-flex items-center gap-1">
                <span>${ikon}</span>
                <span>${k.kategori}</span>
              </span>
            </td>
            <td class="py-2 text-right text-gray-600">${k.antalSvar}</td>
            <td class="py-2 text-right font-medium">${k.medelSvarstidMin} min</td>
            <td class="py-2 text-right text-gray-600">${Math.round(k.medianSvarstidSek / 60)} min</td>
            <td class="py-2 text-right">
              <span class="${k.jaRate >= 50 ? 'text-green-600' : 'text-gray-600'} font-medium">
                ${k.jaRate}%
              </span>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Hantera periodv√§ljare
    const periodSelect = document.getElementById('svarstid-period') as HTMLSelectElement;
    if (periodSelect) {
      periodSelect.addEventListener('change', () => {
        laddaSvarstidsstatistik(periodSelect.value);
      });
    }

    // Ladda statistik n√§r Historik-fliken visas
    const historikTab = document.getElementById('tab-historik');
    let dashboardLaddad = false;
    
    if (historikTab) {
      historikTab.addEventListener('click', () => {
        const period = dashboardPeriodSelect?.value || '30';
        
        // Ladda dashboard (alltid vid klick f√∂r f√§rsk data)
        laddaDashboard(period);
        
        // Ladda trendanalys
        laddaTrend(period);
        
        // Ladda svarstidsstatistik
        const innehallEl = document.getElementById('svarstid-innehall');
        const ingenDataEl = document.getElementById('svarstid-ingen-data');
        const laddarEl = document.getElementById('svarstid-laddar');
        
        // Om ingen av vyerna visas (f√∂rsta laddningen)
        if (innehallEl?.classList.contains('hidden') && 
            ingenDataEl?.classList.contains('hidden') &&
            laddarEl?.classList.contains('hidden')) {
          laddarEl?.classList.remove('hidden');
        }
        
        laddaSvarstidsstatistik(period);
      });
    }
  </script>
</BaseLayout>
