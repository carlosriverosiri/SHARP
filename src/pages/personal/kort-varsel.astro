---
/**
 * Dashboard f√∂r Kort varsel SMS
 * URL: /personal/kort-varsel
 */

export const prerender = false;

import BaseLayout from '../../layouts/BaseLayout.astro';
import { hamtaAnvandare, arInloggad } from '../../lib/auth';
import { supabaseAdmin, supabaseKonfigurerad } from '../../lib/supabase';

// Kontrollera inloggning
if (!await arInloggad(Astro.cookies)) {
  return Astro.redirect('/personal/');
}

const anvandare = await hamtaAnvandare(Astro.cookies);

// Om anv√§ndare √§r null trots inloggning, omdirigera
if (!anvandare) {
  return Astro.redirect('/personal/');
}

// H√§mta l√§kare
let lakare: any[] = [];
let lakareError: string | null = null;

if (supabaseKonfigurerad) {
  try {
    const { data, error } = await supabaseAdmin
      .from('lakare')
      .select('id, namn, kortnamn')
      .eq('aktiv', true)
      .order('namn');
    
    if (error) {
      lakareError = `L√§kare: ${error.message || 'Ok√§nt fel'}`;
    } else {
      lakare = data || [];
    }
  } catch (error: any) {
    lakareError = `L√§kare: ${error?.message || 'Exception'}`;
  }
} else {
  lakareError = 'Supabase √§r inte konfigurerat';
}

// H√§mta personal f√∂r notifieringslistan
let personal: any[] = [];
let personalError: string | null = null;

if (supabaseKonfigurerad) {
  try {
    const { data, error } = await supabaseAdmin
      .from('profiles')
      .select('id, email, mobilnummer, vill_ha_notifikationer')
      .order('email');
    
    if (error) {
      personalError = `Personal: ${error.message || 'Ok√§nt fel'}`;
    } else {
      personal = data || [];
    }
  } catch (error: any) {
    personalError = `Personal: ${error?.message || 'Exception'}`;
  }
}

// H√§mta kampanjer
let kampanjer: any[] = [];
let kampanjerError: string | null = null;

if (supabaseKonfigurerad) {
  try {
    const { data, error } = await supabaseAdmin
      .from('sms_kampanjer')
      .select('*')
      .order('skapad_vid', { ascending: false })
      .limit(20);
    
    if (error) {
      kampanjerError = `Kampanjer: ${error.message || 'Ok√§nt fel'}`;
    } else {
      kampanjer = data || [];
    }
  } catch (error: any) {
    kampanjerError = `Kampanjer: ${error?.message || 'Exception'}`;
  }
}

// URL-parameter f√∂r att visa specifik kampanj (?id=...)
const kampanjIdFromUrl = Astro.url.searchParams.get('id');

// H√§mta statistik
let statistik: any = null;
let statistikError: string | null = null;

if (supabaseKonfigurerad) {
  try {
    const { data, error } = await supabaseAdmin
      .from('kort_varsel_statistik')
      .select('*')
      .single();
    
    if (error) {
      statistikError = `Statistik: ${error.message || 'Ok√§nt fel'}`;
    } else {
      statistik = data;
    }
  } catch (error: any) {
    statistikError = `Statistik: ${error?.message || 'Exception'}`;
  }
}
---

<BaseLayout title="Kort varsel SMS | Personalportal" description="Hantera kort varsel SMS-kampanjer">
  <div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
      <div class="max-w-7xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            <a href="/personal/oversikt" class="text-gray-500 hover:text-gray-700">
              ‚Üê Tillbaka
            </a>
            <h1 class="text-2xl font-bold text-gray-900">üì± Kort varsel SMS</h1>
          </div>
          <div class="text-sm text-gray-500">
            Inloggad som {anvandare.email}
          </div>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8" data-kampanj-id={kampanjIdFromUrl || ''}>
      <!-- Debug: Visa om Supabase inte √§r konfigurerat -->
      {!supabaseKonfigurerad && (
        <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
          <h3 class="text-sm font-semibold text-red-800 mb-2">‚ùå Supabase inte konfigurerat</h3>
          <p class="text-xs text-red-700">
            Milj√∂variablerna <code>PUBLIC_SUPABASE_URL</code> eller <code>SUPABASE_SERVICE_ROLE_KEY</code> saknas.
            Kontrollera Netlify-inst√§llningar ‚Üí Environment variables.
          </p>
        </div>
      )}
      
      <!-- Debug: Visa felmeddelanden om n√•got gick fel -->
      {(lakareError || personalError || kampanjerError || statistikError) && (
        <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
          <h3 class="text-sm font-semibold text-yellow-800 mb-2">‚ö†Ô∏è Varningar vid databasanslutning:</h3>
          <ul class="text-xs text-yellow-700 space-y-1">
            {lakareError && <li>‚Ä¢ {lakareError}</li>}
            {personalError && <li>‚Ä¢ {personalError}</li>}
            {kampanjerError && <li>‚Ä¢ {kampanjerError}</li>}
            {statistikError && <li>‚Ä¢ {statistikError}</li>}
          </ul>
          <p class="text-xs text-yellow-600 mt-2">
            Sidan fungerar fortfarande, men vissa data kan saknas. Kontrollera Netlify-funktionsloggar f√∂r mer information.
          </p>
        </div>
      )}
      
      <!-- Flikar -->
      <div class="mb-6 border-b border-gray-200">
        <nav class="flex gap-4 md:gap-6 overflow-x-auto" role="tablist">
          <button 
            id="tab-pool"
            class="tab-button pb-3 px-1 text-sm font-medium border-b-2 border-sky-500 text-sky-600 whitespace-nowrap"
            data-tab="pool"
          >
            üë• Patientpool
          </button>
          <button 
            id="tab-kampanj"
            class="tab-button pb-3 px-1 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap"
            data-tab="kampanj"
          >
            üì§ Skapa kampanj
          </button>
          <button 
            id="tab-aktiva"
            class="tab-button pb-3 px-1 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap"
            data-tab="aktiva"
          >
            <span class="inline-flex items-center gap-1">
              <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
              Aktiva
            </span>
          </button>
          <button 
            id="tab-historik"
            class="tab-button pb-3 px-1 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap"
            data-tab="historik"
          >
            üìã Historik
          </button>
        </nav>
      </div>

      <!-- ========== PATIENTPOOL-VY ========== -->
      <div id="panel-pool" class="tab-panel">
        <div class="flex flex-col lg:flex-row gap-6">
          
          <!-- ===== V√ÑNSTER HUVUDKOLUMN ===== -->
          <div class="flex-1 space-y-5">
            
            <!-- Kompakt statistik-rad -->
            <div class="flex flex-wrap gap-3">
              <div class="bg-white rounded-lg shadow-sm border px-4 py-2 flex items-center gap-2">
                <span class="text-xl font-bold text-sky-600" id="stat-tillgangliga">-</span>
                <span class="text-xs text-gray-500">tillg√§ngliga</span>
              </div>
              <div class="bg-yellow-50 rounded-lg border border-yellow-200 px-4 py-2 flex items-center gap-2">
                <span class="text-xl font-bold text-yellow-600" id="stat-reserv">-</span>
                <span class="text-xs text-yellow-700">‚≠ê reserv</span>
              </div>
              <div class="bg-white rounded-lg shadow-sm border px-4 py-2 flex items-center gap-2">
                <span class="text-xl font-bold text-gray-500" id="stat-totalt">-</span>
                <span class="text-xs text-gray-500">totalt</span>
              </div>
            </div>

            <!-- L√§gg till patienter (kompaktare) -->
            <div class="bg-white rounded-xl shadow-sm border p-5">
              <h3 class="text-base font-semibold text-gray-900 mb-3">‚ûï L√§gg till patient</h3>
              
              <div class="grid grid-cols-2 md:grid-cols-6 gap-3 mb-3">
                <div>
                  <label class="block text-xs font-medium text-gray-600 mb-1">L√§kare *</label>
                  <select 
                    id="patient-lakare"
                    class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500"
                  >
                    <option value="">V√§lj...</option>
                    {lakare?.map(l => (
                      <option value={l.namn}>{l.namn}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 mb-1">Op-datum *</label>
                  <input 
                    type="date" 
                    id="patient-op-datum"
                    class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500"
                  />
                </div>
                <div class="flex items-end pb-1">
                  <label class="flex items-center gap-1.5 cursor-pointer">
                    <input type="checkbox" id="patient-flexibel" class="rounded" />
                    <span class="text-xs text-gray-600">Flexibel l√§kare</span>
                  </label>
                </div>
                <div class="flex items-end pb-1">
                  <label class="flex items-center gap-1.5 cursor-pointer bg-red-100 border-2 border-red-300 rounded px-2 py-1">
                    <input type="checkbox" id="patient-akut" class="rounded text-red-600 focus:ring-red-500" />
                    <span class="text-xs text-red-700 font-bold">üö® AKUT</span>
                  </label>
                </div>
                <div class="flex items-end pb-1">
                  <label class="flex items-center gap-1.5 cursor-pointer bg-orange-50 border border-orange-200 rounded px-2 py-1">
                    <input type="checkbox" id="patient-ont" class="rounded text-orange-600 focus:ring-orange-500" />
                    <span class="text-xs text-orange-700 font-medium">üî• Ont</span>
                  </label>
                </div>
                <div class="flex items-end pb-1">
                  <label class="flex items-center gap-1.5 cursor-pointer bg-blue-50 border border-blue-200 rounded px-2 py-1">
                    <input type="checkbox" id="patient-sjukskriven" class="rounded text-blue-600 focus:ring-blue-500" />
                    <span class="text-xs text-blue-700 font-medium">üìã Sjukskr.</span>
                  </label>
                </div>
              </div>
              
              <div class="flex gap-2">
                <textarea 
                  id="nya-patienter"
                  rows="2"
                  placeholder="Namn Personnummer&#10;Mobilnummer: 07X-XXX XX XX"
                  class="flex-1 px-2 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 font-mono text-xs"
                ></textarea>
                <button 
                  id="btn-lagg-till"
                  class="px-4 py-1.5 bg-sky-600 text-white text-sm font-medium rounded-lg hover:bg-sky-700 transition-colors self-start"
                >
                  L√§gg till
                </button>
              </div>
              
              <!-- Felmeddelande f√∂r dubbletter -->
              <div id="dubblett-varning" class="hidden mt-3 p-3 bg-red-50 border-2 border-red-300 rounded-lg">
                <div class="flex items-start gap-2">
                  <span class="text-lg">‚õî</span>
                  <div class="flex-1">
                    <h4 class="font-bold text-red-800 text-xs">DUBBLETT - REDAN I POOLEN</h4>
                    <div id="dubblett-lista" class="mt-1 space-y-1"></div>
                    <p class="text-red-600 text-xs mt-1">Ta bort patienten f√∂rst f√∂r att l√§gga till p√• nytt.</p>
                  </div>
                  <button id="stang-dubblett-varning" class="text-red-400 hover:text-red-600 font-bold" title="St√§ng">√ó</button>
                </div>
              </div>
              
              <!-- Succ√©meddelande -->
              <div id="tillagd-success" class="hidden mt-2 p-2 bg-green-50 border border-green-300 rounded-lg">
                <div class="flex items-center gap-2 text-green-700 text-sm">
                  <span>‚úÖ</span>
                  <span id="tillagd-success-text" class="font-medium"></span>
                </div>
              </div>
            </div>
            
            <!-- Filter + Tillg√§ngliga -->
            <div class="bg-white rounded-xl shadow-sm border p-5">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-base font-semibold text-gray-900">‚úÖ Tillg√§ngliga patienter</h3>
                <div class="flex items-center gap-2">
                  <select 
                    id="filter-lakare"
                    class="px-2 py-1 text-xs border border-gray-300 rounded focus:ring-2 focus:ring-sky-500"
                  >
                    <option value="">Alla l√§kare</option>
                    {lakare?.map(l => (
                      <option value={l.namn}>{l.namn}</option>
                    ))}
                  </select>
                  <label class="flex items-center gap-1 cursor-pointer text-xs text-gray-600">
                    <input type="checkbox" id="filter-inkludera-flexibla" checked class="rounded" />
                    +flexibla
                  </label>
                  <button id="btn-valj-alla" class="text-xs text-sky-600 hover:underline">V√§lj alla</button>
                </div>
              </div>
              
              <!-- Kolumnrubriker med sortering -->
              <div class="flex items-center gap-2 px-2 py-1.5 bg-gray-50 rounded-t border-b text-xs font-medium text-gray-600 mb-1">
                <div class="w-5"></div>
                <button id="sort-prioritet" class="w-12 text-center hover:text-red-600 cursor-pointer" title="Sortera p√• prioritet (ont/sjukskriven)">Prio ‚Üï</button>
                <button id="sort-namn" class="flex-1 text-left hover:text-sky-600 cursor-pointer">Namn ‚Üï</button>
                <button id="sort-alder" class="w-10 text-center hover:text-sky-600 cursor-pointer" title="Pension√§rer kommer l√§ttare">√Ölder ‚Üï</button>
                <button id="sort-lakare" class="w-20 text-left hover:text-sky-600 cursor-pointer">L√§kare ‚Üï</button>
                <button id="sort-dagar" class="w-12 text-right hover:text-sky-600 cursor-pointer">Dagar ‚Üï</button>
              </div>
              
              <div id="lista-tillgangliga" class="space-y-1 max-h-[50vh] overflow-y-auto">
                <p class="text-gray-400 italic text-sm">Laddar...</p>
              </div>
              
              <div class="mt-4 pt-3 border-t flex items-center justify-between">
                <span id="valda-count" class="text-sm text-gray-500">0 valda</span>
                <button 
                  id="btn-skapa-fran-pool"
                  disabled
                  class="px-4 py-2 bg-sky-600 text-white text-sm font-medium rounded-lg hover:bg-sky-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                >
                  üì§ Skapa kampanj med valda
                </button>
              </div>
            </div>
          </div>

          <!-- ===== H√ñGER SIDOKOLUMN ===== -->
          <div class="lg:w-72 space-y-4">
            
            <!-- Reserv (kompakt) -->
            <div class="bg-yellow-50 rounded-lg border border-yellow-200 p-4">
              <h4 class="text-sm font-semibold text-yellow-800 mb-2 flex items-center gap-1">
                ‚≠ê Reserv
                <span class="text-xs font-normal text-yellow-600">(prioriteras!)</span>
              </h4>
              <div id="lista-reserv" class="space-y-1 max-h-32 overflow-y-auto text-sm">
                <p class="text-yellow-600 italic text-xs">Inga</p>
              </div>
            </div>

            <!-- NEJ (kompakt) -->
            <div class="bg-red-50 rounded-lg border border-red-200 p-4">
              <div class="flex items-center justify-between mb-2">
                <h4 class="text-sm font-semibold text-red-800">‚ùå Tackat NEJ</h4>
                <span class="text-xs text-red-600" id="stat-nej">-</span>
              </div>
              <div id="lista-nej" class="space-y-1 max-h-40 overflow-y-auto text-sm">
                <p class="text-red-400 italic text-xs">Inga</p>
              </div>
              <p class="text-xs text-red-600 mt-2 italic">Klicka "Hanterad" efter uppdatering i journal</p>
            </div>

            <!-- Bokade (kompakt) -->
            <div class="bg-green-50 rounded-lg border border-green-200 p-4">
              <div class="flex items-center justify-between mb-2">
                <h4 class="text-sm font-semibold text-green-800">‚úÖ Bokade</h4>
                <span class="text-xs text-green-600" id="stat-bokade">-</span>
              </div>
              <div id="lista-bokade" class="space-y-1 max-h-32 overflow-y-auto text-sm">
                <p class="text-green-600 italic text-xs">Inga</p>
              </div>
            </div>

          </div>

        </div>
      </div>

      <!-- ========== SKAPA KAMPANJ-VY ========== -->
      <div id="panel-kampanj" class="tab-panel hidden">
        <div class="max-w-3xl mx-auto">
          <div class="bg-white rounded-xl shadow-sm border p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center gap-2">
              <span class="text-2xl">üì§</span>
              Skapa ny kampanj
            </h2>

            <form id="kampanj-form" class="space-y-6">
              <!-- Datum och antal platser -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Datum f√∂r operationen *
                  </label>
                  <input 
                    type="date" 
                    name="datum" 
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                  >
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Antal lediga platser *
                  </label>
                  <div class="flex gap-2">
                    <label class="flex-1">
                      <input type="radio" name="antalPlatser" value="1" checked class="sr-only peer">
                      <div class="text-center py-2 px-4 border-2 border-gray-300 rounded-lg cursor-pointer peer-checked:border-sky-500 peer-checked:bg-sky-50 peer-checked:text-sky-700 font-medium transition-colors">
                        1
                      </div>
                    </label>
                    <label class="flex-1">
                      <input type="radio" name="antalPlatser" value="2" class="sr-only peer">
                      <div class="text-center py-2 px-4 border-2 border-gray-300 rounded-lg cursor-pointer peer-checked:border-sky-500 peer-checked:bg-sky-50 peer-checked:text-sky-700 font-medium transition-colors">
                        2
                      </div>
                    </label>
                    <label class="flex-1">
                      <input type="radio" name="antalPlatser" value="3" class="sr-only peer">
                      <div class="text-center py-2 px-4 border-2 border-gray-300 rounded-lg cursor-pointer peer-checked:border-sky-500 peer-checked:bg-sky-50 peer-checked:text-sky-700 font-medium transition-colors">
                        3
                      </div>
                    </label>
                  </div>
                  <p class="text-xs text-gray-500 mt-1">
                    Hur m√•nga patienter s√∂ker ni?
                  </p>
                </div>
              </div>

              <!-- L√§kare (VIKTIGT!) -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Opererande l√§kare *
                </label>
                <select 
                  name="lakare"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                >
                  <option value="">-- V√§lj l√§kare --</option>
                  {lakare?.map(l => (
                    <option value={l.namn}>{l.namn}</option>
                  ))}
                </select>
                <p class="text-xs text-gray-500 mt-1">
                  Visas i SMS:et s√• patienten vet vem som opererar
                </p>
              </div>

              <!-- Tidsblock och operationstyp -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Tidsblock (valfritt)
                  </label>
                  <div class="flex gap-2">
                    <label class="flex-1">
                      <input type="radio" name="tidsblock" value="" checked class="sr-only peer">
                      <div class="text-center py-2 px-3 border border-gray-300 rounded-lg cursor-pointer peer-checked:border-sky-500 peer-checked:bg-sky-50 text-sm transition-colors">
                        Ingen info
                      </div>
                    </label>
                    <label class="flex-1">
                      <input type="radio" name="tidsblock" value="formiddag" class="sr-only peer">
                      <div class="text-center py-2 px-3 border border-gray-300 rounded-lg cursor-pointer peer-checked:border-sky-500 peer-checked:bg-sky-50 text-sm transition-colors">
                        F√∂rmiddag
                      </div>
                    </label>
                    <label class="flex-1">
                      <input type="radio" name="tidsblock" value="eftermiddag" class="sr-only peer">
                      <div class="text-center py-2 px-3 border border-gray-300 rounded-lg cursor-pointer peer-checked:border-sky-500 peer-checked:bg-sky-50 text-sm transition-colors">
                        Eftermiddag
                      </div>
                    </label>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Operationstyp (valfritt)
                  </label>
                  <input 
                    type="text" 
                    name="operationTyp" 
                    placeholder="T.ex. Kn√§artroskopi"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                  >
                  <p class="text-xs text-gray-500 mt-1">
                    Visas endast f√∂r patienter med samtycke
                  </p>
                </div>
              </div>

              <!-- Mottagare -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Mottagare (en per rad) *
                </label>
                <textarea 
                  name="mottagare" 
                  rows="6"
                  required
                  placeholder="Tolvan Tolvansson 19121212-1212
Mobilnummer: 070-123 45 67

Tretton Trettonsson 19131313-1313
Mobilnummer: 073-456 78 90"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 font-mono text-sm"
                ></textarea>
                <p class="text-xs text-gray-500 mt-1">
                  Klistra in direkt fr√•n journalsystemet. Samtycke s√§tts automatiskt till ja.
                </p>
              </div>

              <!-- Utskicksmetod -->
              <div class="bg-gray-50 rounded-lg p-4">
                <label class="block text-sm font-medium text-gray-700 mb-3">
                  Utskicksmetod
                </label>
                <div class="space-y-3">
                  <label class="flex items-start gap-3 cursor-pointer">
                    <input 
                      type="radio" 
                      name="utskicksmetod" 
                      value="direkt"
                      checked
                      class="mt-1"
                    >
                    <div>
                      <div class="font-medium text-gray-900">Skicka alla direkt</div>
                      <div class="text-sm text-gray-500">Alla patienter f√•r SMS samtidigt</div>
                    </div>
                  </label>
                  <label class="flex items-start gap-3 cursor-pointer">
                    <input 
                      type="radio" 
                      name="utskicksmetod" 
                      value="gradvis"
                      class="mt-1"
                    >
                    <div>
                      <div class="font-medium text-gray-900">Skicka gradvis (en i taget)</div>
                      <div class="text-sm text-gray-500">
                        V√§ntar mellan varje SMS - stoppar automatiskt n√§r alla platser √§r fyllda
                      </div>
                    </div>
                  </label>
                </div>

                <div id="intervall-section" class="mt-4 hidden">
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Intervall mellan SMS
                  </label>
                  <div class="flex items-center gap-2">
                    <select 
                      name="intervall" 
                      class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500"
                    >
                      <option value="5">5 minuter</option>
                      <option value="10" selected>10 minuter</option>
                      <option value="15">15 minuter</option>
                      <option value="20">20 minuter</option>
                      <option value="30">30 minuter</option>
                      <option value="45">45 minuter</option>
                      <option value="60">60 minuter (1 timme)</option>
                    </select>
                    <span class="text-sm text-gray-500">mellan varje SMS</span>
                  </div>
                  <p id="tid-berakning" class="text-sm text-sky-600 mt-2"></p>
                </div>
              </div>

              <!-- Tidsgr√§ns -->
              <div>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" name="harTidsGrans" class="rounded">
                  <span class="text-sm font-medium text-gray-700">
                    S√§tt sista svarstid
                  </span>
                </label>
                <div id="tidsgrans-section" class="mt-3 hidden">
                  <div class="grid grid-cols-2 gap-4">
                    <input 
                      type="date" 
                      name="tidsgransDatum"
                      class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500"
                    >
                    <input 
                      type="time" 
                      name="tidsgransTid"
                      value="18:00"
                      class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500"
                    >
                  </div>
                  <p class="text-xs text-gray-500 mt-1">
                    Efter denna tid kan patienter inte l√§ngre svara
                  </p>
                </div>
              </div>

              <!-- Notifiera personal -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Notifiera vid JA-svar
                </label>
                <div class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                  {personal?.filter(p => p.mobilnummer && p.vill_ha_notifikationer).map(p => (
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input 
                        type="checkbox" 
                        name="notifiera" 
                        value={p.id}
                        checked={p.id === anvandare?.id}
                        class="rounded"
                      >
                      <span class="text-sm text-gray-700">{p.email}</span>
                    </label>
                  ))}
                  {!personal?.some(p => p.mobilnummer && p.vill_ha_notifikationer) && (
                    <p class="text-sm text-gray-500 italic">
                      Ingen personal har registrerat mobilnummer. 
                      <a href="/personal/profil" class="text-sky-600 hover:underline">L√§gg till i din profil</a>
                    </p>
                  )}
                </div>
              </div>

              <!-- Submit -->
              <div class="flex items-center justify-between pt-4 border-t">
                <div id="mottagare-count" class="text-sm text-gray-500">
                  0 mottagare
                </div>
                <button 
                  type="submit"
                  class="px-6 py-3 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition-colors flex items-center gap-2"
                >
                  <span>üöÄ</span>
                  Skapa kampanj
                </button>
              </div>
            </form>

            <!-- Resultat -->
            <div id="result" class="hidden mt-6 p-4 rounded-lg"></div>
          </div>
        </div>
      </div> <!-- St√§ng panel-kampanj -->

      <!-- ========== AKTIVA KAMPANJER-VY ========== -->
      <div id="panel-aktiva" class="tab-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          
          <!-- V√§nster: Kampanjdetaljer (visas n√§r ?id= finns) -->
          <div class="lg:col-span-2">
            <div id="kampanj-detalj-wrap" class="hidden">
              <div class="bg-sky-50 rounded-xl shadow-sm border-2 border-sky-200 p-5">
                <div class="flex items-center justify-between mb-3">
                  <h2 id="kampanj-detalj-rubrik" class="text-lg font-semibold text-gray-900">üìã Vem svarade?</h2>
                  <span id="kampanj-detalj-datum" class="text-gray-500 text-sm"></span>
                </div>
                <div class="grid grid-cols-4 gap-2 mb-4">
                  <div class="bg-green-50 rounded-lg p-2 text-center">
                    <span id="kampanj-detalj-ja" class="text-xl font-bold text-green-700">0</span>
                    <div class="text-xs text-green-600">‚úÖ JA</div>
                  </div>
                  <div class="bg-yellow-50 rounded-lg p-2 text-center">
                    <span id="kampanj-detalj-reserv" class="text-xl font-bold text-yellow-700">0</span>
                    <div class="text-xs text-yellow-600">‚è∞ Reserv</div>
                  </div>
                  <div class="bg-red-50 rounded-lg p-2 text-center">
                    <span id="kampanj-detalj-nej" class="text-xl font-bold text-red-700">0</span>
                    <div class="text-xs text-red-600">‚ùå NEJ</div>
                  </div>
                  <div class="bg-gray-100 rounded-lg p-2 text-center">
                    <span id="kampanj-detalj-vantar" class="text-xl font-bold text-gray-700">0</span>
                    <div class="text-xs text-gray-600">‚è≥ V√§ntar</div>
                  </div>
                </div>
                <h3 class="font-medium text-gray-900 mb-2 text-sm">Mottagare</h3>
                <div id="kampanj-detalj-lista" class="space-y-1.5 max-h-64 overflow-y-auto"></div>
                
                <!-- Ut√∂ka kampanj -->
                <div id="kampanj-utoka-section" class="mt-4 pt-4 border-t border-sky-200">
                  <button 
                    id="btn-utoka-kampanj"
                    class="w-full px-3 py-2 bg-sky-100 text-sky-700 text-sm font-medium rounded-lg hover:bg-sky-200 transition-colors flex items-center justify-center gap-2"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    L√§gg till fler patienter
                  </button>
                  <p class="text-xs text-gray-500 mt-1 text-center">
                    Ut√∂ka kampanjen med fler mottagare
                  </p>
                </div>
                
                <!-- √Ötg√§rder -->
                <div id="kampanj-detalj-actions" class="mt-4 pt-4 border-t border-sky-200">
                  <p class="text-xs text-gray-600 mb-2">Avsluta kampanj:</p>
                  <div class="flex flex-wrap gap-2">
                    <button 
                      id="btn-fylld-manuellt"
                      class="px-3 py-1.5 bg-green-600 text-white text-xs font-medium rounded-lg hover:bg-green-700 transition-colors"
                    >
                      ‚úÖ Fylld manuellt
                    </button>
                    <button 
                      id="btn-avbokad"
                      class="px-3 py-1.5 bg-orange-500 text-white text-xs font-medium rounded-lg hover:bg-orange-600 transition-colors"
                    >
                      üìÖ Avbokad tid
                    </button>
                  </div>
                  <p class="text-xs text-gray-500 mt-2">
                    B√•da skickar SMS till v√§ntande patienter om att tiden √§r fylld
                  </p>
                </div>
              </div>
            </div>
            
            <!-- Tomt l√§ge n√§r ingen kampanj √§r vald -->
            <div id="kampanj-ingen-vald" class="bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 p-8 text-center">
              <div class="text-3xl mb-3">üëà</div>
              <h3 class="text-lg font-medium text-gray-900 mb-2">V√§lj en kampanj</h3>
              <p class="text-gray-500 text-sm">Klicka p√• en kampanj i listan till h√∂ger f√∂r att se detaljer</p>
            </div>
          </div>

          <!-- H√∂ger: Lista √∂ver aktiva kampanjer -->
          <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-sm border p-4">
              <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <span class="w-2.5 h-2.5 bg-green-500 rounded-full animate-pulse"></span>
                Aktiva kampanjer
              </h3>
              
              <div class="space-y-2">
                {kampanjer?.filter(k => k.status === 'aktiv' || k.status === 'fylld').length === 0 && (
                  <div class="text-center py-6">
                    <p class="text-gray-500 text-sm italic mb-3">Inga aktiva kampanjer</p>
                    <button 
                      onclick="document.getElementById('tab-kampanj')?.click()"
                      class="px-3 py-1.5 bg-sky-600 text-white text-sm font-medium rounded-lg hover:bg-sky-700 transition-colors"
                    >
                      üì§ Skapa kampanj
                    </button>
                  </div>
                )}
                {kampanjer?.filter(k => k.status === 'aktiv' || k.status === 'fylld').map(k => (
                  <a 
                    href={`/personal/kort-varsel?id=${k.id}`}
                    class="block p-3 border border-gray-200 rounded-lg hover:border-sky-400 hover:bg-sky-50 transition-colors"
                  >
                    <div class="flex items-center justify-between mb-1">
                      <span class={`px-2 py-0.5 text-xs font-medium rounded-full ${
                        k.status === 'fylld' 
                          ? 'bg-green-100 text-green-800' 
                          : 'bg-yellow-100 text-yellow-800'
                      }`}>
                        {k.status === 'fylld' ? 'üéâ Fylld' : '‚è≥ V√§ntar'}
                      </span>
                      <span class="text-gray-400 text-xs">
                        {k.skapad_vid ? new Date(k.skapad_vid).toLocaleDateString('sv-SE', { day: 'numeric', month: 'short' }) : '-'}
                      </span>
                    </div>
                    <div class="font-medium text-gray-900 text-sm">
                      {k.datum ? new Date(k.datum).toLocaleDateString('sv-SE', { weekday: 'short', day: 'numeric', month: 'short' }) : 'Inget datum'}
                    </div>
                    {k.lakare && (
                      <div class="text-xs text-gray-500 mt-1">{k.lakare}</div>
                    )}
                  </a>
                ))}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ========== HISTORIK-VY ========== -->
      <div id="panel-historik" class="tab-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
          
          <!-- V√§nster: Statistik -->
          <div class="lg:col-span-1 space-y-6">
            <!-- Statistik -->
            <div class="bg-white rounded-xl shadow-sm border p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">
                üìä Statistik (30 dagar)
              </h3>
              
              <div class="space-y-4">
                <div class="flex justify-between items-center">
                  <span class="text-gray-600">Kampanjer</span>
                  <span class="font-semibold">{statistik?.kampanjer_30_dagar || 0}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-600">Fyllda via SMS</span>
                  <span class="font-semibold text-green-600">{statistik?.fyllda_via_sms || 0}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-600">SMS skickade</span>
                  <span class="font-semibold">{statistik?.totalt_sms_skickade || 0}</span>
                </div>
                {statistik?.fyllda_via_sms > 0 && statistik?.totalt_sms_skickade > 0 && (
                  <div class="pt-3 border-t">
                    <div class="flex justify-between items-center">
                      <span class="text-gray-600">SMS per fylld tid</span>
                      <span class="font-semibold text-sky-600">
                        {(statistik.totalt_sms_skickade / statistik.fyllda_via_sms).toFixed(1)}
                      </span>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>

          <!-- H√∂ger: Kampanjlista -->
          <div class="lg:col-span-3">
            <div class="bg-white rounded-xl shadow-sm border p-6">
              <h2 class="text-xl font-semibold text-gray-900 mb-6">üìã Alla kampanjer</h2>
              
              <div class="space-y-4">
                {kampanjer?.map(k => (
                  <div class="border border-gray-200 rounded-lg p-4 hover:border-sky-300 transition-colors">
                    <div class="flex items-center justify-between">
                      <div>
                        <div class="font-medium text-gray-900">
                          {k.datum ? new Date(k.datum).toLocaleDateString('sv-SE', { weekday: 'long', day: 'numeric', month: 'long' }) : 'Inget datum'}
                          {k.tidsblock && ` (${k.tidsblock === 'formiddag' ? 'f√∂rmiddag' : 'eftermiddag'})`}
                        </div>
                        <div class="text-sm text-gray-500">
                          Skapad {k.skapad_vid ? new Date(k.skapad_vid).toLocaleDateString('sv-SE') : '-'}
                          {k.operation_typ && ` ‚Ä¢ ${k.operation_typ}`}
                          {k.lakare && ` ‚Ä¢ ${k.lakare}`}
                        </div>
                      </div>
                      <div class="flex items-center gap-3">
                        <span class={`px-3 py-1 text-sm font-medium rounded-full ${
                          k.utfall === 'fylld_via_sms' ? 'bg-green-100 text-green-700' :
                          k.utfall === 'fylld_manuellt' ? 'bg-blue-100 text-blue-700' :
                          k.utfall === 'misslyckad' ? 'bg-red-100 text-red-700' :
                          k.status === 'aktiv' ? 'bg-yellow-100 text-yellow-700' :
                          k.status === 'fylld' ? 'bg-green-100 text-green-700' :
                          'bg-gray-100 text-gray-600'
                        }`}>
                          {k.utfall === 'fylld_via_sms' ? '‚úÖ Fylld via SMS' :
                           k.utfall === 'fylld_manuellt' ? '‚úÖ Fylld manuellt' :
                           k.utfall === 'misslyckad' ? '‚ùå Misslyckad' :
                           k.status === 'aktiv' ? '‚è≥ Aktiv' :
                           k.status === 'fylld' ? '‚úÖ Fylld' : 'Avslutad'}
                        </span>
                        <a 
                          href={`/personal/kort-varsel?id=${k.id}`}
                          class="text-sky-600 hover:underline text-sm"
                        >
                          Visa ‚Üí
                        </a>
                      </div>
                    </div>
                  </div>
                ))}
                
                {!kampanjer?.length && (
                  <p class="text-gray-500 italic text-center py-8">Inga kampanjer √§nnu</p>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script>
    // ========== FLIKHANTERING ==========
    const tabs = document.querySelectorAll('.tab-button');
    const panels = document.querySelectorAll('.tab-panel');

    function visaPanel(panelKey: string) {
      const targetPanel = panelKey;
      tabs.forEach(t => {
        const key = t.getAttribute('data-tab');
        const isActive = key === targetPanel;
        t.classList.toggle('border-sky-500', isActive);
        t.classList.toggle('text-sky-600', isActive);
        t.classList.toggle('border-transparent', !isActive);
        t.classList.toggle('text-gray-500', !isActive);
      });
      panels.forEach(p => p.classList.add('hidden'));
      document.getElementById(`panel-${targetPanel}`)?.classList.remove('hidden');
    }

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const targetPanel = tab.getAttribute('data-tab');
        if (targetPanel) visaPanel(targetPanel);
      });
    });

    // ========== KAMPANJDETALJ (?id=) ==========
    async function laddaKampanjDetalj(kampanjId: string) {
      console.log('üì¶ laddaKampanjDetalj anropad med ID:', kampanjId);
      
      // Spara f√∂r avsluta-knappar (variabel definieras l√§ngre ner)
      (window as any).aktivKampanjId = kampanjId;
      
      const wrap = document.getElementById('kampanj-detalj-wrap');
      const ingenVald = document.getElementById('kampanj-ingen-vald');
      const actionsEl = document.getElementById('kampanj-detalj-actions');
      const utokaEl = document.getElementById('kampanj-utoka-section');
      const rubrik = document.getElementById('kampanj-detalj-rubrik');
      const datumEl = document.getElementById('kampanj-detalj-datum');
      const jaEl = document.getElementById('kampanj-detalj-ja');
      const reservEl = document.getElementById('kampanj-detalj-reserv');
      const nejEl = document.getElementById('kampanj-detalj-nej');
      const vantarEl = document.getElementById('kampanj-detalj-vantar');
      const listaEl = document.getElementById('kampanj-detalj-lista');
      
      console.log('üì¶ Element hittade:', { wrap: !!wrap, rubrik: !!rubrik, datumEl: !!datumEl, listaEl: !!listaEl });
      
      if (!wrap || !rubrik || !datumEl || !jaEl || !reservEl || !nejEl || !vantarEl || !listaEl) {
        console.error('‚ùå Kunde inte hitta alla element f√∂r kampanjdetalj');
        return;
      }

      // Visa detalj-wrap och d√∂lj "ingen vald"-meddelandet
      console.log('üëÅÔ∏è Visar kampanjdetalj-wrap och s√§tter Laddar...');
      wrap.classList.remove('hidden');
      ingenVald?.classList.add('hidden');
      rubrik.textContent = 'üìã Vem svarade?';
      datumEl.textContent = 'Laddar...';
      listaEl.innerHTML = '<p class="text-gray-400 italic text-sm">Laddar mottagare...</p>';

      try {
        console.log('üåê Fetchar kampanjstatus fr√•n API...');
        const response = await fetch(`/api/kampanj/status?id=${encodeURIComponent(kampanjId)}`, { credentials: 'include' });
        console.log('üì• API svarade med status:', response.status);
        
        const data = await response.json();
        console.log('üìä API-data:', data);
        
        if (!response.ok || data.error) {
          console.error('‚ùå API-fel:', data.error, 'Details:', data.details);
          rubrik.textContent = 'Kunde inte ladda kampanj';
          datumEl.textContent = `${data.error || 'Ok√§nt fel'}${data.details ? ' ‚Äì ' + data.details : ''}`;
          listaEl.innerHTML = `<p class="text-red-600 text-sm">API-fel: ${data.error}</p><p class="text-gray-500 text-xs mt-2">Kampanj-ID: ${kampanjId}</p>`;
          return;
        }

        const k = data.kampanj;
        const mottagare = data.mottagare || [];
        const stats = data.statistik || {};
        
        console.log('‚úÖ Renderar kampanjdetaljer:', { antalMottagare: mottagare.length, stats });

        // Kortare rubrik f√∂r smalare layout
        const datumStr = k.datum ? new Date(k.datum).toLocaleDateString('sv-SE', { day: 'numeric', month: 'short' }) : '';
        rubrik.textContent = `üìã ${datumStr}${k.operationTyp ? ' ‚Äì ' + k.operationTyp : ''}`;
        datumEl.textContent = k.status === 'fylld' ? '‚úÖ Fylld' : k.status === 'aktiv' ? '‚è≥ V√§ntar' : 'Avslutad';

        // Visa/d√∂lj avsluta-knappar och ut√∂ka-knapp beroende p√• status
        if (actionsEl) {
          if (k.status === 'aktiv') {
            actionsEl.classList.remove('hidden');
          } else {
            actionsEl.classList.add('hidden');
          }
        }
        if (utokaEl) {
          if (k.status === 'aktiv') {
            utokaEl.classList.remove('hidden');
          } else {
            utokaEl.classList.add('hidden');
          }
        }

        jaEl.textContent = String(stats.jaSvar ?? 0);
        reservEl.textContent = String(stats.reservSvar ?? 0);
        nejEl.textContent = String(stats.nejSvar ?? 0);
        vantarEl.textContent = String(stats.vantar ?? 0);

        // Sortera: Avregistrerade (beh√∂ver √•tg√§rd) f√∂rst, sen ja, reserv, nej, v√§ntar
        const sortOrder: Record<string, number> = { 'avregistrerad': 0, 'ja': 1, 'reserv': 2, 'nej': 3 };
        const sorterade = [...mottagare].sort((a: any, b: any) => {
          const aOrder = sortOrder[a.svar] ?? 4;
          const bOrder = sortOrder[b.svar] ?? 4;
          return aOrder - bOrder;
        });

        listaEl.innerHTML = sorterade.map((m: any) => {
          let badge = '';
          let extraClass = '';
          let actionTag = '';
          
          if (m.svar === 'ja') {
            badge = '‚úÖ';
          } else if (m.svar === 'reserv') {
            badge = '‚è∞';
          } else if (m.svar === 'nej') {
            badge = '‚ùå';
          } else if (m.svar === 'avregistrerad') {
            badge = 'üö´';
            extraClass = 'bg-amber-50 border-amber-200';
            actionTag = '<span class="text-xs bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded font-medium">‚Üí √Ñndra i kalender</span>';
          } else {
            badge = '‚è≥';
          }
          const namn = (m.namn || '').toString();
          return `<div class="flex items-center gap-2 p-2 rounded border text-sm ${extraClass || 'bg-white border-gray-100'}">
            <span class="flex-shrink-0">${badge}</span>
            <div class="flex-1 min-w-0">
              <span class="text-gray-900">${escapeHtml(namn)}</span>
              ${actionTag ? `<div class="mt-1">${actionTag}</div>` : ''}
            </div>
            <button 
              type="button"
              class="copy-namn-btn flex-shrink-0 p-1 text-gray-400 hover:text-sky-600 hover:bg-sky-50 rounded transition-colors cursor-pointer"
              data-namn="${escapeHtml(namn)}"
              title="Kopiera namn"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
            </button>
          </div>`;
        }).join('') || '<p class="text-gray-400 italic text-sm">Inga mottagare</p>';
        
        // L√§gg till klick-hanterare f√∂r kopiera namn
        listaEl.querySelectorAll('.copy-namn-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const button = e.currentTarget as HTMLButtonElement;
            const namn = button.getAttribute('data-namn') || '';
            
            try {
              await navigator.clipboard.writeText(namn);
              
              // Visuell feedback - byt till bock-ikon
              const originalHTML = button.innerHTML;
              button.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>`;
              button.classList.add('text-green-600', 'bg-green-50');
              button.classList.remove('text-gray-400');
              
              setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('text-green-600', 'bg-green-50');
                button.classList.add('text-gray-400');
              }, 1500);
            } catch (err) {
              console.error('Kunde inte kopiera:', err);
            }
          });
        });

      } catch (e) {
        rubrik.textContent = 'Kunde inte ladda kampanj';
        datumEl.textContent = 'N√§tverksfel';
        listaEl.innerHTML = '';
      }
    }

    function escapeHtml(s: string) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    // ========== AVSLUTA KAMPANJ ==========
    async function avslutaKampanj(utfall: 'fylld_manuellt' | 'avbruten') {
      const kampanjId = (window as any).aktivKampanjId;
      if (!kampanjId) {
        alert('Ingen kampanj vald');
        return;
      }
      
      const bekrafta = utfall === 'fylld_manuellt'
        ? confirm('Markera kampanjen som fylld manuellt?\n\nDetta inneb√§r att platsen bokades p√• annat s√§tt.\n\nSMS skickas till de som v√§ntar p√• svar.')
        : confirm('Markera tiden som avbokad?\n\nSMS skickas till de som v√§ntar p√• svar och informerar att tiden nu √§r bokad.');
      
      if (!bekrafta) return;
      
      try {
        const response = await fetch('/api/kampanj/avsluta', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            kampanjId: kampanjId,
            utfall: utfall,
            skickaAvslutSms: true, // Skicka SMS till de som v√§ntar
          }),
        });
        
        const data = await response.json();
        
        if (data.success) {
          const smsInfo = data.antalNotifierade > 0 
            ? `\n\n${data.antalNotifierade} SMS skickades till v√§ntande patienter.` 
            : '';
          alert(utfall === 'fylld_manuellt' 
            ? `‚úÖ Kampanjen markerades som fylld manuellt!${smsInfo}` 
            : `üìÖ Tiden markerades som avbokad!${smsInfo}`);
          window.location.href = '/personal/kort-varsel';
        } else {
          alert('N√•got gick fel: ' + (data.error || 'Ok√§nt fel'));
        }
      } catch (err) {
        console.error('Fel vid avslutning:', err);
        alert('N√§tverksfel ‚Äì kunde inte avsluta kampanjen');
      }
    }
    
    // Event listeners f√∂r avsluta-knappar
    document.getElementById('btn-fylld-manuellt')?.addEventListener('click', () => {
      avslutaKampanj('fylld_manuellt');
    });
    
    document.getElementById('btn-avbokad')?.addEventListener('click', () => {
      avslutaKampanj('avbruten');
    });

    // ========== UT√ñKA KAMPANJ ==========
    document.getElementById('btn-utoka-kampanj')?.addEventListener('click', async () => {
      const kampanjId = (window as any).aktivKampanjId;
      if (!kampanjId) {
        alert('Ingen kampanj vald');
        return;
      }
      
      // H√§mta tillg√§ngliga patienter fr√•n poolen
      const response = await fetch('/api/pool/lista');
      const data = await response.json();
      
      if (!data.success || !data.patienter?.length) {
        alert('Inga tillg√§ngliga patienter i poolen.\n\nG√• till fliken "Patientpool" f√∂r att l√§gga till patienter.');
        return;
      }
      
      // Filtrera bort de som redan √§r med i denna kampanj
      const nuvarandeMottagare = await fetch(`/api/kampanj/status?id=${kampanjId}`)
        .then(r => r.json())
        .then(d => d.mottagare?.map((m: any) => m.telefon_hash) || []);
      
      const tillgangliga = data.patienter.filter((p: any) => 
        p.status === 'tillganglig' && !nuvarandeMottagare.includes(p.telefon_hash)
      );
      
      if (!tillgangliga.length) {
        alert('Alla patienter i poolen √§r redan med i denna kampanj eller upptagna.');
        return;
      }
      
      // Fr√•ga hur m√•nga som ska l√§ggas till
      const antal = prompt(
        `${tillgangliga.length} patienter tillg√§ngliga i poolen.\n\nHur m√•nga vill du l√§gga till i kampanjen?`,
        Math.min(5, tillgangliga.length).toString()
      );
      
      if (!antal || isNaN(parseInt(antal)) || parseInt(antal) < 1) return;
      
      const antalAttLagga = Math.min(parseInt(antal), tillgangliga.length);
      const patienterAttLagga = tillgangliga.slice(0, antalAttLagga);
      
      // Visa vilka som kommer l√§ggas till
      const namnLista = patienterAttLagga.map((p: any) => `‚Ä¢ ${p.namn}`).join('\n');
      const bekrafta = confirm(
        `F√∂ljande ${antalAttLagga} patient${antalAttLagga > 1 ? 'er' : ''} l√§ggs till och f√•r SMS direkt:\n\n${namnLista}\n\nForts√§tt?`
      );
      
      if (!bekrafta) return;
      
      // Anropa API f√∂r att ut√∂ka kampanjen
      try {
        const utResponse = await fetch('/api/kampanj/utoka', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            kampanjId: kampanjId,
            patientIds: patienterAttLagga.map((p: any) => p.id),
          }),
        });
        
        const utData = await utResponse.json();
        
        if (utData.success) {
          alert(`‚úÖ ${utData.antalTillagda} patient${utData.antalTillagda > 1 ? 'er' : ''} tillagda!\n\n${utData.antalSkickade} SMS skickades.`);
          // Ladda om kampanjdetaljen
          laddaKampanjDetalj(kampanjId);
        } else {
          alert('N√•got gick fel: ' + (utData.error || 'Ok√§nt fel'));
        }
      } catch (err) {
        console.error('Fel vid ut√∂kning:', err);
        alert('N√§tverksfel ‚Äì kunde inte ut√∂ka kampanjen');
      }
    });

    // ========== PATIENTPOOL ==========
    let valdaPatienter: Set<string> = new Set();
    let cachedTillgangliga: any[] = []; // Cache f√∂r sortering
    let currentSort: { field: string; asc: boolean } = { field: 'prioritet', asc: false }; // Prioriterade f√∂rst som default

    async function laddaPatientpool() {
      try {
        const response = await fetch('/api/pool/lista');
        const data = await response.json();
        
        if (data.success) {
          // Uppdatera statistik
          document.getElementById('stat-tillgangliga')!.textContent = data.statistik.tillgangliga;
          document.getElementById('stat-reserv')!.textContent = data.statistik.reserv;
          document.getElementById('stat-nej')!.textContent = data.statistik.nej;
          document.getElementById('stat-bokade')!.textContent = data.statistik.bokade;
          document.getElementById('stat-totalt')!.textContent = data.statistik.totalt;
          
          // Spara och sortera tillg√§ngliga
          cachedTillgangliga = data.patienter.tillgangliga || [];
          renderaSorteradLista();
          
          // Rendera √∂vriga listor
          renderaPatientlista('lista-reserv', data.patienter.reserv, true, 'reserv');
          renderaPatientlista('lista-nej', data.patienter.nej, false, 'nej');
          renderaPatientlista('lista-bokade', data.patienter.bokade, false, 'bokad');
        }
      } catch (error) {
        console.error('Kunde inte ladda patientpool:', error);
      }
    }
    
    function renderaSorteradLista() {
      const sorterade = [...cachedTillgangliga].sort((a, b) => {
        // AKUT alltid f√∂rst, oavsett annan sortering
        if (a.akut && !b.akut) return -1;
        if (!a.akut && b.akut) return 1;
        
        let comparison = 0;
        
        if (currentSort.field === 'prioritet') {
          // Prioritet: ont=2, sjukskriven=1, b√•da=3
          const prioA = (a.har_ont ? 2 : 0) + (a.sjukskriven ? 1 : 0);
          const prioB = (b.har_ont ? 2 : 0) + (b.sjukskriven ? 1 : 0);
          comparison = prioB - prioA;
        } else if (currentSort.field === 'namn') {
          comparison = (a.namn || '').localeCompare(b.namn || '', 'sv');
        } else if (currentSort.field === 'alder') {
          // √Ñldre f√∂rst (pension√§rer kommer l√§ttare)
          const alderA = a.alder ?? 0;
          const alderB = b.alder ?? 0;
          comparison = alderB - alderA;
        } else if (currentSort.field === 'lakare') {
          comparison = (a.lakare || '').localeCompare(b.lakare || '', 'sv');
        } else if (currentSort.field === 'dagar') {
          const dagarA = Math.ceil((new Date(a.utgar_vid).getTime() - Date.now()) / (1000*60*60*24));
          const dagarB = Math.ceil((new Date(b.utgar_vid).getTime() - Date.now()) / (1000*60*60*24));
          comparison = dagarA - dagarB;
        }
        
        return currentSort.asc ? comparison : -comparison;
      });
      
      renderaPatientlista('lista-tillgangliga', sorterade, true);
    }
    
    // Sorteringsknappar
    function setupSortering(btnId: string, field: string) {
      document.getElementById(btnId)?.addEventListener('click', () => {
        if (currentSort.field === field) {
          currentSort.asc = !currentSort.asc;
        } else {
          currentSort.field = field;
          currentSort.asc = field === 'dagar'; // Dagar: l√§gst f√∂rst, annars: fallande
        }
        renderaSorteradLista();
      });
    }
    
    setupSortering('sort-prioritet', 'prioritet');
    setupSortering('sort-namn', 'namn');
    setupSortering('sort-alder', 'alder');
    setupSortering('sort-lakare', 'lakare');
    setupSortering('sort-dagar', 'dagar');

    function renderaPatientlista(containerId: string, patienter: any[], selectable: boolean, type?: string) {
      const container = document.getElementById(containerId);
      if (!container) return;
      
      if (!patienter || patienter.length === 0) {
        const emptyMessages: Record<string, string> = {
          'lista-tillgangliga': 'Inga tillg√§ngliga patienter. L√§gg till ovan!',
          'lista-reserv': 'Inga',
          'lista-nej': 'Inga',
          'lista-bokade': 'Inga',
        };
        container.innerHTML = `<p class="text-gray-400 italic text-xs">${emptyMessages[containerId] || 'Inga'}</p>`;
        return;
      }
      
      container.innerHTML = patienter.map(p => {
        const dagarKvar = Math.ceil((new Date(p.utgar_vid).getTime() - Date.now()) / (1000*60*60*24));
        
        if (type === 'nej') {
          return `
            <div class="flex items-center justify-between p-1.5 bg-white rounded border border-red-100 text-xs">
              <div class="min-w-0 flex-1">
                <div class="font-medium text-gray-800 truncate">${p.namn}</div>
              </div>
              <div class="flex items-center gap-1 flex-shrink-0">
                ${!p.hanterad_i_journal ? `
                  <button 
                    onclick="markeraHanterad('${p.id}')"
                    class="px-1.5 py-0.5 bg-gray-100 rounded hover:bg-gray-200 text-[10px]"
                  >‚úì</button>
                ` : '<span class="text-green-600 text-[10px]">‚úì</span>'}
                <button 
                  onclick="taBortPatient('${p.id}')"
                  class="px-1 py-0.5 text-red-500 hover:bg-red-50 rounded"
                >üóë</button>
              </div>
            </div>
          `;
        }
        
        if (type === 'bokad') {
          return `
            <div class="flex items-center p-1.5 bg-white rounded border border-green-100 text-xs">
              <div class="min-w-0 flex-1">
                <div class="font-medium text-gray-800 truncate">${p.namn}</div>
                <div class="text-[10px] text-gray-500">
                  ${p.bokad_datum ? new Date(p.bokad_datum).toLocaleDateString('sv-SE') : ''}
                </div>
              </div>
            </div>
          `;
        }
        
        // Tillg√§ngliga och Reserv
        const lakareInfo = p.lakare || '-';
        const flexBadge = p.flexibel_lakare ? '<span class="text-[10px] bg-purple-100 text-purple-700 px-0.5 rounded">F</span>' : '';
        const arAkut = p.akut === true;
        const harOnt = p.har_ont === true;
        const arSjukskriven = p.sjukskriven === true;
        
        // Bakgrundsf√§rg baserat p√• prioritet (akut > ont > sjukskriven > reserv > normal)
        let prioClass = 'border-gray-100';
        if (arAkut) {
          prioClass = 'bg-red-100 border-red-300 border-2';
        } else if (harOnt) {
          prioClass = 'bg-orange-50 border-orange-200';
        } else if (arSjukskriven) {
          prioClass = 'bg-blue-50 border-blue-200';
        } else if (type === 'reserv') {
          prioClass = 'border-yellow-200 bg-yellow-50';
        }
        
        // Prioritetsikoner
        const prioIcons: string[] = [];
        if (arAkut) prioIcons.push('<span title="AKUT - m√•ste opereras snarast">üö®</span>');
        if (harOnt) prioIcons.push('<span title="Mycket ont">üî•</span>');
        if (arSjukskriven) prioIcons.push('<span title="Sjukskriven">üìã</span>');
        
        // √Ölder
        const alderText = p.alder ? `${p.alder}` : '-';
        const isPension = p.alder && p.alder >= 65;
        const alderClass = isPension ? 'text-green-600 font-medium' : 'text-gray-500';
        
        return `
          <label class="flex items-center gap-2 px-2 py-1.5 rounded border ${prioClass} hover:border-sky-300 cursor-pointer text-sm">
            ${selectable ? `
              <input 
                type="checkbox" 
                value="${p.id}" 
                class="patient-checkbox rounded flex-shrink-0 w-4 h-4"
                ${valdaPatienter.has(p.id) ? 'checked' : ''}
              >
            ` : '<div class="w-4"></div>'}
            <div class="w-12 text-center flex-shrink-0 text-sm">
              ${prioIcons.join('')}
            </div>
            <div class="flex-1 min-w-0">
              <span class="font-medium text-gray-900">${p.namn}</span>
              ${flexBadge}
            </div>
            <div class="w-10 text-center flex-shrink-0">
              <span class="text-xs ${alderClass}" title="${isPension ? 'Pension√§r - kommer l√§ttare' : '√Ölder'}">${alderText}</span>
            </div>
            <div class="w-20 text-xs text-sky-600 font-medium truncate flex-shrink-0">${lakareInfo}</div>
            <div class="w-12 text-right flex-shrink-0">
              <span class="text-xs font-medium ${dagarKvar <= 7 ? 'text-orange-600' : 'text-gray-400'}">${dagarKvar}d</span>
            </div>
          </label>
        `;
      }).join('');
      
      // L√§gg till event listeners f√∂r checkboxar
      if (selectable) {
        container.querySelectorAll('.patient-checkbox').forEach(cb => {
          cb.addEventListener('change', (e) => {
            const id = (e.target as HTMLInputElement).value;
            if ((e.target as HTMLInputElement).checked) {
              valdaPatienter.add(id);
            } else {
              valdaPatienter.delete(id);
            }
            uppdateraValdaCount();
          });
        });
      }
    }

    function uppdateraValdaCount() {
      const count = valdaPatienter.size;
      document.getElementById('valda-count')!.textContent = `${count} valda`;
      const btn = document.getElementById('btn-skapa-fran-pool') as HTMLButtonElement;
      btn.disabled = count === 0;
    }

    // V√§lj alla
    document.getElementById('btn-valj-alla')?.addEventListener('click', () => {
      const checkboxes = document.querySelectorAll('#lista-tillgangliga .patient-checkbox') as NodeListOf<HTMLInputElement>;
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      
      checkboxes.forEach(cb => {
        cb.checked = !allChecked;
        if (!allChecked) {
          valdaPatienter.add(cb.value);
        } else {
          valdaPatienter.delete(cb.value);
        }
      });
      
      // Inkludera reserv ocks√•
      const reservCheckboxes = document.querySelectorAll('#lista-reserv .patient-checkbox') as NodeListOf<HTMLInputElement>;
      reservCheckboxes.forEach(cb => {
        cb.checked = !allChecked;
        if (!allChecked) {
          valdaPatienter.add(cb.value);
        } else {
          valdaPatienter.delete(cb.value);
        }
      });
      
      uppdateraValdaCount();
    });

    // Hj√§lpfunktion: Ber√§kna √•lder fr√•n personnummer
    function beraknaAlderFranPnr(pnr: string): number | null {
      if (!pnr) return null;
      
      // Ta bort bindestreck och mellanslag
      const clean = pnr.replace(/[-\s]/g, '');
      
      // Format: √Ö√Ö√Ö√ÖMMDDXXXX (12 siffror) eller √Ö√ÖMMDDXXXX (10 siffror)
      let year: number;
      let month: number;
      let day: number;
      
      if (clean.length === 12) {
        year = parseInt(clean.substring(0, 4));
        month = parseInt(clean.substring(4, 6));
        day = parseInt(clean.substring(6, 8));
      } else if (clean.length === 10) {
        const shortYear = parseInt(clean.substring(0, 2));
        // Anta 1900-tal om > 30, annars 2000-tal
        year = shortYear > 30 ? 1900 + shortYear : 2000 + shortYear;
        month = parseInt(clean.substring(2, 4));
        day = parseInt(clean.substring(4, 6));
      } else {
        return null;
      }
      
      // Validera
      if (isNaN(year) || isNaN(month) || isNaN(day)) return null;
      if (month < 1 || month > 12 || day < 1 || day > 31) return null;
      
      // Ber√§kna √•lder
      const today = new Date();
      let age = today.getFullYear() - year;
      const monthDiff = today.getMonth() + 1 - month;
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < day)) {
        age--;
      }
      
      return age > 0 && age < 120 ? age : null;
    }

    // L√§gg till patienter
    document.getElementById('btn-lagg-till')?.addEventListener('click', async () => {
      const textarea = document.getElementById('nya-patienter') as HTMLTextAreaElement;
      const lakareSelect = document.getElementById('patient-lakare') as HTMLSelectElement;
      const flexibelCheckbox = document.getElementById('patient-flexibel') as HTMLInputElement;
      const opDatumInput = document.getElementById('patient-op-datum') as HTMLInputElement;
      const akutCheckbox = document.getElementById('patient-akut') as HTMLInputElement;
      const ontCheckbox = document.getElementById('patient-ont') as HTMLInputElement;
      const sjukskrivenCheckbox = document.getElementById('patient-sjukskriven') as HTMLInputElement;
      
      const text = textarea.value.trim();
      const lakare = lakareSelect.value;
      const flexibelLakare = flexibelCheckbox.checked;
      const opDatum = opDatumInput.value;
      const arAkut = akutCheckbox.checked;
      const harOnt = ontCheckbox.checked;
      const arSjukskriven = sjukskrivenCheckbox.checked;
      
      if (!text) return;
      
      if (!lakare) {
        alert('V√§lj vilken l√§kare patienterna tillh√∂r');
        return;
      }
      
      if (!opDatum) {
        alert('Ange patientens ordinarie operationsdatum');
        return;
      }
      
      // Validera att op-datumet √§r i framtiden
      const opDate = new Date(opDatum);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      if (opDate < today) {
        alert('Operationsdatumet m√•ste vara i framtiden');
        return;
      }
      
      // Parsera patientdata - st√∂djer journalsystemformat
      const patienter: any[] = [];
      const lines = text.split('\n').map(l => l.trim()).filter(l => l);
      
      // Journalsystemformat: "Namn Personnummer" f√∂ljt av "Mobilnummer: 07X-XXX XX XX"
      if (text.toLowerCase().includes('mobilnummer')) {
        let currentNamn = '';
        let currentAlder: number | null = null;
        
        for (const line of lines) {
          // Kontrollera om raden inneh√•ller personnummer (√Ö√Ö√Ö√ÖMMDD-XXXX eller √Ö√ÖMMDD-XXXX)
          const personnummerMatch = line.match(/^(.+?)\s+(\d{6,8}[-\s]?\d{4})\s*$/);
          if (personnummerMatch) {
            currentNamn = personnummerMatch[1].trim();
            const pnr = personnummerMatch[2];
            currentAlder = beraknaAlderFranPnr(pnr);
          }
          // Kontrollera om raden inneh√•ller mobilnummer
          else if (line.toLowerCase().startsWith('mobilnummer')) {
            let telefon = line.replace(/mobilnummer[:\s]*/i, '').replace(/[-\s]/g, '');
            if (telefon.startsWith('0')) {
              telefon = '+46' + telefon.slice(1);
            }
            if (currentNamn && telefon) {
              patienter.push({
                namn: currentNamn,
                telefon: telefon,
                harSamtycke: true, // Default till ja vid journalimport
                lakare: lakare,
                flexibelLakare: flexibelLakare,
                opDatum: opDatum,
                akut: arAkut,
                harOnt: harOnt,
                sjukskriven: arSjukskriven,
                alder: currentAlder
              });
              currentNamn = '';
              currentAlder = null;
            }
          }
        }
      } 
      // Gammalt CSV-format: "Namn, Telefon, Samtycke"
      else {
        for (const line of lines) {
          const parts = line.split(',').map(p => p.trim());
          let telefon = parts[1]?.replace(/\s/g, '') || '';
          if (telefon.startsWith('0')) {
            telefon = '+46' + telefon.slice(1);
          }
          if (parts[0] && telefon) {
            patienter.push({
              namn: parts[0],
              telefon: telefon,
              harSamtycke: (parts[2] || '').toLowerCase() === 'ja',
              lakare: lakare,
              flexibelLakare: flexibelLakare,
              opDatum: opDatum,
              akut: arAkut,
              harOnt: harOnt,
              sjukskriven: arSjukskriven,
              alder: null // Ingen √•lder vid CSV-import
            });
          }
        }
      }
      
      if (patienter.length === 0) {
        alert('Inga giltiga patienter hittades. Kontrollera formatet.');
        return;
      }
      
      try {
        const response = await fetch('/api/pool/lagg-till', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ patienter })
        });
        
        const data = await response.json();
        
        // D√∂lj eventuella tidigare meddelanden
        const dublettVarning = document.getElementById('dubblett-varning')!;
        const successMsg = document.getElementById('tillagd-success')!;
        dublettVarning.classList.add('hidden');
        successMsg.classList.add('hidden');
        
        if (data.success) {
          textarea.value = '';
          opDatumInput.value = '';
          akutCheckbox.checked = false;
          ontCheckbox.checked = false;
          sjukskrivenCheckbox.checked = false;
          laddaPatientpool();
          
          // Visa succ√©meddelande
          const successText = document.getElementById('tillagd-success-text')!;
          successText.textContent = `${data.antalTillagda} patient(er) tillagda i poolen!`;
          successMsg.classList.remove('hidden');
          
          // D√∂lj efter 4 sekunder
          setTimeout(() => successMsg.classList.add('hidden'), 4000);
          
        } else if (data.dubletter) {
          // Visa tydlig dubblettvarning
          const dublettLista = document.getElementById('dubblett-lista')!;
          dublettLista.innerHTML = data.existerande.map((namn: string) => `
            <div class="flex items-center gap-2 p-2 bg-red-100 rounded border border-red-200">
              <span class="text-red-500 font-bold">‚úó</span>
              <span class="line-through text-red-800 font-medium">${namn}</span>
              <span class="text-red-600 text-xs ml-auto">redan i poolen</span>
            </div>
          `).join('');
          dublettVarning.classList.remove('hidden');
          
          // Scrolla till varningen
          dublettVarning.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
        } else {
          alert(data.error || 'Kunde inte l√§gga till patienter');
        }
      } catch (error) {
        alert('N√•got gick fel');
      }
    });

    // St√§ng dubblettvarning
    document.getElementById('stang-dubblett-varning')?.addEventListener('click', () => {
      document.getElementById('dubblett-varning')?.classList.add('hidden');
    });

    // Markera hanterad
    async function markeraHanterad(patientId: string) {
      await fetch('/api/pool/uppdatera', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ patientId, action: 'markera_hanterad' })
      });
      laddaPatientpool();
    }

    // Ta bort patient
    async function taBortPatient(patientId: string) {
      if (!confirm('Ta bort patienten fr√•n listan?')) return;
      
      await fetch('/api/pool/ta-bort', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ patientId })
      });
      laddaPatientpool();
    }

    // Skapa kampanj fr√•n pool
    document.getElementById('btn-skapa-fran-pool')?.addEventListener('click', () => {
      // Byt till kampanj-fliken och fyll i valda patienter
      document.getElementById('tab-kampanj')?.click();
      
      // TODO: Fylla i patientlistan i kampanjformul√§ret
      alert(`Skapa kampanj med ${valdaPatienter.size} valda patienter\n\nDenna funktion √§r under utveckling.`);
    });

    // G√∂r funktioner globala f√∂r onclick
    (window as any).markeraHanterad = markeraHanterad;
    (window as any).taBortPatient = taBortPatient;

    // Ladda patientpool vid start
    laddaPatientpool();

    // Vid ?id=: visa Aktiva-flik och ladda kampanjdetaljer (JA/NEJ/reserv)
    // Anv√§nd URLSearchParams f√∂r att vara s√§ker p√• att vi f√•ngar ID:t √§ven om data-attributet strular
    const urlParams = new URLSearchParams(window.location.search);
    const kampanjIdFromUrl = urlParams.get('id') || document.querySelector('main')?.getAttribute('data-kampanj-id')?.trim();
    
    console.log('üîç Kampanj-ID fr√•n URL:', kampanjIdFromUrl);
    
    if (kampanjIdFromUrl) {
      console.log('‚úÖ Visar Aktiva-flik och laddar detaljer f√∂r ID:', kampanjIdFromUrl);
      // Se till att Aktiva-fliken √§r vald
      visaPanel('aktiva');
      
      // Scrolla upp s√• anv√§ndaren ser detaljerna
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      // Ladda detaljer
      laddaKampanjDetalj(kampanjIdFromUrl);
    } else {
      console.log('‚ö†Ô∏è Ingen kampanj-ID i URL, visar standard-vy');
    }

    // ========== KAMPANJFORMUL√ÑR ==========
    // Visa/d√∂lj intervall-sektion
    document.querySelectorAll('input[name="utskicksmetod"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const section = document.getElementById('intervall-section');
        if ((e.target as HTMLInputElement).value === 'gradvis') {
          section?.classList.remove('hidden');
          updateTidBerakning();
        } else {
          section?.classList.add('hidden');
        }
      });
    });

    // Visa/d√∂lj tidsgr√§ns
    document.querySelector('input[name="harTidsGrans"]')?.addEventListener('change', (e) => {
      const section = document.getElementById('tidsgrans-section');
      if ((e.target as HTMLInputElement).checked) {
        section?.classList.remove('hidden');
        // S√§tt default till imorgon
        const idag = new Date();
        idag.setDate(idag.getDate());
        (document.querySelector('input[name="tidsgransDatum"]') as HTMLInputElement).value = 
          idag.toISOString().split('T')[0];
      } else {
        section?.classList.add('hidden');
      }
    });

    // R√§kna mottagare och uppdatera tid-ber√§kning
    const mottagareTextarea = document.querySelector('textarea[name="mottagare"]') as HTMLTextAreaElement;
    const mottagareCount = document.getElementById('mottagare-count');
    const intervallSelect = document.querySelector('select[name="intervall"]') as HTMLSelectElement;

    function parseMottagare() {
      const text = mottagareTextarea?.value || '';
      const lines = text.trim().split('\n').map(l => l.trim()).filter(l => l);
      const mottagare: any[] = [];
      
      // Journalsystemformat: "Namn Personnummer" f√∂ljt av "Mobilnummer: 07X-XXX XX XX"
      if (text.toLowerCase().includes('mobilnummer')) {
        let currentNamn = '';
        
        for (const line of lines) {
          // Kontrollera om raden inneh√•ller personnummer
          const personnummerMatch = line.match(/^(.+?)\s+(\d{6,8}[-\s]?\d{4})\s*$/);
          if (personnummerMatch) {
            currentNamn = personnummerMatch[1].trim();
          }
          // Kontrollera om raden inneh√•ller mobilnummer
          else if (line.toLowerCase().startsWith('mobilnummer')) {
            const telefon = line.replace(/mobilnummer[:\s]*/i, '').replace(/[-\s]/g, '');
            if (currentNamn && telefon) {
              mottagare.push({
                namn: currentNamn,
                telefon: telefon,
                harSamtycke: true
              });
              currentNamn = '';
            }
          }
        }
      } 
      // Gammalt CSV-format
      else {
        for (const line of lines) {
          const parts = line.split(',').map(p => p.trim());
          const telefon = parts[1]?.replace(/\s/g, '') || '';
          if (parts[0] && telefon) {
            mottagare.push({
              namn: parts[0],
              telefon: telefon,
              harSamtycke: (parts[2] || '').toLowerCase() === 'ja'
            });
          }
        }
      }
      
      return mottagare;
    }

    function updateMottagareCount() {
      const mottagare = parseMottagare();
      if (mottagareCount) {
        mottagareCount.textContent = `${mottagare.length} mottagare`;
      }
      updateTidBerakning();
    }

    function updateTidBerakning() {
      const mottagare = parseMottagare();
      const intervall = parseInt(intervallSelect?.value || '10');
      const totalTid = mottagare.length * intervall;
      
      const tidBerakning = document.getElementById('tid-berakning');
      if (tidBerakning && mottagare.length > 0) {
        const timmar = Math.floor(totalTid / 60);
        const minuter = totalTid % 60;
        const tidStr = timmar > 0 
          ? `${timmar}h ${minuter}min` 
          : `${minuter} min`;
        tidBerakning.textContent = `üí° ${mottagare.length} patienter √ó ${intervall} min = ~${tidStr} totalt (om ingen svarar JA)`;
      }
    }

    mottagareTextarea?.addEventListener('input', updateMottagareCount);
    intervallSelect?.addEventListener('change', updateTidBerakning);

    // Formul√§rsubmit
    document.getElementById('kampanj-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const form = e.target as HTMLFormElement;
      const formData = new FormData(form);
      const result = document.getElementById('result');
      
      const mottagare = parseMottagare();
      if (mottagare.length === 0) {
        if (result) {
          result.className = 'mt-6 p-4 rounded-lg bg-red-50 border border-red-200 text-red-800';
          result.textContent = 'L√§gg till minst en mottagare';
          result.classList.remove('hidden');
        }
        return;
      }

      // Formatera telefonnummer
      const mottagareMedTelefon = mottagare.map(m => {
        let telefon = m.telefon.replace(/\D/g, '');
        if (telefon.startsWith('0')) {
          telefon = '+46' + telefon.slice(1);
        } else if (!telefon.startsWith('+')) {
          telefon = '+46' + telefon;
        }
        return { ...m, telefon };
      });

      const utskicksmetod = formData.get('utskicksmetod');
      const intervall = utskicksmetod === 'gradvis' ? parseInt(formData.get('intervall') as string) : 0;

      // Tidsgr√§ns
      let sistaVarstid = null;
      if (formData.get('harTidsGrans')) {
        const datum = formData.get('tidsgransDatum');
        const tid = formData.get('tidsgransTid') || '18:00';
        if (datum) {
          sistaVarstid = `${datum}T${tid}:00`;
        }
      }

      // Notifiera personal
      const notifiera = Array.from(form.querySelectorAll('input[name="notifiera"]:checked'))
        .map((el: any) => el.value);

      // H√§mta antal platser och tidsblock
      const antalPlatserValue = formData.get('antalPlatser');
      const antalPlatser = antalPlatserValue ? parseInt(antalPlatserValue as string) : 1;
      const tidsblock = formData.get('tidsblock') || null;

      const body = {
        datum: formData.get('datum'),
        antalPlatser,
        tidsblock,
        operationTyp: formData.get('operationTyp') || null,
        mottagare: mottagareMedTelefon,
        batchIntervallMinuter: intervall,
        sistaVarstid,
        notifieraPersonal: notifiera,
      };

      try {
        const response = await fetch('/api/kampanj/skapa', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        const data = await response.json();

        if (result) {
          if (data.success) {
            result.className = 'mt-6 p-4 rounded-lg bg-green-50 border border-green-200 text-green-800';
            result.innerHTML = `
              <div class="font-semibold">‚úÖ Kampanj skapad!</div>
              <div class="text-sm mt-1">
                ${data.antalSkickade} av ${data.antalMottagare} SMS skickade
                ${data.gradvisUtskick ? ' (gradvis utskick aktiverat)' : ''}
              </div>
              <a href="/personal/kort-varsel?id=${data.kampanjId}" class="text-green-700 underline text-sm mt-2 inline-block">
                Visa kampanj ‚Üí
              </a>
            `;
            form.reset();
            updateMottagareCount();
          } else {
            result.className = 'mt-6 p-4 rounded-lg bg-red-50 border border-red-200 text-red-800';
            result.textContent = data.error || 'N√•got gick fel';
          }
          result.classList.remove('hidden');
        }
      } catch (error) {
        if (result) {
          result.className = 'mt-6 p-4 rounded-lg bg-red-50 border border-red-200 text-red-800';
          result.textContent = 'Kunde inte skapa kampanj. F√∂rs√∂k igen.';
          result.classList.remove('hidden');
        }
      }
    });

    // Initial count
    updateMottagareCount();
  </script>
</BaseLayout>
