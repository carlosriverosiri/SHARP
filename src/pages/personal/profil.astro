---
/**
 * Profilsida f√∂r personal
 * URL: /personal/profil
 * 
 * H√§r kan personal l√§gga till sitt mobilnummer f√∂r att f√• SMS-notifieringar.
 */

export const prerender = false;

import BaseLayout from '../../layouts/BaseLayout.astro';
import { hamtaAnvandare } from '../../lib/auth';
import { supabase } from '../../lib/supabase';

const anvandare = await hamtaAnvandare(Astro.cookies);

// H√§mta profil
let profil: any = null;
let felmeddelande = '';
let framgangsmeddelande = '';

if (anvandare) {
  const { data, error } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', anvandare.id)
    .single();
  
  if (data) {
    profil = data;
  }
}

// Hantera POST
if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const mobilnummer = formData.get('mobilnummer')?.toString() || '';
    const villHaNotifikationer = formData.get('villHaNotifikationer') === 'on';

    // Validera mobilnummer om det finns
    let formateratNummer = '';
    if (mobilnummer) {
      const cleanNumber = mobilnummer.replace(/\D/g, '');
      if (cleanNumber.length < 9 || cleanNumber.length > 12) {
        felmeddelande = 'Ogiltigt mobilnummer';
      } else {
        // Formatera till +46-format
        if (cleanNumber.startsWith('46')) {
          formateratNummer = '+' + cleanNumber;
        } else if (cleanNumber.startsWith('0')) {
          formateratNummer = '+46' + cleanNumber.slice(1);
        } else {
          formateratNummer = '+46' + cleanNumber;
        }
      }
    }

    if (!felmeddelande && anvandare) {
      // Kontrollera om profil finns
      const { data: existing } = await supabase
        .from('profiles')
        .select('id')
        .eq('id', anvandare.id)
        .single();

      if (existing) {
        // Uppdatera befintlig
        const { error } = await supabase
          .from('profiles')
          .update({
            mobilnummer: formateratNummer || null,
            vill_ha_notifikationer: villHaNotifikationer,
          })
          .eq('id', anvandare.id);

        if (error) {
          felmeddelande = 'Kunde inte spara √§ndringar';
          console.error('Profil update error:', error);
        } else {
          framgangsmeddelande = 'Profilen har sparats!';
          profil = { ...profil, mobilnummer: formateratNummer, vill_ha_notifikationer: villHaNotifikationer };
        }
      } else {
        // Skapa ny profil
        const { error } = await supabase
          .from('profiles')
          .insert({
            id: anvandare.id,
            email: anvandare.email,
            mobilnummer: formateratNummer || null,
            vill_ha_notifikationer: villHaNotifikationer,
          });

        if (error) {
          felmeddelande = 'Kunde inte skapa profil';
          console.error('Profil insert error:', error);
        } else {
          framgangsmeddelande = 'Profilen har skapats!';
          profil = { mobilnummer: formateratNummer, vill_ha_notifikationer: villHaNotifikationer };
        }
      }
    }
  } catch (e) {
    console.error('Form error:', e);
    felmeddelande = 'Ett fel uppstod';
  }
}

// Formatera nummer f√∂r visning
function formateraNummer(nummer: string | null): string {
  if (!nummer) return '';
  // +46701234567 ‚Üí 070-123 45 67
  const clean = nummer.replace(/^\+46/, '0');
  if (clean.length === 10) {
    return `${clean.slice(0, 3)}-${clean.slice(3, 6)} ${clean.slice(6, 8)} ${clean.slice(8)}`;
  }
  return clean;
}
---

<BaseLayout title="Min profil | Personalportal" description="Hantera din profil och SMS-notifikationer">
  <div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
      <div class="max-w-3xl mx-auto px-4 py-4">
        <div class="flex items-center gap-4">
          <a href="/personal/oversikt" class="text-gray-500 hover:text-gray-700">
            ‚Üê Tillbaka
          </a>
          <h1 class="text-2xl font-bold text-gray-900">üë§ Min profil</h1>
        </div>
      </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 py-8">
      <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
        
        <!-- Profil-header -->
        <div class="bg-gradient-to-r from-sky-500 to-sky-600 px-6 py-8 text-white">
          <div class="flex items-center gap-4">
            <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center text-2xl">
              üë§
            </div>
            <div>
              <h2 class="text-xl font-semibold">{anvandare?.email}</h2>
              <p class="text-sky-100">
                {anvandare?.roll === 'admin' ? 'Administrat√∂r' : 'Personal'}
              </p>
            </div>
          </div>
        </div>

        <!-- Formul√§r -->
        <form method="POST" class="p-6 space-y-6">
          
          {felmeddelande && (
            <div class="p-4 bg-red-50 border border-red-200 rounded-lg text-red-800 flex items-center gap-2">
              <span>‚ùå</span>
              {felmeddelande}
            </div>
          )}
          
          {framgangsmeddelande && (
            <div class="p-4 bg-green-50 border border-green-200 rounded-lg text-green-800 flex items-center gap-2">
              <span>‚úÖ</span>
              {framgangsmeddelande}
            </div>
          )}

          <!-- Mobilnummer -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              üì± Mobilnummer f√∂r SMS-notifikationer
            </label>
            <input 
              type="tel" 
              name="mobilnummer" 
              value={formateraNummer(profil?.mobilnummer)}
              placeholder="070-123 45 67"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 text-lg"
            >
            <p class="text-sm text-gray-500 mt-2">
              Anv√§nds f√∂r att f√• SMS n√§r en patient svarar JA p√• kort varsel-f√∂rfr√•gningar.
            </p>
          </div>

          <!-- Notifikationsinst√§llningar -->
          <div class="bg-gray-50 rounded-lg p-4">
            <label class="flex items-start gap-3 cursor-pointer">
              <input 
                type="checkbox" 
                name="villHaNotifikationer" 
                checked={profil?.vill_ha_notifikationer}
                class="mt-1 rounded"
              >
              <div>
                <div class="font-medium text-gray-900">
                  Jag vill ta emot kort varsel-notifikationer
                </div>
                <div class="text-sm text-gray-500 mt-1">
                  N√§r denna √§r aktiverad kan du v√§ljas som mottagare n√§r kollegor skapar kampanjer.
                  Du f√•r d√• SMS direkt n√§r en patient svarar JA.
                </div>
              </div>
            </label>
          </div>

          <!-- Hur det fungerar -->
          <div class="bg-sky-50 border border-sky-100 rounded-lg p-4">
            <h3 class="font-medium text-sky-900 mb-2">‚ÑπÔ∏è S√• fungerar notifikationer</h3>
            <ol class="text-sm text-sky-800 space-y-2 list-decimal list-inside">
              <li>Du eller en kollega skapar en kort varsel-kampanj</li>
              <li>Du v√§ljs som mottagare av notifikationer</li>
              <li>SMS skickas till patienterna</li>
              <li>N√§r en patient svarar JA f√•r du ett SMS:
                <div class="ml-5 mt-1 p-2 bg-white rounded border border-sky-200 font-mono text-xs">
                  üéâ KORT VARSEL: Anna svarade JA!<br>
                  Tid: tis 28/1 kl 08:00<br>
                  G√• till personalportalen...
                </div>
              </li>
              <li>Du kan d√• ringa patienten och bekr√§fta bokningen</li>
            </ol>
          </div>

          <!-- Spara-knapp -->
          <div class="pt-4 border-t">
            <button 
              type="submit"
              class="w-full px-6 py-3 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition-colors"
            >
              Spara √§ndringar
            </button>
          </div>
        </form>
      </div>

      <!-- Snabbl√§nkar -->
      <div class="mt-8 grid grid-cols-2 gap-4">
        <a 
          href="/personal/kort-varsel" 
          class="p-4 bg-white rounded-lg border border-gray-200 hover:border-sky-300 hover:bg-sky-50 transition-colors"
        >
          <div class="text-lg mb-1">üì±</div>
          <div class="font-medium text-gray-900">Kort varsel SMS</div>
          <div class="text-sm text-gray-500">Skapa och hantera kampanjer</div>
        </a>
        <a 
          href="/personal/lankar-sms" 
          class="p-4 bg-white rounded-lg border border-gray-200 hover:border-sky-300 hover:bg-sky-50 transition-colors"
        >
          <div class="text-lg mb-1">üìé</div>
          <div class="font-medium text-gray-900">L√§nkar & SMS</div>
          <div class="text-sm text-gray-500">Skicka info till patienter</div>
        </a>
      </div>
    </main>
  </div>
</BaseLayout>
