---
/**
 * Admin-sida f√∂r personalportalen
 * URL: /personal/admin
 * 
 * Hantera anv√§ndare och l√§kare.
 */

export const prerender = false;

import BaseLayout from '../../layouts/BaseLayout.astro';
import { hamtaAnvandare } from '../../lib/auth';
import { supabaseAdmin } from '../../lib/supabase';

const anvandare = await hamtaAnvandare(Astro.cookies);

// Endast inloggade
if (!anvandare) {
  return Astro.redirect('/personal/');
}

// H√§mta alla profiler med notifikationsinst√§llningar
let personal: any[] = [];
let personalError = '';

try {
  // H√§mta alla anv√§ndare fr√•n auth och deras profiler
  const { data: authUsers, error: authError } = await supabaseAdmin.auth.admin.listUsers();
  
  if (authError) {
    personalError = 'Kunde inte h√§mta anv√§ndare';
    console.error('Auth error:', authError);
  } else {
    // H√§mta profiler
    const { data: profiles } = await supabaseAdmin
      .from('profiles')
      .select('*');
    
    // Kombinera
    personal = (authUsers?.users || []).map(user => {
      const profil = profiles?.find(p => p.id === user.id);
      return {
        id: user.id,
        email: user.email,
        skapad: user.created_at,
        mobilnummer: profil?.mobilnummer || null,
        vill_ha_notifikationer: profil?.vill_ha_notifikationer || false,
        avatar_url: profil?.avatar_url || null
      };
    });
  }
} catch (e) {
  console.error('Error fetching personal:', e);
  personalError = 'Ett fel uppstod';
}

// H√§mta l√§kare
let lakare: any[] = [];
let lakareError = '';

try {
  const { data, error } = await supabaseAdmin
    .from('lakare')
    .select('*')
    .order('namn');
  
  if (error) {
    lakareError = error.message;
  } else {
    lakare = data || [];
  }
} catch (e) {
  lakareError = 'Kunde inte h√§mta l√§kare';
}

// Hantera formul√§r
let meddelande = '';
let meddelandeTyp: 'success' | 'error' = 'success';

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const action = formData.get('action');

    // === SKAPA NY ANV√ÑNDARE ===
    if (action === 'skapa_anvandare') {
      const email = formData.get('email')?.toString().trim();
      const password = formData.get('password')?.toString();

      if (!email || !password) {
        meddelande = 'E-post och l√∂senord kr√§vs';
        meddelandeTyp = 'error';
      } else if (password.length < 6) {
        meddelande = 'L√∂senordet m√•ste vara minst 6 tecken';
        meddelandeTyp = 'error';
      } else {
        const { data, error } = await supabaseAdmin.auth.admin.createUser({
          email,
          password,
          email_confirm: true // Bekr√§fta direkt utan email-verifiering
        });

        if (error) {
          meddelande = `Kunde inte skapa anv√§ndare: ${error.message}`;
          meddelandeTyp = 'error';
        } else {
          meddelande = `‚úÖ Anv√§ndare ${email} skapad!`;
          meddelandeTyp = 'success';
          
          // L√§gg till i personal-listan
          personal.push({
            id: data.user.id,
            email: data.user.email,
            skapad: data.user.created_at,
            mobilnummer: null,
            vill_ha_notifikationer: false
          });
        }
      }
    }

    // === L√ÑGG TILL L√ÑKARE ===
    if (action === 'lagg_till_lakare') {
      const namn = formData.get('lakare_namn')?.toString().trim();
      const kortnamn = formData.get('lakare_kortnamn')?.toString().trim();

      if (!namn) {
        meddelande = 'L√§karens namn kr√§vs';
        meddelandeTyp = 'error';
      } else {
        const { error } = await supabaseAdmin
          .from('lakare')
          .insert({ namn, kortnamn: kortnamn || null });

        if (error) {
          if (error.code === '23505') {
            meddelande = 'En l√§kare med detta namn finns redan';
          } else {
            meddelande = `Kunde inte l√§gga till l√§kare: ${error.message}`;
          }
          meddelandeTyp = 'error';
        } else {
          meddelande = `‚úÖ L√§kare "${namn}" tillagd!`;
          meddelandeTyp = 'success';
          
          // H√§mta uppdaterad lista
          const { data } = await supabaseAdmin
            .from('lakare')
            .select('*')
            .order('namn');
          lakare = data || [];
        }
      }
    }

    // === TA BORT L√ÑKARE ===
    if (action === 'ta_bort_lakare') {
      const lakareId = formData.get('lakare_id')?.toString();

      if (lakareId) {
        const { error } = await supabaseAdmin
          .from('lakare')
          .delete()
          .eq('id', lakareId);

        if (error) {
          meddelande = `Kunde inte ta bort l√§kare: ${error.message}`;
          meddelandeTyp = 'error';
        } else {
          meddelande = '‚úÖ L√§kare borttagen!';
          meddelandeTyp = 'success';
          lakare = lakare.filter(l => l.id !== lakareId);
        }
      }
    }

    // === UPPDATERA L√ÑKARE STATUS ===
    if (action === 'toggle_lakare_aktiv') {
      const lakareId = formData.get('lakare_id')?.toString();
      const nuvarandeAktiv = formData.get('nuvarande_aktiv') === 'true';

      if (lakareId) {
        const { error } = await supabaseAdmin
          .from('lakare')
          .update({ aktiv: !nuvarandeAktiv })
          .eq('id', lakareId);

        if (error) {
          meddelande = `Kunde inte uppdatera l√§kare: ${error.message}`;
          meddelandeTyp = 'error';
        } else {
          meddelande = nuvarandeAktiv ? '‚è∏Ô∏è L√§kare inaktiverad' : '‚úÖ L√§kare aktiverad';
          meddelandeTyp = 'success';
          
          // Uppdatera lokalt
          const idx = lakare.findIndex(l => l.id === lakareId);
          if (idx >= 0) {
            lakare[idx].aktiv = !nuvarandeAktiv;
          }
        }
      }
    }

  } catch (e) {
    console.error('Form error:', e);
    meddelande = 'Ett ov√§ntat fel uppstod';
    meddelandeTyp = 'error';
  }
}

// Formatera mobilnummer f√∂r visning
function formateraNummer(nummer: string | null): string {
  if (!nummer) return '‚Äî';
  const clean = nummer.replace(/^\+46/, '0');
  if (clean.length === 10) {
    return `${clean.slice(0, 3)}-${clean.slice(3, 6)} ${clean.slice(6, 8)} ${clean.slice(8)}`;
  }
  return clean;
}

function formateraDatum(datum: string): string {
  return new Date(datum).toLocaleDateString('sv-SE', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}
---

<BaseLayout title="Administration | Personalportal" description="Hantera anv√§ndare och l√§kare">
  <div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
      <div class="max-w-6xl mx-auto px-4 py-4">
        <div class="flex items-center gap-4">
          <a href="/personal/oversikt" class="text-gray-500 hover:text-gray-700">
            ‚Üê Tillbaka
          </a>
          <h1 class="text-2xl font-bold text-gray-900">‚öôÔ∏è Administration</h1>
        </div>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-8">
      
      {/* Meddelande */}
      {meddelande && (
        <div class={`mb-6 p-4 rounded-lg border ${
          meddelandeTyp === 'success' 
            ? 'bg-green-50 border-green-200 text-green-800' 
            : 'bg-red-50 border-red-200 text-red-800'
        }`}>
          {meddelande}
        </div>
      )}

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <!-- ANV√ÑNDARE -->
        <section class="bg-white rounded-xl shadow-sm border overflow-hidden">
          <div class="bg-gradient-to-r from-sky-500 to-sky-600 px-6 py-4">
            <h2 class="text-xl font-semibold text-white">üë• Anv√§ndare</h2>
            <p class="text-sky-100 text-sm">Personal som kan logga in i portalen</p>
          </div>
          
          <div class="p-6">
            {/* Formul√§r f√∂r ny anv√§ndare */}
            <form method="POST" class="mb-6 p-4 bg-gray-50 rounded-lg border">
              <h3 class="font-medium text-gray-900 mb-4">‚ûï Bjud in ny anv√§ndare</h3>
              
              <input type="hidden" name="action" value="skapa_anvandare" />
              
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">E-postadress</label>
                  <input 
                    type="email" 
                    name="email" 
                    required
                    placeholder="anna@sodermalmsortopedi.se"
                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-sky-500"
                  />
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Tillf√§lligt l√∂senord</label>
                  <input 
                    type="text" 
                    name="password" 
                    required
                    minlength="6"
                    placeholder="Minst 6 tecken"
                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-sky-500"
                  />
                  <p class="text-xs text-gray-500 mt-1">Anv√§ndaren kan byta l√∂senord senare</p>
                </div>
                
                <button 
                  type="submit"
                  class="w-full px-4 py-2 bg-sky-600 text-white font-medium rounded-lg hover:bg-sky-700 transition-colors"
                >
                  Skapa anv√§ndare
                </button>
              </div>
            </form>
            
            {/* Lista √∂ver anv√§ndare */}
            <div>
              <h3 class="font-medium text-gray-900 mb-3">Registrerade anv√§ndare ({personal.length})</h3>
              
              {personalError && (
                <p class="text-red-600 text-sm">{personalError}</p>
              )}
              
              <div class="space-y-3">
                {personal.map(p => (
                  <div class="p-3 bg-gray-50 rounded-lg border" data-user-id={p.id}>
                    <div class="flex items-center gap-3">
                      {/* Profilbild */}
                      <div class="relative group">
                        <div class="w-12 h-12 rounded-full overflow-hidden bg-gray-200 flex items-center justify-center">
                          {p.avatar_url ? (
                            <img 
                              src={p.avatar_url} 
                              alt={p.email}
                              class="w-full h-full object-cover avatar-img"
                            />
                          ) : (
                            <span class="text-gray-400 text-lg">üë§</span>
                          )}
                        </div>
                        {/* Ladda upp-knapp */}
                        <label class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-full opacity-0 group-hover:opacity-100 cursor-pointer transition-opacity">
                          <span class="text-white text-xs">üì∑</span>
                          <input 
                            type="file" 
                            accept="image/*"
                            class="hidden avatar-input"
                            data-user-id={p.id}
                          />
                        </label>
                      </div>
                      
                      {/* Info */}
                      <div class="flex-1 min-w-0">
                        <div class="font-medium text-gray-900 text-sm truncate">{p.email}</div>
                        <div class="text-xs text-gray-500">
                          üì± {formateraNummer(p.mobilnummer)}
                          {p.vill_ha_notifikationer && (
                            <span class="ml-2 text-green-600">üîî</span>
                          )}
                        </div>
                      </div>
                      
                      {/* Datum */}
                      <div class="text-xs text-gray-400">
                        {formateraDatum(p.skapad)}
                      </div>
                    </div>
                    {/* Upload status */}
                    <div class="upload-status hidden mt-2 text-xs"></div>
                  </div>
                ))}
              </div>
              
              <p class="text-xs text-gray-500 mt-4">
                üí° Anv√§ndare l√§gger till sitt mobilnummer via <a href="/personal/profil" class="text-sky-600 underline">Min profil</a>
              </p>
            </div>
          </div>
        </section>

        <!-- L√ÑKARE -->
        <section class="bg-white rounded-xl shadow-sm border overflow-hidden">
          <div class="bg-gradient-to-r from-emerald-500 to-emerald-600 px-6 py-4">
            <h2 class="text-xl font-semibold text-white">ü©∫ L√§kare</h2>
            <p class="text-emerald-100 text-sm">Kirurger f√∂r Kort Varsel-kampanjer</p>
          </div>
          
          <div class="p-6">
            {/* Formul√§r f√∂r ny l√§kare */}
            <form method="POST" class="mb-6 p-4 bg-gray-50 rounded-lg border">
              <h3 class="font-medium text-gray-900 mb-4">‚ûï L√§gg till l√§kare</h3>
              
              <input type="hidden" name="action" value="lagg_till_lakare" />
              
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Namn</label>
                  <input 
                    type="text" 
                    name="lakare_namn" 
                    required
                    placeholder="Dr. Andersson"
                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500"
                  />
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Kortnamn (valfritt)</label>
                  <input 
                    type="text" 
                    name="lakare_kortnamn" 
                    placeholder="Andersson"
                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500"
                  />
                  <p class="text-xs text-gray-500 mt-1">Anv√§nds i SMS om det √§r kortare</p>
                </div>
                
                <button 
                  type="submit"
                  class="w-full px-4 py-2 bg-emerald-600 text-white font-medium rounded-lg hover:bg-emerald-700 transition-colors"
                >
                  L√§gg till l√§kare
                </button>
              </div>
            </form>
            
            {/* Lista √∂ver l√§kare */}
            <div>
              <h3 class="font-medium text-gray-900 mb-3">Registrerade l√§kare ({lakare.length})</h3>
              
              {lakareError && (
                <p class="text-red-600 text-sm">{lakareError}</p>
              )}
              
              <div class="space-y-2">
                {lakare.map(l => (
                  <div class={`p-3 rounded-lg border flex items-center justify-between ${
                    l.aktiv ? 'bg-gray-50' : 'bg-gray-100 opacity-60'
                  }`}>
                    <div>
                      <div class="font-medium text-gray-900 text-sm flex items-center gap-2">
                        {l.namn}
                        {!l.aktiv && <span class="text-xs bg-gray-300 text-gray-600 px-2 py-0.5 rounded">Inaktiv</span>}
                      </div>
                      {l.kortnamn && (
                        <div class="text-xs text-gray-500">Kortnamn: {l.kortnamn}</div>
                      )}
                    </div>
                    <div class="flex gap-2">
                      {/* Toggle aktiv */}
                      <form method="POST" class="inline">
                        <input type="hidden" name="action" value="toggle_lakare_aktiv" />
                        <input type="hidden" name="lakare_id" value={l.id} />
                        <input type="hidden" name="nuvarande_aktiv" value={l.aktiv.toString()} />
                        <button 
                          type="submit"
                          class={`px-2 py-1 text-xs rounded ${
                            l.aktiv 
                              ? 'bg-yellow-100 text-yellow-700 hover:bg-yellow-200' 
                              : 'bg-green-100 text-green-700 hover:bg-green-200'
                          }`}
                          title={l.aktiv ? 'Inaktivera' : 'Aktivera'}
                        >
                          {l.aktiv ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}
                        </button>
                      </form>
                      
                      {/* Ta bort */}
                      <form method="POST" class="inline" onsubmit="return confirm('Vill du verkligen ta bort denna l√§kare?')">
                        <input type="hidden" name="action" value="ta_bort_lakare" />
                        <input type="hidden" name="lakare_id" value={l.id} />
                        <button 
                          type="submit"
                          class="px-2 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200"
                          title="Ta bort"
                        >
                          üóëÔ∏è
                        </button>
                      </form>
                    </div>
                  </div>
                ))}
                
                {lakare.length === 0 && (
                  <p class="text-gray-500 text-sm italic">Inga l√§kare tillagda √§nnu</p>
                )}
              </div>
            </div>
          </div>
        </section>
        
      </div>
      
      <!-- Info-ruta -->
      <div class="mt-8 bg-amber-50 border border-amber-200 rounded-lg p-4">
        <h3 class="font-medium text-amber-900 mb-2">üí° Tips</h3>
        <ul class="text-sm text-amber-800 space-y-1 list-disc list-inside">
          <li>Nya anv√§ndare kan logga in direkt med e-post och det tillf√§lliga l√∂senordet</li>
          <li>Be anv√§ndare g√• till <strong>Min profil</strong> f√∂r att l√§gga till sitt mobilnummer och aktivera notifikationer</li>
          <li>L√§kare som √§r inaktiverade visas inte i Kort Varsel-dropdown:en</li>
          <li>Hovra √∂ver en profilbild och klicka p√• üì∑ f√∂r att ladda upp en ny bild</li>
        </ul>
      </div>
      
    </main>
  </div>

  <script>
    // Hantera bilduppladdning
    document.querySelectorAll('.avatar-input').forEach(input => {
      input.addEventListener('change', async (e) => {
        const target = e.target as HTMLInputElement;
        const file = target.files?.[0];
        const userId = target.dataset.userId;
        
        if (!file || !userId) return;
        
        // Hitta status-elementet
        const container = target.closest('[data-user-id]');
        const statusEl = container?.querySelector('.upload-status');
        const imgEl = container?.querySelector('.avatar-img') as HTMLImageElement;
        const placeholder = container?.querySelector('.text-gray-400');
        
        if (statusEl) {
          statusEl.classList.remove('hidden');
          statusEl.textContent = '‚è≥ Laddar upp...';
          statusEl.className = 'upload-status mt-2 text-xs text-blue-600';
        }
        
        try {
          const formData = new FormData();
          formData.append('userId', userId);
          formData.append('avatar', file);
          
          const response = await fetch('/api/admin/upload-avatar', {
            method: 'POST',
            body: formData,
            credentials: 'include' // Viktigt: skicka cookies
          });
          
          const result = await response.json();
          
          if (result.success) {
            // Uppdatera bilden
            if (imgEl) {
              imgEl.src = result.avatarUrl + '?t=' + Date.now(); // Cache bust
            } else if (placeholder) {
              // Ers√§tt placeholder med bild
              const img = document.createElement('img');
              img.src = result.avatarUrl;
              img.alt = 'Profilbild';
              img.className = 'w-full h-full object-cover avatar-img';
              placeholder.replaceWith(img);
            }
            
            if (statusEl) {
              statusEl.textContent = '‚úÖ Bild uppladdad!';
              statusEl.className = 'upload-status mt-2 text-xs text-green-600';
              setTimeout(() => statusEl.classList.add('hidden'), 3000);
            }
          } else {
            if (statusEl) {
              statusEl.textContent = '‚ùå ' + (result.error || 'Uppladdning misslyckades');
              statusEl.className = 'upload-status mt-2 text-xs text-red-600';
            }
          }
        } catch (error) {
          if (statusEl) {
            statusEl.textContent = '‚ùå N√§tverksfel';
            statusEl.className = 'upload-status mt-2 text-xs text-red-600';
          }
        }
        
        // √Öterst√§ll input
        target.value = '';
      });
    });
  </script>
</BaseLayout>
