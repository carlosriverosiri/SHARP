---
// SSR f√∂r denna sida (kr√§vs f√∂r cookies och Supabase auth)
export const prerender = false;

import { arInloggad, hamtaAnvandare } from '../../lib/auth';
import { supabase } from '../../lib/supabase';

// Kontrollera inloggning
if (!await arInloggad(Astro.cookies)) {
  return Astro.redirect('/personal/');
}

const anvandare = await hamtaAnvandare(Astro.cookies);

// Hantera POST-requests (l√§gg till, ta bort)
let meddelande = '';
let meddelandeTyp = '';

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action')?.toString();

  if (action === 'lagg-till-lank') {
    const titel = formData.get('titel')?.toString();
    const url = formData.get('url')?.toString();
    const kategori = formData.get('kategori')?.toString();
    const beskrivning = formData.get('beskrivning')?.toString();
    
    // Avg√∂r typ baserat p√• URL
    let typ = 'l√§nk';
    if (url?.includes('youtube.com') || url?.includes('youtu.be') || url?.includes('vimeo.com')) {
      typ = 'video';
    }

    const { error } = await supabase.from('resurser').insert({
      titel,
      url,
      kategori,
      beskrivning,
      typ,
      skapad_av: anvandare?.id
    });

    if (error) {
      meddelande = 'Kunde inte l√§gga till l√§nken: ' + error.message;
      meddelandeTyp = 'error';
    } else {
      meddelande = 'L√§nken har lagts till!';
      meddelandeTyp = 'success';
    }
  }

  if (action === 'ta-bort') {
    const id = formData.get('id')?.toString();
    const filNamn = formData.get('fil_namn')?.toString();

    // Ta bort fil fr√•n storage om det finns
    if (filNamn) {
      await supabase.storage.from('dokument').remove([filNamn]);
    }

    const { error } = await supabase.from('resurser').delete().eq('id', id);

    if (error) {
      meddelande = 'Kunde inte ta bort resursen: ' + error.message;
      meddelandeTyp = 'error';
    } else {
      meddelande = 'Resursen har tagits bort!';
      meddelandeTyp = 'success';
    }
  }
}

// H√§mta alla resurser grupperade per kategori
const { data: resurser, error } = await supabase
  .from('resurser')
  .select('*')
  .order('kategori', { ascending: true })
  .order('skapad_vid', { ascending: false });

// Gruppera per kategori
const kategorier: Record<string, typeof resurser> = {};
if (resurser) {
  for (const resurs of resurser) {
    if (!kategorier[resurs.kategori]) {
      kategorier[resurs.kategori] = [];
    }
    kategorier[resurs.kategori].push(resurs);
  }
}

// F√∂rdefinierade kategorier
const kategoriAlternativ = [
  'Journalsystem',
  'Region Stockholm',
  'Rutiner & Policyer',
  'Onboarding',
  'Utbildning',
  '√ñvrigt'
];

// Ikoner per kategori
const kategoriIkoner: Record<string, string> = {
  'Journalsystem': 'üé¨',
  'Region Stockholm': 'üè•',
  'Rutiner & Policyer': 'üìã',
  'Onboarding': 'üëã',
  'Utbildning': 'üìö',
  '√ñvrigt': 'üìÅ'
};

// Ikon per typ
function getTypIkon(typ: string, url?: string) {
  if (typ === 'video') return '‚ñ∂Ô∏è';
  if (typ === 'dokument') return 'üìÑ';
  return 'üîó';
}
---
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Resurser | Personalportal</title>
  <link rel="icon" type="image/svg+xml" href="/favicons/favicon.svg">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f1f5f9;
      min-height: 100vh;
    }

    .layout {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
      color: white;
      padding: 1.5rem;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 1.5rem;
    }

    .sidebar-logo img {
      height: 32px;
    }

    .sidebar-logo span {
      font-weight: 600;
      font-size: 1rem;
    }

    .nav-section {
      margin-bottom: 1.5rem;
    }

    .nav-section-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #64748b;
      margin-bottom: 0.75rem;
      padding-left: 0.75rem;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      color: #cbd5e1;
      text-decoration: none;
      border-radius: 0.5rem;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .nav-link:hover {
      background: rgba(255,255,255,0.1);
      color: white;
    }

    .nav-link.active {
      background: #0284c7;
      color: white;
    }

    .nav-link svg {
      width: 20px;
      height: 20px;
    }

    /* Main content */
    .main-content {
      flex: 1;
      margin-left: 260px;
      padding: 2rem;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .page-title {
      font-size: 1.75rem;
      font-weight: 700;
      color: #1e293b;
    }

    .page-subtitle {
      color: #64748b;
      margin-top: 0.25rem;
    }

    .header-actions {
      display: flex;
      gap: 0.75rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      border-radius: 0.5rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      border: none;
    }

    .btn-primary {
      background: #0284c7;
      color: white;
    }

    .btn-primary:hover {
      background: #0369a1;
    }

    .btn-secondary {
      background: white;
      color: #374151;
      border: 1px solid #d1d5db;
    }

    .btn-secondary:hover {
      background: #f9fafb;
    }

    .btn-danger {
      background: #fee2e2;
      color: #dc2626;
      padding: 0.5rem;
    }

    .btn-danger:hover {
      background: #fecaca;
    }

    /* Meddelande */
    .message {
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .message.success {
      background: #f0fdf4;
      border: 1px solid #86efac;
      color: #166534;
    }

    .message.error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
    }

    /* Kategori-sektion */
    .kategori-section {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
      overflow: hidden;
    }

    .kategori-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem 1.5rem;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
    }

    .kategori-header h2 {
      font-size: 1.1rem;
      font-weight: 600;
      color: #1e293b;
    }

    .kategori-ikon {
      font-size: 1.25rem;
    }

    .resurs-lista {
      padding: 0.5rem;
    }

    .resurs-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      transition: background 0.2s;
    }

    .resurs-item:hover {
      background: #f8fafc;
    }

    .resurs-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex: 1;
    }

    .resurs-ikon {
      font-size: 1.25rem;
    }

    .resurs-titel {
      font-weight: 500;
      color: #1e293b;
    }

    .resurs-titel a {
      color: inherit;
      text-decoration: none;
    }

    .resurs-titel a:hover {
      color: #0284c7;
      text-decoration: underline;
    }

    .resurs-beskrivning {
      font-size: 0.8rem;
      color: #64748b;
      margin-top: 0.25rem;
    }

    .resurs-actions {
      display: flex;
      gap: 0.5rem;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 1rem;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .modal-header h3 {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #64748b;
    }

    .modal-body {
      padding: 1.5rem;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group label {
      display: block;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #0284c7;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      padding: 1rem 1.5rem;
      border-top: 1px solid #e2e8f0;
      background: #f8fafc;
    }

    /* Tom state */
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #64748b;
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid #e2e8f0;
      padding-bottom: 0.5rem;
    }

    .tab {
      padding: 0.5rem 1rem;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 0.9rem;
      color: #64748b;
      border-radius: 0.375rem;
    }

    .tab.active {
      background: #0284c7;
      color: white;
    }

    /* File upload */
    .file-upload-area {
      border: 2px dashed #d1d5db;
      border-radius: 0.5rem;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .file-upload-area:hover {
      border-color: #0284c7;
      background: #f0f9ff;
    }

    .file-upload-area.dragover {
      border-color: #0284c7;
      background: #e0f2fe;
    }

    .file-upload-input {
      display: none;
    }

    @media (max-width: 768px) {
      .sidebar {
        display: none;
      }
      .main-content {
        margin-left: 0;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <img src="/images/branding/logo.svg" alt="Logo">
        <span>Personalportal</span>
      </div>

      <nav>
        <div class="nav-section">
          <div class="nav-section-title">Meny</div>
          <a href="/personal/oversikt" class="nav-link">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
            </svg>
            √ñversikt
          </a>
          <a href="/personal/resurser" class="nav-link active">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
            </svg>
            Resurser
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Konto</div>
          <a href="/personal/oversikt?logout=true" class="nav-link">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
            </svg>
            Logga ut
          </a>
        </div>
      </nav>
    </aside>

    <!-- Main content -->
    <main class="main-content">
      <div class="page-header">
        <div>
          <h1 class="page-title">üìö Resurser</h1>
          <p class="page-subtitle">Dokument, l√§nkar och instruktionsvideor f√∂r personalen</p>
        </div>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="openModal('link')">
            <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
            </svg>
            L√§gg till l√§nk
          </button>
          <button class="btn btn-secondary" onclick="openModal('file')">
            <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
            </svg>
            Ladda upp dokument
          </button>
        </div>
      </div>

      {meddelande && (
        <div class={`message ${meddelandeTyp}`}>
          {meddelandeTyp === 'success' ? '‚úÖ' : '‚ùå'} {meddelande}
        </div>
      )}

      {Object.keys(kategorier).length === 0 ? (
        <div class="kategori-section">
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <h3>Inga resurser √§n</h3>
            <p>Klicka p√• "L√§gg till l√§nk" eller "Ladda upp dokument" f√∂r att komma ig√•ng.</p>
          </div>
        </div>
      ) : (
        Object.entries(kategorier).map(([kategori, items]) => (
          <div class="kategori-section">
            <div class="kategori-header">
              <span class="kategori-ikon">{kategoriIkoner[kategori] || 'üìÅ'}</span>
              <h2>{kategori}</h2>
            </div>
            <div class="resurs-lista">
              {items?.map((resurs) => (
                <div class="resurs-item">
                  <div class="resurs-info">
                    <span class="resurs-ikon">{getTypIkon(resurs.typ, resurs.url)}</span>
                    <div>
                      <div class="resurs-titel">
                        {resurs.typ === 'dokument' ? (
                          <a href={`${import.meta.env.PUBLIC_SUPABASE_URL}/storage/v1/object/public/dokument/${resurs.fil_namn}`} target="_blank" rel="noopener">
                            {resurs.titel}
                          </a>
                        ) : (
                          <a href={resurs.url} target="_blank" rel="noopener">
                            {resurs.titel}
                          </a>
                        )}
                      </div>
                      {resurs.beskrivning && (
                        <div class="resurs-beskrivning">{resurs.beskrivning}</div>
                      )}
                    </div>
                  </div>
                  <div class="resurs-actions">
                    <form method="POST" style="display: inline;">
                      <input type="hidden" name="action" value="ta-bort">
                      <input type="hidden" name="id" value={resurs.id}>
                      <input type="hidden" name="fil_namn" value={resurs.fil_namn || ''}>
                      <button type="submit" class="btn btn-danger" onclick="return confirm('√Ñr du s√§ker p√• att du vill ta bort denna resurs?')">
                        <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                      </button>
                    </form>
                  </div>
                </div>
              ))}
            </div>
          </div>
        ))
      )}
    </main>
  </div>

  <!-- Modal f√∂r l√§nk -->
  <div class="modal-overlay" id="link-modal">
    <div class="modal">
      <div class="modal-header">
        <h3>üîó L√§gg till l√§nk</h3>
        <button class="modal-close" onclick="closeModal('link')">&times;</button>
      </div>
      <form method="POST">
        <input type="hidden" name="action" value="lagg-till-lank">
        <div class="modal-body">
          <div class="form-group">
            <label for="titel">Titel *</label>
            <input type="text" id="titel" name="titel" placeholder="T.ex. S√• loggar du in i TakeCare" required>
          </div>
          <div class="form-group">
            <label for="url">URL *</label>
            <input type="url" id="url" name="url" placeholder="https://..." required>
          </div>
          <div class="form-group">
            <label for="kategori">Kategori *</label>
            <select id="kategori" name="kategori" required>
              {kategoriAlternativ.map((kat) => (
                <option value={kat}>{kat}</option>
              ))}
            </select>
          </div>
          <div class="form-group">
            <label for="beskrivning">Beskrivning (valfritt)</label>
            <textarea id="beskrivning" name="beskrivning" placeholder="Kort beskrivning..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('link')">Avbryt</button>
          <button type="submit" class="btn btn-primary">L√§gg till</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal f√∂r fil-uppladdning -->
  <div class="modal-overlay" id="file-modal">
    <div class="modal">
      <div class="modal-header">
        <h3>üìÑ Ladda upp dokument</h3>
        <button class="modal-close" onclick="closeModal('file')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>V√§lj fil</label>
          <div class="file-upload-area" id="drop-area">
            <p>üìÅ Dra fil hit eller klicka f√∂r att v√§lja</p>
            <p style="font-size: 0.8rem; color: #64748b; margin-top: 0.5rem;">PDF, Word, Excel, etc.</p>
            <input type="file" class="file-upload-input" id="file-input" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx">
          </div>
        </div>
        <div class="form-group">
          <label for="file-titel">Titel *</label>
          <input type="text" id="file-titel" placeholder="Dokumentets namn">
        </div>
        <div class="form-group">
          <label for="file-kategori">Kategori *</label>
          <select id="file-kategori">
            {kategoriAlternativ.map((kat) => (
              <option value={kat}>{kat}</option>
            ))}
          </select>
        </div>
        <div class="form-group">
          <label for="file-beskrivning">Beskrivning (valfritt)</label>
          <textarea id="file-beskrivning" placeholder="Kort beskrivning..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal('file')">Avbryt</button>
        <button type="button" class="btn btn-primary" id="upload-btn">Ladda upp</button>
      </div>
    </div>
  </div>

  <script define:vars={{ supabaseUrl: import.meta.env.PUBLIC_SUPABASE_URL, supabaseAnonKey: import.meta.env.PUBLIC_SUPABASE_ANON_KEY }}>
    // Modal-hantering
    function openModal(type) {
      document.getElementById(type + '-modal').classList.add('active');
    }

    function closeModal(type) {
      document.getElementById(type + '-modal').classList.remove('active');
    }

    // St√§ng modal vid klick utanf√∂r
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('active');
        }
      });
    });

    // G√∂r funktioner globala
    window.openModal = openModal;
    window.closeModal = closeModal;

    // Fil-uppladdning
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('file-input');
    const uploadBtn = document.getElementById('upload-btn');
    let selectedFile = null;

    // Klick f√∂r att v√§lja fil
    dropArea.addEventListener('click', () => fileInput.click());

    // Fil vald
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        selectedFile = e.target.files[0];
        dropArea.innerHTML = `<p>‚úÖ ${selectedFile.name}</p><p style="font-size: 0.8rem; color: #64748b;">${(selectedFile.size / 1024).toFixed(1)} KB</p>`;
        document.getElementById('file-titel').value = selectedFile.name.replace(/\.[^/.]+$/, '');
      }
    });

    // Drag & drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
      });
    });

    ['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, () => dropArea.classList.add('dragover'));
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, () => dropArea.classList.remove('dragover'));
    });

    dropArea.addEventListener('drop', (e) => {
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        selectedFile = files[0];
        dropArea.innerHTML = `<p>‚úÖ ${selectedFile.name}</p><p style="font-size: 0.8rem; color: #64748b;">${(selectedFile.size / 1024).toFixed(1)} KB</p>`;
        document.getElementById('file-titel').value = selectedFile.name.replace(/\.[^/.]+$/, '');
      }
    });

    // Ladda upp fil
    uploadBtn.addEventListener('click', async () => {
      if (!selectedFile) {
        alert('V√§lj en fil f√∂rst!');
        return;
      }

      const titel = document.getElementById('file-titel').value;
      const kategori = document.getElementById('file-kategori').value;
      const beskrivning = document.getElementById('file-beskrivning').value;

      if (!titel) {
        alert('Ange en titel!');
        return;
      }

      uploadBtn.textContent = 'Laddar upp...';
      uploadBtn.disabled = true;

      try {
        // Skapa unik filnamn
        const filnamn = Date.now() + '_' + selectedFile.name.replace(/[^a-zA-Z0-9.-]/g, '_');

        // Ladda upp till Supabase Storage
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('dokument')
          .upload(filnamn, selectedFile);

        if (uploadError) throw uploadError;

        // Spara metadata i databasen
        const { error: dbError } = await supabase.from('resurser').insert({
          titel,
          fil_namn: filnamn,
          fil_storlek: selectedFile.size,
          kategori,
          beskrivning,
          typ: 'dokument'
        });

        if (dbError) throw dbError;

        // Ladda om sidan
        window.location.reload();
      } catch (err) {
        console.error('Uppladdningsfel:', err);
        alert('Kunde inte ladda upp filen: ' + err.message);
        uploadBtn.textContent = 'Ladda upp';
        uploadBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
