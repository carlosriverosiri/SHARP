---
// SSR f√∂r denna sida (kr√§vs f√∂r cookies och Supabase auth)
export const prerender = false;

import { arInloggad, hamtaAnvandare } from '../../lib/auth';
import { supabaseAdmin } from '../../lib/supabase';

// Kontrollera inloggning
if (!await arInloggad(Astro.cookies)) {
  return Astro.redirect('/personal/');
}

const anvandare = await hamtaAnvandare(Astro.cookies);

// Hantera POST-requests (l√§gg till, ta bort)
let meddelande = '';
let meddelandeTyp = '';

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action')?.toString();

  if (action === 'lagg-till-lank') {
    const titel = formData.get('titel')?.toString();
    const url = formData.get('url')?.toString();
    const kategori = formData.get('kategori')?.toString();
    const beskrivning = formData.get('beskrivning')?.toString();
    
    // Avg√∂r typ baserat p√• URL
    let typ = 'l√§nk';
    if (url?.includes('youtube.com') || url?.includes('youtu.be') || url?.includes('vimeo.com')) {
      typ = 'video';
    }

    const { error } = await supabaseAdmin.from('resurser').insert({
      titel,
      url,
      kategori,
      beskrivning,
      typ,
      skapad_av: anvandare?.id
    });

    if (error) {
      meddelande = 'Kunde inte l√§gga till l√§nken: ' + error.message;
      meddelandeTyp = 'error';
    } else {
      meddelande = 'L√§nken har lagts till!';
      meddelandeTyp = 'success';
    }
  }

  if (action === 'ta-bort') {
    const id = formData.get('id')?.toString();
    const filNamn = formData.get('fil_namn')?.toString();

    // Ta bort fil fr√•n storage om det finns
    if (filNamn) {
      await supabaseAdmin.storage.from('dokument').remove([filNamn]);
    }

    const { error } = await supabaseAdmin.from('resurser').delete().eq('id', id);

    if (error) {
      meddelande = 'Kunde inte ta bort resursen: ' + error.message;
      meddelandeTyp = 'error';
    } else {
      meddelande = 'Resursen har tagits bort!';
      meddelandeTyp = 'success';
    }
  }
}

// H√§mta alla resurser
const { data: resurser, error } = await supabaseAdmin
  .from('resurser')
  .select('*')
  .order('skapad_vid', { ascending: false });

// Gruppera per TYP (dokument, l√§nk, video)
const dokument = resurser?.filter(r => r.typ === 'dokument') || [];
const lankar = resurser?.filter(r => r.typ === 'l√§nk') || [];
const videor = resurser?.filter(r => r.typ === 'video') || [];

// F√∂rdefinierade kategorier
const kategoriAlternativ = [
  'Journalsystem',
  'Region Stockholm',
  'Rutiner & Policyer',
  'Onboarding',
  'Utbildning',
  '√ñvrigt'
];
---
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Resurser | Personalportal</title>
  <link rel="icon" type="image/svg+xml" href="/favicons/favicon.svg">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f1f5f9;
      min-height: 100vh;
    }

    .layout {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
      color: white;
      padding: 1.5rem;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 1.5rem;
      text-decoration: none;
      color: inherit;
      transition: opacity 0.2s;
    }

    .sidebar-logo:hover {
      opacity: 0.8;
    }

    .sidebar-logo img {
      height: 32px;
    }

    .sidebar-logo span {
      font-weight: 600;
      font-size: 1rem;
    }

    .nav-section {
      margin-bottom: 1.5rem;
    }

    .nav-section-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #64748b;
      margin-bottom: 0.75rem;
      padding-left: 0.75rem;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      color: #cbd5e1;
      text-decoration: none;
      border-radius: 0.5rem;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .nav-link:hover {
      background: rgba(255,255,255,0.1);
      color: white;
    }

    .nav-link.active {
      background: #0284c7;
      color: white;
    }

    .nav-link svg {
      width: 20px;
      height: 20px;
    }

    /* Main content */
    .main-content {
      flex: 1;
      margin-left: 260px;
      padding: 2rem;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .page-title {
      font-size: 1.75rem;
      font-weight: 700;
      color: #1e293b;
    }

    .page-subtitle {
      color: #64748b;
      margin-top: 0.25rem;
    }

    .header-actions {
      display: flex;
      gap: 0.75rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      border-radius: 0.5rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      border: none;
    }

    .btn-primary {
      background: #0284c7;
      color: white;
    }

    .btn-primary:hover {
      background: #0369a1;
    }

    .btn-secondary {
      background: white;
      color: #374151;
      border: 1px solid #d1d5db;
    }

    .btn-secondary:hover {
      background: #f9fafb;
    }

    .btn-danger {
      background: #fee2e2;
      color: #dc2626;
      padding: 0.5rem;
    }

    .btn-danger:hover {
      background: #fecaca;
    }

    /* Meddelande */
    .message {
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .message.success {
      background: #f0fdf4;
      border: 1px solid #86efac;
      color: #166534;
    }

    .message.error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
    }

    /* Kategori-sektion */
    .kategori-section {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
      overflow: hidden;
    }

    .kategori-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem 1.5rem;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
    }

    .kategori-header h2 {
      font-size: 1.1rem;
      font-weight: 600;
      color: #1e293b;
    }

    .kategori-ikon {
      font-size: 1.25rem;
    }

    .resurs-lista {
      padding: 0.5rem;
    }

    .resurs-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      transition: background 0.2s;
    }

    .resurs-item:hover {
      background: #f8fafc;
    }

    .resurs-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex: 1;
    }

    .resurs-ikon {
      font-size: 1.25rem;
    }

    .resurs-titel {
      font-weight: 500;
      color: #1e293b;
    }

    .resurs-titel a {
      color: inherit;
      text-decoration: none;
    }

    .resurs-titel a:hover {
      color: #0284c7;
      text-decoration: underline;
    }

    .resurs-beskrivning {
      font-size: 0.8rem;
      color: #64748b;
      margin-top: 0.25rem;
    }

    .resurs-actions {
      display: flex;
      gap: 0.5rem;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 1rem;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .modal-header h3 {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #64748b;
    }

    .modal-body {
      padding: 1.5rem;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group label {
      display: block;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #0284c7;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      padding: 1rem 1.5rem;
      border-top: 1px solid #e2e8f0;
      background: #f8fafc;
    }

    /* Tom state */
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #64748b;
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid #e2e8f0;
      padding-bottom: 0.5rem;
    }

    .tab {
      padding: 0.5rem 1rem;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 0.9rem;
      color: #64748b;
      border-radius: 0.375rem;
    }

    .tab.active {
      background: #0284c7;
      color: white;
    }

    /* File upload */
    .file-upload-area {
      border: 2px dashed #d1d5db;
      border-radius: 0.5rem;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .file-upload-area:hover {
      border-color: #0284c7;
      background: #f0f9ff;
    }

    .file-upload-area.dragover {
      border-color: #0284c7;
      background: #e0f2fe;
    }

    .file-upload-input {
      display: none;
    }

    /* 3-kolumns layout */
    .columns-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
    }

    .column {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .column-header {
      padding: 1rem 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      border-bottom: 2px solid;
    }

    .column-header.dokument {
      background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%);
      border-color: #f59e0b;
    }

    .column-header.lankar {
      background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%);
      border-color: #3b82f6;
    }

    .column-header.videor {
      background: linear-gradient(135deg, #fce7f3 0%, #fdf2f8 100%);
      border-color: #ec4899;
    }

    .column-header h2 {
      font-size: 1rem;
      font-weight: 600;
      color: #1e293b;
    }

    .column-header .count {
      margin-left: auto;
      background: white;
      padding: 0.25rem 0.625rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      color: #64748b;
    }

    .column-content {
      padding: 0.75rem;
      flex: 1;
      overflow-y: auto;
      max-height: calc(100vh - 280px);
    }

    .column-empty {
      text-align: center;
      padding: 2rem 1rem;
      color: #94a3b8;
    }

    .column-empty-icon {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
      opacity: 0.5;
    }

    .resource-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      transition: all 0.2s;
      cursor: pointer;
      display: block;
      text-decoration: none;
      color: inherit;
    }

    .resource-card:hover {
      background: #f1f5f9;
      border-color: #94a3b8;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .resource-card .resource-title {
      color: #1e293b;
      font-weight: 500;
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }

    .resource-card:hover .resource-title {
      color: #0284c7;
    }

    .resource-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 0.5rem;
    }

    .resource-kategori {
      font-size: 0.7rem;
      background: #e2e8f0;
      color: #64748b;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
    }

    .resource-delete {
      background: none;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 0.25rem;
      transition: all 0.2s;
    }

    .resource-delete:hover {
      background: #fee2e2;
      color: #dc2626;
    }

    @media (max-width: 1200px) {
      .columns-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        display: none;
      }
      .main-content {
        margin-left: 0;
      }
      .columns-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <a href="/" class="sidebar-logo" title="Tillbaka till hemsidan">
        <img src="/images/branding/logo.svg" alt="S√∂dermalms Ortopedi">
      </a>

      <nav>
        <div class="nav-section">
          <div class="nav-section-title">Verktyg</div>
          <a href="/personal/oversikt" class="nav-link">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
            </svg>
            √ñversikt
          </a>
          <a href="/personal/resurser" class="nav-link active">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
            </svg>
            Resurser
          </a>
          <a href="/copy-links" class="nav-link">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
            </svg>
            Kopiera l√§nkar
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Administration</div>
          <a href="/admin/obesvarade" class="nav-link">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Obesvarade fr√•gor
          </a>
          <a href="/senast-redigerade" class="nav-link">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Senast redigerade
          </a>
          <a href="/info/kallelse-operation" class="nav-link">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            Kallelse operation
          </a>
          <a href="/info/kallelse-operation-forsakring" class="nav-link">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
            </svg>
            Kallelse f√∂rs√§kring
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Konto</div>
          <a href="/personal/oversikt?logout=true" class="nav-link">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
            </svg>
            Logga ut
          </a>
        </div>
      </nav>
    </aside>

    <!-- Main content -->
    <main class="main-content">
      <div class="page-header">
        <div>
          <h1 class="page-title">üìö Resurser</h1>
          <p class="page-subtitle">Dokument, l√§nkar och instruktionsvideor f√∂r personalen</p>
        </div>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="openModal('link')">
            <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
            </svg>
            L√§gg till l√§nk
          </button>
          <button class="btn btn-secondary" onclick="openModal('file')">
            <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
            </svg>
            Ladda upp dokument
          </button>
        </div>
      </div>

      {meddelande && (
        <div class={`message ${meddelandeTyp}`}>
          {meddelandeTyp === 'success' ? '‚úÖ' : '‚ùå'} {meddelande}
        </div>
      )}

      <!-- 3-kolumns layout -->
      <div class="columns-grid">
        <!-- DOKUMENT -->
        <div class="column">
          <div class="column-header dokument">
            <span style="font-size: 1.5rem;">üìÑ</span>
            <h2>Dokument</h2>
            <span class="count">{dokument.length}</span>
          </div>
          <div class="column-content">
            {dokument.length === 0 ? (
              <div class="column-empty">
                <div class="column-empty-icon">üìÑ</div>
                <p>Inga dokument √§n</p>
                <p style="font-size: 0.75rem; margin-top: 0.5rem;">Ladda upp PDF:er, Word-dokument m.m.</p>
              </div>
            ) : (
              dokument.map((resurs) => (
                <a 
                  href={`${import.meta.env.PUBLIC_SUPABASE_URL}/storage/v1/object/public/dokument/${resurs.fil_namn}`} 
                  target="_blank" 
                  rel="noopener"
                  class="resource-card"
                >
                  <div class="resource-title">{resurs.titel}</div>
                  {resurs.beskrivning && (
                    <p style="font-size: 0.8rem; color: #64748b; margin: 0;">{resurs.beskrivning}</p>
                  )}
                  <div class="resource-meta">
                    <span class="resource-kategori">{resurs.kategori}</span>
                  </div>
                </a>
              ))
            )}
          </div>
        </div>

        <!-- L√ÑNKAR -->
        <div class="column">
          <div class="column-header lankar">
            <span style="font-size: 1.5rem;">üîó</span>
            <h2>L√§nkar</h2>
            <span class="count">{lankar.length}</span>
          </div>
          <div class="column-content">
            {lankar.length === 0 ? (
              <div class="column-empty">
                <div class="column-empty-icon">üîó</div>
                <p>Inga l√§nkar √§n</p>
                <p style="font-size: 0.75rem; margin-top: 0.5rem;">L√§gg till l√§nkar till Region Stockholm, rutiner m.m.</p>
              </div>
            ) : (
              lankar.map((resurs) => (
                <a 
                  href={resurs.url} 
                  target="_blank" 
                  rel="noopener"
                  class="resource-card"
                >
                  <div class="resource-title">{resurs.titel}</div>
                  {resurs.beskrivning && (
                    <p style="font-size: 0.8rem; color: #64748b; margin: 0;">{resurs.beskrivning}</p>
                  )}
                  <div class="resource-meta">
                    <span class="resource-kategori">{resurs.kategori}</span>
                  </div>
                </a>
              ))
            )}
          </div>
        </div>

        <!-- INSTRUKTIONSVIDEOR -->
        <div class="column">
          <div class="column-header videor">
            <span style="font-size: 1.5rem;">‚ñ∂Ô∏è</span>
            <h2>Instruktionsvideor</h2>
            <span class="count">{videor.length}</span>
          </div>
          <div class="column-content">
            {videor.length === 0 ? (
              <div class="column-empty">
                <div class="column-empty-icon">üé¨</div>
                <p>Inga videor √§n</p>
                <p style="font-size: 0.75rem; margin-top: 0.5rem;">L√§gg till YouTube-l√§nkar f√∂r utbildning och onboarding</p>
              </div>
            ) : (
              videor.map((resurs) => (
                <a 
                  href={resurs.url} 
                  target="_blank" 
                  rel="noopener"
                  class="resource-card"
                >
                  <div class="resource-title">{resurs.titel}</div>
                  {resurs.beskrivning && (
                    <p style="font-size: 0.8rem; color: #64748b; margin: 0;">{resurs.beskrivning}</p>
                  )}
                  <div class="resource-meta">
                    <span class="resource-kategori">{resurs.kategori}</span>
                  </div>
                </a>
              ))
            )}
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal f√∂r l√§nk -->
  <div class="modal-overlay" id="link-modal">
    <div class="modal">
      <div class="modal-header">
        <h3>üîó L√§gg till l√§nk</h3>
        <button class="modal-close" onclick="closeModal('link')">&times;</button>
      </div>
      <form method="POST">
        <input type="hidden" name="action" value="lagg-till-lank">
        <div class="modal-body">
          <div class="form-group">
            <label for="titel">Titel *</label>
            <input type="text" id="titel" name="titel" placeholder="T.ex. S√• loggar du in i TakeCare" required>
          </div>
          <div class="form-group">
            <label for="url">URL *</label>
            <input type="url" id="url" name="url" placeholder="https://..." required>
          </div>
          <div class="form-group">
            <label for="kategori">Kategori *</label>
            <select id="kategori" name="kategori" required>
              {kategoriAlternativ.map((kat) => (
                <option value={kat}>{kat}</option>
              ))}
            </select>
          </div>
          <div class="form-group">
            <label for="beskrivning">Beskrivning (valfritt)</label>
            <textarea id="beskrivning" name="beskrivning" placeholder="Kort beskrivning..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('link')">Avbryt</button>
          <button type="submit" class="btn btn-primary">L√§gg till</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal f√∂r fil-uppladdning -->
  <div class="modal-overlay" id="file-modal">
    <div class="modal">
      <div class="modal-header">
        <h3>üìÑ Ladda upp dokument</h3>
        <button class="modal-close" onclick="closeModal('file')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>V√§lj fil</label>
          <div class="file-upload-area" id="drop-area">
            <p>üìÅ Dra fil hit eller klicka f√∂r att v√§lja</p>
            <p style="font-size: 0.8rem; color: #64748b; margin-top: 0.5rem;">PDF, Word, Excel, etc.</p>
            <input type="file" class="file-upload-input" id="file-input" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx">
          </div>
        </div>
        <div class="form-group">
          <label for="file-titel">Titel *</label>
          <input type="text" id="file-titel" placeholder="Dokumentets namn">
        </div>
        <div class="form-group">
          <label for="file-kategori">Kategori *</label>
          <select id="file-kategori">
            {kategoriAlternativ.map((kat) => (
              <option value={kat}>{kat}</option>
            ))}
          </select>
        </div>
        <div class="form-group">
          <label for="file-beskrivning">Beskrivning (valfritt)</label>
          <textarea id="file-beskrivning" placeholder="Kort beskrivning..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal('file')">Avbryt</button>
        <button type="button" class="btn btn-primary" id="upload-btn">Ladda upp</button>
      </div>
    </div>
  </div>

  <script define:vars={{ supabaseUrl: import.meta.env.PUBLIC_SUPABASE_URL, supabaseAnonKey: import.meta.env.PUBLIC_SUPABASE_ANON_KEY }}>
    // Modal-hantering
    function openModal(type) {
      document.getElementById(type + '-modal').classList.add('active');
    }

    function closeModal(type) {
      document.getElementById(type + '-modal').classList.remove('active');
    }

    // St√§ng modal vid klick utanf√∂r
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('active');
        }
      });
    });

    // G√∂r funktioner globala
    window.openModal = openModal;
    window.closeModal = closeModal;

    // Fil-uppladdning
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('file-input');
    const uploadBtn = document.getElementById('upload-btn');
    let selectedFile = null;

    // Klick f√∂r att v√§lja fil
    dropArea.addEventListener('click', () => fileInput.click());

    // Fil vald
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        selectedFile = e.target.files[0];
        dropArea.innerHTML = `<p>‚úÖ ${selectedFile.name}</p><p style="font-size: 0.8rem; color: #64748b;">${(selectedFile.size / 1024).toFixed(1)} KB</p>`;
        document.getElementById('file-titel').value = selectedFile.name.replace(/\.[^/.]+$/, '');
      }
    });

    // Drag & drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
      });
    });

    ['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, () => dropArea.classList.add('dragover'));
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, () => dropArea.classList.remove('dragover'));
    });

    dropArea.addEventListener('drop', (e) => {
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        selectedFile = files[0];
        dropArea.innerHTML = `<p>‚úÖ ${selectedFile.name}</p><p style="font-size: 0.8rem; color: #64748b;">${(selectedFile.size / 1024).toFixed(1)} KB</p>`;
        document.getElementById('file-titel').value = selectedFile.name.replace(/\.[^/.]+$/, '');
      }
    });

    // Ladda upp fil
    uploadBtn.addEventListener('click', async () => {
      if (!selectedFile) {
        alert('V√§lj en fil f√∂rst!');
        return;
      }

      const titel = document.getElementById('file-titel').value;
      const kategori = document.getElementById('file-kategori').value;
      const beskrivning = document.getElementById('file-beskrivning').value;

      if (!titel) {
        alert('Ange en titel!');
        return;
      }

      uploadBtn.textContent = 'Laddar upp...';
      uploadBtn.disabled = true;

      try {
        // Skapa unik filnamn
        const filnamn = Date.now() + '_' + selectedFile.name.replace(/[^a-zA-Z0-9.-]/g, '_');

        // Ladda upp till Supabase Storage
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('dokument')
          .upload(filnamn, selectedFile);

        if (uploadError) throw uploadError;

        // Spara metadata i databasen
        const { error: dbError } = await supabase.from('resurser').insert({
          titel,
          fil_namn: filnamn,
          fil_storlek: selectedFile.size,
          kategori,
          beskrivning,
          typ: 'dokument'
        });

        if (dbError) throw dbError;

        // Ladda om sidan
        window.location.reload();
      } catch (err) {
        console.error('Uppladdningsfel:', err);
        alert('Kunde inte ladda upp filen: ' + err.message);
        uploadBtn.textContent = 'Ladda upp';
        uploadBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
