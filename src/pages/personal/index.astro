---
/**
 * Personalportal - Inloggningssida
 * 
 * St√∂der tv√• l√§gen:
 * 1. ENKELT L√ÑGE: Endast l√∂senord (nuvarande)
 * 2. SUPABASE L√ÑGE: E-post + l√∂senord, gl√∂mt l√∂senord, magic link (framtiden)
 */

// SSR f√∂r denna sida (kr√§vs f√∂r cookies och Supabase auth)
export const prerender = false;

import { 
  arInloggad, 
  loggaIn, 
  arSupabaseAktiverat,
  skickaAterst√§llningslank,
  skickaMagicLink 
} from '../../lib/auth';

const USE_SUPABASE = arSupabaseAktiverat();

const url = new URL(Astro.request.url);
const nextParam = url.searchParams.get('next') || '';
const safeNext = nextParam.startsWith('/personal') ? nextParam : '';

// Kontrollera om redan inloggad (med sliding timeout)
if (await arInloggad(Astro.cookies)) {
  return Astro.redirect(safeNext || '/personal/oversikt');
}

// Hantera POST (login-f√∂rs√∂k)
let errorMessage = '';
let successMessage = '';
let activeTab = 'password'; // 'password' eller 'magic-link'

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const action = formData.get('action')?.toString() || 'login';
    
    if (action === 'login') {
      // Inloggning med l√∂senord
      const password = formData.get('password')?.toString() || '';
      const email = formData.get('email')?.toString() || '';
      console.log('üìß F√∂rs√∂ker logga in:', { email, hasPassword: !!password });
      
      const result = await loggaIn(Astro.cookies, password, email, Astro.request);
      
      if (result.success) {
        return Astro.redirect((((formData.get('next')?.toString() || '').startsWith('/personal') ? (formData.get('next')?.toString() || '') : '') || safeNext || '/personal/oversikt'));
      } else {
        errorMessage = result.error || 'Inloggning misslyckades';
      }
    } else if (action === 'forgot-password' && USE_SUPABASE) {
      // Gl√∂mt l√∂senord
      const email = formData.get('reset-email')?.toString() || '';
      const result = await skickaAterst√§llningslank(email);
      
      if (result.success) {
        successMessage = 'Om kontot finns skickas en √•terst√§llningsl√§nk till ' + email;
      } else {
        errorMessage = result.error || 'Kunde inte skicka √•terst√§llningsl√§nk';
      }
    } else if (action === 'magic-link' && USE_SUPABASE) {
      // Magic Link
      activeTab = 'magic-link';
      const email = formData.get('magic-email')?.toString() || '';
      const result = await skickaMagicLink(email);
      
      if (result.success) {
        successMessage = 'En inloggningsl√§nk har skickats till ' + email;
      } else {
        errorMessage = result.error || 'Kunde inte skicka inloggningsl√§nk';
      }
    }
  } catch (e) {
    console.error('‚ùå Inloggningsfel:', e);
    errorMessage = 'Ett fel uppstod. F√∂rs√∂k igen.';
  }
}
---

<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Personalportal | S√∂dermalms Ortopedi</title>
  <link rel="icon" type="image/svg+xml" href="/favicons/favicon.svg">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    
    .login-container {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      width: 100%;
      max-width: 420px;
      padding: 2.5rem;
    }
    
    .logo-section {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .logo-section img {
      height: 48px;
      margin-bottom: 1rem;
    }
    
    .logo-section h1 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 0.5rem;
    }
    
    .logo-section p {
      color: #64748b;
      font-size: 0.875rem;
    }
    
    /* Tab Navigation (endast Supabase-l√§ge) */
    .tab-nav {
      display: flex;
      gap: 0.25rem;
      background: #f1f5f9;
      padding: 0.25rem;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
    }
    
    .tab-btn {
      flex: 1;
      padding: 0.625rem 1rem;
      border: none;
      background: transparent;
      color: #64748b;
      font-size: 0.875rem;
      font-weight: 500;
      border-radius: 0.375rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .tab-btn.active {
      background: white;
      color: #1e293b;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .tab-btn:hover:not(.active) {
      color: #1e293b;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .form-group {
      margin-bottom: 1.25rem;
    }
    
    .form-group label {
      display: block;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }
    
    .form-group input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #0284c7;
      box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.1);
    }
    
    .error-message {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .success-message {
      background: #f0fdf4;
      border: 1px solid #86efac;
      color: #166534;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .error-message svg, .success-message svg {
      flex-shrink: 0;
    }
    
    .submit-btn {
      width: 100%;
      padding: 0.875rem 1.5rem;
      background: #0284c7;
      color: white;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.1s;
    }
    
    .submit-btn:hover {
      background: #0369a1;
    }
    
    .submit-btn:active {
      transform: scale(0.98);
    }
    
    .forgot-link {
      display: block;
      text-align: center;
      margin-top: 1rem;
      color: #0284c7;
      font-size: 0.875rem;
      text-decoration: none;
      cursor: pointer;
    }
    
    .forgot-link:hover {
      text-decoration: underline;
    }
    
    .back-link {
      display: block;
      text-align: center;
      margin-top: 1.5rem;
      color: #64748b;
      font-size: 0.875rem;
      text-decoration: none;
    }
    
    .back-link:hover {
      color: #0284c7;
    }
    
    .security-note {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid #e5e7eb;
      text-align: center;
    }
    
    .security-note p {
      color: #94a3b8;
      font-size: 0.75rem;
    }
    
    .mode-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      background: #dbeafe;
      color: #1e40af;
      font-size: 0.625rem;
      font-weight: 600;
      border-radius: 9999px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    /* Gl√∂mt l√∂senord modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 100;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal {
      background: white;
      border-radius: 1rem;
      padding: 2rem;
      width: 100%;
      max-width: 400px;
    }
    
    .modal h2 {
      font-size: 1.25rem;
      color: #1e293b;
      margin-bottom: 0.5rem;
    }
    
    .modal p {
      color: #64748b;
      font-size: 0.875rem;
      margin-bottom: 1.5rem;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: #64748b;
      cursor: pointer;
      padding: 0.5rem;
      margin-top: 1rem;
      width: 100%;
      text-align: center;
    }
    
    .modal-close:hover {
      color: #1e293b;
    }
    
    /* Mobile-friendly styles */
    @media (max-width: 640px) {
      body {
        padding: 0;
        align-items: flex-start;
      }
      
      .login-container {
        max-width: 100%;
        border-radius: 0;
        min-height: 100vh;
        padding: 2rem 1.5rem;
        display: flex;
        flex-direction: column;
      }
      
      .logo-section {
        margin-bottom: 1.5rem;
      }
      
      .logo-section h1 {
        font-size: 1.375rem;
      }
      
      .form-group input {
        font-size: 16px; /* Prevents iOS zoom */
        padding: 1rem;
      }
      
      .submit-btn {
        padding: 1rem 1.5rem;
        font-size: 1.0625rem;
      }
      
      .tab-btn {
        padding: 0.75rem 0.5rem;
        font-size: 0.8125rem;
      }
      
      .security-note {
        margin-top: auto;
        padding-top: 2rem;
      }
    }
    
    /* Hide mobile notice - portal now works on mobile */
    .mobile-notice {
      display: none;
    }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="logo-section">
      <img src="/images/branding/logo.svg" alt="S√∂dermalms Ortopedi">
      <h1>Personalportal</h1>
      <p>Logga in f√∂r att komma √•t administrativa verktyg</p>
      {USE_SUPABASE && (
        <span class="mode-badge" style="margin-top: 0.5rem;">Supabase</span>
      )}
    </div>
    
    <!-- Mobile-friendly portal -->
    <div class="mobile-notice" style="display: none;"></div>
    
    {errorMessage && (
      <div class="error-message">
        <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        {errorMessage}
      </div>
    )}
    
    {successMessage && (
      <div class="success-message">
        <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        {successMessage}
      </div>
    )}
    
    {USE_SUPABASE ? (
      <!-- SUPABASE-L√ÑGE: E-post + l√∂senord eller Magic Link -->
      <div>
        <div class="tab-nav">
          <button type="button" class={`tab-btn ${activeTab === 'password' ? 'active' : ''}`} data-tab="password">
            L√∂senord
          </button>
          <button type="button" class={`tab-btn ${activeTab === 'magic-link' ? 'active' : ''}`} data-tab="magic-link">
            E-postl√§nk
          </button>
        </div>
        
        <!-- L√∂senords-inloggning -->
        <div id="tab-password" class={`tab-content ${activeTab === 'password' ? 'active' : ''}`}>
          <form method="POST">
            <input type="hidden" name="action" value="login">
            <input type="hidden" name="next" value={safeNext}>
            <div class="form-group">
              <label for="email">E-postadress</label>
              <input 
                type="email" 
                id="email" 
                name="email" 
                placeholder="personal@klinik.se"
                autocomplete="email"
                required
                autofocus
              >
            </div>
            <div class="form-group">
              <label for="password">L√∂senord</label>
              <input 
                type="password" 
                id="password" 
                name="password" 
                placeholder="Ange l√∂senord"
                autocomplete="current-password"
                required
              >
            </div>
            <button type="submit" class="submit-btn">
              Logga in
            </button>
          </form>
          <button type="button" class="forgot-link" id="show-forgot-modal">
            Gl√∂mt l√∂senord?
          </button>
        </div>
        
        <!-- Magic Link-inloggning -->
        <div id="tab-magic-link" class={`tab-content ${activeTab === 'magic-link' ? 'active' : ''}`}>
          <form method="POST">
            <input type="hidden" name="action" value="magic-link">
            <div class="form-group">
              <label for="magic-email">E-postadress</label>
              <input 
                type="email" 
                id="magic-email" 
                name="magic-email" 
                placeholder="personal@klinik.se"
                autocomplete="email"
                required
              >
            </div>
            <button type="submit" class="submit-btn">
              Skicka inloggningsl√§nk
            </button>
          </form>
          <p style="text-align: center; color: #64748b; font-size: 0.75rem; margin-top: 1rem;">
            Vi skickar en l√§nk till din e-post som loggar in dig automatiskt.
          </p>
        </div>
      </div>
    ) : (
      <!-- ENKELT L√ÑGE: Endast l√∂senord -->
      <form method="POST">
        <input type="hidden" name="action" value="login">
        <input type="hidden" name="next" value={safeNext}>
        <div class="form-group">
          <label for="password">L√∂senord</label>
          <input 
            type="password" 
            id="password" 
            name="password" 
            placeholder="Ange l√∂senord"
            autocomplete="current-password"
            required
            autofocus
          >
        </div>
        
        <button type="submit" class="submit-btn">
          Logga in
        </button>
      </form>
    )}
    
    <a href="/" class="back-link">‚Üê Tillbaka till hemsidan</a>
    
    <div class="security-note">
      <p>üîí Endast f√∂r beh√∂rig personal</p>
    </div>
  </div>
  
  {USE_SUPABASE && (
    <!-- Gl√∂mt l√∂senord modal -->
    <div class="modal-overlay" id="forgot-modal">
      <div class="modal">
        <h2>√Öterst√§ll l√∂senord</h2>
        <p>Ange din e-postadress s√• skickar vi en l√§nk f√∂r att √•terst√§lla ditt l√∂senord.</p>
        <form method="POST">
          <input type="hidden" name="action" value="forgot-password">
          <div class="form-group">
            <label for="reset-email">E-postadress</label>
            <input 
              type="email" 
              id="reset-email" 
              name="reset-email" 
              placeholder="personal@klinik.se"
              required
            >
          </div>
          <button type="submit" class="submit-btn">
            Skicka √•terst√§llningsl√§nk
          </button>
        </form>
        <button type="button" class="modal-close" id="close-forgot-modal">
          Avbryt
        </button>
      </div>
    </div>
  )}
  
  <script>
    // Tab-navigation
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const button = btn as HTMLButtonElement;
        const tab = button.dataset.tab;
        
        // Uppdatera aktiv tab
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        button.classList.add('active');
        
        // Visa r√§tt inneh√•ll
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(`tab-${tab}`)?.classList.add('active');
      });
    });
    
    // Gl√∂mt l√∂senord modal
    const forgotModal = document.getElementById('forgot-modal');
    const showForgotBtn = document.getElementById('show-forgot-modal');
    const closeForgotBtn = document.getElementById('close-forgot-modal');
    
    showForgotBtn?.addEventListener('click', () => {
      forgotModal?.classList.add('active');
    });
    
    closeForgotBtn?.addEventListener('click', () => {
      forgotModal?.classList.remove('active');
    });
    
    // St√§ng modal vid klick utanf√∂r
    forgotModal?.addEventListener('click', (e) => {
      if (e.target === forgotModal) {
        forgotModal.classList.remove('active');
      }
    });
  </script>
</body>
</html>
