---
/**
 * Kopiera Kortl√§nkar - Internt verktyg f√∂r klinisk anv√§ndning
 * 
 * Sida: /copy-links
 * Meny: Om Oss ‚Üí Admin ‚Üí Kopiera l√§nkar
 * 
 * SINGLE SOURCE OF TRUTH:
 * Alla l√§nkar definieras i src/data/shortLinks.json
 * Denna sida importerar samma JSON-fil som astro.config.mjs anv√§nder f√∂r redirects.
 * 
 * F√ñR ATT L√ÑGGA TILL NYA L√ÑNKAR:
 *   1. √ñppna src/data/shortLinks.json
 *   2. L√§gg till ny l√§nk i r√§tt kategori
 *   3. Pusha till GitHub
 *   4. Klart! B√•de redirect och denna UI uppdateras automatiskt.
 */
import BaseLayout from '../layouts/BaseLayout.astro';

// Importera kortl√§nkar fr√•n central JSON-fil (Single Source of Truth)
import shortLinksData from '../data/shortLinks.json';

// Ikoner f√∂r varje kategori
const categoryIcons: Record<string, string> = {
  "Diagnoser": "ü©∫",
  "Operationer": "üî™",
  "Rehab": "üèãÔ∏è",
  "Fr√•geformul√§r": "üìã",
  "Info": "‚ÑπÔ∏è"  // Administrativa riktlinjer, patientinfo, policy etc.
};

// Filtrera bort metadata-nycklar (b√∂rjar med "_") och bygg l√§nklista f√∂r UI
const categories = Object.entries(shortLinksData)
  .filter(([key]) => !key.startsWith('_'))
  .map(([categoryName, items]) => ({
    category: categoryName,
    icon: categoryIcons[categoryName] || "üìÑ",
    items: (items as Array<{name: string; shortCode: string; target: string; isExternal: boolean}>)
      .filter(item => item.shortCode && item.name)  // Filtrera bort eventuella ogiltiga objekt
  }));

// Anv√§nder www. ist√§llet f√∂r https:// f√∂r att spara tecken i SMS
// www.specialist.se/d/ac (21 tecken) vs https://specialist.se/d/ac (25 tecken)
const baseDomain = "www.specialist.se";
---

<BaseLayout title="Kopiera kortl√§nkar" description="Internt verktyg f√∂r att kopiera korta l√§nkar till patientinformation">
  <div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4">
      
      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-2xl md:text-3xl font-bold text-[#024264] mb-2">
          Kopiera kortl√§nkar till patientinfo
        </h1>
        <p class="text-slate-600">
          Klicka p√• "Kopiera l√§nk" f√∂r att kopiera en kort URL till urklipp. 
          Perfekt f√∂r SMS till patienter.
        </p>
      </div>

      <!-- S√∂kf√§lt -->
      <div class="mb-6">
        <div class="relative">
          <input 
            type="text" 
            id="search-input"
            placeholder="S√∂k diagnos, operation eller rehab..."
            class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg"
          />
          <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
        </div>
      </div>

      <!-- Toast-notifikation f√∂r kopierad l√§nk -->
      <div 
        id="toast" 
        class="fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50"
      >
        ‚úì Kopierad!
      </div>

      <!-- L√§nkkategorier - Genereras dynamiskt fr√•n shortLinks.json -->
      <div id="links-container" class="space-y-8">
        {categories.map((cat) => (
          <section class="category-section" data-category={cat.category}>
            <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
              <span>{cat.icon}</span>
              {cat.category}
              {cat.category === "Fr√•geformul√§r" && (
                <span class="text-xs font-normal text-orange-600 bg-orange-100 px-2 py-0.5 rounded-full">Externa</span>
              )}
            </h2>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 divide-y divide-gray-100">
              {cat.items.map((item) => (
                <div 
                  class="link-item flex items-center justify-between p-4 hover:bg-gray-50 transition-colors"
                  data-name={item.name.toLowerCase()}
                  data-shortcode={item.shortCode}
                >
                  <div class="flex-1 min-w-0 mr-4">
                    <p class="font-medium text-slate-800">
                      {item.name}
                      {item.isExternal && (
                        <span class="ml-2 text-xs text-orange-500" title="Extern l√§nk (journalsystem)">‚Üó</span>
                      )}
                    </p>
                    <p class="text-sm text-slate-500 font-mono">{baseDomain}{item.shortCode}</p>
                  </div>
                  <button 
                    type="button"
                    class="copy-btn flex-shrink-0 bg-[#024264] text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-800 active:scale-95 transition-all flex items-center gap-2"
                    data-url={`${baseDomain}${item.shortCode}`}
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                    Kopiera l√§nk
                  </button>
                </div>
              ))}
            </div>
          </section>
        ))}
      </div>

      <!-- Meddelande n√§r inga resultat hittas -->
      <div id="no-results" class="hidden text-center py-12">
        <p class="text-slate-500 text-lg">Inga resultat hittades</p>
      </div>

      <!-- Tips-sektion -->
      <div class="mt-12 bg-blue-50 border border-blue-200 rounded-xl p-6">
        <h3 class="font-bold text-blue-800 mb-2">üí° Tips f√∂r SMS</h3>
        <ul class="text-blue-700 space-y-1 text-sm">
          <li>‚Ä¢ Korta URLs sparar tecken ‚Äì SMS har max 255 tecken</li>
          <li>‚Ä¢ Exempel: "Hej! H√§r √§r info om din diagnos: www.specialist.se/d/ac"</li>
          <li>‚Ä¢ L√§nkarna fungerar direkt ‚Äì de omdirigerar till fullst√§ndiga sidor</li>
          <li>‚Ä¢ Externa formul√§r (üìã) g√•r till journalsystemet automatiskt</li>
        </ul>
      </div>

      <!-- Info om Single Source of Truth (f√∂r utvecklare) -->
      <div class="mt-4 text-xs text-slate-400 text-center">
        L√§nkar definieras i <code class="bg-slate-100 px-1 rounded">src/data/shortLinks.json</code>
      </div>

      <!-- ================================================================
           LINK GENERATOR - Admin-verktyg f√∂r att skapa nya kortl√§nkar
           ================================================================ -->
      <details class="mt-8 bg-white rounded-xl shadow-sm border border-gray-200">
        <summary class="px-6 py-4 cursor-pointer font-bold text-slate-700 hover:bg-gray-50 rounded-xl flex items-center gap-2">
          üõ† L√§gg till ny kortl√§nk
        </summary>
        
        <div class="px-6 pb-6 border-t border-gray-100 pt-4">
          <!-- Enkel guide -->
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
            <p class="text-sm text-blue-800 font-medium mb-2">üìã S√• h√§r g√∂r du:</p>
            <ol class="text-sm text-blue-700 space-y-1 list-decimal list-inside">
              <li>V√§lj kategori (Diagnoser, Operationer, etc.)</li>
              <li>Skriv namnet p√• l√§nken</li>
              <li>Kortkoden fylls i automatiskt (du kan √§ndra den)</li>
              <li>Skriv dit l√§nken ska g√•</li>
              <li>Klicka "Generera" och kopiera</li>
            </ol>
          </div>
          
          <!-- Formul√§r -->
          <div class="space-y-4">
            
            <!-- Steg 1: Kategori -->
            <div>
              <label for="gen-category" class="block text-sm font-medium text-slate-700 mb-1">
                <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs mr-2">Steg 1</span>
                V√§lj kategori
              </label>
              <div class="flex items-center gap-3">
                <select 
                  id="gen-category" 
                  class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base"
                >
                  <option value="Diagnoser" data-prefix="/d/">ü©∫ Diagnoser</option>
                  <option value="Operationer" data-prefix="/o/">üî™ Operationer</option>
                  <option value="Rehab" data-prefix="/r/">üèãÔ∏è Rehab</option>
                  <option value="Fr√•geformul√§r" data-prefix="/ff/">üìã Fr√•geformul√§r</option>
                  <option value="Info" data-prefix="/i/">‚ÑπÔ∏è Info (policy, riktlinjer)</option>
                </select>
                <!-- Prefix-feedback -->
                <span id="prefix-display" class="text-base font-mono bg-blue-100 text-blue-800 px-3 py-2 rounded-lg font-bold">/d/</span>
              </div>
              <p class="text-xs text-slate-400 mt-1">Detta best√§mmer vilken typ av l√§nk det blir</p>
            </div>
            
            <!-- Steg 2: Namn -->
            <div>
              <label for="gen-name" class="block text-sm font-medium text-slate-700 mb-1">
                <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs mr-2">Steg 2</span>
                Vad ska l√§nken heta?
              </label>
              <input 
                type="text" 
                id="gen-name" 
                placeholder="Exempel: AC-ledsartros (yttre nyckelbensleden)"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base"
              />
              <p class="text-xs text-slate-400 mt-1">Detta √§r det namn som syns i listan</p>
            </div>
            
            <!-- Steg 3: Kortkod (auto-genererad) -->
            <div>
              <label for="gen-shortcode" class="block text-sm font-medium text-slate-700 mb-1">
                <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs mr-2">Steg 3</span>
                Kortkod (fylls i automatiskt)
              </label>
              <div class="flex items-center gap-2">
                <span id="prefix-inline" class="text-base font-mono text-slate-500 font-bold">/d/</span>
                <input 
                  type="text" 
                  id="gen-shortcode" 
                  placeholder="ac"
                  class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-base"
                />
                <button 
                  type="button"
                  id="auto-fill-btn"
                  class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded text-slate-600"
                  title="Fyll i automatiskt fr√•n namnet"
                >
                  Auto
                </button>
              </div>
              <div class="mt-2 p-2 bg-slate-50 rounded border border-slate-200">
                <p class="text-xs text-slate-500 mb-1">S√• h√§r ser l√§nken ut:</p>
                <p class="text-sm font-mono text-slate-700 font-bold">
                  www.specialist.se<span id="shortcode-preview" class="text-blue-600">/d/ac</span>
                </p>
              </div>
            </div>
            
            <!-- Steg 4: Target URL -->
            <div>
              <label for="gen-target" class="block text-sm font-medium text-slate-700 mb-1">
                <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs mr-2">Steg 4</span>
                Vart ska l√§nken g√•?
              </label>
              <input 
                type="text" 
                id="gen-target" 
                placeholder="Exempel: /sjukdomar/axel/ac-ledsartros"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"
              />
              <div class="mt-2 space-y-1">
                <p class="text-xs text-slate-500">üí° Exempel p√• intern sida:</p>
                <p class="text-xs font-mono text-slate-400 bg-slate-50 p-1 rounded">/sjukdomar/axel/ac-ledsartros</p>
                <p class="text-xs text-slate-500 mt-2">üí° Exempel p√• extern sida (journalsystem):</p>
                <p class="text-xs font-mono text-slate-400 bg-slate-50 p-1 rounded">https://journalsystem.se/form/axel-123</p>
              </div>
            </div>
            
            <!-- F√∂rhandsvisning (uppdateras live) -->
            <div id="live-preview" class="hidden p-3 bg-green-50 border border-green-200 rounded-lg">
              <p class="text-xs text-green-700 font-medium mb-1">‚úÖ F√∂rhandsvisning:</p>
              <p class="text-sm text-green-800">
                <span id="preview-name" class="font-semibold"></span> ‚Üí 
                <span id="preview-url" class="font-mono"></span>
              </p>
            </div>
            
            <!-- Generera-knapp -->
            <button 
              type="button" 
              id="generate-btn"
              class="w-full bg-[#024264] text-white px-4 py-3 rounded-lg font-medium hover:bg-blue-800 active:scale-[0.98] transition-all flex items-center justify-center gap-2 text-base"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
              </svg>
              Generera och kopiera
            </button>
          </div>
          
          <!-- Output-sektion (dold tills JSON genereras) -->
          <div id="output-section" class="hidden mt-6">
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-3">
              <p class="text-green-800 text-sm font-bold mb-2 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Klart! Nu g√∂r du s√• h√§r:
              </p>
              <ol class="text-green-700 text-sm space-y-1 list-decimal list-inside ml-2">
                <li>Klicka p√• knappen "Kopiera" h√§r nedan</li>
                <li>√ñppna filen <code class="bg-green-100 px-1 rounded font-mono text-xs">src/data/shortLinks.json</code></li>
                <li>Hitta kategorin <strong id="output-category-name"></strong> i filen</li>
                <li>Klistra in det kopierade blocket l√§ngst ner i den kategorins lista</li>
                <li>Spara filen och pusha till GitHub</li>
              </ol>
            </div>
            
            <!-- JSON-output -->
            <div class="relative">
              <pre id="json-output" class="bg-slate-800 text-green-400 p-4 rounded-lg text-sm font-mono overflow-x-auto pb-12"></pre>
              <button 
                type="button"
                id="copy-json-btn"
                class="absolute bottom-2 right-2 bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-700 transition-colors flex items-center gap-2 shadow-lg"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                </svg>
                Kopiera
              </button>
            </div>
          </div>
          
          <!-- Felmeddelande -->
          <div id="error-message" class="hidden mt-4 bg-red-50 border border-red-200 rounded-lg p-4">
            <p class="text-red-800 text-sm font-medium flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span id="error-text">Fyll i alla f√§lt</span>
            </p>
          </div>
        </div>
      </details>

    </div>
  </div>
</BaseLayout>

<script>
  /**
   * Client-side JavaScript f√∂r kopiera-funktionalitet och s√∂kfilter
   */
  document.addEventListener('DOMContentLoaded', () => {
    const toast = document.getElementById('toast') as HTMLElement | null;
    const copyButtons = document.querySelectorAll<HTMLButtonElement>('.copy-btn');
    
    // Kopiera-funktionalitet f√∂r alla knappar
    copyButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        const url = btn.getAttribute('data-url') ?? '';
        if (!url) return;
        
        try {
          // Kopiera URL till urklipp
          await navigator.clipboard.writeText(url);
          
          // Visa toast-notifikation
          if (toast) {
            toast.classList.remove('translate-x-full');
            setTimeout(() => {
              toast.classList.add('translate-x-full');
            }, 2000);
          }
          
          // √Ñndra knapptext tillf√§lligt
          const originalText = btn.innerHTML;
          btn.innerHTML = `
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Kopierad!
          `;
          btn.classList.remove('bg-[#024264]');
          btn.classList.add('bg-green-600');
          
          // √Öterst√§ll knappen efter 2 sekunder
          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('bg-green-600');
            btn.classList.add('bg-[#024264]');
          }, 2000);
          
        } catch (err) {
          console.error('Kunde inte kopiera:', err);
          alert('Kunde inte kopiera l√§nken. F√∂rs√∂k igen.');
        }
      });
    });

    // S√∂kfunktionalitet
    const searchInput = document.getElementById('search-input') as HTMLInputElement | null;
    const categorySections = document.querySelectorAll('.category-section');
    const noResults = document.getElementById('no-results');
    if (!searchInput) return;

    searchInput.addEventListener('input', (e) => {
      const target = e.target as HTMLInputElement;
      const searchTerm = target.value.toLowerCase().trim();
      let hasResults = false;
      
      categorySections.forEach(section => {
        const items = section.querySelectorAll('.link-item');
        let categoryHasResults = false;
        
        items.forEach(item => {
          const element = item as HTMLElement;
          const name = element.getAttribute('data-name') || '';
          const shortCode = element.getAttribute('data-shortcode') || '';
          
          // S√∂k i b√•de namn och shortcode
          const matches = name.includes(searchTerm) || shortCode.includes(searchTerm);
          
          element.style.display = matches ? 'flex' : 'none';
          if (matches) {
            categoryHasResults = true;
            hasResults = true;
          }
        });
        
        // Visa/d√∂lj hela kategorin
        (section as HTMLElement).style.display = categoryHasResults ? 'block' : 'none';
      });
      
      // Visa meddelande om inga resultat
      noResults?.classList.toggle('hidden', hasResults);
    });

    // ================================================================
    // LINK GENERATOR - Logik f√∂r att generera JSON
    // ================================================================
    
    // Prefix-mappning f√∂r varje kategori
    const prefixMap: Record<string, string> = {
      'Diagnoser': '/d/',
      'Operationer': '/o/',
      'Rehab': '/r/',
      'Fr√•geformul√§r': '/ff/'
    };
    
    // H√§mta DOM-element
    const categorySelect = document.getElementById('gen-category') as HTMLSelectElement;
    const prefixDisplay = document.getElementById('prefix-display') as HTMLSpanElement;
    const prefixInline = document.getElementById('prefix-inline') as HTMLSpanElement;
    const shortcodePreview = document.getElementById('shortcode-preview') as HTMLSpanElement;
    const nameInput = document.getElementById('gen-name') as HTMLInputElement;
    const shortcodeInput = document.getElementById('gen-shortcode') as HTMLInputElement;
    const targetInput = document.getElementById('gen-target') as HTMLInputElement;
    const generateBtn = document.getElementById('generate-btn') as HTMLButtonElement;
    const outputSection = document.getElementById('output-section') as HTMLDivElement;
    const jsonOutput = document.getElementById('json-output') as HTMLPreElement;
    const copyJsonBtn = document.getElementById('copy-json-btn') as HTMLButtonElement;
    const errorMessage = document.getElementById('error-message') as HTMLDivElement;
    const errorText = document.getElementById('error-text') as HTMLSpanElement;
    
    // Hj√§lpfunktion: Generera kortkod fr√•n namn
    function generateShortcodeFromName(name: string): string {
      if (!name) return '';
      
      // Ta bort specialtecken, g√∂r sm√• bokst√§ver, ers√§tt mellanslag med bindestreck
      return name
        .toLowerCase()
        .replace(/[√•√§√∂]/g, (char) => {
          const map: Record<string, string> = { '√•': 'a', '√§': 'a', '√∂': 'o' };
          return map[char] || char;
        })
        .replace(/[^a-z0-9\s-]/g, '')  // Ta bort specialtecken
        .replace(/\s+/g, '-')           // Mellanslag till bindestreck
        .replace(/-+/g, '-')           // Flera bindestreck till ett
        .replace(/^-|-$/g, '');         // Ta bort bindestreck i b√∂rjan/slutet
    }
    
    // Uppdatera prefix-visning n√§r kategori √§ndras
    categorySelect?.addEventListener('change', () => {
      const prefix = prefixMap[categorySelect.value] || '/d/';
      prefixDisplay.textContent = prefix;
      prefixInline.textContent = prefix;
      updateShortcodePreview();
      updateLivePreview();
    });
    
    // Auto-fill kortkod fr√•n namn
    const autoFillBtn = document.getElementById('auto-fill-btn') as HTMLButtonElement;
    autoFillBtn?.addEventListener('click', () => {
      const name = nameInput.value.trim();
      if (name) {
        const suggestedCode = generateShortcodeFromName(name);
        shortcodeInput.value = suggestedCode;
        updateShortcodePreview();
        updateLivePreview();
        
        // Feedback
        autoFillBtn.textContent = '‚úì';
        autoFillBtn.classList.remove('bg-gray-100');
        autoFillBtn.classList.add('bg-green-100', 'text-green-700');
        setTimeout(() => {
          autoFillBtn.textContent = 'Auto';
          autoFillBtn.classList.remove('bg-green-100', 'text-green-700');
          autoFillBtn.classList.add('bg-gray-100');
        }, 1500);
      }
    });
    
    // Auto-fill n√§r namn √§ndras (om kortkod √§r tom)
    nameInput?.addEventListener('input', () => {
      if (!shortcodeInput.value.trim()) {
        const suggestedCode = generateShortcodeFromName(nameInput.value);
        shortcodeInput.value = suggestedCode;
      }
      updateShortcodePreview();
      updateLivePreview();
    });
    
    // Uppdatera f√∂rhandsvisning av kortkod
    shortcodeInput?.addEventListener('input', () => {
      updateShortcodePreview();
      updateLivePreview();
    });
    
    // Uppdatera live-f√∂rhandsvisning n√§r target √§ndras
    targetInput?.addEventListener('input', updateLivePreview);
    
    function updateShortcodePreview() {
      const prefix = prefixMap[categorySelect.value] || '/d/';
      const code = shortcodeInput.value.trim().toLowerCase().replace(/^\//, '');
      shortcodePreview.textContent = prefix + (code || 'xxx');
    }
    
    // Live-f√∂rhandsvisning av hela l√§nken
    const livePreview = document.getElementById('live-preview') as HTMLDivElement;
    const previewName = document.getElementById('preview-name') as HTMLSpanElement;
    const previewUrl = document.getElementById('preview-url') as HTMLSpanElement;
    
    function updateLivePreview() {
      const name = nameInput.value.trim();
      const prefix = prefixMap[categorySelect.value] || '/d/';
      const code = shortcodeInput.value.trim().toLowerCase().replace(/^\//, '');
      const target = targetInput.value.trim();
      
      if (name && code && target) {
        previewName.textContent = name;
        previewUrl.textContent = `www.specialist.se${prefix}${code}`;
        livePreview.classList.remove('hidden');
      } else {
        livePreview.classList.add('hidden');
      }
    }
    
    // Generera JSON n√§r knappen klickas
    generateBtn?.addEventListener('click', () => {
      // D√∂lj tidigare meddelanden
      outputSection.classList.add('hidden');
      errorMessage.classList.add('hidden');
      
      // H√§mta v√§rden
      const category = categorySelect.value;
      const name = nameInput.value.trim();
      const shortcodeSuffix = shortcodeInput.value.trim().toLowerCase().replace(/^\//, '');
      const target = targetInput.value.trim();
      
      // Validera - Tydliga felmeddelanden
      if (!name) {
        errorText.textContent = '‚ùå Du m√•ste skriva ett namn (steg 2)';
        errorMessage.classList.remove('hidden');
        nameInput.focus();
        return;
      }
      
      if (!shortcodeSuffix) {
        errorText.textContent = '‚ùå Du m√•ste skriva en kortkod (steg 3). Klicka p√• "Auto" f√∂r att fylla i automatiskt!';
        errorMessage.classList.remove('hidden');
        shortcodeInput.focus();
        return;
      }
      
      if (!target) {
        errorText.textContent = '‚ùå Du m√•ste skriva vart l√§nken ska g√• (steg 4)';
        errorMessage.classList.remove('hidden');
        targetInput.focus();
        return;
      }
      
      // Validera kortkod (endast bokst√§ver, siffror, bindestreck)
      if (!/^[a-z0-9-]+$/.test(shortcodeSuffix)) {
        errorText.textContent = '‚ùå Kortkod f√•r endast inneh√•lla sm√• bokst√§ver (a-z), siffror (0-9) och bindestreck (-). Klicka p√• "Auto" f√∂r att generera en korrekt kortkod!';
        errorMessage.classList.remove('hidden');
        shortcodeInput.focus();
        return;
      }
      
      // Bygg fullst√§ndig shortCode med prefix
      const prefix = prefixMap[category] || '/d/';
      const shortCode = prefix + shortcodeSuffix;
      
      // Avg√∂r om det √§r extern URL
      const isExternal = target.startsWith('http://') || target.startsWith('https://');
      
      // Skapa JSON-objekt
      const linkObject = {
        name: name,
        shortCode: shortCode,
        target: target,
        isExternal: isExternal
      };
      
      // Formatera JSON med indrag (2 spaces) och trailing comma
      const jsonString = JSON.stringify(linkObject, null, 2)
        .replace(/^{/, '    {')           // Indentera f√∂rsta raden
        .replace(/\n/g, '\n    ')         // Indentera alla rader
        .replace(/    }$/, '    },');     // L√§gg till trailing comma
      
      // Visa output
      jsonOutput.textContent = jsonString;
      
      // S√§tt kategori-namn i instruktionerna
      const outputCategoryName = document.getElementById('output-category-name') as HTMLElement | null;
      if (outputCategoryName) {
        outputCategoryName.textContent = `"${category}"`;
      }
      
      outputSection.classList.remove('hidden');
      
      // Scrolla till output
      outputSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    });
    
    // Kopiera JSON till urklipp
    copyJsonBtn?.addEventListener('click', async () => {
      const jsonText = jsonOutput.textContent || '';
      
      try {
        await navigator.clipboard.writeText(jsonText);
        
        // Visa feedback
        const originalText = copyJsonBtn.innerHTML;
        copyJsonBtn.innerHTML = `
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          Kopierad!
        `;
        copyJsonBtn.classList.remove('bg-slate-700');
        copyJsonBtn.classList.add('bg-green-600');
        
        // Visa toast ocks√•
        if (toast) {
          toast.classList.remove('translate-x-full');
          setTimeout(() => {
            toast.classList.add('translate-x-full');
          }, 2000);
        }
        
        // √Öterst√§ll knappen
        setTimeout(() => {
          copyJsonBtn.innerHTML = originalText;
          copyJsonBtn.classList.remove('bg-green-600');
          copyJsonBtn.classList.add('bg-slate-700');
        }, 2000);
        
      } catch (err) {
        console.error('Kunde inte kopiera:', err);
        alert('Kunde inte kopiera. Markera och kopiera manuellt.');
      }
    });
  });
</script>

                    </svg>
                    Kopiera l√§nk
                  </button>
                </div>
              ))}
            </div>
          </section>
        ))}
      </div>

      <!-- Meddelande n√§r inga resultat hittas -->
      <div id="no-results" class="hidden text-center py-12">
        <p class="text-slate-500 text-lg">Inga resultat hittades</p>
      </div>

      <!-- Tips-sektion -->
      <div class="mt-12 bg-blue-50 border border-blue-200 rounded-xl p-6">
        <h3 class="font-bold text-blue-800 mb-2">üí° Tips f√∂r SMS</h3>
        <ul class="text-blue-700 space-y-1 text-sm">
          <li>‚Ä¢ Korta URLs sparar tecken ‚Äì SMS har max 255 tecken</li>
          <li>‚Ä¢ Exempel: "Hej! H√§r √§r info om din diagnos: www.specialist.se/d/ac"</li>
          <li>‚Ä¢ L√§nkarna fungerar direkt ‚Äì de omdirigerar till fullst√§ndiga sidor</li>
          <li>‚Ä¢ Externa formul√§r (üìã) g√•r till journalsystemet automatiskt</li>
        </ul>
      </div>

      <!-- Info om Single Source of Truth (f√∂r utvecklare) -->
      <div class="mt-4 text-xs text-slate-400 text-center">
        L√§nkar definieras i <code class="bg-slate-100 px-1 rounded">src/data/shortLinks.json</code>
      </div>

      <!-- ================================================================
           LINK GENERATOR - Admin-verktyg f√∂r att skapa nya kortl√§nkar
           ================================================================ -->
      <details class="mt-8 bg-white rounded-xl shadow-sm border border-gray-200">
        <summary class="px-6 py-4 cursor-pointer font-bold text-slate-700 hover:bg-gray-50 rounded-xl flex items-center gap-2">
          üõ† L√§gg till ny kortl√§nk
        </summary>
        
        <div class="px-6 pb-6 border-t border-gray-100 pt-4">
          <!-- Enkel guide -->
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
            <p class="text-sm text-blue-800 font-medium mb-2">üìã S√• h√§r g√∂r du:</p>
            <ol class="text-sm text-blue-700 space-y-1 list-decimal list-inside">
              <li>V√§lj kategori (Diagnoser, Operationer, etc.)</li>
              <li>Skriv namnet p√• l√§nken</li>
              <li>Kortkoden fylls i automatiskt (du kan √§ndra den)</li>
              <li>Skriv dit l√§nken ska g√•</li>
              <li>Klicka "Generera" och kopiera</li>
            </ol>
          </div>
          
          <!-- Formul√§r -->
          <div class="space-y-4">
            
            <!-- Steg 1: Kategori -->
            <div>
              <label for="gen-category" class="block text-sm font-medium text-slate-700 mb-1">
                <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs mr-2">Steg 1</span>
                V√§lj kategori
              </label>
              <div class="flex items-center gap-3">
                <select 
                  id="gen-category" 
                  class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base"
                >
                  <option value="Diagnoser" data-prefix="/d/">ü©∫ Diagnoser</option>
                  <option value="Operationer" data-prefix="/o/">üî™ Operationer</option>
                  <option value="Rehab" data-prefix="/r/">üèãÔ∏è Rehab</option>
                  <option value="Fr√•geformul√§r" data-prefix="/ff/">üìã Fr√•geformul√§r</option>
                  <option value="Info" data-prefix="/i/">‚ÑπÔ∏è Info (policy, riktlinjer)</option>
                </select>
                <!-- Prefix-feedback -->
                <span id="prefix-display" class="text-base font-mono bg-blue-100 text-blue-800 px-3 py-2 rounded-lg font-bold">/d/</span>
              </div>
              <p class="text-xs text-slate-400 mt-1">Detta best√§mmer vilken typ av l√§nk det blir</p>
            </div>
            
            <!-- Steg 2: Namn -->
            <div>
              <label for="gen-name" class="block text-sm font-medium text-slate-700 mb-1">
                <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs mr-2">Steg 2</span>
                Vad ska l√§nken heta?
              </label>
              <input 
                type="text" 
                id="gen-name" 
                placeholder="Exempel: AC-ledsartros (yttre nyckelbensleden)"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base"
              />
              <p class="text-xs text-slate-400 mt-1">Detta √§r det namn som syns i listan</p>
            </div>
            
            <!-- Steg 3: Kortkod (auto-genererad) -->
            <div>
              <label for="gen-shortcode" class="block text-sm font-medium text-slate-700 mb-1">
                <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs mr-2">Steg 3</span>
                Kortkod (fylls i automatiskt)
              </label>
              <div class="flex items-center gap-2">
                <span id="prefix-inline" class="text-base font-mono text-slate-500 font-bold">/d/</span>
                <input 
                  type="text" 
                  id="gen-shortcode" 
                  placeholder="ac"
                  class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-base"
                />
                <button 
                  type="button"
                  id="auto-fill-btn"
                  class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded text-slate-600"
                  title="Fyll i automatiskt fr√•n namnet"
                >
                  Auto
                </button>
              </div>
              <div class="mt-2 p-2 bg-slate-50 rounded border border-slate-200">
                <p class="text-xs text-slate-500 mb-1">S√• h√§r ser l√§nken ut:</p>
                <p class="text-sm font-mono text-slate-700 font-bold">
                  www.specialist.se<span id="shortcode-preview" class="text-blue-600">/d/ac</span>
                </p>
              </div>
            </div>
            
            <!-- Steg 4: Target URL -->
            <div>
              <label for="gen-target" class="block text-sm font-medium text-slate-700 mb-1">
                <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs mr-2">Steg 4</span>
                Vart ska l√§nken g√•?
              </label>
              <input 
                type="text" 
                id="gen-target" 
                placeholder="Exempel: /sjukdomar/axel/ac-ledsartros"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"
              />
              <div class="mt-2 space-y-1">
                <p class="text-xs text-slate-500">üí° Exempel p√• intern sida:</p>
                <p class="text-xs font-mono text-slate-400 bg-slate-50 p-1 rounded">/sjukdomar/axel/ac-ledsartros</p>
                <p class="text-xs text-slate-500 mt-2">üí° Exempel p√• extern sida (journalsystem):</p>
                <p class="text-xs font-mono text-slate-400 bg-slate-50 p-1 rounded">https://journalsystem.se/form/axel-123</p>
              </div>
            </div>
            
            <!-- F√∂rhandsvisning (uppdateras live) -->
            <div id="live-preview" class="hidden p-3 bg-green-50 border border-green-200 rounded-lg">
              <p class="text-xs text-green-700 font-medium mb-1">‚úÖ F√∂rhandsvisning:</p>
              <p class="text-sm text-green-800">
                <span id="preview-name" class="font-semibold"></span> ‚Üí 
                <span id="preview-url" class="font-mono"></span>
              </p>
            </div>
            
            <!-- Generera-knapp -->
            <button 
              type="button" 
              id="generate-btn"
              class="w-full bg-[#024264] text-white px-4 py-3 rounded-lg font-medium hover:bg-blue-800 active:scale-[0.98] transition-all flex items-center justify-center gap-2 text-base"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
              </svg>
              Generera och kopiera
            </button>
          </div>
          
          <!-- Output-sektion (dold tills JSON genereras) -->
          <div id="output-section" class="hidden mt-6">
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-3">
              <p class="text-green-800 text-sm font-bold mb-2 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Klart! Nu g√∂r du s√• h√§r:
              </p>
              <ol class="text-green-700 text-sm space-y-1 list-decimal list-inside ml-2">
                <li>Klicka p√• knappen "Kopiera" h√§r nedan</li>
                <li>√ñppna filen <code class="bg-green-100 px-1 rounded font-mono text-xs">src/data/shortLinks.json</code></li>
                <li>Hitta kategorin <strong id="output-category-name"></strong> i filen</li>
                <li>Klistra in det kopierade blocket l√§ngst ner i den kategorins lista</li>
                <li>Spara filen och pusha till GitHub</li>
              </ol>
            </div>
            
            <!-- JSON-output -->
            <div class="relative">
              <pre id="json-output" class="bg-slate-800 text-green-400 p-4 rounded-lg text-sm font-mono overflow-x-auto pb-12"></pre>
              <button 
                type="button"
                id="copy-json-btn"
                class="absolute bottom-2 right-2 bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-700 transition-colors flex items-center gap-2 shadow-lg"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                </svg>
                Kopiera
              </button>
            </div>
          </div>
          
          <!-- Felmeddelande -->
          <div id="error-message" class="hidden mt-4 bg-red-50 border border-red-200 rounded-lg p-4">
            <p class="text-red-800 text-sm font-medium flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span id="error-text">Fyll i alla f√§lt</span>
            </p>
          </div>
        </div>
      </details>

    </div>
  </div>
</BaseLayout>

<script>
  /**
   * Client-side JavaScript f√∂r kopiera-funktionalitet och s√∂kfilter
   */
  document.addEventListener('DOMContentLoaded', () => {
    const toast = document.getElementById('toast') as HTMLElement | null;
    const copyButtons = document.querySelectorAll<HTMLButtonElement>('.copy-btn');
    
    // Kopiera-funktionalitet f√∂r alla knappar
    copyButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        const url = btn.getAttribute('data-url') ?? '';
        if (!url) return;
        
        try {
          // Kopiera URL till urklipp
          await navigator.clipboard.writeText(url);
          
          // Visa toast-notifikation
          if (toast) {
            toast.classList.remove('translate-x-full');
            setTimeout(() => {
              toast.classList.add('translate-x-full');
            }, 2000);
          }
          
          // √Ñndra knapptext tillf√§lligt
          const originalText = btn.innerHTML;
          btn.innerHTML = `
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Kopierad!
          `;
          btn.classList.remove('bg-[#024264]');
          btn.classList.add('bg-green-600');
          
          // √Öterst√§ll knappen efter 2 sekunder
          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('bg-green-600');
            btn.classList.add('bg-[#024264]');
          }, 2000);
          
        } catch (err) {
          console.error('Kunde inte kopiera:', err);
          alert('Kunde inte kopiera l√§nken. F√∂rs√∂k igen.');
        }
      });
    });

    // S√∂kfunktionalitet
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const categorySections = document.querySelectorAll('.category-section');
    const noResults = document.getElementById('no-results');
    
    searchInput.addEventListener('input', (e) => {
      const target = e.target as HTMLInputElement;
      const searchTerm = target.value.toLowerCase().trim();
      let hasResults = false;
      
      categorySections.forEach(section => {
        const items = section.querySelectorAll('.link-item');
        let categoryHasResults = false;
        
        items.forEach(item => {
          const element = item as HTMLElement;
          const name = element.getAttribute('data-name') || '';
          const shortCode = element.getAttribute('data-shortcode') || '';
          
          // S√∂k i b√•de namn och shortcode
          const matches = name.includes(searchTerm) || shortCode.includes(searchTerm);
          
          element.style.display = matches ? 'flex' : 'none';
          if (matches) {
            categoryHasResults = true;
            hasResults = true;
          }
        });
        
        // Visa/d√∂lj hela kategorin
        (section as HTMLElement).style.display = categoryHasResults ? 'block' : 'none';
      });
      
      // Visa meddelande om inga resultat
      noResults?.classList.toggle('hidden', hasResults);
    });

    // ================================================================
    // LINK GENERATOR - Logik f√∂r att generera JSON
    // ================================================================
    
    // Prefix-mappning f√∂r varje kategori
    const prefixMap: Record<string, string> = {
      'Diagnoser': '/d/',
      'Operationer': '/o/',
      'Rehab': '/r/',
      'Fr√•geformul√§r': '/ff/'
    };
    
    // H√§mta DOM-element
    const categorySelect = document.getElementById('gen-category') as HTMLSelectElement;
    const prefixDisplay = document.getElementById('prefix-display') as HTMLSpanElement;
    const prefixInline = document.getElementById('prefix-inline') as HTMLSpanElement;
    const shortcodePreview = document.getElementById('shortcode-preview') as HTMLSpanElement;
    const nameInput = document.getElementById('gen-name') as HTMLInputElement;
    const shortcodeInput = document.getElementById('gen-shortcode') as HTMLInputElement;
    const targetInput = document.getElementById('gen-target') as HTMLInputElement;
    const generateBtn = document.getElementById('generate-btn') as HTMLButtonElement;
    const outputSection = document.getElementById('output-section') as HTMLDivElement;
    const jsonOutput = document.getElementById('json-output') as HTMLPreElement;
    const copyJsonBtn = document.getElementById('copy-json-btn') as HTMLButtonElement;
    const errorMessage = document.getElementById('error-message') as HTMLDivElement;
    const errorText = document.getElementById('error-text') as HTMLSpanElement;
    
    // Hj√§lpfunktion: Generera kortkod fr√•n namn
    function generateShortcodeFromName(name: string): string {
      if (!name) return '';
      
      // Ta bort specialtecken, g√∂r sm√• bokst√§ver, ers√§tt mellanslag med bindestreck
      return name
        .toLowerCase()
        .replace(/[√•√§√∂]/g, (char) => {
          const map: Record<string, string> = { '√•': 'a', '√§': 'a', '√∂': 'o' };
          return map[char] || char;
        })
        .replace(/[^a-z0-9\s-]/g, '')  // Ta bort specialtecken
        .replace(/\s+/g, '-')           // Mellanslag till bindestreck
        .replace(/-+/g, '-')           // Flera bindestreck till ett
        .replace(/^-|-$/g, '');         // Ta bort bindestreck i b√∂rjan/slutet
    }
    
    // Uppdatera prefix-visning n√§r kategori √§ndras
    categorySelect?.addEventListener('change', () => {
      const prefix = prefixMap[categorySelect.value] || '/d/';
      prefixDisplay.textContent = prefix;
      prefixInline.textContent = prefix;
      updateShortcodePreview();
      updateLivePreview();
    });
    
    // Auto-fill kortkod fr√•n namn
    const autoFillBtn = document.getElementById('auto-fill-btn') as HTMLButtonElement;
    autoFillBtn?.addEventListener('click', () => {
      const name = nameInput.value.trim();
      if (name) {
        const suggestedCode = generateShortcodeFromName(name);
        shortcodeInput.value = suggestedCode;
        updateShortcodePreview();
        updateLivePreview();
        
        // Feedback
        autoFillBtn.textContent = '‚úì';
        autoFillBtn.classList.remove('bg-gray-100');
        autoFillBtn.classList.add('bg-green-100', 'text-green-700');
        setTimeout(() => {
          autoFillBtn.textContent = 'Auto';
          autoFillBtn.classList.remove('bg-green-100', 'text-green-700');
          autoFillBtn.classList.add('bg-gray-100');
        }, 1500);
      }
    });
    
    // Auto-fill n√§r namn √§ndras (om kortkod √§r tom)
    nameInput?.addEventListener('input', () => {
      if (!shortcodeInput.value.trim()) {
        const suggestedCode = generateShortcodeFromName(nameInput.value);
        shortcodeInput.value = suggestedCode;
      }
      updateShortcodePreview();
      updateLivePreview();
    });
    
    // Uppdatera f√∂rhandsvisning av kortkod
    shortcodeInput?.addEventListener('input', () => {
      updateShortcodePreview();
      updateLivePreview();
    });
    
    // Uppdatera live-f√∂rhandsvisning n√§r target √§ndras
    targetInput?.addEventListener('input', updateLivePreview);
    
    function updateShortcodePreview() {
      const prefix = prefixMap[categorySelect.value] || '/d/';
      const code = shortcodeInput.value.trim().toLowerCase().replace(/^\//, '');
      shortcodePreview.textContent = prefix + (code || 'xxx');
    }
    
    // Live-f√∂rhandsvisning av hela l√§nken
    const livePreview = document.getElementById('live-preview') as HTMLDivElement;
    const previewName = document.getElementById('preview-name') as HTMLSpanElement;
    const previewUrl = document.getElementById('preview-url') as HTMLSpanElement;
    
    function updateLivePreview() {
      const name = nameInput.value.trim();
      const prefix = prefixMap[categorySelect.value] || '/d/';
      const code = shortcodeInput.value.trim().toLowerCase().replace(/^\//, '');
      const target = targetInput.value.trim();
      
      if (name && code && target) {
        previewName.textContent = name;
        previewUrl.textContent = `www.specialist.se${prefix}${code}`;
        livePreview.classList.remove('hidden');
      } else {
        livePreview.classList.add('hidden');
      }
    }
    
    // Generera JSON n√§r knappen klickas
    generateBtn?.addEventListener('click', () => {
      // D√∂lj tidigare meddelanden
      outputSection.classList.add('hidden');
      errorMessage.classList.add('hidden');
      
      // H√§mta v√§rden
      const category = categorySelect.value;
      const name = nameInput.value.trim();
      const shortcodeSuffix = shortcodeInput.value.trim().toLowerCase().replace(/^\//, '');
      const target = targetInput.value.trim();
      
      // Validera - Tydliga felmeddelanden
      if (!name) {
        errorText.textContent = '‚ùå Du m√•ste skriva ett namn (steg 2)';
        errorMessage.classList.remove('hidden');
        nameInput.focus();
        return;
      }
      
      if (!shortcodeSuffix) {
        errorText.textContent = '‚ùå Du m√•ste skriva en kortkod (steg 3). Klicka p√• "Auto" f√∂r att fylla i automatiskt!';
        errorMessage.classList.remove('hidden');
        shortcodeInput.focus();
        return;
      }
      
      if (!target) {
        errorText.textContent = '‚ùå Du m√•ste skriva vart l√§nken ska g√• (steg 4)';
        errorMessage.classList.remove('hidden');
        targetInput.focus();
        return;
      }
      
      // Validera kortkod (endast bokst√§ver, siffror, bindestreck)
      if (!/^[a-z0-9-]+$/.test(shortcodeSuffix)) {
        errorText.textContent = '‚ùå Kortkod f√•r endast inneh√•lla sm√• bokst√§ver (a-z), siffror (0-9) och bindestreck (-). Klicka p√• "Auto" f√∂r att generera en korrekt kortkod!';
        errorMessage.classList.remove('hidden');
        shortcodeInput.focus();
        return;
      }
      
      // Bygg fullst√§ndig shortCode med prefix
      const prefix = prefixMap[category] || '/d/';
      const shortCode = prefix + shortcodeSuffix;
      
      // Avg√∂r om det √§r extern URL
      const isExternal = target.startsWith('http://') || target.startsWith('https://');
      
      // Skapa JSON-objekt
      const linkObject = {
        name: name,
        shortCode: shortCode,
        target: target,
        isExternal: isExternal
      };
      
      // Formatera JSON med indrag (2 spaces) och trailing comma
      const jsonString = JSON.stringify(linkObject, null, 2)
        .replace(/^{/, '    {')           // Indentera f√∂rsta raden
        .replace(/\n/g, '\n    ')         // Indentera alla rader
        .replace(/    }$/, '    },');     // L√§gg till trailing comma
      
      // Visa output
      jsonOutput.textContent = jsonString;
      
      // S√§tt kategori-namn i instruktionerna
      const outputCategoryName = document.getElementById('output-category-name') as HTMLElement | null;
      if (outputCategoryName) {
        outputCategoryName.textContent = `"${category}"`;
      }
      
      outputSection.classList.remove('hidden');
      
      // Scrolla till output
      outputSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    });
    
    // Kopiera JSON till urklipp
    copyJsonBtn?.addEventListener('click', async () => {
      const jsonText = jsonOutput.textContent || '';
      
      try {
        await navigator.clipboard.writeText(jsonText);
        
        // Visa feedback
        const originalText = copyJsonBtn.innerHTML;
        copyJsonBtn.innerHTML = `
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          Kopierad!
        `;
        copyJsonBtn.classList.remove('bg-slate-700');
        copyJsonBtn.classList.add('bg-green-600');
        
        // Visa toast ocks√•
        if (toast) {
          toast.classList.remove('translate-x-full');
          setTimeout(() => {
            toast.classList.add('translate-x-full');
          }, 2000);
        }
        
        // √Öterst√§ll knappen
        setTimeout(() => {
          copyJsonBtn.innerHTML = originalText;
          copyJsonBtn.classList.remove('bg-green-600');
          copyJsonBtn.classList.add('bg-slate-700');
        }, 2000);
        
      } catch (err) {
        console.error('Kunde inte kopiera:', err);
        alert('Kunde inte kopiera. Markera och kopiera manuellt.');
      }
    });
  });
</script>
