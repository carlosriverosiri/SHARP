---
/**
 * AI Council - Master Mind Tool
 * URL: /admin/ai-council
 * 
 * Features:
 * - Multi-model queries (OpenAI, Anthropic, Google)
 * - Selectable synthesis model
 * - File upload (images, documents)
 * - Supabase session storage with localStorage fallback
 */

export const prerender = false;

import { arInloggad, hamtaAnvandare } from '../../lib/auth';

// Check authentication
if (!await arInloggad(Astro.cookies)) {
  return Astro.redirect('/personal');
}

const anvandare = await hamtaAnvandare(Astro.cookies);
if (!anvandare) {
  return Astro.redirect('/personal');
}
---

<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>AI Council | Master Mind</title>
  <link rel="icon" type="image/x-icon" href="/favicons/favicon.ico">
  
  <!-- Highlight.js for code syntax -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  
  <!-- Marked.js for Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <!-- PDF.js for PDF parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0a0a;
      color: #e5e5e5;
      min-height: 100vh;
      line-height: 1.6;
    }
    
    .layout { display: flex; min-height: 100vh; }
    .main-area { flex: 1; display: flex; flex-direction: column; min-width: 0; }
    
    /* Notes sidebar */
    .notes-sidebar {
      width: 320px;
      background: #0d0d0d;
      border-left: 1px solid #1a1a1a;
      display: flex;
      flex-direction: column;
    }
    .notes-sidebar.collapsed { width: 48px; }
    .notes-sidebar.collapsed .notes-content,
    .notes-sidebar.collapsed .notes-header-title,
    .notes-sidebar.collapsed .notes-actions { display: none; }
    
    .notes-header {
      padding: 1rem;
      border-bottom: 1px solid #1a1a1a;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }
    .notes-header-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 600;
      color: #888;
    }
    .notes-toggle {
      background: transparent;
      border: none;
      color: #666;
      cursor: pointer;
      padding: 0.25rem;
    }
    .notes-toggle:hover { color: #999; }
    
    .notes-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .notes-list { flex: 1; overflow-y: auto; padding: 0.75rem; }
    
    .note-item {
      background: #111;
      border: 1px solid #1a1a1a;
      border-radius: 8px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      font-size: 0.8125rem;
      cursor: pointer;
    }
    .note-item:hover { border-color: #333; }
    .note-item-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
    .note-item-time { font-size: 0.6875rem; color: #555; }
    .note-item-actions { display: flex; gap: 0.25rem; }
    .note-item-btn {
      background: transparent;
      border: none;
      color: #555;
      cursor: pointer;
      padding: 0.125rem;
      font-size: 0.75rem;
    }
    .note-item-btn:hover { color: #999; }
    .note-item-name {
      color: #f97316;
      font-weight: 600;
      font-size: 0.8125rem;
      margin-bottom: 0.25rem;
      padding: 0.25rem 0.5rem;
      background: rgba(249, 115, 22, 0.1);
      border-radius: 4px;
      display: inline-block;
    }
    .note-item-prompt {
      color: #818cf8;
      font-weight: 500;
      margin-bottom: 0.25rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .note-item-preview {
      color: #777;
      font-size: 0.75rem;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .note-item-model {
      font-size: 0.625rem;
      color: #555;
      margin-top: 0.25rem;
    }
    
    .notes-actions {
      padding: 0.75rem;
      border-top: 1px solid #1a1a1a;
      display: flex;
      gap: 0.5rem;
    }
    .notes-btn {
      flex: 1;
      background: #1a1a1a;
      border: 1px solid #222;
      color: #888;
      padding: 0.5rem;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
    }
    .notes-btn:hover { background: #222; color: #ccc; }
    .notes-btn.danger:hover { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .notes-empty { text-align: center; padding: 2rem 1rem; color: #444; font-size: 0.8125rem; }
    .notes-sync { font-size: 0.625rem; color: #555; padding: 0.5rem 0.75rem; text-align: center; }
    .notes-sync.synced { color: #10b981; }
    
    /* Session modal */
    .session-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    .session-modal.open { display: flex; }
    .session-modal-content {
      background: #111;
      border: 1px solid #222;
      border-radius: 12px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .session-modal-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #222;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #0d0d0d;
    }
    .session-modal-title { font-size: 1rem; font-weight: 600; color: #ccc; }
    .session-modal-meta { font-size: 0.75rem; color: #666; }
    .session-modal-close {
      background: transparent;
      border: none;
      color: #666;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem;
      line-height: 1;
    }
    .session-modal-close:hover { color: #999; }
    .session-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
    }
    .session-modal-prompt {
      background: #1a1a1a;
      border: 1px solid #222;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    .session-modal-prompt-label { font-size: 0.75rem; color: #666; margin-bottom: 0.5rem; text-transform: uppercase; }
    .session-modal-prompt-text { color: #818cf8; font-weight: 500; }
    .session-modal-synthesis { color: #ddd; }
    .session-modal-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid #222;
      display: flex;
      gap: 0.75rem;
      background: #0d0d0d;
    }
    .session-modal-btn {
      background: #1a1a1a;
      border: 1px solid #333;
      color: #ccc;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.875rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .session-modal-btn:hover { background: #222; }
    .session-modal-btn.primary { background: #818cf8; border-color: #818cf8; color: #fff; }
    .session-modal-btn.primary:hover { background: #6366f1; }
    
    /* Save prompt modal */
    .save-prompt-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(8px);
      z-index: 1100;
      display: none;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }
    .save-prompt-modal.open { display: flex; }
    .save-prompt-content {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border: 2px solid #f97316;
      border-radius: 16px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 0 60px rgba(249, 115, 22, 0.3);
      animation: saveModalPulse 2s ease-in-out infinite;
    }
    @keyframes saveModalPulse {
      0%, 100% { box-shadow: 0 0 40px rgba(249, 115, 22, 0.3); }
      50% { box-shadow: 0 0 60px rgba(249, 115, 22, 0.5); }
    }
    .save-prompt-header {
      padding: 1.5rem;
      text-align: center;
      border-bottom: 1px solid rgba(249, 115, 22, 0.3);
    }
    .save-prompt-icon {
      font-size: 3rem;
      margin-bottom: 0.5rem;
      display: block;
    }
    .save-prompt-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #f97316;
      margin-bottom: 0.25rem;
    }
    .save-prompt-subtitle {
      font-size: 0.875rem;
      color: #94a3b8;
    }
    .save-prompt-body {
      padding: 1.5rem;
    }
    .save-prompt-input-group {
      margin-bottom: 1rem;
    }
    .save-prompt-label {
      display: block;
      font-size: 0.75rem;
      color: #94a3b8;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .save-prompt-input {
      width: 100%;
      background: #0a0a0a;
      border: 1px solid #333;
      color: #fff;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-size: 1rem;
    }
    .save-prompt-input:focus {
      outline: none;
      border-color: #f97316;
      box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2);
    }
    .save-prompt-input::placeholder { color: #555; }
    .save-prompt-preview {
      background: #0a0a0a;
      border: 1px solid #222;
      border-radius: 8px;
      padding: 0.75rem 1rem;
      font-size: 0.8125rem;
      color: #666;
      max-height: 60px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .save-prompt-autosave {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 8px;
      margin-top: 1rem;
      cursor: pointer;
    }
    .save-prompt-autosave:hover { background: rgba(16, 185, 129, 0.15); }
    .save-prompt-autosave input { display: none; }
    .save-prompt-autosave-check {
      width: 20px; height: 20px;
      border: 2px solid #10b981;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .save-prompt-autosave-check svg { display: none; width: 14px; height: 14px; color: #10b981; }
    .save-prompt-autosave input:checked + .save-prompt-autosave-check svg { display: block; }
    .save-prompt-autosave-text { font-size: 0.8125rem; color: #10b981; }
    .save-prompt-footer {
      padding: 1.5rem;
      border-top: 1px solid rgba(249, 115, 22, 0.3);
      display: flex;
      gap: 1rem;
    }
    .save-prompt-btn {
      flex: 1;
      padding: 1rem;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.2s;
    }
    .save-prompt-btn.save {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      border: none;
      color: #fff;
    }
    .save-prompt-btn.save:hover {
      background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
      transform: scale(1.02);
    }
    .save-prompt-btn.skip {
      background: transparent;
      border: 1px solid #444;
      color: #888;
    }
    .save-prompt-btn.skip:hover { background: #1a1a1a; color: #ccc; }
    
    /* Header */
    .header {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid #222;
      padding: 1rem 1.5rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-inner { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
    .header-left { display: flex; align-items: center; gap: 1rem; }
    .back-link { color: #666; text-decoration: none; font-size: 0.875rem; }
    .back-link:hover { color: #999; }
    .logo h1 {
      font-size: 1.25rem;
      font-weight: 700;
      background: linear-gradient(135deg, #818cf8, #a78bfa, #f97316);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .logo span { font-size: 0.75rem; color: #555; }
    .header-right { display: flex; align-items: center; gap: 1rem; }
    .profile-link {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.375rem 0.75rem;
      background: rgba(129, 140, 248, 0.1);
      border: 1px solid rgba(129, 140, 248, 0.3);
      border-radius: 6px;
      color: #a5b4fc;
      font-size: 0.8125rem;
      text-decoration: none;
      transition: all 0.15s;
    }
    .profile-link:hover {
      background: rgba(129, 140, 248, 0.15);
      border-color: rgba(129, 140, 248, 0.5);
      color: #c4b5fd;
    }
    .user-email { font-size: 0.875rem; color: #666; }
    .model-dots { display: flex; gap: 4px; }
    .model-dot { width: 8px; height: 8px; border-radius: 50%; }
    .dot-openai { background: #10a37f; }
    .dot-anthropic { background: #d97706; }
    .dot-google { background: #4285f4; }
    .dot-grok { background: #1d9bf0; }
    
    /* Model selection checkboxes */
    .model-selection {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }
    .model-checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .model-checkbox:hover { border-color: #444; background: #222; }
    .model-checkbox.selected { border-color: #555; background: #252525; }
    
    /* Profile selector */
    .profile-selector {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    .profile-btn {
      position: relative;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.875rem;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      color: #999;
      font-size: 0.8125rem;
      cursor: pointer;
      transition: all 0.15s;
    }
    .profile-btn:hover { border-color: #555; background: #222; color: #ccc; }
    .profile-btn.active { border-color: #818cf8; background: rgba(129, 140, 248, 0.1); color: #818cf8; }
    .profile-btn.turbo.active { border-color: #4ade80; background: rgba(74, 222, 128, 0.1); color: #4ade80; }
    .profile-btn .profile-icon { font-size: 1rem; }
    .profile-btn .profile-name { font-weight: 500; }
    .profile-btn .profile-desc { font-size: 0.6875rem; color: #666; }
    .profile-btn.active .profile-desc { color: inherit; opacity: 0.7; }
    
    /* Profile tooltips */
    .profile-tooltip {
      position: absolute;
      bottom: calc(100% + 10px);
      left: 50%;
      transform: translateX(-50%);
      width: 280px;
      padding: 1rem;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
      z-index: 100;
      pointer-events: none;
    }
    .profile-btn:hover .profile-tooltip {
      opacity: 1;
      visibility: visible;
    }
    .profile-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 8px solid transparent;
      border-top-color: #333;
    }
    .profile-tooltip-title {
      font-size: 0.9375rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .profile-tooltip-why {
      font-size: 0.8125rem;
      color: #ccc;
      margin-bottom: 0.75rem;
      line-height: 1.5;
    }
    .profile-tooltip-config {
      font-size: 0.75rem;
      color: #888;
      padding-top: 0.75rem;
      border-top: 1px solid #333;
    }
    .profile-tooltip-config div {
      margin-bottom: 0.25rem;
    }
    .profile-tooltip-config strong {
      color: #aaa;
    }
    .profile-tooltip-tag {
      display: inline-block;
      padding: 0.125rem 0.375rem;
      background: rgba(129, 140, 248, 0.2);
      color: #818cf8;
      border-radius: 4px;
      font-size: 0.6875rem;
      margin-left: 0.25rem;
    }
    .profile-tooltip-tag.turbo {
      background: rgba(74, 222, 128, 0.2);
      color: #4ade80;
    }
    .model-checkbox.unavailable { opacity: 0.4; cursor: not-allowed; }
    .model-checkbox input { display: none; }
    .model-checkbox-dot { width: 10px; height: 10px; border-radius: 50%; }
    .model-checkbox-name { font-size: 0.8125rem; color: #ccc; }
    .model-checkbox-desc { font-size: 0.6875rem; color: #666; }
    .model-checkbox.selected .model-checkbox-name { color: #fff; }
    .model-checkbox-check {
      width: 16px; height: 16px;
      border: 2px solid #444;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      color: transparent;
    }
    .model-checkbox.selected .model-checkbox-check {
      background: #818cf8;
      border-color: #818cf8;
      color: #fff;
    }
    
    /* Deliberation toggle */
    .deliberation-toggle {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem 0.75rem;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      cursor: pointer;
    }
    .deliberation-toggle:hover { border-color: #444; background: #222; }
    .deliberation-toggle.active { border-color: #f97316; background: rgba(249, 115, 22, 0.1); }
    .deliberation-toggle input { display: none; }
    .deliberation-toggle-switch {
      width: 36px; height: 20px;
      background: #333;
      border-radius: 10px;
      position: relative;
      transition: background 0.2s;
    }
    .deliberation-toggle-switch::after {
      content: '';
      position: absolute;
      width: 16px; height: 16px;
      background: #666;
      border-radius: 50%;
      top: 2px; left: 2px;
      transition: all 0.2s;
    }
    .deliberation-toggle.active .deliberation-toggle-switch { background: #f97316; }
    .deliberation-toggle.active .deliberation-toggle-switch::after { background: #fff; left: 18px; }
    .deliberation-toggle-label { font-size: 0.8125rem; color: #999; }
    .deliberation-toggle.active .deliberation-toggle-label { color: #f97316; }
    .deliberation-toggle-desc { font-size: 0.6875rem; color: #555; }
    .deliberation-toggle.active .deliberation-toggle-desc { color: #b45309; }
    
    /* Round 2 section */
    .round-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: #f97316;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: 1.5rem 0 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #222;
    }
    .round-label.round-1 { color: #818cf8; }
    
    /* Main content */
    .main { max-width: 1200px; margin: 0 auto; padding: 2rem 1.5rem; width: 100%; }
    
    /* Input card */
    .input-card {
      background: linear-gradient(135deg, #818cf8, #a78bfa, #f97316);
      padding: 2px;
      border-radius: 16px;
      margin-bottom: 2rem;
    }
    .input-card-inner { background: #111; border-radius: 14px; padding: 1.5rem; }
    .form-group { margin-bottom: 1.5rem; }
    .form-label { display: block; font-size: 0.875rem; font-weight: 500; color: #ccc; margin-bottom: 0.5rem; }
    .form-label .icon { margin-right: 0.5rem; }
    .form-label .optional { color: #666; font-weight: 400; }
    .form-label .required { color: #ef4444; }
    
    textarea, input[type="text"], select {
      width: 100%;
      background: #1a1a1a;
      border: 1px solid #333;
      color: #e5e5e5;
      border-radius: 8px;
      padding: 0.875rem 1rem;
      font-size: 0.9375rem;
      font-family: inherit;
    }
    textarea { resize: vertical; }
    textarea:focus, input:focus, select:focus {
      outline: none;
      border-color: #818cf8;
      box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.15);
    }
    textarea::placeholder, input::placeholder { color: #555; }
    .context-input { min-height: 120px; font-family: 'Monaco', 'Menlo', monospace; font-size: 0.875rem; }
    .prompt-input { min-height: 80px; }
    
    /* File upload */
    .file-upload-area {
      border: 2px dashed #333;
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      margin-top: 0.75rem;
    }
    .file-upload-area:hover { border-color: #555; background: rgba(255,255,255,0.02); }
    .file-upload-area.dragover { border-color: #818cf8; background: rgba(129, 140, 248, 0.1); }
    .file-upload-icon { font-size: 1.5rem; margin-bottom: 0.5rem; }
    .file-upload-text { font-size: 0.8125rem; color: #666; }
    .file-upload-text strong { color: #818cf8; }
    .file-list { margin-top: 0.75rem; }
    .file-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: #1a1a1a;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      font-size: 0.8125rem;
    }
    .file-item-name { flex: 1; color: #ccc; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .file-item-size { color: #555; font-size: 0.75rem; }
    .file-item-remove {
      background: transparent;
      border: none;
      color: #666;
      cursor: pointer;
      padding: 0.25rem;
    }
    .file-item-remove:hover { color: #f87171; }
    
    /* Synthesis model selector */
    .synthesis-selector {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .synthesis-selector label { font-size: 0.8125rem; color: #888; }
    .synthesis-selector select {
      width: auto;
      padding: 0.5rem 2rem 0.5rem 0.75rem;
      font-size: 0.8125rem;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23666'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.5rem center;
      background-size: 1rem;
      appearance: none;
    }
    
    /* Actions row */
    .actions-row { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; }
    .model-legend { display: flex; align-items: center; gap: 1rem; font-size: 0.75rem; color: #666; }
    .model-legend-item { display: flex; align-items: center; gap: 0.375rem; }
    .model-legend-dot { width: 8px; height: 8px; border-radius: 50%; }
    
    .run-btn {
      background: linear-gradient(135deg, #6366f1, #8b5cf6, #f97316);
      color: white;
      border: none;
      padding: 0.875rem 2rem;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .run-btn:hover:not(:disabled) { opacity: 0.9; }
    .run-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .run-btn .spinner {
      width: 18px; height: 18px;
      border: 2px solid transparent;
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: none;
    }
    .run-btn.loading .spinner { display: block; }
    .run-btn.loading .btn-text { display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Status & Error */
    .status {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
      display: none;
      align-items: center;
      gap: 0.75rem;
    }
    .status.visible { display: flex; }
    .status-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: #818cf8;
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .status-text { font-size: 0.875rem; color: #aaa; }
    
    .error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 8px;
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
      color: #f87171;
      font-size: 0.875rem;
      display: none;
    }
    .error.visible { display: block; }
    
    /* Results */
    .results { display: none; }
    .results.visible { display: block; }
    
    /* Copy button */
    .copy-btn {
      background: #1a1a1a;
      border: 1px solid #333;
      color: #888;
      padding: 0.375rem 0.75rem;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
    }
    .copy-btn:hover { background: #222; color: #ccc; }
    .copy-btn.copied { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .copy-btn svg { width: 14px; height: 14px; }
    
    .export-md-btn {
      background: linear-gradient(135deg, #1e3a5f 0%, #1a1a2e 100%);
      border: 1px solid #3b82f6;
      color: #60a5fa;
      padding: 0.375rem 0.75rem;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
    }
    .export-md-btn:hover { background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); color: #fff; border-color: #60a5fa; }
    .export-md-btn svg { width: 14px; height: 14px; }
    
    /* Synthesis card */
    .synthesis-card {
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(168, 85, 247, 0.05));
      border: 1px solid rgba(168, 85, 247, 0.3);
      border-left: 4px solid #a855f7;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    .synthesis-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .synthesis-icon { font-size: 1.5rem; }
    .synthesis-title { flex: 1; }
    .synthesis-title h2 { font-size: 1.125rem; font-weight: 600; color: #c4b5fd; }
    .synthesis-title span { font-size: 0.75rem; color: #777; }
    .synthesis-actions { display: flex; align-items: center; gap: 0.5rem; }
    .synthesis-duration { font-size: 0.75rem; color: #666; }
    .synthesis-content { color: #ddd; }
    
    .save-note-btn {
      background: transparent;
      border: 1px solid rgba(168, 85, 247, 0.3);
      color: #a78bfa;
      padding: 0.375rem 0.75rem;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
    }
    .save-note-btn:hover { background: rgba(168, 85, 247, 0.1); }
    .save-note-btn.saved { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    
    /* Accordion */
    .responses-section h3 {
      font-size: 0.75rem;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 1rem;
    }
    .responses-grid { display: flex; flex-direction: column; gap: 0.75rem; }
    
    .accordion { background: #111; border: 1px solid #222; border-radius: 8px; overflow: hidden; }
    .accordion.openai { border-left: 3px solid #10a37f; }
    .accordion.anthropic { border-left: 3px solid #d97706; }
    .accordion.google { border-left: 3px solid #4285f4; }
    .accordion.grok { border-left: 3px solid #1d9bf0; }
    
    .accordion-header {
      width: 100%;
      background: transparent;
      border: none;
      padding: 1rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }
    .accordion-header:hover { background: rgba(255, 255, 255, 0.03); }
    .accordion-header-left { display: flex; align-items: center; gap: 0.75rem; }
    .accordion-dot { width: 10px; height: 10px; border-radius: 50%; }
    .accordion-title { font-size: 0.9375rem; font-weight: 500; color: #ddd; }
    .accordion-status { font-size: 0.75rem; color: #666; margin-left: 0.5rem; }
    .accordion-status.success { color: #10b981; }
    .accordion-status.error { color: #ef4444; }
    .accordion-header-right { display: flex; align-items: center; gap: 0.75rem; }
    .accordion-duration { font-size: 0.75rem; color: #555; }
    .accordion-icon { width: 20px; height: 20px; color: #555; transition: transform 0.2s; }
    .accordion.open .accordion-icon { transform: rotate(180deg); }
    
    .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .accordion.open .accordion-content { max-height: 3000px; }
    .accordion-content-inner { padding: 0 1.25rem 1.25rem; border-top: 1px solid #222; }
    .accordion-content-inner .markdown-content { padding-top: 1rem; }
    .accordion-content-actions { display: flex; gap: 0.5rem; padding-top: 1rem; border-top: 1px solid #1a1a1a; margin-top: 1rem; }
    
    .total-stats { display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; padding-top: 1.5rem; border-top: 1px solid #222; margin-top: 1.5rem; font-size: 0.875rem; color: #555; }
    .total-duration { }
    .total-cost { color: #4ade80; }
    .total-cost .cost-details { display: block; font-size: 0.75rem; color: #666; margin-top: 0.25rem; }
    
    /* Cost banner at top */
    .cost-banner {
      display: none;
      background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(74, 222, 128, 0.05));
      border: 1px solid rgba(74, 222, 128, 0.3);
      border-radius: 12px;
      padding: 1rem 1.5rem;
      margin-bottom: 1.5rem;
    }
    .cost-banner.visible { display: block; }
    .cost-banner-main {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .cost-banner-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .cost-banner-icon { font-size: 1.5rem; }
    .cost-banner-amount {
      font-size: 1.5rem;
      font-weight: 700;
      color: #4ade80;
    }
    .cost-banner-sek {
      font-size: 0.875rem;
      color: #86efac;
      margin-left: 0.5rem;
    }
    .cost-banner-right {
      display: flex;
      gap: 1.5rem;
      font-size: 0.8125rem;
      color: #666;
    }
    .cost-banner-stat {
      display: flex;
      align-items: center;
      gap: 0.375rem;
    }
    .cost-banner-stat-value { color: #999; font-weight: 500; }
    
    /* Hallucination Report */
    .hallucination-report {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 12px;
      padding: 1.25rem 1.5rem;
      margin-bottom: 1.5rem;
    }
    .hallucination-report.has-issues {
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(251, 191, 36, 0.05));
      border-color: rgba(251, 191, 36, 0.3);
    }
    .hallucination-report.has-high {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
      border-color: rgba(239, 68, 68, 0.3);
    }
    .hallucination-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .hallucination-icon { font-size: 1.5rem; }
    .hallucination-title h2 { font-size: 1rem; font-weight: 600; color: #93c5fd; margin: 0; }
    .hallucination-title span { font-size: 0.75rem; color: #666; }
    .hallucination-summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .hallucination-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
    }
    .hallucination-status-good {
      background: rgba(74, 222, 128, 0.15);
      color: #4ade80;
    }
    .hallucination-status-warning {
      background: rgba(251, 191, 36, 0.15);
      color: #fbbf24;
    }
    .hallucination-status-danger {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }
    .hallucination-counts {
      display: flex;
      gap: 1rem;
    }
    .hallucination-count {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      font-size: 0.8125rem;
    }
    .hallucination-count .count-num { font-weight: 600; color: #fff; }
    .hallucination-count .count-label { color: #888; }
    .hallucination-details { margin-top: 1rem; }
    .hallucination-toggle {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      padding: 0.5rem 1rem;
      color: #888;
      font-size: 0.8125rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .hallucination-toggle:hover { background: rgba(255,255,255,0.1); color: #fff; }
    .hallucination-list { margin-top: 1rem; }
    .hallucination-item {
      background: rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.75rem;
    }
    .hallucination-item.high { border-left: 3px solid #ef4444; }
    .hallucination-item.medium { border-left: 3px solid #fbbf24; }
    .hallucination-item.low { border-left: 3px solid #facc15; }
    .hallucination-item-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .hallucination-item-claim {
      font-style: italic;
      color: #ccc;
      margin-bottom: 0.5rem;
      padding-left: 0.5rem;
      border-left: 2px solid #444;
    }
    .hallucination-item-meta {
      font-size: 0.75rem;
      color: #666;
    }
    .hallucination-item-meta span { margin-right: 1rem; }
    
    /* Markdown */
    .markdown-content { line-height: 1.7; color: #ccc; }
    .markdown-content h1, .markdown-content h2, .markdown-content h3, .markdown-content h4 { color: #fff; margin-top: 1.5em; margin-bottom: 0.5em; }
    .markdown-content h1:first-child, .markdown-content h2:first-child, .markdown-content h3:first-child { margin-top: 0; }
    .markdown-content h1 { font-size: 1.5em; font-weight: 700; }
    .markdown-content h2 { font-size: 1.25em; font-weight: 600; }
    .markdown-content h3 { font-size: 1.1em; font-weight: 600; }
    .markdown-content p { margin-bottom: 1em; }
    .markdown-content ul, .markdown-content ol { margin-left: 1.5em; margin-bottom: 1em; }
    .markdown-content li { margin-bottom: 0.25em; }
    .markdown-content code { background: #1e1e1e; padding: 0.2em 0.4em; border-radius: 4px; font-size: 0.875em; font-family: 'Monaco', 'Menlo', monospace; }
    .markdown-content pre { background: #1e1e1e; padding: 1rem; border-radius: 8px; overflow-x: auto; margin-bottom: 1em; }
    .markdown-content pre code { background: transparent; padding: 0; font-size: 0.875rem; }
    .markdown-content blockquote { border-left: 3px solid #818cf8; padding-left: 1em; margin-left: 0; margin-bottom: 1em; color: #999; }
    .markdown-content table { width: 100%; border-collapse: collapse; margin-bottom: 1em; }
    .markdown-content th, .markdown-content td { border: 1px solid #333; padding: 0.5em 0.75em; text-align: left; }
    .markdown-content th { background: #1a1a1a; font-weight: 600; }
    .markdown-content a { color: #818cf8; text-decoration: none; }
    .markdown-content a:hover { text-decoration: underline; }
    .markdown-content strong { color: #fff; }
    
    @media (max-width: 1024px) {
      .notes-sidebar { position: fixed; right: 0; top: 0; bottom: 0; z-index: 200; transform: translateX(100%); }
      .notes-sidebar.open { transform: translateX(0); }
    }
    @media (max-width: 768px) {
      .header-inner { flex-direction: column; gap: 1rem; align-items: flex-start; }
      .actions-row { flex-direction: column; align-items: stretch; }
      .run-btn { justify-content: center; }
      .notes-sidebar { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <div class="main-area">
      <header class="header">
        <div class="header-inner">
          <div class="header-left">
            <a href="/personal/oversikt" class="back-link">‚Üê Tillbaka</a>
            <div class="logo">
              <h1>AI Council</h1>
              <span>Master Mind Tool</span>
            </div>
          </div>
          <div class="header-right">
            <a href="/admin/ai-council/profil" class="profile-link" title="Redigera din AI-profil">
              üë§ Min profil
            </a>
            <span class="user-email">{anvandare.email}</span>
            <div class="model-dots">
              <span class="model-dot dot-openai" title="OpenAI o1"></span>
              <span class="model-dot dot-anthropic" title="Claude Sonnet"></span>
              <span class="model-dot dot-google" title="Gemini 2.0 Flash"></span>
              <span class="model-dot dot-grok" title="Grok 4"></span>
            </div>
          </div>
        </div>
      </header>

      <main class="main">
        <section class="input-card">
          <div class="input-card-inner">
            <!-- Context -->
            <div class="form-group">
              <label class="form-label">
                <span class="icon">üìã</span> Kontext
                <span class="optional">(valfritt - kod, dokumentation)</span>
              </label>
              <textarea id="context" class="context-input" placeholder="Klistra in kod, dokumentation eller bakgrundsinfo..."></textarea>
              
              <!-- File upload -->
              <div id="fileUploadArea" class="file-upload-area">
                <div class="file-upload-icon">üìé</div>
                <div class="file-upload-text">
                  <strong>Klicka</strong> eller dra filer hit<br>
                  Bilder (PNG, JPG), PDF, TXT, MD, JSON
                </div>
                <input type="file" id="fileInput" multiple accept=".png,.jpg,.jpeg,.gif,.webp,.pdf,.txt,.md,.json,.js,.ts,.py,.html,.css" style="display:none">
              </div>
              <div id="fileList" class="file-list"></div>
            </div>
            
            <!-- Prompt -->
            <div class="form-group">
              <label class="form-label">
                <span class="icon">üí¨</span> Prompt <span class="required">*</span>
              </label>
              <textarea id="prompt" class="prompt-input" placeholder="St√§ll din fr√•ga..." required></textarea>
            </div>
            
            <!-- Profile selector -->
            <div class="form-group">
              <label class="form-label">
                <span class="icon">‚ö°</span> V√§lj profil
              </label>
              <div class="profile-selector" id="profileSelector">
                <button type="button" class="profile-btn turbo active" data-profile="snabb">
                  <span class="profile-icon">‚ö°</span>
                  <div>
                    <div class="profile-name">Snabb</div>
                    <div class="profile-desc">~3-5 sek</div>
                  </div>
                  <div class="profile-tooltip">
                    <div class="profile-tooltip-title">‚ö° Snabb <span class="profile-tooltip-tag turbo">STANDARD</span></div>
                    <div class="profile-tooltip-why">
                      Blixtsnabbt svar med Gemini. Perfekt f√∂r enkla fr√•gor och n√§r du inte vill v√§nta.
                      Undviker Netlify timeout-problem.
                    </div>
                    <div class="profile-tooltip-config">
                      <div><strong>Modell:</strong> Gemini 2.0 Flash</div>
                      <div><strong>Syntes:</strong> Gemini (direkt)</div>
                      <div><strong>Tid:</strong> ~2-5 sek</div>
                    </div>
                  </div>
                </button>
                <button type="button" class="profile-btn turbo" data-profile="patient">
                  <span class="profile-icon">üè•</span>
                  <div>
                    <div class="profile-name">Patientfr√•gor</div>
                    <div class="profile-desc">Turbo + kontroll</div>
                  </div>
                  <div class="profile-tooltip">
                    <div class="profile-tooltip-title">üè• Patientfr√•gor <span class="profile-tooltip-tag turbo">TURBO</span></div>
                    <div class="profile-tooltip-why">
                      Optimerad f√∂r telefonsamtal med patienter. Blixtsnabb respons n√§r du 
                      beh√∂ver svara direkt. Tv√• modeller kontrollerar varandra f√∂r s√§kerhet.
                    </div>
                    <div class="profile-tooltip-config">
                      <div><strong>Modeller:</strong> Gemini 2.0 Flash + Claude Sonnet</div>
                      <div><strong>Syntes:</strong> GPT-4o (snabbast)</div>
                      <div><strong>Deliberation:</strong> Av (f√∂r snabbhet)</div>
                    </div>
                  </div>
                </button>
                <button type="button" class="profile-btn" data-profile="kod">
                  <span class="profile-icon">üíª</span>
                  <div>
                    <div class="profile-name">Kodning</div>
                    <div class="profile-desc">Claude</div>
                  </div>
                  <div class="profile-tooltip">
                    <div class="profile-tooltip-title">üíª Kodning</div>
                    <div class="profile-tooltip-why">
                      Claude √§r b√§st p√• strukturerad kod, debugging och arkitekturbeslut.
                      Snabb nog f√∂r Netlify.
                    </div>
                    <div class="profile-tooltip-config">
                      <div><strong>Modell:</strong> Claude Sonnet</div>
                      <div><strong>Syntes:</strong> Claude (kod-expert)</div>
                      <div><strong>Tid:</strong> ~5-15 sek</div>
                    </div>
                  </div>
                </button>
                <button type="button" class="profile-btn" data-profile="vetenskap">
                  <span class="profile-icon">üî¨</span>
                  <div>
                    <div class="profile-name">Vetenskap</div>
                    <div class="profile-desc">Gemini + Claude</div>
                  </div>
                  <div class="profile-tooltip">
                    <div class="profile-tooltip-title">üî¨ Vetenskap</div>
                    <div class="profile-tooltip-why">
                      F√∂r litteratursyntes och evidensgranskning. Gemini har stort kontextf√∂nster,
                      Claude √§r stark p√• analys.
                    </div>
                    <div class="profile-tooltip-config">
                      <div><strong>Modeller:</strong> Gemini + Claude</div>
                      <div><strong>Syntes:</strong> Claude</div>
                      <div><strong>Tid:</strong> ~10-20 sek</div>
                    </div>
                  </div>
                </button>
                <button type="button" class="profile-btn" data-profile="djup">
                  <span class="profile-icon">üéØ</span>
                  <div>
                    <div class="profile-name">Djup analys</div>
                    <div class="profile-desc">Opus</div>
                  </div>
                  <div class="profile-tooltip">
                    <div class="profile-tooltip-title">üéØ Djup analys <span class="profile-tooltip-tag">PREMIUM</span></div>
                    <div class="profile-tooltip-why">
                      F√∂r kritiska beslut. Gemini + Claude med Claude Opus 4.5 som syntetiserar.
                      Anthropics b√§sta modell f√∂r komplex analys.
                    </div>
                    <div class="profile-tooltip-config">
                      <div><strong>Modeller:</strong> Gemini + Claude</div>
                      <div><strong>Syntes:</strong> Claude Opus 4.5</div>
                      <div><strong>Tid:</strong> ~15-25 sek</div>
                    </div>
                  </div>
                </button>
              </div>
            </div>
            
            <!-- Model selection -->
            <div class="form-group">
              <label class="form-label">
                <span class="icon">ü§ñ</span> V√§lj AI-modeller
                <span class="optional">(eller anv√§nd profil)</span>
              </label>
              <div class="model-selection" id="modelSelection">
                <label class="model-checkbox" data-model="openai">
                  <input type="checkbox">
                  <span class="model-checkbox-check">‚úì</span>
                  <span class="model-checkbox-dot dot-openai"></span>
                  <div>
                    <div class="model-checkbox-name">OpenAI o1</div>
                    <div class="model-checkbox-desc">Djup logik & resonering</div>
                  </div>
                </label>
                <label class="model-checkbox selected" data-model="anthropic">
                  <input type="checkbox" checked>
                  <span class="model-checkbox-check">‚úì</span>
                  <span class="model-checkbox-dot dot-anthropic"></span>
                  <div>
                    <div class="model-checkbox-name">Claude Sonnet</div>
                    <div class="model-checkbox-desc">Struktur & kod</div>
                  </div>
                </label>
                <label class="model-checkbox selected" data-model="gemini">
                  <input type="checkbox" checked>
                  <span class="model-checkbox-check">‚úì</span>
                  <span class="model-checkbox-dot dot-google"></span>
                  <div>
                    <div class="model-checkbox-name">Gemini 2.0 Flash</div>
                    <div class="model-checkbox-desc">Snabbast & billigast</div>
                  </div>
                </label>
                <label class="model-checkbox" data-model="grok">
                  <input type="checkbox">
                  <span class="model-checkbox-check">‚úì</span>
                  <span class="model-checkbox-dot dot-grok"></span>
                  <div>
                    <div class="model-checkbox-name">Grok 4</div>
                    <div class="model-checkbox-desc">Referenser & realtid</div>
                  </div>
                </label>
              </div>
            </div>
            
            <!-- Actions -->
            <div class="actions-row">
              <div style="display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap;">
                <div class="synthesis-selector">
                  <label for="synthesisModel">Syntes-modell:</label>
                  <select id="synthesisModel">
                    <option value="gpt4o">‚ö° GPT-4o (snabb)</option>
                    <option value="claude">üîß Claude Sonnet (kod)</option>
                    <option value="gemini">üìö Gemini (billig)</option>
                    <option value="grok">üåê Grok (vetenskap)</option>
                    <option value="openai">üß™ OpenAI o1 (logik)</option>
                    <option value="claude-opus">üëë Claude Opus 4.5 (b√§st)</option>
                  </select>
                </div>
                <label id="deliberationToggle" class="deliberation-toggle">
                  <input type="checkbox" id="enableDeliberation">
                  <span class="deliberation-toggle-switch"></span>
                  <div>
                    <div class="deliberation-toggle-label">Deliberation</div>
                    <div class="deliberation-toggle-desc">Runda 2: Modeller granskar varandra</div>
                  </div>
                </label>
              </div>
              <button type="button" id="runBtn" class="run-btn">
                <span class="btn-text">‚ö° K√∂r AI Council</span>
                <span class="spinner"></span>
              </button>
            </div>
          </div>
        </section>
        
        <div id="status" class="status">
          <span class="status-dot"></span>
          <span id="statusText" class="status-text">F√∂rbereder...</span>
        </div>
        
        <div id="error" class="error"></div>
        
        <section id="results" class="results">
          <!-- Cost banner at top -->
          <div id="costBanner" class="cost-banner">
            <div class="cost-banner-main">
              <div class="cost-banner-left">
                <span class="cost-banner-icon">üí∞</span>
                <span id="costBannerAmount" class="cost-banner-amount">$0.00</span>
                <span id="costBannerSek" class="cost-banner-sek">(~0 kr)</span>
              </div>
              <div class="cost-banner-right">
                <div class="cost-banner-stat">
                  <span>‚è±Ô∏è</span>
                  <span id="costBannerTime" class="cost-banner-stat-value">0s</span>
                </div>
                <div class="cost-banner-stat">
                  <span>üì•</span>
                  <span id="costBannerTokensIn" class="cost-banner-stat-value">0</span>
                  <span>in</span>
                </div>
                <div class="cost-banner-stat">
                  <span>üì§</span>
                  <span id="costBannerTokensOut" class="cost-banner-stat-value">0</span>
                  <span>out</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Hallucination Report (shown when deliberation is enabled) -->
          <div id="hallucinationReport" class="hallucination-report" style="display: none;">
            <div class="hallucination-header">
              <span class="hallucination-icon">üîç</span>
              <div class="hallucination-title">
                <h2>Trov√§rdighetsrapport</h2>
                <span id="hallucinationSubtitle">Baserat p√• modellernas granskning av varandra</span>
              </div>
            </div>
            <div class="hallucination-summary">
              <div id="hallucinationStatus" class="hallucination-status hallucination-status-good">
                <span class="status-icon">‚úÖ</span>
                <span class="status-text">Inga s√§kra fel uppt√§ckta</span>
              </div>
              <div class="hallucination-counts">
                <div class="hallucination-count high" id="hallucinationHigh" style="display: none;">
                  <span class="count-badge">üî¥</span>
                  <span class="count-num">0</span>
                  <span class="count-label">s√§kra</span>
                </div>
                <div class="hallucination-count medium" id="hallucinationMedium" style="display: none;">
                  <span class="count-badge">üü†</span>
                  <span class="count-num">0</span>
                  <span class="count-label">troliga</span>
                </div>
                <div class="hallucination-count low" id="hallucinationLow" style="display: none;">
                  <span class="count-badge">üü°</span>
                  <span class="count-num">0</span>
                  <span class="count-label">misst√§nkta</span>
                </div>
              </div>
            </div>
            <div id="hallucinationDetails" class="hallucination-details" style="display: none;">
              <button type="button" class="hallucination-toggle" id="toggleHallucinationDetails">
                <span>‚ñº Visa detaljer</span>
              </button>
              <div id="hallucinationList" class="hallucination-list" style="display: none;"></div>
            </div>
          </div>
          
          <div id="synthesisCard" class="synthesis-card" style="display: none;">
            <div class="synthesis-header">
              <span class="synthesis-icon">üß†</span>
              <div class="synthesis-title">
                <h2>Syntes</h2>
                <span id="synthesisModelLabel">GPT-4o syntetiserar</span>
              </div>
              <div class="synthesis-actions">
                <button type="button" class="copy-btn" id="copySynthesis" title="Kopiera">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                  <span>Kopiera</span>
                </button>
                <button type="button" class="export-md-btn" id="exportMarkdown" title="Exportera som Markdown">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                  <span>Export .md</span>
                </button>
                <button type="button" class="save-note-btn" id="saveSynthesis" title="Spara">
                  <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>
                  <span>Spara</span>
                </button>
                <span id="synthesisDuration" class="synthesis-duration"></span>
              </div>
            </div>
            <div id="synthesisContent" class="synthesis-content markdown-content"></div>
          </div>
          
          <div class="responses-section">
            <div id="round1Label" class="round-label round-1" style="display: none;">Runda 1 ‚Äî Initiala svar</div>
            <h3 id="responsesHeader">Individuella svar</h3>
            <div class="responses-grid">
              <div id="accordion-openai" class="accordion openai">
                <button type="button" class="accordion-header">
                  <div class="accordion-header-left">
                    <span class="accordion-dot dot-openai"></span>
                    <span class="accordion-title">OpenAI o1</span>
                    <span id="status-openai" class="accordion-status"></span>
                  </div>
                  <div class="accordion-header-right">
                    <span id="duration-openai" class="accordion-duration"></span>
                    <svg class="accordion-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                  </div>
                </button>
                <div id="content-openai" class="accordion-content">
                  <div class="accordion-content-inner">
                    <div class="markdown-content"></div>
                    <div class="accordion-content-actions">
                      <button type="button" class="copy-btn" data-copy="openai"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg><span>Kopiera</span></button>
                    </div>
                  </div>
                </div>
              </div>
              
              <div id="accordion-anthropic" class="accordion anthropic">
                <button type="button" class="accordion-header">
                  <div class="accordion-header-left">
                    <span class="accordion-dot dot-anthropic"></span>
                    <span class="accordion-title">Claude Sonnet</span>
                    <span id="status-anthropic" class="accordion-status"></span>
                  </div>
                  <div class="accordion-header-right">
                    <span id="duration-anthropic" class="accordion-duration"></span>
                    <svg class="accordion-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                  </div>
                </button>
                <div id="content-anthropic" class="accordion-content">
                  <div class="accordion-content-inner">
                    <div class="markdown-content"></div>
                    <div class="accordion-content-actions">
                      <button type="button" class="copy-btn" data-copy="anthropic"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg><span>Kopiera</span></button>
                    </div>
                  </div>
                </div>
              </div>
              
              <div id="accordion-google" class="accordion google">
                <button type="button" class="accordion-header">
                  <div class="accordion-header-left">
                    <span class="accordion-dot dot-google"></span>
                    <span class="accordion-title">Gemini 2.0 Flash</span>
                    <span id="status-google" class="accordion-status"></span>
                  </div>
                  <div class="accordion-header-right">
                    <span id="duration-google" class="accordion-duration"></span>
                    <svg class="accordion-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                  </div>
                </button>
                <div id="content-google" class="accordion-content">
                  <div class="accordion-content-inner">
                    <div class="markdown-content"></div>
                    <div class="accordion-content-actions">
                      <button type="button" class="copy-btn" data-copy="google"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg><span>Kopiera</span></button>
                    </div>
                  </div>
                </div>
              </div>
              
              <div id="accordion-grok" class="accordion grok" style="display: none;">
                <button type="button" class="accordion-header">
                  <div class="accordion-header-left">
                    <span class="accordion-dot dot-grok"></span>
                    <span class="accordion-title">Grok 4</span>
                    <span id="status-grok" class="accordion-status"></span>
                  </div>
                  <div class="accordion-header-right">
                    <span id="duration-grok" class="accordion-duration"></span>
                    <svg class="accordion-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                  </div>
                </button>
                <div id="content-grok" class="accordion-content">
                  <div class="accordion-content-inner">
                    <div class="markdown-content"></div>
                    <div class="accordion-content-actions">
                      <button type="button" class="copy-btn" data-copy="grok"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg><span>Kopiera</span></button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Round 2 Section (Deliberation) -->
            <div id="round2Section" style="display: none;">
              <div class="round-label">Runda 2 ‚Äî Granskning & f√∂rb√§ttring</div>
              <div class="responses-grid">
                <div id="accordion-r2-openai" class="accordion openai">
                  <button type="button" class="accordion-header">
                    <div class="accordion-header-left">
                      <span class="accordion-dot dot-openai"></span>
                      <span class="accordion-title">OpenAI o1 (R2)</span>
                      <span id="status-r2-openai" class="accordion-status"></span>
                    </div>
                    <div class="accordion-header-right">
                      <span id="duration-r2-openai" class="accordion-duration"></span>
                      <svg class="accordion-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </div>
                  </button>
                  <div id="content-r2-openai" class="accordion-content">
                    <div class="accordion-content-inner">
                      <div class="markdown-content"></div>
                      <div class="accordion-content-actions">
                        <button type="button" class="copy-btn" data-copy="r2-openai"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg><span>Kopiera</span></button>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div id="accordion-r2-anthropic" class="accordion anthropic">
                  <button type="button" class="accordion-header">
                    <div class="accordion-header-left">
                      <span class="accordion-dot dot-anthropic"></span>
                      <span class="accordion-title">Claude (R2)</span>
                      <span id="status-r2-anthropic" class="accordion-status"></span>
                    </div>
                    <div class="accordion-header-right">
                      <span id="duration-r2-anthropic" class="accordion-duration"></span>
                      <svg class="accordion-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </div>
                  </button>
                  <div id="content-r2-anthropic" class="accordion-content">
                    <div class="accordion-content-inner">
                      <div class="markdown-content"></div>
                      <div class="accordion-content-actions">
                        <button type="button" class="copy-btn" data-copy="r2-anthropic"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg><span>Kopiera</span></button>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div id="accordion-r2-google" class="accordion google">
                  <button type="button" class="accordion-header">
                    <div class="accordion-header-left">
                      <span class="accordion-dot dot-google"></span>
                      <span class="accordion-title">Gemini (R2)</span>
                      <span id="status-r2-google" class="accordion-status"></span>
                    </div>
                    <div class="accordion-header-right">
                      <span id="duration-r2-google" class="accordion-duration"></span>
                      <svg class="accordion-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </div>
                  </button>
                  <div id="content-r2-google" class="accordion-content">
                    <div class="accordion-content-inner">
                      <div class="markdown-content"></div>
                      <div class="accordion-content-actions">
                        <button type="button" class="copy-btn" data-copy="r2-google"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg><span>Kopiera</span></button>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div id="accordion-r2-grok" class="accordion grok" style="display: none;">
                  <button type="button" class="accordion-header">
                    <div class="accordion-header-left">
                      <span class="accordion-dot dot-grok"></span>
                      <span class="accordion-title">Grok (R2)</span>
                      <span id="status-r2-grok" class="accordion-status"></span>
                    </div>
                    <div class="accordion-header-right">
                      <span id="duration-r2-grok" class="accordion-duration"></span>
                      <svg class="accordion-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </div>
                  </button>
                  <div id="content-r2-grok" class="accordion-content">
                    <div class="accordion-content-inner">
                      <div class="markdown-content"></div>
                      <div class="accordion-content-actions">
                        <button type="button" class="copy-btn" data-copy="r2-grok"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg><span>Kopiera</span></button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="total-stats">
            <div class="total-duration">Total tid: <span id="totalDuration">-</span></div>
            <div class="total-cost" id="totalCostContainer" style="display: none;">
              üí∞ Kostnad: <span id="totalCost">-</span>
              <span class="cost-details" id="costDetails"></span>
            </div>
          </div>
        </section>
      </main>
    </div>
    
    <!-- Notes sidebar -->
    <aside id="notesSidebar" class="notes-sidebar">
      <div class="notes-header">
        <div class="notes-header-title">
          <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
          Sessionslogg
        </div>
        <button type="button" class="notes-toggle" id="notesToggle" title="Minimera">
          <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" /></svg>
        </button>
      </div>
      <div class="notes-content">
        <div id="notesSync" class="notes-sync">Laddar...</div>
        <div id="notesList" class="notes-list">
          <div class="notes-empty">Inga sparade sessioner.</div>
        </div>
        <div class="notes-actions">
          <button type="button" class="notes-btn" id="exportNotes">üì• Export</button>
          <button type="button" class="notes-btn danger" id="clearNotes">üóëÔ∏è Rensa</button>
        </div>
      </div>
    </aside>
  </div>
  
  <!-- Save prompt modal (appears after synthesis) -->
  <div id="savePromptModal" class="save-prompt-modal">
    <div class="save-prompt-content">
      <div class="save-prompt-header">
        <span class="save-prompt-icon">üíæ</span>
        <div class="save-prompt-title">Spara session?</div>
        <div class="save-prompt-subtitle">Din AI Council-k√∂rning √§r klar!</div>
      </div>
      <div class="save-prompt-body">
        <div class="save-prompt-input-group">
          <label class="save-prompt-label">Ge sessionen ett namn (valfritt)</label>
          <input type="text" id="saveSessionName" class="save-prompt-input" placeholder="T.ex. 'Litteraturs√∂kning brosk' eller 'Arkitekturbeslut SMS'">
        </div>
        <div class="save-prompt-input-group">
          <label class="save-prompt-label">Prompt (f√∂rhandsgranskning)</label>
          <div id="savePromptPreview" class="save-prompt-preview"></div>
        </div>
        <label class="save-prompt-autosave">
          <input type="checkbox" id="enableAutoSave">
          <span class="save-prompt-autosave-check">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg>
          </span>
          <span class="save-prompt-autosave-text">Aktivera auto-spara (spara automatiskt efter varje k√∂rning)</span>
        </label>
      </div>
      <div class="save-prompt-footer">
        <button type="button" class="save-prompt-btn skip" id="skipSaveBtn">Hoppa √∂ver</button>
        <button type="button" class="save-prompt-btn save" id="confirmSaveBtn">üíæ Spara session</button>
      </div>
    </div>
  </div>

  <!-- Session modal -->
  <div id="sessionModal" class="session-modal">
    <div class="session-modal-content">
      <div class="session-modal-header">
        <div>
          <div class="session-modal-title">Sparad session</div>
          <div id="sessionModalMeta" class="session-modal-meta"></div>
        </div>
        <button type="button" class="session-modal-close" id="closeSessionModal">√ó</button>
      </div>
      <div class="session-modal-body">
        <div class="session-modal-prompt">
          <div class="session-modal-prompt-label">Prompt</div>
          <div id="sessionModalPrompt" class="session-modal-prompt-text"></div>
        </div>
        <div id="sessionModalSynthesis" class="session-modal-synthesis markdown-content"></div>
      </div>
      <div class="session-modal-footer">
        <button type="button" class="session-modal-btn" id="copySessionSynthesis">üìã Kopiera syntes</button>
        <button type="button" class="session-modal-btn" id="copySessionAll">üìÑ Kopiera allt</button>
        <button type="button" class="session-modal-btn" id="loadSessionPrompt">üí¨ Ladda prompt</button>
      </div>
    </div>
  </div>

  <script is:inline>
    document.addEventListener('DOMContentLoaded', function() {
      // Configure marked
      if (typeof marked !== 'undefined') {
        marked.setOptions({ breaks: true, gfm: true });
      }
      
      // State
      let currentResponses = { openai: '', anthropic: '', google: '', grok: '', synthesis: '' };
      let currentPrompt = '';
      let uploadedFiles = [];
      let sessions = [];
      let useSupabase = true;
      let availableModels = { openai: true, anthropic: true, gemini: true, grok: false };
      
      // Elements
      const contextEl = document.getElementById('context');
      const promptEl = document.getElementById('prompt');
      const runBtn = document.getElementById('runBtn');
      const statusEl = document.getElementById('status');
      const statusTextEl = document.getElementById('statusText');
      const errorEl = document.getElementById('error');
      const resultsEl = document.getElementById('results');
      const synthesisCard = document.getElementById('synthesisCard');
      const synthesisModelEl = document.getElementById('synthesisModel');
      const notesSidebar = document.getElementById('notesSidebar');
      const notesToggle = document.getElementById('notesToggle');
      const notesList = document.getElementById('notesList');
      const notesSync = document.getElementById('notesSync');
      const fileUploadArea = document.getElementById('fileUploadArea');
      const fileInput = document.getElementById('fileInput');
      const fileListEl = document.getElementById('fileList');
      const modelSelectionEl = document.getElementById('modelSelection');
      const deliberationToggle = document.getElementById('deliberationToggle');
      const enableDeliberationEl = document.getElementById('enableDeliberation');
      const round1Label = document.getElementById('round1Label');
      const round2Section = document.getElementById('round2Section');
      
      // Profile definitions
      const profiles = {
        snabb: {
          name: 'Snabb',
          // Only Gemini - fastest, avoids Netlify timeout (26s max on free plan)
          models: ['gemini'],
          synthesis: 'gemini',  // Gemini syntetiserar sig sj√§lv = snabbast
          deliberation: false
        },
        patient: {
          name: 'Patientfr√•gor',
          // Gemini + Claude - fast enough for 26s timeout
          models: ['gemini', 'anthropic'],
          synthesis: 'gpt4o',
          deliberation: false
        },
        kod: {
          name: 'Kodning',
          // Claude only - fast and good for code
          models: ['anthropic'],
          synthesis: 'claude',
          deliberation: false
        },
        vetenskap: {
          name: 'Vetenskap',
          // Warning: May timeout on free Netlify plan
          models: ['gemini', 'anthropic'],
          synthesis: 'claude',
          deliberation: false  // Deliberation causes timeout
        },
        djup: {
          name: 'Djup analys',
          // Warning: Will likely timeout on free Netlify plan
          // Requires Netlify Pro or local development
          models: ['anthropic', 'gemini'],
          synthesis: 'claude-opus',
          deliberation: false  // Deliberation causes timeout
        }
      };
      
      let currentProfile = 'snabb';
      
      // Profile selector
      const profileSelectorEl = document.getElementById('profileSelector');
      
      function applyProfile(profileId) {
        const profile = profiles[profileId];
        if (!profile) return;
        
        currentProfile = profileId;
        
        // Update profile buttons
        profileSelectorEl.querySelectorAll('.profile-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.profile === profileId);
        });
        
        // Update model checkboxes
        modelSelectionEl.querySelectorAll('.model-checkbox').forEach(cb => {
          const model = cb.dataset.model;
          const checkbox = cb.querySelector('input');
          const shouldSelect = profile.models.includes(model) && availableModels[model];
          
          checkbox.checked = shouldSelect;
          cb.classList.toggle('selected', shouldSelect);
        });
        
        // Update synthesis model
        synthesisModelEl.value = profile.synthesis;
        
        // Update deliberation
        enableDeliberationEl.checked = profile.deliberation;
        deliberationToggle.classList.toggle('active', profile.deliberation);
      }
      
      profileSelectorEl.addEventListener('click', (e) => {
        const btn = e.target.closest('.profile-btn');
        if (!btn) return;
        
        applyProfile(btn.dataset.profile);
      });
      
      // Deliberation toggle handler
      deliberationToggle.addEventListener('click', () => {
        enableDeliberationEl.checked = !enableDeliberationEl.checked;
        deliberationToggle.classList.toggle('active', enableDeliberationEl.checked);
        
        // Clear profile selection when manually changing
        profileSelectorEl.querySelectorAll('.profile-btn').forEach(btn => btn.classList.remove('active'));
      });
      
      // Model checkbox handlers
      function getSelectedModels() {
        return Array.from(modelSelectionEl.querySelectorAll('.model-checkbox.selected:not(.unavailable)'))
          .map(el => el.dataset.model);
      }
      
      function updateModelCheckboxes() {
        modelSelectionEl.querySelectorAll('.model-checkbox').forEach(cb => {
          const model = cb.dataset.model;
          const isAvailable = availableModels[model];
          const checkbox = cb.querySelector('input');
          
          if (!isAvailable) {
            cb.classList.add('unavailable');
            cb.classList.remove('selected');
            checkbox.checked = false;
            checkbox.disabled = true;
          } else {
            cb.classList.remove('unavailable');
            checkbox.disabled = false;
          }
        });
      }
      
      modelSelectionEl.querySelectorAll('.model-checkbox').forEach(cb => {
        cb.addEventListener('click', (e) => {
          if (cb.classList.contains('unavailable')) return;
          
          const checkbox = cb.querySelector('input');
          checkbox.checked = !checkbox.checked;
          cb.classList.toggle('selected', checkbox.checked);
          
          // Ensure at least one is selected
          if (getSelectedModels().length === 0) {
            checkbox.checked = true;
            cb.classList.add('selected');
          }
          
          // Clear profile selection when manually changing models
          profileSelectorEl.querySelectorAll('.profile-btn').forEach(btn => btn.classList.remove('active'));
        });
      });
      
      // Clear profile when synthesis model is manually changed
      synthesisModelEl.addEventListener('change', () => {
        profileSelectorEl.querySelectorAll('.profile-btn').forEach(btn => btn.classList.remove('active'));
      });
      
      // File upload handlers
      fileUploadArea.addEventListener('click', () => fileInput.click());
      fileUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); fileUploadArea.classList.add('dragover'); });
      fileUploadArea.addEventListener('dragleave', () => fileUploadArea.classList.remove('dragover'));
      fileUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
      });
      fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
      
      async function handleFiles(files) {
        for (const file of files) {
          const content = await extractFileContent(file);
          if (content) {
            uploadedFiles.push({ name: file.name, size: file.size, content });
            renderFileList();
          }
        }
      }
      
      async function extractFileContent(file) {
        const type = file.type;
        const name = file.name.toLowerCase();
        
        // Text files
        if (type.startsWith('text/') || ['.txt', '.md', '.json', '.js', '.ts', '.py', '.html', '.css'].some(ext => name.endsWith(ext))) {
          return await file.text();
        }
        
        // PDF
        if (type === 'application/pdf' || name.endsWith('.pdf')) {
          try {
            if (typeof pdfjsLib !== 'undefined') {
              pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
              const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
              let text = '';
              for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(' ') + '\n';
              }
              return text;
            }
          } catch (e) {
            console.error('PDF parse error:', e);
          }
          return '[PDF kunde inte l√§sas]';
        }
        
        // Images - convert to base64 description placeholder
        if (type.startsWith('image/')) {
          return `[Bild: ${file.name} (${formatSize(file.size)})]`;
        }
        
        return null;
      }
      
      function renderFileList() {
        if (uploadedFiles.length === 0) {
          fileListEl.innerHTML = '';
          return;
        }
        fileListEl.innerHTML = uploadedFiles.map((f, i) => 
          '<div class="file-item">' +
            '<span class="file-item-name">' + escapeHtml(f.name) + '</span>' +
            '<span class="file-item-size">' + formatSize(f.size) + '</span>' +
            '<button class="file-item-remove" data-index="' + i + '">‚úï</button>' +
          '</div>'
        ).join('');
        
        fileListEl.querySelectorAll('.file-item-remove').forEach(btn => {
          btn.addEventListener('click', () => {
            uploadedFiles.splice(parseInt(btn.dataset.index), 1);
            renderFileList();
          });
        });
      }
      
      function formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      }
      
      // Sessions management (Supabase with localStorage fallback)
      async function loadSessions() {
        notesSync.textContent = 'Laddar...';
        notesSync.className = 'notes-sync';
        
        try {
          const res = await fetch('/api/ai-council/sessions', { credentials: 'include' });
          const data = await res.json();
          
          if (data.sessions && data.sessions.length > 0) {
            sessions = data.sessions;
            useSupabase = true;
            notesSync.textContent = '‚òÅÔ∏è Synkad med Supabase';
            notesSync.className = 'notes-sync synced';
          } else if (data.error && data.error.includes('ej konfigurerat')) {
            // Fallback to localStorage
            useSupabase = false;
            sessions = JSON.parse(localStorage.getItem('ai-council-sessions') || '[]');
            notesSync.textContent = 'üíæ Lokal lagring';
          } else {
            sessions = data.sessions || [];
            useSupabase = true;
            notesSync.textContent = '‚òÅÔ∏è Supabase (tom)';
            notesSync.className = 'notes-sync synced';
          }
        } catch (e) {
          useSupabase = false;
          sessions = JSON.parse(localStorage.getItem('ai-council-sessions') || '[]');
          notesSync.textContent = 'üíæ Lokal lagring';
        }
        
        renderSessions();
      }
      
      async function saveSession(data) {
        if (useSupabase) {
          try {
            const res = await fetch('/api/ai-council/sessions', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(data)
            });
            const result = await res.json();
            if (result.success) {
              await loadSessions();
              return true;
            }
          } catch (e) {
            console.error('Save error:', e);
          }
        }
        
        // Fallback to localStorage
        const localSessions = JSON.parse(localStorage.getItem('ai-council-sessions') || '[]');
        localSessions.unshift({
          id: Date.now().toString(),
          name: data.name || null,
          prompt: data.prompt,
          synthesis: data.synthesis,
          synthesis_model: data.synthesisModel,
          created_at: new Date().toISOString()
        });
        localStorage.setItem('ai-council-sessions', JSON.stringify(localSessions.slice(0, 50)));
        sessions = localSessions;
        renderSessions();
        return true;
      }
      
      // Save prompt modal handlers
      const savePromptModal = document.getElementById('savePromptModal');
      const saveSessionNameInput = document.getElementById('saveSessionName');
      const savePromptPreview = document.getElementById('savePromptPreview');
      const enableAutoSaveCheckbox = document.getElementById('enableAutoSave');
      
      // Load auto-save preference from localStorage
      const autoSaveEnabled = localStorage.getItem('ai-council-autosave') === 'true';
      enableAutoSaveCheckbox.checked = autoSaveEnabled;
      
      enableAutoSaveCheckbox.addEventListener('change', () => {
        localStorage.setItem('ai-council-autosave', enableAutoSaveCheckbox.checked);
      });
      
      function showSavePromptModal() {
        saveSessionNameInput.value = '';
        savePromptPreview.textContent = currentPrompt ? currentPrompt.substring(0, 150) + (currentPrompt.length > 150 ? '...' : '') : '';
        savePromptModal.classList.add('open');
        saveSessionNameInput.focus();
      }
      
      function closeSavePromptModal() {
        savePromptModal.classList.remove('open');
      }
      
      async function saveCurrentSession(customName) {
        const name = customName || saveSessionNameInput.value.trim() || null;
        await saveSession({
          name: name,
          prompt: currentPrompt,
          context: contextEl.value,
          responses: currentResponses.rawResponses,
          synthesis: currentResponses.synthesis,
          synthesisModel: synthesisModelEl.value,
          totalDuration: currentResponses.totalDuration
        });
        closeSavePromptModal();
      }
      
      document.getElementById('confirmSaveBtn').addEventListener('click', () => saveCurrentSession());
      document.getElementById('skipSaveBtn').addEventListener('click', closeSavePromptModal);
      savePromptModal.addEventListener('click', (e) => { if (e.target === savePromptModal) closeSavePromptModal(); });
      document.addEventListener('keydown', (e) => { 
        if (savePromptModal.classList.contains('open')) {
          if (e.key === 'Escape') closeSavePromptModal();
          if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); saveCurrentSession(); }
        }
      });
      
      async function deleteSession(id) {
        if (useSupabase) {
          try {
            await fetch('/api/ai-council/sessions?id=' + id, { method: 'DELETE', credentials: 'include' });
            await loadSessions();
            return;
          } catch (e) {
            console.error('Delete error:', e);
          }
        }
        
        const localSessions = JSON.parse(localStorage.getItem('ai-council-sessions') || '[]');
        const filtered = localSessions.filter(s => s.id !== id);
        localStorage.setItem('ai-council-sessions', JSON.stringify(filtered));
        sessions = filtered;
        renderSessions();
      }
      
      function renderSessions() {
        if (sessions.length === 0) {
          notesList.innerHTML = '<div class="notes-empty">Inga sparade sessioner.</div>';
          return;
        }
        
        notesList.innerHTML = sessions.map(s => {
          const date = new Date(s.created_at);
          const timeStr = date.toLocaleString('sv-SE', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
          const preview = (s.synthesis || '').substring(0, 80).replace(/[#*`]/g, '');
          const modelLabel = { claude: 'üîß Claude', openai: 'üß™ OpenAI', gemini: 'üìö Gemini' }[s.synthesis_model] || s.synthesis_model;
          const hasName = s.name && s.name.trim();
          
          return '<div class="note-item" data-id="' + s.id + '">' +
            '<div class="note-item-header">' +
              '<span class="note-item-time">' + timeStr + '</span>' +
              '<div class="note-item-actions">' +
                '<button class="note-item-btn" data-action="view" title="Visa">üëÅÔ∏è</button>' +
                '<button class="note-item-btn" data-action="copy" title="Kopiera">üìã</button>' +
                '<button class="note-item-btn" data-action="delete" title="Ta bort">‚úï</button>' +
              '</div>' +
            '</div>' +
            (hasName ? '<div class="note-item-name">' + escapeHtml(s.name) + '</div>' : '') +
            '<div class="note-item-prompt">' + escapeHtml(s.prompt) + '</div>' +
            '<div class="note-item-preview">' + escapeHtml(preview) + '...</div>' +
            '<div class="note-item-model">' + modelLabel + '</div>' +
          '</div>';
        }).join('');
        
        notesList.querySelectorAll('.note-item-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = btn.closest('.note-item').dataset.id;
            const action = btn.dataset.action;
            
            if (action === 'delete') deleteSession(id);
            else if (action === 'copy') {
              const session = sessions.find(s => s.id === id);
              if (session) copyToClipboard(session.synthesis, btn);
            }
            else if (action === 'view') {
              const session = sessions.find(s => s.id === id);
              if (session) openSessionModal(session);
            }
          });
        });
        
        notesList.querySelectorAll('.note-item').forEach(item => {
          item.addEventListener('click', () => {
            const session = sessions.find(s => s.id === item.dataset.id);
            if (session) openSessionModal(session);
          });
        });
      }
      
      // Session modal
      let currentModalSession = null;
      const sessionModal = document.getElementById('sessionModal');
      const sessionModalPrompt = document.getElementById('sessionModalPrompt');
      const sessionModalSynthesis = document.getElementById('sessionModalSynthesis');
      const sessionModalMeta = document.getElementById('sessionModalMeta');
      
      function openSessionModal(session) {
        currentModalSession = session;
        const date = new Date(session.created_at);
        const modelLabel = { claude: 'üîß Claude', openai: 'üß™ OpenAI', gemini: 'üìö Gemini' }[session.synthesis_model] || session.synthesis_model;
        
        sessionModalMeta.textContent = date.toLocaleString('sv-SE') + ' ‚Ä¢ ' + modelLabel;
        sessionModalPrompt.textContent = session.prompt;
        sessionModalSynthesis.innerHTML = renderMarkdown(session.synthesis);
        sessionModal.classList.add('open');
      }
      
      function closeSessionModal() {
        sessionModal.classList.remove('open');
        currentModalSession = null;
      }
      
      document.getElementById('closeSessionModal').addEventListener('click', closeSessionModal);
      sessionModal.addEventListener('click', (e) => { if (e.target === sessionModal) closeSessionModal(); });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && sessionModal.classList.contains('open')) closeSessionModal(); });
      
      document.getElementById('copySessionSynthesis').addEventListener('click', () => {
        if (currentModalSession) {
          navigator.clipboard.writeText(currentModalSession.synthesis);
          alert('Syntes kopierad!');
        }
      });
      
      document.getElementById('copySessionAll').addEventListener('click', () => {
        if (currentModalSession) {
          const text = '## Prompt\n\n' + currentModalSession.prompt + '\n\n## Syntes\n\n' + currentModalSession.synthesis;
          navigator.clipboard.writeText(text);
          alert('Prompt + syntes kopierat!');
        }
      });
      
      document.getElementById('loadSessionPrompt').addEventListener('click', () => {
        if (currentModalSession) {
          promptEl.value = currentModalSession.prompt;
          closeSessionModal();
          promptEl.focus();
        }
      });
      
      function escapeHtml(str) {
        return (str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      }
      
      // Initialize sessions
      loadSessions();
      
      // Toggle sidebar
      notesToggle.addEventListener('click', () => notesSidebar.classList.toggle('collapsed'));
      
      // Export
      document.getElementById('exportNotes').addEventListener('click', () => {
        if (sessions.length === 0) { alert('Inga sessioner att exportera.'); return; }
        
        let md = '# AI Council Sessioner\n\nExporterad: ' + new Date().toLocaleString('sv-SE') + '\n\n---\n\n';
        sessions.forEach(s => {
          md += '## ' + new Date(s.created_at).toLocaleString('sv-SE') + '\n\n';
          md += '**Prompt:** ' + s.prompt + '\n\n';
          md += '**Syntes-modell:** ' + s.synthesis_model + '\n\n';
          md += s.synthesis + '\n\n---\n\n';
        });
        
        const blob = new Blob([md], { type: 'text/markdown' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'ai-council-' + new Date().toISOString().split('T')[0] + '.md';
        a.click();
      });
      
      // Clear
      document.getElementById('clearNotes').addEventListener('click', async () => {
        if (!confirm('Rensa alla sessioner?')) return;
        
        if (useSupabase) {
          for (const s of sessions) {
            await fetch('/api/ai-council/sessions?id=' + s.id, { method: 'DELETE', credentials: 'include' });
          }
        }
        localStorage.removeItem('ai-council-sessions');
        sessions = [];
        renderSessions();
      });
      
      // Accordion toggles
      document.querySelectorAll('.accordion-header').forEach(btn => {
        btn.addEventListener('click', () => btn.closest('.accordion').classList.toggle('open'));
      });
      
      // Copy
      function copyToClipboard(text, btn) {
        navigator.clipboard.writeText(text).then(() => {
          const span = btn.querySelector('span');
          const orig = span ? span.textContent : '';
          btn.classList.add('copied');
          if (span) span.textContent = '‚úì';
          setTimeout(() => { btn.classList.remove('copied'); if (span) span.textContent = orig; }, 2000);
        });
      }
      
      document.querySelectorAll('.copy-btn[data-copy]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const text = currentResponses[btn.dataset.copy];
          if (text) copyToClipboard(text, btn);
        });
      });
      
      document.getElementById('copySynthesis').addEventListener('click', function() {
        if (currentResponses.synthesis) copyToClipboard(currentResponses.synthesis, this);
      });
      
      // Export as Markdown
      document.getElementById('exportMarkdown').addEventListener('click', function() {
        if (!currentResponses.synthesis || !currentPrompt) {
          alert('Ingen session att exportera.');
          return;
        }
        
        const now = new Date();
        const dateStr = now.toLocaleString('sv-SE');
        const fileDate = now.toISOString().split('T')[0];
        
        // Get current profile name
        const profileSelect = document.getElementById('profileSelect');
        const profileName = profileSelect.options[profileSelect.selectedIndex].text;
        
        // Get synthesis model name
        const synthLabel = document.getElementById('synthesisModelLabel').textContent;
        
        // Get which models were used
        const usedModels = [];
        ['openai', 'anthropic', 'google', 'xai'].forEach(provider => {
          const checkbox = document.querySelector(`input[value="${provider}"]`);
          if (checkbox && checkbox.checked) {
            const label = { openai: 'OpenAI o1', anthropic: 'Claude Sonnet', google: 'Gemini 2.0 Flash', xai: 'Grok 4' }[provider];
            usedModels.push(label);
          }
        });
        
        // Get deliberation status
        const deliberationEnabled = document.getElementById('enableDeliberation').checked;
        
        // Get cost info
        const costBanner = document.getElementById('costBannerAmount');
        const costSek = document.getElementById('costBannerSek');
        const costInfo = costBanner ? `${costBanner.textContent} ${costSek ? costSek.textContent : ''}` : 'N/A';
        
        // Get duration
        const totalDuration = document.getElementById('totalDuration').textContent || 'N/A';
        
        // Build markdown
        let md = `# AI Council Session\n\n`;
        md += `**Datum:** ${dateStr}\n`;
        md += `**Profil:** ${profileName}\n`;
        md += `**Modeller:** ${usedModels.join(', ')}\n`;
        md += `**Syntesmodell:** ${synthLabel}\n`;
        md += `**Deliberation:** ${deliberationEnabled ? 'Ja (Runda 2)' : 'Nej'}\n`;
        md += `**Kostnad:** ${costInfo}\n`;
        md += `**Total tid:** ${totalDuration}\n\n`;
        
        md += `---\n\n`;
        
        md += `## Fr√•gest√§llning\n\n${currentPrompt}\n\n`;
        
        // Add context if provided
        const context = document.getElementById('context').value;
        if (context && context.trim()) {
          md += `## Kontext\n\n${context.trim()}\n\n`;
        }
        
        // Add hallucination report if present
        const hallucinationReport = document.getElementById('hallucinationReport');
        if (hallucinationReport && hallucinationReport.style.display !== 'none' && deliberationEnabled) {
          const status = document.getElementById('hallucinationStatus').textContent;
          const highCount = document.querySelector('#hallucinationHigh .count-num')?.textContent || '0';
          const medCount = document.querySelector('#hallucinationMedium .count-num')?.textContent || '0';
          const lowCount = document.querySelector('#hallucinationLow .count-num')?.textContent || '0';
          
          md += `## Trov√§rdighetsrapport\n\n`;
          md += `**Status:** ${status}\n\n`;
          md += `| S√§kerhet | Antal |\n`;
          md += `|----------|-------|\n`;
          md += `| üî¥ H√∂g | ${highCount} |\n`;
          md += `| üü° Medium | ${medCount} |\n`;
          md += `| ‚ö™ L√•g | ${lowCount} |\n\n`;
        }
        
        md += `---\n\n`;
        
        // Add synthesis
        const synthType = deliberationEnabled ? 'SUPERSYNTES' : 'Syntes';
        md += `## ${synthType}\n\n${currentResponses.synthesis}\n\n`;
        
        md += `---\n\n`;
        
        // Add individual responses
        md += `## Individuella svar\n\n`;
        
        const modelNames = {
          openai: 'OpenAI o1',
          anthropic: 'Claude Sonnet',
          google: 'Gemini 2.0 Flash',
          grok: 'Grok 4'
        };
        
        ['openai', 'anthropic', 'google', 'grok'].forEach(provider => {
          if (currentResponses[provider]) {
            md += `### ${modelNames[provider]}\n\n`;
            md += `${currentResponses[provider]}\n\n`;
          }
        });
        
        // Add deliberation responses if present (stored as 'r2-provider')
        if (deliberationEnabled) {
          const r2Keys = { openai: 'r2-openai', anthropic: 'r2-anthropic', google: 'r2-google', grok: 'r2-grok' };
          const hasDeliberation = Object.values(r2Keys).some(k => currentResponses[k]);
          if (hasDeliberation) {
            md += `---\n\n`;
            md += `## Deliberation (Runda 2)\n\n`;
            Object.entries(r2Keys).forEach(([provider, r2Key]) => {
              if (currentResponses[r2Key]) {
                md += `### ${modelNames[provider]} - Granskning\n\n`;
                md += `${currentResponses[r2Key]}\n\n`;
              }
            });
          }
        }
        
        md += `---\n\n*Exporterad fr√•n AI Council v2.6*\n`;
        
        // Create and download file
        const blob = new Blob([md], { type: 'text/markdown' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `ai-council-${fileDate}.md`;
        a.click();
        URL.revokeObjectURL(a.href);
      });
      
      document.getElementById('saveSynthesis').addEventListener('click', async function() {
        if (!currentResponses.synthesis || !currentPrompt) return;
        
        const btn = this;
        btn.disabled = true;
        
        await saveSession({
          prompt: currentPrompt,
          context: contextEl.value,
          responses: currentResponses.rawResponses,
          synthesis: currentResponses.synthesis,
          synthesisModel: synthesisModelEl.value,
          totalDuration: currentResponses.totalDuration
        });
        
        btn.classList.add('saved');
        btn.querySelector('span').textContent = 'Sparat!';
        setTimeout(() => { btn.classList.remove('saved'); btn.querySelector('span').textContent = 'Spara'; btn.disabled = false; }, 2000);
      });
      
      // Helpers
      function formatDuration(ms) { return ms < 1000 ? ms + 'ms' : (ms / 1000).toFixed(1) + 's'; }
      function renderMarkdown(content) { return typeof marked !== 'undefined' && marked.parse ? marked.parse(content || '') : '<p>' + (content || '').replace(/\n/g, '<br>') + '</p>'; }
      function setStatus(text, show) { statusEl.classList.toggle('visible', show); statusTextEl.textContent = text; }
      function showError(text) { errorEl.classList.add('visible'); errorEl.textContent = text; }
      function hideError() { errorEl.classList.remove('visible'); }
      function setLoading(loading) { runBtn.disabled = loading; runBtn.classList.toggle('loading', loading); }
      
      function displayResponse(provider, data) {
        const statusEl = document.getElementById('status-' + provider);
        const durationEl = document.getElementById('duration-' + provider);
        const contentEl = document.getElementById('content-' + provider);
        const markdownEl = contentEl.querySelector('.markdown-content');
        const accordionEl = document.getElementById('accordion-' + provider);
        const titleEl = accordionEl?.querySelector('.accordion-title');
        
        currentResponses[provider] = data.response || '';
        
        // Update accordion title with actual model name from response
        if (titleEl && data.model) {
          const modelDisplayNames = {
            'o1': 'OpenAI o1',
            'gpt-4o': 'GPT-4o',
            'claude-sonnet-4-20250514': 'Claude Sonnet 4',
            'claude-opus-4-5-20250514': 'Claude Opus 4.5',
            'gemini-2.0-flash': 'Gemini 2.0 Flash',
            'grok-4': 'Grok 4',
            'grok-2-latest': 'Grok 2',
          };
          titleEl.textContent = modelDisplayNames[data.model] || data.model;
        }
        
        if (data.error) {
          statusEl.textContent = '‚ùå';
          statusEl.classList.add('error');
          markdownEl.innerHTML = '<p style="color:#f87171;">' + data.error + '</p>';
        } else {
          statusEl.textContent = '‚úì';
          statusEl.classList.add('success');
          markdownEl.innerHTML = renderMarkdown(data.response);
        }
        
        // Display duration and cost
        let durationText = formatDuration(data.duration);
        if (data.cost && data.cost.totalCost > 0) {
          durationText += ` ¬∑ $${data.cost.totalCost.toFixed(4)}`;
        }
        durationEl.textContent = durationText;
      }
      
      // Run query
      async function runQuery() {
        const context = contextEl.value.trim();
        const prompt = promptEl.value.trim();
        const synthesisModel = synthesisModelEl.value;
        const selectedModels = getSelectedModels();
        const enableDeliberation = enableDeliberationEl.checked;
        
        if (!prompt) { showError('Ange en prompt.'); return; }
        if (selectedModels.length === 0) { showError('V√§lj minst en AI-modell.'); return; }
        if (enableDeliberation && selectedModels.length < 2) {
          showError('Deliberation kr√§ver minst 2 valda modeller.');
          return;
        }
        
        currentPrompt = prompt;
        hideError();
        setLoading(true);
        
        const modelNames = selectedModels.map(m => ({ openai: 'OpenAI', anthropic: 'Claude', gemini: 'Gemini', grok: 'Grok' }[m])).join(', ');
        setStatus('Runda 1: Skickar till ' + modelNames + '...', true);
        
        resultsEl.classList.remove('visible');
        synthesisCard.style.display = 'none';
        round2Section.style.display = 'none';
        round1Label.style.display = enableDeliberation ? 'block' : 'none';
        document.getElementById('costBanner').classList.remove('visible');
        
        // Reset hallucination report
        document.getElementById('hallucinationReport').style.display = 'none';
        document.getElementById('hallucinationList').innerHTML = '';
        document.getElementById('hallucinationList').style.display = 'none';
        
        currentResponses = { openai: '', anthropic: '', google: '', grok: '', 'r2-openai': '', 'r2-anthropic': '', 'r2-google': '', 'r2-grok': '', synthesis: '', rawResponses: [], totalDuration: 0 };
        
        // Hide/show Round 1 accordions based on selection
        ['openai', 'anthropic', 'google', 'grok'].forEach(p => {
          const accordion = document.getElementById('accordion-' + p);
          const r2Accordion = document.getElementById('accordion-r2-' + p);
          if (accordion) {
            const providerToModel = { openai: 'openai', anthropic: 'anthropic', google: 'gemini', grok: 'grok' };
            const isSelected = selectedModels.includes(providerToModel[p]);
            accordion.style.display = isSelected ? 'block' : 'none';
            if (r2Accordion) r2Accordion.style.display = isSelected ? 'block' : 'none';
            if (isSelected) {
              document.getElementById('status-' + p).textContent = '';
              document.getElementById('status-' + p).className = 'accordion-status';
              document.getElementById('duration-' + p).textContent = '';
              document.getElementById('content-' + p).querySelector('.markdown-content').innerHTML = '';
              accordion.classList.remove('open');
              // Clear R2 as well
              if (r2Accordion) {
                const r2Status = document.getElementById('status-r2-' + p);
                const r2Duration = document.getElementById('duration-r2-' + p);
                const r2Content = document.getElementById('content-r2-' + p);
                if (r2Status) { r2Status.textContent = ''; r2Status.className = 'accordion-status'; }
                if (r2Duration) r2Duration.textContent = '';
                if (r2Content) r2Content.querySelector('.markdown-content').innerHTML = '';
                r2Accordion.classList.remove('open');
              }
            }
          }
        });
        
        // Combine file content
        const fileContent = uploadedFiles.map(f => '### ' + f.name + '\n' + f.content).join('\n\n---\n\n');
        
        // Map profile IDs to API profileType values
        const profileTypeMap = {
          snabb: 'fast',
          patient: 'patient', 
          kod: 'coding',
          vetenskap: 'science',
          djup: 'deep'
        };
        const profileType = profileTypeMap[currentProfile] || 'fast';
        
        try {
          const response = await fetch('/api/ai-council/query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ context, prompt, synthesisModel, fileContent, selectedModels, enableDeliberation, profileType })
          });
          
          // Check if response is JSON before parsing
          const contentType = response.headers.get('content-type') || '';
          const responseText = await response.text();
          
          // Debug: Log the first 500 chars if it looks like HTML
          if (responseText.startsWith('<')) {
            console.error('API returned HTML instead of JSON:', responseText.substring(0, 500));
            console.error('Response status:', response.status, response.statusText);
            console.error('Response URL:', response.url);
            
            // Try to extract useful info from HTML
            let errorDetail = 'Ok√§nt fel';
            if (responseText.includes('Not Found') || responseText.includes('404')) {
              errorDetail = 'API-endpoint hittades inte (404). Kolla att sidan √§r deployad korrekt p√• Netlify.';
            } else if (responseText.includes('Unauthorized') || responseText.includes('401')) {
              errorDetail = 'Ej beh√∂rig (401). Du kanske beh√∂ver logga in igen.';
            } else if (responseText.includes('Internal Server Error') || responseText.includes('500')) {
              errorDetail = 'Serverfel (500). Kolla Netlify-loggarna f√∂r mer info.';
            } else if (responseText.includes('<!DOCTYPE') || responseText.includes('<html')) {
              errorDetail = 'Server returnerade en HTML-sida ist√§llet f√∂r JSON. URL: ' + response.url;
            }
            
            throw new Error(errorDetail);
          }
          
          let data;
          try {
            data = JSON.parse(responseText);
          } catch (parseError) {
            console.error('Failed to parse JSON:', responseText.substring(0, 500));
            throw new Error('Kunde inte tolka API-svar som JSON: ' + responseText.substring(0, 100) + '...');
          }
          
          if (!response.ok) throw new Error(data.error || 'N√•got gick fel');
          
          // Update available models from API response
          if (data.availableModels) {
            data.availableModels.forEach(m => { availableModels[m.model] = m.available; });
            updateModelCheckboxes();
          }
          
          resultsEl.classList.add('visible');
          currentResponses.rawResponses = data.responses;
          currentResponses.totalDuration = data.totalDuration;
          
          // Display Round 1 responses
          const providerMap = { 'OpenAI': 'openai', 'Anthropic': 'anthropic', 'Google': 'google', 'xAI': 'grok' };
          data.responses.forEach(r => { const key = providerMap[r.provider]; if (key) displayResponse(key, r); });
          
          // Display Round 2 responses if deliberation was enabled
          if (data.deliberationEnabled && data.round2Responses) {
            setStatus('Runda 2: Modellerna granskar varandra...', true);
            round2Section.style.display = 'block';
            
            data.round2Responses.forEach(r => {
              const key = providerMap[r.provider];
              if (key) {
                displayResponse('r2-' + key, r);
              }
            });
          }
          
          const synthLabel = { 
            claude: 'Claude Sonnet', 
            'claude-opus': 'Claude Opus 4.5', 
            openai: 'OpenAI o1', 
            gpt4o: 'GPT-4o',
            gemini: 'Gemini', 
            grok: 'Grok' 
          }[data.synthesisModel || synthesisModel];
          const synthType = data.deliberationEnabled ? 'Supersyntes' : 'Syntes';
          setStatus(synthType + ' med ' + synthLabel + '...', true);
          
          if (data.synthesis) {
            currentResponses.synthesis = data.synthesis.response || '';
            synthesisCard.style.display = 'block';
            
            let synthDuration = formatDuration(data.synthesis.duration);
            if (data.synthesis.cost && data.synthesis.cost.totalCost > 0) {
              synthDuration += ` ¬∑ $${data.synthesis.cost.totalCost.toFixed(4)}`;
            }
            document.getElementById('synthesisDuration').textContent = synthDuration;
            document.getElementById('synthesisContent').innerHTML = renderMarkdown(data.synthesis.response);
            document.getElementById('synthesisModelLabel').textContent = data.synthesis.provider;
          }
          
          document.getElementById('totalDuration').textContent = formatDuration(data.totalDuration);
          
          // Display cost information (banner at top + details at bottom)
          if (data.totalCost && data.totalCost.totalCostUSD > 0) {
            const costContainer = document.getElementById('totalCostContainer');
            const costEl = document.getElementById('totalCost');
            const detailsEl = document.getElementById('costDetails');
            
            const usdCost = data.totalCost.totalCostUSD;
            const sekCost = usdCost * 10.5; // Approximate USD to SEK
            
            costEl.textContent = `$${usdCost.toFixed(4)} (~${sekCost.toFixed(2)} kr)`;
            detailsEl.textContent = `${data.totalCost.inputTokens.toLocaleString()} in / ${data.totalCost.outputTokens.toLocaleString()} ut tokens`;
            costContainer.style.display = 'block';
            
            // Update cost banner at top
            const costBanner = document.getElementById('costBanner');
            document.getElementById('costBannerAmount').textContent = `$${usdCost.toFixed(4)}`;
            document.getElementById('costBannerSek').textContent = `(~${sekCost.toFixed(2)} kr)`;
            document.getElementById('costBannerTime').textContent = formatDuration(data.totalDuration);
            document.getElementById('costBannerTokensIn').textContent = data.totalCost.inputTokens.toLocaleString();
            document.getElementById('costBannerTokensOut').textContent = data.totalCost.outputTokens.toLocaleString();
            costBanner.classList.add('visible');
          }
          
          // Display hallucination report (only if deliberation was enabled)
          const hallucinationReport = document.getElementById('hallucinationReport');
          if (data.hallucinationReport && data.deliberationEnabled) {
            const report = data.hallucinationReport;
            hallucinationReport.style.display = 'block';
            
            // Update counts
            const highEl = document.getElementById('hallucinationHigh');
            const mediumEl = document.getElementById('hallucinationMedium');
            const lowEl = document.getElementById('hallucinationLow');
            const statusEl = document.getElementById('hallucinationStatus');
            
            if (report.high > 0) {
              highEl.style.display = 'flex';
              highEl.querySelector('.count-num').textContent = report.high;
            } else {
              highEl.style.display = 'none';
            }
            
            if (report.medium > 0) {
              mediumEl.style.display = 'flex';
              mediumEl.querySelector('.count-num').textContent = report.medium;
            } else {
              mediumEl.style.display = 'none';
            }
            
            if (report.low > 0) {
              lowEl.style.display = 'flex';
              lowEl.querySelector('.count-num').textContent = report.low;
            } else {
              lowEl.style.display = 'none';
            }
            
            // Update status message and styling
            if (report.high > 0) {
              statusEl.className = 'hallucination-status hallucination-status-danger';
              statusEl.innerHTML = '<span class="status-icon">üî¥</span><span class="status-text">' + report.high + ' s√§kra fel uppt√§ckta</span>';
              hallucinationReport.className = 'hallucination-report has-high';
            } else if (report.medium > 0) {
              statusEl.className = 'hallucination-status hallucination-status-warning';
              statusEl.innerHTML = '<span class="status-icon">üü†</span><span class="status-text">' + report.medium + ' troliga fel uppt√§ckta</span>';
              hallucinationReport.className = 'hallucination-report has-issues';
            } else if (report.low > 0) {
              statusEl.className = 'hallucination-status hallucination-status-warning';
              statusEl.innerHTML = '<span class="status-icon">üü°</span><span class="status-text">' + report.low + ' misst√§nkta p√•st√•enden</span>';
              hallucinationReport.className = 'hallucination-report has-issues';
            } else {
              statusEl.className = 'hallucination-status hallucination-status-good';
              statusEl.innerHTML = '<span class="status-icon">‚úÖ</span><span class="status-text">Inga uppenbara fel uppt√§ckta</span>';
              hallucinationReport.className = 'hallucination-report';
            }
            
            // Show details toggle if there are items
            const detailsSection = document.getElementById('hallucinationDetails');
            const listEl = document.getElementById('hallucinationList');
            if (report.items && report.items.length > 0) {
              detailsSection.style.display = 'block';
              listEl.innerHTML = report.items.map(item => {
                const confidenceClass = item.confidence;
                const badge = item.confidence === 'high' ? 'üî¥' : item.confidence === 'medium' ? 'üü†' : 'üü°';
                return `
                  <div class="hallucination-item ${confidenceClass}">
                    <div class="hallucination-item-header">
                      <span>${badge}</span>
                      <span style="color: #fff; font-weight: 500;">Flaggad av ${item.flaggedBy}</span>
                    </div>
                    <div class="hallucination-item-claim">"${item.claim}"</div>
                    <div class="hallucination-item-meta">
                      <span>K√§lla: ${item.source}</span>
                      <span>Anledning: ${item.reason}</span>
                    </div>
                  </div>
                `;
              }).join('');
            } else {
              detailsSection.style.display = 'none';
            }
          } else {
            hallucinationReport.style.display = 'none';
          }
          
          setStatus('', false);
          
          // Show save prompt or auto-save
          if (currentResponses.synthesis) {
            if (localStorage.getItem('ai-council-autosave') === 'true') {
              // Auto-save with timestamp as name
              await saveCurrentSession('Auto: ' + new Date().toLocaleString('sv-SE'));
            } else {
              // Show save prompt modal
              setTimeout(() => showSavePromptModal(), 500);
            }
          }
        } catch (error) {
          showError(error.message);
          setStatus('', false);
        } finally {
          setLoading(false);
        }
      }
      
      runBtn.addEventListener('click', runQuery);
      document.addEventListener('keydown', (e) => { if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') runQuery(); });
      
      // Hallucination details toggle
      document.getElementById('toggleHallucinationDetails').addEventListener('click', function() {
        const listEl = document.getElementById('hallucinationList');
        const isVisible = listEl.style.display !== 'none';
        listEl.style.display = isVisible ? 'none' : 'block';
        this.querySelector('span').textContent = isVisible ? '‚ñº Visa detaljer' : '‚ñ≤ D√∂lj detaljer';
      });
    });
  </script>
</body>
</html>
