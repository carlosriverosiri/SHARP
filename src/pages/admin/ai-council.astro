---
/**
 * AI Council - Master Mind Tool
 * URL: /admin/ai-council
 * 
 * Features:
 * - Multi-model queries (OpenAI, Anthropic, Google)
 * - Selectable synthesis model
 * - File upload (images, documents)
 * - Supabase session storage with localStorage fallback
 */

export const prerender = false;

import { arInloggad, hamtaAnvandare } from '../../lib/auth';
import QuickPrompt from '../../components/QuickPrompt.astro';
import HistorySidebar from '../../components/ai-council/HistorySidebar.astro';
import PromptPanel from '../../components/ai-council/PromptPanel.astro';
import ResultsPanel from '../../components/ai-council/ResultsPanel.astro';
import ZoteroModals from '../../components/ai-council/ZoteroModals.astro';
import OverlayModals from '../../components/ai-council/OverlayModals.astro';
import '../../styles/ai-council.css';
import '../../styles/ai-council-page.css';

// Check authentication
if (!await arInloggad(Astro.cookies)) {
  return Astro.redirect('/personal');
}

const anvandare = await hamtaAnvandare(Astro.cookies);
if (!anvandare) {
  return Astro.redirect('/personal');
}
---

<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>AI Council | Master Mind</title>
  <link rel="icon" type="image/x-icon" href="/favicons/favicon.ico">
  
  <!-- Highlight.js for code syntax -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  
  <!-- Marked.js for Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <!-- PDF.js for PDF parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  
  
</head>
<body>
  <!-- Logout banner - shown when session expires -->
  <div id="logoutBanner" class="logout-banner">
    <span class="logout-banner-icon">‚ö†Ô∏è</span>
    <span class="logout-banner-text">Din session har g√•tt ut. Logga in igen f√∂r att forts√§tta.</span>
    <button class="logout-banner-btn" onclick="window.location.href='/personal'">Logga in</button>
    <button class="logout-banner-dismiss" onclick="dismissLogoutBanner()" title="St√§ng">√ó</button>
  </div>
  
  <div class="layout">
    <!-- Project Sidebar (Left) -->
    <aside class="project-sidebar" id="projectSidebar">
      <div class="project-sidebar-header">
        <span class="project-sidebar-logo">AI Council</span>
      </div>
      
      <!-- Zotero - h√∂gst upp -->
      <div class="sidebar-tools">
        <button class="sidebar-tool-btn zotero-btn" id="zoteroOpenBtn" title="√ñppna Zotero-bibliotek">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
          <span>Zotero</span>
          <span class="zotero-status-badge" id="zoteroStatus">‚Äî</span>
        </button>
      </div>
      
      <div class="project-sidebar-actions">
        <a href="/admin/kunskapsbas" class="project-action-btn" title="Projekt√∂versikt" style="text-decoration: none;">
          üìÅ Projekt
        </a>
      </div>
      
      <!-- Prompt library -->
      <div class="prompt-library-section">
        <div class="prompt-library-header">
          <div class="prompt-library-title">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
            Promptbibliotek
          </div>
          <button type="button" class="prompt-library-add-btn" id="addPromptBtn" title="L√§gg till prompt">+</button>
        </div>
        <div class="prompt-library-list" id="promptLibraryList">
          <!-- Prompter laddas dynamiskt -->
        </div>
      </div>
      
      <!-- Context library -->
      <div class="prompt-library-section context-library-section">
        <div class="prompt-library-header">
          <div class="prompt-library-title">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
            Kontextbibliotek
          </div>
          <button type="button" class="prompt-library-add-btn" id="addContextBtn" title="Spara kontext">+</button>
        </div>
        <div class="prompt-library-list" id="contextLibraryList">
          <!-- Kontexter laddas dynamiskt -->
        </div>
      </div>
      
      <div class="project-section">
        <div class="project-section-header">
          <div class="project-section-title"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-inline"><line x1="12" y1="17" x2="12" y2="22"></line><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.89A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.89A2 2 0 0 0 5 15.24z"></path></svg>Projekt</div>
          <a href="/admin/kunskapsbas" class="project-section-btn">Projekt√∂versikt</a>
        </div>
      </div>
      
      <div class="project-list" id="projectList">
        <!-- Projekten laddas dynamiskt -->
      </div>
      
      <!-- Session accordions -->
      <div class="session-accordions">
        <!-- Osorterade sessioner -->
        <div class="session-accordion" id="unsortedAccordion">
          <button class="session-accordion-header">
            <span class="session-accordion-header-left">
              <span class="session-accordion-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg></span>
              <span class="session-accordion-title">Osorterade</span>
            </span>
            <span class="session-accordion-count" id="unsortedCount">0</span>
            <svg class="session-accordion-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="session-accordion-content" id="unsortedList">
            <!-- Osorterade sessioner laddas dynamiskt -->
          </div>
        </div>
        
        <!-- Alla sessioner -->
        <div class="session-accordion" id="allSessionsAccordion">
          <button class="session-accordion-header">
            <span class="session-accordion-header-left">
              <span class="session-accordion-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg></span>
              <span class="session-accordion-title">Alla sessioner</span>
            </span>
            <span class="session-accordion-count" id="allSessionsCount">0</span>
            <svg class="session-accordion-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="session-accordion-content" id="allSessionsList">
            <!-- Alla sessioner laddas dynamiskt -->
          </div>
        </div>
      </div>
    </aside>
    
    <ZoteroModals />
    
    <div class="main-area">
      <header class="header">
        <div class="header-inner">
          <div class="header-left">
            <button class="mobile-menu-btn" id="mobileMenuBtn" title="Visa projekt">
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            </button>
            <a href="/personal/oversikt" class="back-link">‚Üê Tillbaka</a>
            <div class="logo">
              <h1>AI Council</h1>
              <span>Master Mind Tool</span>
            </div>
          </div>
          <div class="header-right">
            <a href="/admin/ai-council/profil" class="profile-link" title="Redigera din AI-profil">
              üë§ Min profil
            </a>
            <span class="user-email">{anvandare.email}</span>
            <div class="model-dots" title="Prissorterad: billigast ‚Üí dyrast">
              <span class="model-dot dot-google" title="Gemini 2.0 Flash (~$0.10/1M)"></span>
              <span class="model-dot dot-anthropic" title="Claude Sonnet (~$3/1M)"></span>
              <span class="model-dot dot-grok" title="Grok 4 (~$5/1M)"></span>
              <span class="model-dot dot-openai" title="OpenAI GPT-5.2 (~$1.75/1M)"></span>
            </div>
          </div>
        </div>
      </header>

      <main class="main">
        <PromptPanel />
        
        <ResultsPanel />
      </main>
    </div>
    
    <HistorySidebar />
  </div>
  
  <OverlayModals />

  <script>
    import { initUiHelpers, initFieldActions } from '../../lib/ai-council/ui-helpers.ts';
    import { initPromptTools } from '../../lib/ai-council/prompt-tools.ts';
    import { initProjectSidebarState } from '../../lib/ai-council/project-sidebar-state.ts';
    import { initProjectSelectionStorage } from '../../lib/ai-council/project-selection-storage.ts';
    import { initStatusNotifications } from '../../lib/ai-council/status-notifications.ts';
    import { initFileUploads } from '../../lib/ai-council/file-uploads.ts';
    import { initModelSelection } from '../../lib/ai-council/model-selection.ts';
    import { initLibraries } from '../../lib/ai-council/libraries.ts';
    import { initSaveSessionModal } from '../../lib/ai-council/save-session-modal.ts';
    import { initWorkflowProgress } from '../../lib/ai-council/workflow-progress.ts';
    import { initResponseRendering } from '../../lib/ai-council/response-rendering.ts';
    import { getDomRefs } from '../../lib/ai-council/dom-helpers.ts';
    import { initModelProgress } from '../../lib/ai-council/model-progress.ts';
    import { initSaveToKb } from '../../lib/ai-council/kb-save.ts';
    import { initRestoreResponses } from '../../lib/ai-council/restore-responses.ts';
    import { initProjectSidebarUi } from '../../lib/ai-council/project-sidebar-ui.ts';
    import { initKbProjectsUi } from '../../lib/ai-council/kb-projects-ui.ts';
    import { initKbContextLoader } from '../../lib/ai-council/kb-context-loader.ts';
    import { initAccordionUi } from '../../lib/ai-council/accordion-ui.ts';
    import { initRunModules } from '../../lib/ai-council/run-modules.ts';
    import { initRunQuery } from '../../lib/ai-council/run-query.ts';
    import { initSessionsSetup } from '../../lib/ai-council/sessions-setup.ts';
    import { initSynthesisMeta } from '../../lib/ai-council/synthesis-meta.ts';
    import { initResponseStorage } from '../../lib/ai-council/response-storage.ts';
    import { initWorkflowState } from '../../lib/ai-council/workflow-state.ts';
    import { initTextareaUtils } from '../../lib/ai-council/textarea-utils.ts';
    import { initWorkflowControls } from '../../lib/ai-council/workflow-controls.ts';
    import { escapeHtml } from '../../lib/ai-council/html-utils.ts';
    import { initUiAssets } from '../../lib/ai-council/ui-assets.ts';
    import { initPageLoad } from '../../lib/ai-council/page-load.ts';
    import { initSidebarModules } from '../../lib/ai-council/sidebar-modules.ts';
    import { initToast } from '../../lib/ai-council/toast.ts';
    import { initPromptEditModal } from '../../lib/ai-council/prompt-edit-modal.ts';
    import type { AiCouncilProject, AiCouncilSession, CurrentResponses } from '../../lib/ai-council/types.ts';

    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ AI Council script starting...');
      
      const { svgIcons } = initUiAssets();
      const {
        toastContainer,
        logoutBanner,
        soundNotificationEl,
        hallucinationToggleBtn,
        hallucinationList,
        hallucinationReport,
        saveToKbBtn,
        synthesisContentEl,
        costBanner,
        contextEl,
        promptEl,
        clearContextBtn,
        copyContextBtn,
        previewContextBtn,
        clearPromptBtn,
        copyPromptBtn,
        previewPromptBtn,
        runBtn,
        retryFailedBtn,
        expandModelsBtn,
        deliberateNowBtn,
        synthesizeNowBtn,
        runAllSequentialBtn,
        addModelsCardBtn,
        addModelsCount,
        unusedModelDots,
        nextStepCards,
        deliberateCount,
        synthesizeCount,
        kbProjectSelect,
        sessionProjectFilter,
        structurePromptContainer,
        structurePromptBtn,
        structuredPreview,
        structuredPreviewContent,
        structuredPreviewMeta,
        applyStructuredPrompt,
        cancelStructuredPrompt,
        copyStructuredPrompt,
        previewModal,
        previewModalTitle,
        previewModalBody,
        closePreviewModal,
        previewModalClose,
        previewModalCopy,
        promptEditModal,
        promptEditName,
        promptEditText,
        promptEditClose,
        promptEditCancel,
        promptEditSave,
        statusEl,
        statusTextEl,
        errorEl,
        resultsEl,
        synthesisCard,
        synthesisModelEl,
        synthesisModelsUsedEl,
        synthesisProfileEl,
        notesSidebar,
        notesToggle,
        notesList,
        notesSync,
        fileUploadArea,
        fileInput,
        fileListEl,
        cameraBtn,
        cameraInput,
        modelSelectionEl,
        deliberationToggle,
        enableDeliberationEl,
        skipSynthesisToggle,
        skipSynthesisEl,
        tokenCountEl,
        tokenDotEl,
        tokenWarningEl,
        tokenWarningTextEl,
        round1Label,
        round2Section,
        workflowProgressEl,
        workflowStatus,
        resetWorkflowBtn,
        dictationBtn,
        dictationStatus,
        projectSidebar,
        mobileMenuBtn,
        newChatBtn,
        projectSearch,
        projectList,
        unsortedAccordion,
        unsortedList,
        unsortedCount,
        allSessionsAccordion,
        allSessionsList,
        allSessionsCount,
        mobileNotesFab,
        mobileNotesBadge,
        profileSelectorEl
      } = getDomRefs();

      const { showToast } = initToast({
        container: toastContainer
      });
      const { refreshAccordionHeight } = initAccordionUi();
      
      // State
      let currentResponses: CurrentResponses = { openai: '', anthropic: '', google: '', grok: '', synthesis: '', isSuperSynthesis: false };
      let currentPrompt = '';
      let sessions: AiCouncilSession[] = [];
      let useSupabase = true;
      let availableModels: Record<string, boolean> = { openai: true, anthropic: true, gemini: true, grok: true };
      
      // ============================================
      // AUTH STATUS + SOUND NOTIFICATIONS
      // ============================================
      const { showLogoutBanner, playNotificationSound } = initStatusNotifications({
        logoutBanner,
        soundToggleEl: soundNotificationEl
      });
      
      let modelProgress;
      
      let kbProjects: Array<{ id: string; name: string }> = [];
      let kbProjectMap: Record<string, string> = {};
      let currentProjectFilter = 'all';
      let currentProject: AiCouncilProject | null = null;

      const { autoResizeTextarea } = initTextareaUtils({ contextEl });

      let reloadPromptLibrary = async () => {};
      const { openPromptEditModal } = initPromptEditModal({
        modalEl: promptEditModal,
        nameInput: promptEditName,
        promptInput: promptEditText,
        closeBtn: promptEditClose,
        cancelBtn: promptEditCancel,
        saveBtn: promptEditSave,
        getReloadPromptLibrary: () => reloadPromptLibrary,
        showToast
      });
      
      const { showPreviewModal } = initFieldActions({
        contextEl,
        promptEl,
        clearContextBtn,
        copyContextBtn,
        previewContextBtn,
        clearPromptBtn,
        copyPromptBtn,
        previewPromptBtn,
        structurePromptContainer,
        structuredPreview,
        previewModal,
        previewModalTitle,
        previewModalBody,
        closePreviewModal,
        previewModalClose,
        previewModalCopy,
        autoResizeTextarea
      });
      
      // Track how many models were used for current synthesis
      let modelsInCurrentSynthesis = 0;

      let workflowProgress;
      let updateWorkflowProgress = () => {};
      let resetWorkflow = () => {};
      let runQuery = async () => {};
      let openSession = (_session: any) => {};
      let saveResponsesToStorage = () => {};
      let loadResponsesFromStorage = async () => false;
      let clearStoredResponses = () => {};
      let collectedResponses = {}; // Store Round 1 responses across multiple runs
      let lastQueryHash = ''; // Track if prompt/context changed to reset collected responses
      let collectedR2Responses = {}; // Store Round 2 (deliberation) responses
      let hasRunDeliberation = false; // Track if deliberation has been run
      let hasSynthesized = false; // Track if synthesis has been done
      
      const {
        formatDuration,
        renderMarkdown,
        setStatus,
        showError,
        hideError,
        setLoading,
        copyToClipboard
      } = initUiHelpers({
        statusEl,
        statusTextEl,
        errorEl,
        runBtn
      });

      
      modelProgress = initModelProgress({ formatDuration });
      
      initPromptTools({
        dictationBtn,
        dictationStatus,
        promptEl,
        contextEl,
        structurePromptContainer,
        structurePromptBtn,
        structuredPreview,
        structuredPreviewContent,
        structuredPreviewMeta,
        applyStructuredPrompt,
        cancelStructuredPrompt,
        copyStructuredPrompt,
        autoResizeTextarea,
        renderMarkdown,
        escapeHtml
      });
      
      initWorkflowControls({
        resetWorkflowBtn,
        skipSynthesisToggle,
        skipSynthesisEl,
        getCollectedResponses: () => collectedResponses,
        resetWorkflow: () => resetWorkflow()
      });
      
      const { getSelectedModels, updateModelCheckboxes, getCurrentProfile } = initModelSelection({
        modelSelectionEl,
        profileSelectorEl,
        synthesisModelEl,
        enableDeliberationEl,
        deliberationToggle,
        availableModels,
        contextEl,
        promptEl,
        tokenCountEl,
        tokenDotEl,
        tokenWarningEl,
        tokenWarningTextEl
      });
      const getSelectedModelsSafe = () =>
        getSelectedModels().filter((model): model is string => typeof model === 'string' && model.length > 0);

      const { updateSynthesisMeta } = initSynthesisMeta({
        synthesisModelsUsedEl,
        synthesisProfileEl,
        getCurrentProfile
      });
      
      const fileUploadsApi = initFileUploads({
        fileUploadArea,
        fileInput,
        fileListEl,
        contextEl,
        promptEl,
        cameraBtn,
        cameraInput
      });
      const { getUploadedFiles } = fileUploadsApi;
      
      const { updateNotesBadge } = initProjectSidebarUi({
        projectSidebar,
        mobileMenuBtn,
        notesSidebar,
        mobileNotesFab,
        mobileNotesBadge,
        newChatBtn,
        kbProjectSelect,
        contextEl,
        promptEl,
        resultsEl,
        synthesisCard,
        setStatus,
        hideError,
        resetWorkflow: () => resetWorkflow(),
        getSessions: () => sessions,
        setCurrentPrompt: (value) => { currentPrompt = value; },
        setCurrentResponses: (value) => { currentResponses = value; },
        setCurrentSessionId: () => {},
        clearUploadedFiles: () => { fileUploadsApi.clearFiles(); }
      });
      
      const responseRendering = initResponseRendering({
        renderMarkdown,
        formatDuration,
        updateSynthesisMeta,
        getCurrentResponses: () => currentResponses,
        refreshAccordionHeight
      });
      
      const librariesApi = initLibraries({
        promptEl,
        contextEl,
        escapeHtml,
        setStatus,
        showPreviewModal,
        openPromptEditModal
      });
      reloadPromptLibrary = librariesApi.loadPromptLibrary;
      
      // Sessions management (Supabase only - no localStorage fallback)
      let userIsLoggedIn = false;
      let loadSessions = async () => {};
      let renderSessions = () => {};
      let saveSession: (payload: any) => Promise<any> = async () => false;

      const { showSavePromptModal, saveCurrentSession } = initSaveSessionModal({
        getCurrentPrompt: () => currentPrompt,
        getCurrentResponses: () => currentResponses,
        contextEl,
        synthesisModelEl,
        kbProjectSelect,
        getSaveSession: () => saveSession
      });

      workflowProgress = initWorkflowProgress({
        retryFailedBtn,
        expandModelsBtn,
        addModelsCardBtn,
        deliberateNowBtn,
        synthesizeNowBtn,
        addModelsCount,
        unusedModelDots,
        nextStepCards,
        deliberateCount,
        synthesizeCount,
        skipSynthesisEl,
        skipSynthesisToggle,
        runBtn,
        svgIcons,
        getCollectedResponses: () => collectedResponses,
        saveResponsesToStorage,
        updateWorkflowProgress: () => updateWorkflowProgress(),
        getHasRunDeliberation: () => hasRunDeliberation,
        getModelsInCurrentSynthesis: () => modelsInCurrentSynthesis,
        setModelsInCurrentSynthesis: (value) => { modelsInCurrentSynthesis = value; },
        setHasSynthesized: (value) => { hasSynthesized = value; },
        getCurrentResponses: () => currentResponses,
        setStatus,
        showSavePromptModal,
        saveCurrentSession,
        runQuery: () => runQuery()
      });
      
      const sessionsSetup = initSessionsSetup({
        notesList,
        notesSync,
        notesSidebar,
        notesToggle,
        promptEl,
        renderMarkdown,
        escapeHtml,
        copyToClipboard,
        updateNotesBadge,
        showLogoutBanner,
        getSessions: () => sessions,
        setSessions: (next) => { sessions = next; },
        getUserIsLoggedIn: () => userIsLoggedIn,
        setUserIsLoggedIn: (value) => { userIsLoggedIn = value; },
        getUseSupabase: () => useSupabase,
        setUseSupabase: (value) => { useSupabase = value; },
        getKbProjectMap: () => kbProjectMap,
        getCurrentProjectFilter: () => currentProjectFilter,
        contextEl,
        synthesisModelEl,
        getCurrentPrompt: () => currentPrompt,
        getCurrentResponses: () => currentResponses
      });
      loadSessions = sessionsSetup.loadSessions;
      renderSessions = sessionsSetup.renderSessions;
      saveSession = sessionsSetup.saveSession;
      openSession = sessionsSetup.openSession;

      // Initialize sessions
      loadSessions();

      const kbProjectsUi = initKbProjectsUi({
        kbProjectSelect,
        sessionProjectFilter,
        escapeHtml,
        getKbProjects: () => kbProjects,
        setKbProjects: (next) => { kbProjects = next; },
        setKbProjectMap: (next) => { kbProjectMap = next; },
        getCurrentProjectFilter: () => currentProjectFilter,
        setCurrentProjectFilter: (value) => { currentProjectFilter = value; },
        renderSessions: () => renderSessions()
      });
      
      const {
        startModelWaiting,
        stopAllModelTimers,
        markModelComplete,
        getWaitingCount
      } = modelProgress;
      
      const displayResponse = responseRendering.displayResponse;

      const responseStorage = initResponseStorage({
        promptEl,
        contextEl,
        getCurrentPrompt: () => currentPrompt,
        setCurrentPrompt: (value) => { currentPrompt = value; },
        getCollectedResponses: () => collectedResponses,
        setCollectedResponses: (value) => { collectedResponses = value; },
        getCollectedR2Responses: () => collectedR2Responses,
        setCollectedR2Responses: (value) => { collectedR2Responses = value; },
        getHasRunDeliberation: () => hasRunDeliberation,
        setHasRunDeliberation: (value) => { hasRunDeliberation = value; },
        getHasSynthesized: () => hasSynthesized,
        setHasSynthesized: (value) => { hasSynthesized = value; }
      });
      ({
        saveResponsesToStorage,
        loadResponsesFromStorage,
        clearStoredResponses
      } = responseStorage);

      const workflowState = initWorkflowState({
        workflowProgress: workflowProgressEl,
        workflowStatus,
        round2Section,
        round1Label,
        retryFailedBtn,
        expandModelsBtn,
        nextStepCards,
        addModelsCardBtn,
        deliberateNowBtn,
        synthesizeNowBtn,
        svgIcons,
        getCollectedResponses: () => collectedResponses,
        setCollectedResponses: (value) => { collectedResponses = value; },
        setCollectedR2Responses: (value) => { collectedR2Responses = value; },
        setFailedModels: () => {},
        getHasRunDeliberation: () => hasRunDeliberation,
        setHasRunDeliberation: (value) => { hasRunDeliberation = value; },
        getHasSynthesized: () => hasSynthesized,
        setHasSynthesized: (value) => { hasSynthesized = value; },
        setModelsInCurrentSynthesis: (value) => { modelsInCurrentSynthesis = value; },
        clearStoredResponses,
        setStatus,
        hideError
      });
      updateWorkflowProgress = workflowState.updateWorkflowProgress;
      resetWorkflow = workflowState.resetWorkflow;
      
      const runQueryApi = initRunQuery({
        contextEl,
        promptEl,
        synthesisModelEl,
        enableDeliberationEl,
        skipSynthesisEl,
        resultsEl,
        synthesisCard,
        round2Section,
        round1Label,
        hallucinationReportEl: hallucinationReport,
        hallucinationListEl: hallucinationList,
        costBannerEl: costBanner,
        getSelectedModels: getSelectedModelsSafe,
        getCurrentProfile,
        getCurrentProject: () => currentProject,
        getUploadedFiles,
        updateModelCheckboxes,
        formatDuration,
        setStatus,
        showError,
        hideError,
        setLoading,
        showLogoutBanner,
        startModelWaiting,
        stopAllModelTimers,
        markModelComplete,
        getWaitingCount,
        displayResponse,
        renderSynthesis: responseRendering.renderSynthesis,
        renderCostBanner: responseRendering.renderCostBanner,
        renderHallucinationReport: responseRendering.renderHallucinationReport,
        handlePostQuery: (data) => workflowProgress.handlePostQuery(data),
        clearStoredResponses,
        setCurrentPrompt: (value) => { currentPrompt = value; },
        setCollectedResponses: (value) => { collectedResponses = value; },
        setCollectedR2Responses: (value) => { collectedR2Responses = value; },
        setHasRunDeliberation: (value) => { hasRunDeliberation = value; },
        setHasSynthesized: (value) => { hasSynthesized = value; },
        getLastQueryHash: () => lastQueryHash,
        setLastQueryHash: (value) => { lastQueryHash = value; },
        getCurrentResponses: () => currentResponses,
        setCurrentResponses: (value) => { currentResponses = value; },
        getAvailableModels: () => availableModels,
        setAvailableModels: (value) => { availableModels = value; }
      });
      runQuery = runQueryApi.runQuery;

      initRunModules({
        runBtn,
        runQuery: () => runQuery(),
        hallucinationToggleBtn,
        hallucinationList,
        promptEl,
        contextEl,
        resultsEl,
        nextStepCards,
        synthesizeNowBtn,
        synthesizeCount,
        deliberateNowBtn,
        deliberateCount,
        round2Section,
        round1Label,
        svgIcons,
        synthesisModelEl,
        runAllSequentialBtn,
        addModelsCardBtn,
        addModelsCount,
        unusedModelDots,
        getCollectedResponses: () => collectedResponses,
        getCollectedR2Responses: () => collectedR2Responses,
        getHasRunDeliberation: () => hasRunDeliberation,
        getCurrentPrompt: () => currentPrompt,
        setCurrentPrompt: (value) => { currentPrompt = value; },
        setHasRunDeliberation: (value) => { hasRunDeliberation = value; },
        setHasSynthesized: (value) => { hasSynthesized = value; },
        setModelsInCurrentSynthesis: (value) => { modelsInCurrentSynthesis = value; },
        updateWorkflowProgress,
        showSavePromptModal,
        setStatus,
        showError,
        hideError,
        setLoading,
        displayResponse,
        formatDuration,
        saveResponsesToStorage,
        playNotificationSound,
        renderSynthesis: responseRendering.renderSynthesis,
        getCurrentResponses: () => currentResponses,
        setCurrentResponses: (value) => { currentResponses = value; }
      });
      
      // =============================================
      // PROJECT SIDEBAR FUNCTIONALITY
      // =============================================
      
      const projectSidebarState = initProjectSidebarState({
        projectList,
        projectSearch,
        escapeHtml,
        onProjectSelected: (project) => {
          currentProject = project;
          if (project?.id) {
            localStorage.setItem('ai-council-current-project-id', project.id);
          } else {
            localStorage.removeItem('ai-council-current-project-id');
          }
        }
      });
      const { loadProjects, updateProject, deleteProject, selectProject } = projectSidebarState;
      const { loadProjectsWithSelection } = initProjectSelectionStorage({
        loadProjects,
        getProjects: () => projectSidebarState.getProjects(),
        selectProject
      });

      const { renderSessionAccordions } = initSidebarModules({
        contextEl,
        escapeHtml,
        projectSidebar,
        projectList,
        projectSearch,
        unsortedAccordion,
        allSessionsAccordion,
        unsortedList,
        allSessionsList,
        unsortedCount,
        allSessionsCount,
        getSessions: () => sessions,
        openSession,
        getProjects: () => projectSidebarState.getProjects(),
        isKbProjectMode: projectSidebarState.isKbProjectMode,
        updateProject,
        deleteProject,
        showToast
      });
      
      

      const kbContextLoader = initKbContextLoader({ contextEl, setStatus });
      const restoreResponses = initRestoreResponses({
        resultsEl,
        nextStepCards,
        synthesizeNowBtn,
        synthesizeCount,
        deliberateNowBtn,
        deliberateCount,
        setStatus,
        displayResponse,
        formatDuration,
        updateWorkflowProgress,
        loadResponsesFromStorage,
        getCollectedResponses: () => collectedResponses,
        getHasRunDeliberation: () => hasRunDeliberation
      });

      initPageLoad({
        loadProjects: loadProjectsWithSelection,
        loadKbProjects: () => kbProjectsUi.loadKbProjects(),
        getLoadSessions: () => loadSessions,
        setLoadSessions: (fn) => { loadSessions = fn; },
        renderSessionAccordions,
        updateNotesBadge,
        loadKbContextFromUrl: () => kbContextLoader.loadFromUrlParam(),
        restoreResponses: () => restoreResponses.restoreSavedResponses()
      });
      
      // =============================================
      // SAVE TO KUNSKAPSBAS
      // =============================================
      initSaveToKb({
        buttonEl: saveToKbBtn,
        getCurrentPrompt: () => currentPrompt,
        getSynthesisContentEl: () => synthesisContentEl
      });
      
    });
    </script>
    <QuickPrompt />
  </body>
</html>
