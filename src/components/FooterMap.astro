---
// src/components/FooterMap.astro
---

<section aria-labelledby="karta-rubrik" class="w-full mt-auto">
  <h2 id="karta-rubrik" class="sr-only">Karta till v√•r mottagning</h2>
  <div id="map" class="w-full h-96"></div>
</section>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

<script>
  // Ladda Leaflet och initiera kartan
  document.addEventListener('astro:page-load', initMap);
  document.addEventListener('DOMContentLoaded', initMap);
  
  let mapInitialized = false;
  
  function initMap() {
    if (mapInitialized) return;
    const mapEl = document.getElementById('map');
    if (!mapEl || mapEl.hasChildNodes()) return;
    
    // Ladda Leaflet dynamiskt
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    script.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
    script.crossOrigin = '';
    script.onload = () => {
      // Koordinater f√∂r S√∂dermalms Ortopedi, Fatburs Brunnsgata 17
      const lat = 59.3140;
      const lng = 18.0669;
      
      // Skapa kartan
      const map = L.map('map').setView([lat, lng], 16);
      
      // L√§gg till OpenStreetMap-tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);
      
      // Klassisk GPS-pin f√∂r kliniken
      const locationPin = L.divIcon({
        html: `<svg width="36" height="48" viewBox="0 0 24 32" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <filter id="shadow" x="-20%" y="-10%" width="140%" height="130%">
              <feDropShadow dx="0" dy="1" stdDeviation="1.5" flood-opacity="0.3"/>
            </filter>
          </defs>
          <path filter="url(#shadow)" d="M12 0C5.4 0 0 5.4 0 12c0 7.2 10.8 19.2 11.5 20 .3.3.7.3 1 0C13.2 31.2 24 19.2 24 12 24 5.4 18.6 0 12 0z" fill="#e53935"/>
          <circle cx="12" cy="11" r="5" fill="#fff"/>
        </svg>`,
        iconSize: [36, 48],
        iconAnchor: [18, 48],
        popupAnchor: [0, -48],
        className: ''
      });
      
      // L√§gg till mark√∂r med popup och v√§gbeskrivning
      const marker = L.marker([lat, lng], { icon: locationPin }).addTo(map);
      const directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
      marker.bindPopup(`
        <strong>S√∂dermalms Ortopedi</strong><br>
        Fatburs Brunnsgata 17<br><br>
        <a href="${directionsUrl}" target="_blank" rel="noopener" style="color: #0ea5e9; font-weight: 500;">
          üìç V√§gbeskrivning ‚Üí
        </a>
      `).openPopup();
      
      // SVG-ikoner f√∂r kollektivtrafik (fr√•n specialist.se)
      const trainIcon = L.divIcon({
        html: `<svg width="32" height="32" viewBox="0 0 46.1 46.2" xmlns="http://www.w3.org/2000/svg">
          <circle cx="23" cy="23.1" r="22" fill="#ec619f" stroke="#ec619f" stroke-miterlimit="10"/>
          <path fill="#FFFFFF" d="M10.4,27.1c0.1-0.7,0-1.3,0-2c0-0.7,0-1.3,0-2c0-1.3,0-2.6,0-3.9c-0.1-2.6,0-5.2,0-7.8c0-0.6,0-1.2,0-1.8 c0-0.6,0-1.4,0.2-2c0.4-1,1.3-1.9,2.4-2.1c1.3-0.2,2.6-0.1,3.9-0.1c0.2,0,0.5,0,0.7,0c0.3,0,0.3,0,0.5-0.3c0.3-0.5,0.6-0.9,1-1.2 c1-0.7,2.3-0.6,3.4-0.6c0.6,0,1.3,0,1.9,0c0.7,0,1.4,0,2,0.4c0.5,0.3,1.1,0.7,1.3,1.3c0.2,0.5,0.3,0.4,0.8,0.4c0.6,0,1.2,0,1.8,0 c0.6,0,1.3,0,1.9,0c1.2,0.1,2.5,0.8,2.9,2c0.4,1.2,0.2,2.6,0.2,3.9c0,2.6,0,5.1,0,7.7c0,2.9,0.1,5.8,0,8.7c0,0.7,0,1.4,0,2 c0,0.7,0,1.5-0.4,2.1c-0.7,1.2-1.9,1.7-3.2,1.6c0.8,1.2,1.4,2.5,2.2,3.7c0.4,0.8,1.7,2.4,0,2.5c-0.8,0.1-1.7,0-2.5,0 c-1,0-1.1-0.9-1.6-1.6c-0.5-0.7-1.2-0.5-2-0.5c-0.8,0-1.7,0-2.5,0c-1.7,0-3.5,0-5.2,0c-0.9,0-1.7,0-2.6,0c-0.7,0-1.3-0.1-1.8,0.6 c-0.3,0.5-0.5,1.3-1.2,1.5c-0.3,0.1-0.7,0-1,0c-0.5,0-0.9,0-1.4,0c-0.3,0-0.8,0.1-1-0.1c-0.4-0.3-0.3-0.8-0.1-1.1 c0.5-0.8,0.9-1.6,1.4-2.4c0.3-0.4,0.5-0.9,0.8-1.3c0.1-0.2,0.3-0.4,0.4-0.7c0.1-0.2,0.4-0.4,0.1-0.6c-0.2-0.1-0.4,0-0.6,0 c-0.2,0-0.5-0.1-0.7-0.2c-0.4-0.1-0.8-0.4-1.1-0.7c-0.7-0.7-1-1.7-0.9-2.6c0-0.5,0-1,0-1.4C10.4,28.1,10.5,27.5,10.4,27.1 C10.4,26.7,10.4,27.2,10.4,27.1z M28.5,34.7c-0.1-0.7-0.9-1.2-1.6-1.2c-0.9,0-1.8,0-2.8,0c-0.9,0-1.8,0-2.7,0c-0.5,0-0.9,0-1.4,0 c-0.5,0-1-0.1-1.5,0c-0.7,0.1-1.3,0.8-1.3,1.4c-0.1,0.8,0.8,0.6,1.3,0.6c1.9,0,3.7,0.1,5.6,0c1,0,2,0,3.1,0c0.3,0,0.5,0,0.8,0 c0.1,0,0.3,0,0.5-0.1C28.7,35.3,28.6,35,28.5,34.7C28.4,34.5,28.7,35.4,28.5,34.7z M13.6,13.9c0,1.2,0,2.4,0,3.6c0,0.6,0,1.2,0,1.8 c0,0.6,0,1.1,0.2,1.7c0.6,1.2,1.9,1.1,3,1.1c0.6,0,1.2,0,1.8,0c0.6,0,1.1,0.1,1.7-0.1c1-0.3,1.5-1.1,1.6-2.1c0-1.2,0-2.4,0-3.5 c0-0.6,0-1.2,0-1.8c0-0.6,0.1-1.2-0.2-1.8c-0.2-0.4-0.6-0.7-1-0.9c-0.5-0.2-1-0.2-1.6-0.2c-0.7,0-1.4,0-2.1,0 c-0.6,0-1.2-0.1-1.7,0.1C14.2,12,13.5,12.9,13.6,13.9C13.6,14.1,13.5,12.7,13.6,13.9z M13.7,25.5c-0.5,1.1,0.2,2.4,1.3,2.7 c1,0.3,2.1-0.2,2.5-1.2c0.4-1.1-0.1-2.3-1.1-2.7C15.4,23.9,14.1,24.4,13.7,25.5C13.5,25.9,13.9,24.9,13.7,25.5z M20.9,8.2 c0,0.5,0.5,0.9,0.9,1.2c0.5,0.3,1,0.4,1.6,0.2c1-0.2,1.6-1.3,1.5-2.3c-0.1-1.2-1.5-2.1-2.6-1.7C21.3,5.9,20.5,7.1,20.9,8.2 C20.9,8.3,20.8,7.8,20.9,8.2z M32,25.3c-0.1-0.4-0.7-0.8-1.1-1c-0.5-0.2-1-0.2-1.5,0c-1.1,0.5-1.6,1.8-1,2.9c0.5,1,1.8,1.4,2.8,0.8 C32.1,27.5,32.6,26.2,32,25.3C31.9,25.1,32.2,25.6,32,25.3z M23.9,13.7c0,1.3,0,2.5,0,3.8c0,0.6,0,1.2,0,1.8c0,0.6-0.1,1.2,0.2,1.7 c0.2,0.4,0.5,0.7,1,0.9c0.5,0.3,1.1,0.2,1.7,0.2c0.6,0,1.2,0,1.8,0c0.6,0,1.2,0.1,1.8,0c0.8-0.1,1.5-0.6,1.7-1.4 c0.1-0.5,0.1-1,0.1-1.5c0-0.7,0-1.3,0-2c0-0.6,0-1.2,0-1.8c0-0.6,0.1-1.2,0-1.8c-0.1-1.1-1-1.9-2.1-1.9c-1.3,0-2.7,0-4,0 C25,11.8,24,12.5,23.9,13.7C23.9,14.1,24,12.7,23.9,13.7z"/>
        </svg>`,
        iconSize: [32, 32],
        iconAnchor: [16, 16],
        className: ''
      });
      
      const metroIcon = L.divIcon({
        html: `<svg width="32" height="32" viewBox="0 0 46 46" xmlns="http://www.w3.org/2000/svg">
          <circle cx="23" cy="23" r="22" fill="#0066b3" stroke="#0066b3" stroke-miterlimit="10"/>
          <g fill="#FFFFFF">
            <path d="M23,3.7c10.6,0,19.2,8.6,19.2,19.3c0,10.6-8.6,19.3-19.3,19.3C12.4,42.2,3.7,33.6,3.7,23 C3.8,12.3,12.4,3.7,23,3.7z M41.3,23c0-10.1-8.2-18.3-18.3-18.3C12.9,4.7,4.7,12.9,4.7,23c0,10.1,8.2,18.3,18.3,18.3 C33.1,41.3,41.3,33.1,41.3,23z"/>
            <path d="M34.3,19.6c-2.6,0-5.1,0-7.7,0c0,6.1,0,12.3,0,18.4c-2.3,0-4.6,0-6.9,0c0-6.1,0-12.2,0-18.4c-2.7,0-5.3,0-8,0 c0-2.3,0-4.6,0-6.9c7.5,0,15.1,0,22.6,0C34.3,15,34.3,17.3,34.3,19.6z"/>
          </g>
        </svg>`,
        iconSize: [32, 32],
        iconAnchor: [16, 16],
        className: ''
      });
      
      // S√∂dra station (pendelt√•g) - uppg√•ng Swedenborgsgatan
      L.marker([59.314148, 18.064704], { icon: trainIcon })
        .addTo(map)
        .bindTooltip('Uppg√•ng Swedenborgsgatan', { direction: 'top', offset: [0, -10] })
        .bindPopup(`<strong>Stockholms s√∂dra</strong><br>Pendelt√•g<br>Uppg√•ng Swedenborgsgatan`);
      
      // S√∂dra station (pendelt√•g) - uppg√•ng Rosenlundsgatan
      L.marker([59.312805, 18.057752], { icon: trainIcon })
        .addTo(map)
        .bindTooltip('Uppg√•ng Rosenlundsgatan', { direction: 'top', offset: [0, -10] })
        .bindPopup(`<strong>Stockholms s√∂dra</strong><br>Pendelt√•g<br>Uppg√•ng Rosenlundsgatan`);
      
      // Medborgarplatsen T-bana (uppg√•ng Bj√∂rns tr√§dg√•rd)
      L.marker([59.315313, 18.073029], { icon: metroIcon })
        .addTo(map)
        .bindTooltip('Uppg√•ng Bj√∂rns tr√§dg√•rd', { direction: 'top', offset: [0, -10] })
        .bindPopup(`<strong>Medborgarplatsen</strong><br>Tunnelbana (gr√∂n linje)<br>Uppg√•ng Bj√∂rns tr√§dg√•rd`);
      
      // Medborgarplatsen T-bana (uppg√•ng Folkungagatan - n√§rmast kliniken)
      L.marker([59.314288, 18.073067], { icon: metroIcon })
        .addTo(map)
        .bindTooltip('Uppg√•ng Folkungagatan', { direction: 'top', offset: [0, -10] })
        .bindPopup(`<strong>Medborgarplatsen</strong><br>Uppg√•ng Folkungagatan<br><em style="color: #16a34a;">N√§rmast kliniken!</em>`);
      
      // Mariatorget T-bana
      L.marker([59.316917, 18.063395], { icon: metroIcon })
        .addTo(map)
        .bindTooltip('Mariatorget', { direction: 'top', offset: [0, -10] })
        .bindPopup(`<strong>Mariatorget</strong><br>Tunnelbana (r√∂d linje)<br>Uppg√•ng Swedenborgsgatan`);
      
      mapInitialized = true;
    };
    document.head.appendChild(script);
  }
</script>

<style>
  #map {
    z-index: 0;
  }
</style>
